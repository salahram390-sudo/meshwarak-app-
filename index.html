<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ</title>

  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050B16">

  <!-- âœ… Ù…Ù†Ø¹ ÙÙ„Ø§Ø´/ØµÙØ­Ø© Ø¨ÙŠØ¶Ø§ Ù„Ùˆ CSS Ø§ØªØ£Ø®Ø± -->
  <style>
    html,body{margin:0;background:#050B16;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a,button{font-family:inherit}
  </style>

  <link rel="stylesheet" href="./styles.css?v=fix-1">
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card" style="width:min(520px, 100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:54px;height:54px;border-radius:18px;font-size:22px">Ù…</div>
      </div>

      <h1 style="margin:0;font-size:20px">ğŸš– Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
      <p class="hint" style="margin:8px 0 14px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>

      <div class="actions" id="guestBtns" style="justify-content:center">
        <a class="btn success" id="guestPassenger" href="./login.html?role=passenger" style="min-width:220px;text-align:center">ğŸš• Ø±Ø§ÙƒØ¨</a>
        <a class="btn primary" id="guestDriver" href="./login.html?role=driver" style="min-width:220px;text-align:center">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</a>
      </div>

      <div id="meBox" class="card" style="margin-top:14px; display:none; text-align:right">
        <div class="hint" id="meText" style="margin-top:0"></div>

        <div class="actions" style="margin-top:12px;flex-wrap:wrap">
          <button class="btn success" id="openPassengerBtn" type="button" style="min-width:180px">ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨</button>
          <button class="btn primary" id="openDriverBtn" type="button" style="min-width:180px">ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
          <button class="btn danger" id="logoutBtn" type="button" style="min-width:180px">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="hardRefreshBtn" type="button" style="min-width:220px">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ (Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„)</button>
      </div>

      <p class="hint" style="margin:14px 0 0">
        Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø§ Ø§ØªØ­Ø¯Ø«ØªØ´ ÙÙˆØ±Ù‹Ø§ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ¹Ù…Ù„ Refresh.
      </p>

      <p class="hint" id="swMsg" style="margin:10px 0 0"></p>
      <p class="hint" id="errMsg" style="margin:8px 0 0;color:#ffb4b4"></p>
    </div>
  </div>

  <script>
    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Ø®Ø·Ø£: " + (e.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Promise Error: " + (e.reason?.message || e.reason || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });

    // âœ… Ù„Ùˆ Ø±Ø¬Ø¹Øª Ù„Ù„ØµÙØ­Ø© Ù…Ù† Back (bfCache) Ø§Ù…Ù†Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
    window.addEventListener("pageshow", (ev)=>{
      if(ev.persisted){
        document.documentElement.style.background = "#050B16";
        document.body.style.background = "#050B16";
      }
    });
  </script>

  <script type="module">
    import { auth, db, setActiveRole, ensureUserDoc, getActiveRole } from "./app.js?v=fix-1";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const guestBtns = document.getElementById("guestBtns");

    const meBox = document.getElementById("meBox");
    const meText = document.getElementById("meText");
    const logoutBtn = document.getElementById("logoutBtn");
    const openPassengerBtn = document.getElementById("openPassengerBtn");
    const openDriverBtn = document.getElementById("openDriverBtn");

    // ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const guestPassenger = document.getElementById("guestPassenger");
    const guestDriver = document.getElementById("guestDriver");
    guestPassenger?.addEventListener("click", ()=>{ try{ setActiveRole("passenger"); }catch{} });
    guestDriver?.addEventListener("click", ()=>{ try{ setActiveRole("driver"); }catch{} });

    function fallbackNameFromEmail(email){
      const x = (email || "").split("@")[0] || "Ù…Ø³ØªØ®Ø¯Ù…";
      return x.replace(/[._-]+/g, " ").trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
    }

    async function getUserDocX(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    logoutBtn?.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch{}
      location.href = "./index.html";
    });

    function vehText(v){
      return (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":
        (v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":
        (v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":
        (v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":
        (v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":
        (v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª": (v || "-");
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        meBox.style.display = "none";
        guestBtns.style.display = "flex";
        return;
      }

      guestBtns.style.display = "none";

      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: getActiveRole(),
        email: user.email || null,
      }).catch(()=>{});

      const data = await getUserDocX(user.uid).catch(()=>null);
      const name = (data?.name || "").trim() || fallbackNameFromEmail(user.email);

      const gov = data?.governorate || "-";
      const cen = data?.center || "-";

      const roles = data?.roles || { passenger:true, driver:true };
      const hasPassenger = !!roles.passenger;
      const hasDriver = !!roles.driver;

      const driverReady = !!(data?.vehicle && String(data?.model||"").trim().length >= 2);

      meBox.style.display = "block";
      meText.innerHTML =
        `ğŸ‘¤ <b>${name}</b><br>` +
        `ğŸ“§ ${user.email}<br>` +
        `ğŸ“ ${gov} / ${cen}<br>` +
        `ğŸ§© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ${(hasPassenger ? "Ø±Ø§ÙƒØ¨" : "")}${(hasDriver ? (hasPassenger ? " + " : "") + "Ø³Ø§Ø¦Ù‚" : "")}<br>` +
        `${hasDriver ? `ğŸš— Ù…Ø±ÙƒØ¨Ø©: ${vehText(data?.vehicle)} â€¢ Ù…ÙˆØ¯ÙŠÙ„: ${(data?.model || "-")}` : "ğŸš— Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯"}`;

      openPassengerBtn.textContent = hasPassenger ? "ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨" : "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§ÙƒØ¨";
      openPassengerBtn.onclick = ()=>{
        setActiveRole("passenger");
        location.href = hasPassenger ? "./passenger.html" : "./login.html?role=passenger";
      };

      if(!hasDriver){
        openDriverBtn.textContent = "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./login.html?role=driver";
        };
      }else if(!driverReady){
        openDriverBtn.textContent = "Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./account.html?role=driver";
        };
      }else{
        openDriverBtn.textContent = "ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./driver.html";
        };
      }
    });
  </script>

  <script>
    const swMsg = document.getElementById("swMsg");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");

    async function hardRefresh(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      location.reload(true);
    }

    hardRefreshBtn.addEventListener("click", hardRefresh);

    // âœ… Register SW Ù…Ø¹ version Ø¬Ø¯ÙŠØ¯ (Ø¨Ø³ Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ sw.js Ø´ØºØ§Ù„)
    if ("serviceWorker" in navigator) {
      const v = "fix-1-" + Date.now();
      navigator.serviceWorker.register("./sw.js?v=" + v)
        .then(()=>{ swMsg.textContent = "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ ÙƒÙ€ PWA (SW Ø´ØºØ§Ù„)."; })
        .catch(()=>{ swMsg.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Service Worker (Ù…Ø´ Ù…Ø´ÙƒÙ„Ø© ÙƒØ¨ÙŠØ±Ø©)."; });
    }
  </script>
</body>
</html>
