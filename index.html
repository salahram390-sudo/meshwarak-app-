<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ูุดูุงุฑู</title>

  <meta name="theme-color" content="#050B16">
  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">

  <!-- โ Cache-bust ูููุน ุฑุฌูุน CSS ูุฏูู -->
  <link rel="stylesheet" href="./styles.css?v=13">
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card auth-card" style="width:min(560px, 100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:14px">
        <div class="logo auth-logo" style="width:68px;height:68px;border-radius:22px;font-size:26px">ู</div>
      </div>

      <h1 style="margin:0;font-size:22px;letter-spacing:.2px">๐ ูุดูุงุฑู</h1>
      <p class="hint" style="margin:10px 0 16px">ุงุฎุชุฑ ููุน ุงูุงุณุชุฎุฏุงู</p>

      <!-- โ ุงุฎุชูุงุฑ ุงูุฏูุฑ -->
      <div class="actions" id="guestBtns" style="justify-content:center;gap:12px">
        <a class="btn primary" id="guestPassenger" href="./login.html?role=passenger" style="min-width:230px;text-align:center">๐ ุฑุงูุจ</a>
        <a class="btn secondary" id="guestDriver" href="./login.html?role=driver" style="min-width:230px;text-align:center">๐งโโ๏ธ ุณุงุฆู</a>
      </div>

      <!-- ุตูุฏูู ุงููุณุชุฎุฏู ุงูุญุงูู -->
      <div id="meBox" class="card" style="margin-top:14px; display:none; text-align:right">
        <div class="hint" id="meText" style="margin-top:0"></div>

        <div class="actions" style="margin-top:12px;flex-wrap:wrap">
          <button class="btn primary" id="openPassengerBtn" type="button" style="min-width:180px">ูุชุญ ุงูุฑุงูุจ</button>
          <button class="btn secondary" id="openDriverBtn" type="button" style="min-width:180px">ูุชุญ ุงูุณุงุฆู</button>
          <button class="btn danger" id="logoutBtn" type="button" style="min-width:180px">ุชุณุฌูู ุฎุฑูุฌ</button>
        </div>
      </div>

      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="hardRefreshBtn" type="button" style="min-width:230px">๐ ุชุญุฏูุซ ููู (ุญู ุงููุดุงูู)</button>
      </div>

      <p class="hint" style="margin:14px 0 0">
        ูู ุงูุตูุญุฉ ูุง ุงุชุญุฏุซุชุด ููุฑูุงุ ุฌุฑูุจ ุชุนูู Refresh.
      </p>

      <p class="hint" id="swMsg" style="margin:10px 0 0"></p>
      <p class="hint" id="errMsg" style="margin:8px 0 0"></p>
    </div>
  </div>

  <!-- โ ููุน โุฑุฌูุนโ ููุณุฎุฉ ูุฏููุฉ (bfcache) ุงููู ุจุชุนูู ุตูุญุฉ ุจูุถุง -->
  <script>
    window.addEventListener("pageshow", (e) => {
      try{
        if (e.persisted) location.reload();
      }catch{}
    });

    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{ errMsg.textContent = "โ๏ธ ุฎุทุฃ: " + (e.message || "ุบูุฑ ูุนุฑูู"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{ errMsg.textContent = "โ๏ธ Promise Error: " + (e.reason?.message || e.reason || "ุบูุฑ ูุนุฑูู"); }catch{}
    });
  </script>

  <script type="module">
    import { auth, db, setActiveRole, ensureUserDoc } from "./app.js?v=13";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const guestBtns = document.getElementById("guestBtns");

    const meBox = document.getElementById("meBox");
    const meText = document.getElementById("meText");
    const logoutBtn = document.getElementById("logoutBtn");
    const openPassengerBtn = document.getElementById("openPassengerBtn");
    const openDriverBtn = document.getElementById("openDriverBtn");

    // โ ุชุซุจูุช ุงูุฏูุฑ ูุจู ูุชุญ login
    const guestPassenger = document.getElementById("guestPassenger");
    const guestDriver = document.getElementById("guestDriver");
    guestPassenger?.addEventListener("click", ()=>{ try{ setActiveRole("passenger"); }catch{} });
    guestDriver?.addEventListener("click", ()=>{ try{ setActiveRole("driver"); }catch{} });

    function fallbackNameFromEmail(email){
      const x = (email || "").split("@")[0] || "ูุณุชุฎุฏู";
      return x.replace(/[._-]+/g, " ").trim() || "ูุณุชุฎุฏู";
    }

    async function getUserDocX(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    logoutBtn?.addEventListener("click", async ()=>{
      try{
        await auth.signOut();
      }catch{
        try{
          const { signOut } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
          await signOut(auth);
        }catch{}
      }
      location.href = "./index.html";
    });

    function vehText(v){
      return (v==="tuktuk")?"ุชููุชูู":
        (v==="motor_delivery")?"ููุชุณููู ุฏูููุฑู":
        (v==="car")?"ููุงูู":
        (v==="microbus")?"ูููุฑูุจุงุต":
        (v==="tamanya")?"ุชููุงูุฉ":
        (v==="caboot")?"ุนุฑุจูุฉ ูุงุจูุช": (v || "-");
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        meBox.style.display = "none";
        guestBtns.style.display = "flex";
        return;
      }

      guestBtns.style.display = "none";

      // โ ุงุถูู ุฅู ุฃู ุญุณุงุจ ุนูุฏู role ุฑุงูุจ + ุณุงุฆู
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: "passenger",
        email: user.email || null,
      }).catch(()=>{});

      const data = await getUserDocX(user.uid).catch(()=>null);
      const name = (data?.name || "").trim() || fallbackNameFromEmail(user.email);

      const gov = data?.governorate || "-";
      const cen = data?.center || "-";

      const roles = data?.roles || { passenger:true, driver:true };
      const hasPassenger = !!roles.passenger;
      const hasDriver = !!roles.driver;

      const driverReady = !!(data?.vehicle && String(data?.model||"").trim().length >= 2);

      meBox.style.display = "block";
      meText.innerHTML =
        `๐ค <b>${name}</b><br>` +
        `๐ง ${user.email}<br>` +
        `๐ ${gov} / ${cen}<br>` +
        `๐งฉ ุงูุฃุฏูุงุฑ: ${(hasPassenger ? "ุฑุงูุจ" : "")}${(hasDriver ? (hasPassenger ? " + " : "") + "ุณุงุฆู" : "")}<br>` +
        `${hasDriver ? `๐ ูุฑูุจุฉ: ${vehText(data?.vehicle)} โข ููุฏูู: ${(data?.model || "-")}` : "๐ ูู ูุชู ุฅุนุฏุงุฏ ุงูุณุงุฆู ุจุนุฏ"}`;

      openPassengerBtn.textContent = hasPassenger ? "ูุชุญ ุงูุฑุงูุจ" : "ุฅุนุฏุงุฏ ุงูุฑุงูุจ";
      openPassengerBtn.onclick = ()=>{
        setActiveRole("passenger");
        location.href = hasPassenger ? "./passenger.html" : "./login.html?role=passenger";
      };

      if(!hasDriver){
        openDriverBtn.textContent = "ุฅุนุฏุงุฏ ุงูุณุงุฆู";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./login.html?role=driver";
        };
      }else if(!driverReady){
        openDriverBtn.textContent = "ุฃููู ุจูุงูุงุช ุงูุณุงุฆู";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./login.html?role=driver";
        };
      }else{
        openDriverBtn.textContent = "ูุชุญ ุงูุณุงุฆู";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./driver.html";
        };
      }
    });
  </script>

  <script>
    const swMsg = document.getElementById("swMsg");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");

    async function hardRefresh(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      // โ Reload clean
      location.href = "./index.html?v=" + Date.now();
    }

    hardRefreshBtn.addEventListener("click", hardRefresh);

    if ("serviceWorker" in navigator) {
      // โ Version ุซุงุจุช ุจุฏู Date.now ุนูุดุงู ูุงูุจูุงุด SW ุจูุนูุฏ ุชุซุจูุช ูู ูุฑุฉ
      const v = "13";
      navigator.serviceWorker.register("./sw.js?v=" + v)
        .then(()=>{ swMsg.textContent = "โ ุงูุชุทุจูู ุฌุงูุฒ ููุนูู ูู PWA (SW ุดุบุงู)."; })
        .catch(()=>{ swMsg.textContent = "โ๏ธ ุชุนุฐุฑ ุชุดุบูู Service Worker (ูุด ูุดููุฉ ูุจูุฑุฉ)."; });
    }
  </script>
</body>
</html>
