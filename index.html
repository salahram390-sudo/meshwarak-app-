<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ±Ø§Ùƒ - Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</title>

  <!-- Leaflet + OSM -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{font-family:system-ui,Arial; margin:0; background:#0b0f14; color:#e8eef7;}
    header{padding:14px 16px; background:#101825; position:sticky; top:0;}
    h1{margin:0; font-size:18px;}
    #map{height:55vh;}
    .wrap{padding:14px 16px; display:grid; gap:12px;}
    .card{background:#101825; border:1px solid #1f2a3a; border-radius:14px; padding:12px;}
    label{display:block; font-size:13px; opacity:.9; margin-bottom:6px;}
    input,textarea{width:100%; padding:10px; border-radius:10px; border:1px solid #273449; background:#0b0f14; color:#e8eef7;}
    button{padding:12px; border:0; border-radius:12px; background:#2b6cff; color:white; font-weight:700; cursor:pointer;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hint{font-size:13px; opacity:.85; line-height:1.4}
    .pill{display:inline-block; padding:4px 10px; border:1px solid #273449; border-radius:999px; font-size:12px; opacity:.9}
  </style>
</head>
<body>
  <header>
    <h1>ğŸš– Ù…Ø´ÙˆØ±Ø§Ùƒ â€” Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</h1>
  </header>

  <div id="map"></div>

  <div class="wrap">
    <div class="card">
      <div class="hint">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± <b>Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</b> Ø«Ù… Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ù„Ø§Ø®ØªÙŠØ§Ø± <b>Ø§Ù„ÙˆØ¬Ù‡Ø©</b>.
        <br><span class="pill" id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚â€¦</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 010..." />
        </div>
        <div>
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="passengers" type="number" min="1" placeholder="1" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="note" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ÙŠ Ø´Ù†Ø·Ø©â€¦"></textarea>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button id="createBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
        <button id="resetBtn" style="background:#24344a;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø±</button>
      </div>

      <p class="hint" id="result"></p>
      <p class="hint">ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚: <b>driver.html</b></p>
    </div>
  </div>

  <!-- Firebase (CDN Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase config (Ø¨ØªØ§Ø¹Ùƒ)
    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø®Ø±ÙŠØ·Ø© Ø¨Ø¯ÙˆÙ† GPS
    const map = L.map('map').setView([24.7136, 46.6753], 12); // ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø±Ù‡Ø§ Ù„Ù…Ø¯ÙŠÙ†ØªÙƒ
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let from = null, to = null;
    let fromMarker = null, toMarker = null;
    let line = null;

    const statusEl = document.getElementById('status');
    const createBtn = document.getElementById('createBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultEl = document.getElementById('result');

    function updateUI(){
      if(!from){
        statusEl.textContent = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚â€¦";
        createBtn.disabled = true;
      } else if(from && !to){
        statusEl.textContent = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¬Ù‡Ø©â€¦";
        createBtn.disabled = true;
      } else {
        statusEl.textContent = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© âœ…";
        createBtn.disabled = false;
      }
    }

    function resetAll(){
      from = null; to = null;
      if(fromMarker) map.removeLayer(fromMarker);
      if(toMarker) map.removeLayer(toMarker);
      if(line) map.removeLayer(line);
      fromMarker = null; toMarker = null; line = null;
      resultEl.textContent = "";
      updateUI();
    }

    map.on('click', (e) => {
      if(!from){
        from = { lat: e.latlng.lat, lng: e.latlng.lng };
        fromMarker = L.marker(e.latlng).addTo(map).bindPopup("ğŸš© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚").openPopup();
      } else if(!to){
        to = { lat: e.latlng.lat, lng: e.latlng.lng };
        toMarker = L.marker(e.latlng).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø©").openPopup();
        line = L.polyline([from, to], { }).addTo(map);
        map.fitBounds(line.getBounds(), { padding: [30,30] });
      } else {
        resetAll();
      }
      updateUI();
    });

    resetBtn.addEventListener('click', resetAll);

    createBtn.addEventListener('click', async () => {
      try{
        createBtn.disabled = true;
        resultEl.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const phone = document.getElementById('phone').value.trim();
        const passengers = Number(document.getElementById('passengers').value || 0);
        const note = document.getElementById('note').value.trim();

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),
          from, to,
          phone: phone || null,
          passengers: passengers || null,
          note: note || null
        });

        resultEl.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${docRef.id}`;
      }catch(err){
        console.error(err);
        resultEl.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules ÙˆØ§Ø³Ù… Collection rides.";
      }finally{
        updateUI();
      }
    });

    updateUI();
  </script>
</body>
</html>
