<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ</title>

  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050B16" />

  <style>
    :root{
      --bg:#050A14;
      --card: rgba(12,18,32,.62);
      --stroke: rgba(255,255,255,.10);
      --txt:#EAF0FF;
      --muted: rgba(234,240,255,.72);
      --primary:#2B6CFF;
      --violet:#7C3AED;
      --success:#22C55E;
      --danger:#FF5C7A;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 80% 20%, rgba(43,108,255,.18), transparent 55%),
        radial-gradient(700px 520px at 20% 0%, rgba(124,58,237,.16), transparent 55%),
        radial-gradient(1000px 700px at 30% 90%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.18) 50%, transparent 52%),
        radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,.14) 50%, transparent 52%),
        radial-gradient(1px 1px at 60% 35%, rgba(255,255,255,.12) 50%, transparent 52%),
        radial-gradient(1px 1px at 80% 75%, rgba(255,255,255,.10) 50%, transparent 52%),
        radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,.10) 50%, transparent 52%),
        radial-gradient(1px 1px at 55% 85%, rgba(255,255,255,.08) 50%, transparent 52%);
      opacity:.9;
      pointer-events:none;
    }

    .wrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px 14px 28px;
    }

    .card{
      width:min(560px, 100%);
      background: linear-gradient(180deg, rgba(12,18,32,.72), rgba(10,18,34,.52));
      border:1px solid var(--stroke);
      border-radius: 26px;
      padding:18px 16px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      text-align:center;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 220px at 70% 0%, rgba(43,108,255,.16), transparent 60%),
        radial-gradient(520px 220px at 20% 20%, rgba(124,58,237,.14), transparent 62%);
      pointer-events:none;
    }
    .card > *{ position:relative; }

    .logoWrap{display:flex;justify-content:center;margin-bottom:10px}
    .logo{
      width:64px;height:64px;border-radius:20px;
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(34,197,94,.55));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      display:grid;place-items:center;
      font-weight:900;
      font-size:26px;
    }

    h1{margin:6px 0 6px;font-size:22px;letter-spacing:.2px}
    .hint{color:var(--muted);font-size:13px;line-height:1.7}

    .actions{
      width:min(460px,100%);
      margin:14px auto 0;
      display:grid;
      gap:10px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 18px;
      padding:14px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{transform: translateY(1px); filter: brightness(1.06)}
    .btn:disabled{opacity:.55;cursor:not-allowed; transform:none; filter:none;}

    .btn.success{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.62));
      border-color: rgba(34,197,94,.35);
      color:#04110a;
      box-shadow: 0 14px 34px rgba(34,197,94,.14);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(43,108,255,.70));
      border-color: rgba(43,108,255,.38);
      box-shadow: 0 14px 34px rgba(43,108,255,.18);
    }
    .btn.alt{
      background: linear-gradient(135deg, rgba(124,58,237,.88), rgba(124,58,237,.58));
      border-color: rgba(124,58,237,.36);
      box-shadow: 0 14px 34px rgba(124,58,237,.16);
    }
    .btn.danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.30);
      color:#ffd6dd;
    }

    .meBox{
      width:min(460px,100%);
      margin:14px auto 0;
      text-align:right;
      padding:14px 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      display:none;
    }
    .meText b{color:#fff}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:12px;color:rgba(234,240,255,.78);
    }

    .divider{
      width:min(460px,100%);
      margin:14px auto 0;
      height:1px;
      background: rgba(255,255,255,.10);
    }

    #errMsg{margin-top:10px;color:#ffd0d8}
    #swMsg{margin-top:8px}

    @media (max-width:520px){
      .card{padding:16px 14px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="logoWrap">
        <div class="logo">Ù…</div>
      </div>

      <h1>ğŸš– Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
      <p class="hint">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>

      <!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¶ÙŠÙ) -->
      <div class="actions" id="guestBtns" style="margin-top:12px">
        <a class="btn success" id="guestPassenger" href="./login.html?role=passenger">ğŸš• Ø±Ø§ÙƒØ¨</a>
        <a class="btn primary" id="guestDriver" href="./login.html?role=driver">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</a>
      </div>

      <!-- âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
      <div id="meBox" class="meBox">
        <div class="hint meText" id="meText" style="margin-top:0"></div>

        <div class="actions" style="margin-top:12px">
          <button class="btn success" id="openPassengerBtn" type="button">ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨</button>
          <button class="btn primary" id="openDriverBtn" type="button">ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
          <button class="btn danger" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="actions" style="margin-top:12px">
        <button class="btn alt" id="hardRefreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ (Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„)</button>
      </div>

      <p class="hint" style="margin:12px 0 0">Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø§ Ø§ØªØ­Ø¯Ø«ØªØ´ ÙÙˆØ±Ù‹Ø§ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ¹Ù…Ù„ Refresh.</p>
      <p class="hint" id="swMsg"></p>
      <p class="hint" id="errMsg"></p>

    </div>
  </div>

  <script>
    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Ø®Ø·Ø£: " + (e.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Promise Error: " + (e.reason?.message || e.reason || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
  </script>

  <script type="module">
    import { auth, db, setActiveRole, ensureUserDoc } from "./app.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const guestBtns = document.getElementById("guestBtns");
    const meBox = document.getElementById("meBox");
    const meText = document.getElementById("meText");
    const logoutBtn = document.getElementById("logoutBtn");
    const openPassengerBtn = document.getElementById("openPassengerBtn");
    const openDriverBtn = document.getElementById("openDriverBtn");

    const guestPassenger = document.getElementById("guestPassenger");
    const guestDriver = document.getElementById("guestDriver");
    guestPassenger?.addEventListener("click", ()=>{ try{ setActiveRole("passenger"); }catch{} });
    guestDriver?.addEventListener("click", ()=>{ try{ setActiveRole("driver"); }catch{} });

    function fallbackNameFromEmail(email){
      const x = (email || "").split("@")[0] || "Ù…Ø³ØªØ®Ø¯Ù…";
      return x.replace(/[._-]+/g, " ").trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
    }

    function vehText(v){
      return (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":
        (v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":
        (v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":
        (v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":
        (v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":
        (v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª": (v || "-");
    }

    async function getUserDocX(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    logoutBtn?.addEventListener("click", async ()=>{
      try{
        await auth.signOut();
      }catch{
        try{
          const { signOut } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
          await signOut(auth);
        }catch{}
      }
      location.href = "./index.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        meBox.style.display = "none";
        guestBtns.style.display = "grid";
        return;
      }

      guestBtns.style.display = "none";

      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: "passenger",
        email: user.email || null,
      }).catch(()=>{});

      const data = await getUserDocX(user.uid).catch(()=>null);
      const name = (data?.name || "").trim() || fallbackNameFromEmail(user.email);

      const gov = data?.governorate || "-";
      const cen = data?.center || "-";

      const roles = data?.roles || { passenger:true, driver:true };
      const hasPassenger = !!roles.passenger;
      const hasDriver = !!roles.driver;

      const driverReady = !!(data?.vehicle && String(data?.model||"").trim().length >= 2);

      meBox.style.display = "block";
      meText.innerHTML =
        `ğŸ‘¤ <b>${name}</b><br>` +
        `ğŸ“§ ${user.email}<br>` +
        `ğŸ“ ${gov} / ${cen}<br>` +
        `ğŸ§© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ${(hasPassenger ? "Ø±Ø§ÙƒØ¨" : "")}${(hasDriver ? (hasPassenger ? " + " : "") + "Ø³Ø§Ø¦Ù‚" : "")}<br>` +
        `${hasDriver ? `ğŸš— Ù…Ø±ÙƒØ¨Ø©: ${vehText(data?.vehicle)} â€¢ Ù…ÙˆØ¯ÙŠÙ„: ${(data?.model || "-")}` : "ğŸš— Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯"}`;

      openPassengerBtn.textContent = hasPassenger ? "ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨" : "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§ÙƒØ¨";
      openPassengerBtn.onclick = ()=>{
        setActiveRole("passenger");
        location.href = hasPassenger ? "./passenger.html" : "./login.html?role=passenger";
      };

      if(!hasDriver){
        openDriverBtn.textContent = "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./login.html?role=driver";
        };
      }else if(!driverReady){
        openDriverBtn.textContent = "Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./login.html?role=driver";
        };
      }else{
        openDriverBtn.textContent = "ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚";
        openDriverBtn.onclick = ()=>{
          setActiveRole("driver");
          location.href = "./driver.html";
        };
      }
    });
  </script>

  <script>
    const swMsg = document.getElementById("swMsg");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");

    async function hardRefresh(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      location.reload(true);
    }

    hardRefreshBtn.addEventListener("click", hardRefresh);

    if ("serviceWorker" in navigator) {
      const v = Date.now();
      navigator.serviceWorker.register("./sw.js?v=" + v)
        .then(()=>{ swMsg.textContent = "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ ÙƒÙ€ PWA (SW Ø´ØºØ§Ù„)."; })
        .catch(()=>{ swMsg.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Service Worker (Ù…Ø´ Ù…Ø´ÙƒÙ„Ø© ÙƒØ¨ÙŠØ±Ø©)."; });
    }
  </script>
</body>
</html>
