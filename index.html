<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ</title>

  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050B16">
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card" style="width:min(520px, 100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:54px;height:54px;border-radius:18px;font-size:22px">Ù…</div>
      </div>

      <h1 style="margin:0;font-size:20px">ğŸš– Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
      <p class="hint" style="margin:8px 0 14px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ùˆ Ù…Ø´ Ø¹Ø§Ù…Ù„ Login) -->
      <div class="actions" id="guestBtns" style="justify-content:center">
        <a class="btn success" href="./login.html?role=passenger" style="min-width:220px;text-align:center">ğŸš• Ø±Ø§ÙƒØ¨</a>
        <a class="btn primary" href="./login.html?role=driver" style="min-width:220px;text-align:center">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</a>
      </div>

      <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
      <div id="meBox" class="card" style="margin-top:14px; display:none; text-align:right">
        <div class="hint" id="meText" style="margin-top:0"></div>

        <div class="actions" style="margin-top:12px;flex-wrap:wrap">
          <button class="btn success" id="openPassengerBtn" type="button" style="min-width:180px">ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨</button>
          <button class="btn primary" id="openDriverBtn" type="button" style="min-width:180px">ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
          <button class="btn danger" id="logoutBtn" type="button" style="min-width:180px">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="hardRefreshBtn" type="button" style="min-width:220px">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ (Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„)</button>
      </div>

      <p class="hint" style="margin:14px 0 0">
        Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø§ Ø§ØªØ­Ø¯Ø«ØªØ´ ÙÙˆØ±Ù‹Ø§ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ¹Ù…Ù„ Refresh.
      </p>

      <p class="hint" id="swMsg" style="margin:10px 0 0"></p>
      <p class="hint" id="errMsg" style="margin:8px 0 0"></p>
    </div>
  </div>

  <script>
    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Ø®Ø·Ø£: " + (e.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Promise Error: " + (e.reason?.message || e.reason || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
  </script>

  <script type="module">
    import { auth, db, setActiveRole } from "./app.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const guestBtns = document.getElementById("guestBtns");

    const meBox = document.getElementById("meBox");
    const meText = document.getElementById("meText");
    const logoutBtn = document.getElementById("logoutBtn");
    const openPassengerBtn = document.getElementById("openPassengerBtn");
    const openDriverBtn = document.getElementById("openDriverBtn");

    function fallbackNameFromEmail(email){
      const x = (email || "").split("@")[0] || "Ù…Ø³ØªØ®Ø¯Ù…";
      return x.replace(/[._-]+/g, " ").trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
    }

    async function getUserDocX(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    logoutBtn?.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch{}
      location.href = "./index.html";
    });

    openPassengerBtn?.addEventListener("click", ()=>{
      setActiveRole("passenger");
      location.href = "./passenger.html";
    });

    openDriverBtn?.addEventListener("click", ()=>{
      setActiveRole("driver");
      location.href = "./driver.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        meBox.style.display = "none";
        guestBtns.style.display = "flex";
        return;
      }

      guestBtns.style.display = "none";

      const data = await getUserDocX(user.uid).catch(()=>null);
      const name = (data?.name || "").trim() || fallbackNameFromEmail(user.email);

      const gov = data?.governorate || "-";
      const cen = data?.center || "-";

      const roles = data?.roles || {};
      const hasDriver = !!roles.driver;

      meBox.style.display = "block";
      meText.innerHTML =
        `ğŸ‘¤ <b>${name}</b><br>` +
        `ğŸ“§ ${user.email}<br>` +
        `ğŸ“ ${gov} / ${cen}<br>` +
        `ğŸ§© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ${roles.passenger ? "Ø±Ø§ÙƒØ¨" : ""}${roles.driver ? " + Ø³Ø§Ø¦Ù‚" : ""}`;

      // Ù„Ùˆ Ù…Ø§Ø¹Ù†Ø¯ÙˆØ´ driver Ù„Ø³Ù‡: Ù†Ø®Ù„ÙŠÙ‡ ÙŠÙØªØ­ login ÙƒØ³Ø§Ø¦Ù‚ Ù„ÙŠÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
      openDriverBtn.textContent = hasDriver ? "ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚" : "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚";
      openDriverBtn.onclick = ()=>{
        if(hasDriver){
          setActiveRole("driver");
          location.href = "./driver.html";
        }else{
          location.href = "./login.html?role=driver";
        }
      };
    });
  </script>

  <script>
    const swMsg = document.getElementById("swMsg");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");

    async function hardRefresh(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      location.reload(true);
    }

    hardRefreshBtn.addEventListener("click", hardRefresh);

    if ("serviceWorker" in navigator) {
      const v = Date.now();
      navigator.serviceWorker.register("./sw.js?v=" + v)
        .then(()=>{ swMsg.textContent = "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ ÙƒÙ€ PWA (SW Ø´ØºØ§Ù„)."; })
        .catch(()=>{ swMsg.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Service Worker (Ù…Ø´ Ù…Ø´ÙƒÙ„Ø© ÙƒØ¨ÙŠØ±Ø©)."; });
    }
  </script>
</body>
</html>
