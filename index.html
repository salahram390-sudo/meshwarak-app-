<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ</title>

  <!-- âœ… Favicon -->
  <link rel="icon" href="./favicon.png">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050B16">

  <!-- UI -->
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card" style="width:min(520px, 100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:54px;height:54px;border-radius:18px;font-size:22px">Ù…</div>
      </div>

      <h1 style="margin:0;font-size:20px">ğŸš– Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
      <p class="hint" style="margin:8px 0 14px">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
      <div class="actions" style="justify-content:center">
        <a class="btn success" href="./login.html?role=passenger" style="min-width:220px;text-align:center">ğŸš• Ø±Ø§ÙƒØ¨</a>
        <a class="btn primary" href="./login.html?role=driver" style="min-width:220px;text-align:center">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</a>
      </div>

      <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
      <div id="meBox" class="card" style="margin-top:14px; display:none; text-align:right">
        <div class="hint" id="meText" style="margin-top:0"></div>

        <div class="actions" style="margin-top:12px;flex-wrap:wrap">
          <a class="btn primary" id="goBtn" href="#" style="text-align:center;min-width:180px">ÙØªØ­</a>
          <button class="btn danger" id="logoutBtn" type="button" style="min-width:180px">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ -->
      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="hardRefreshBtn" type="button" style="min-width:220px">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ (Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„)</button>
      </div>

      <p class="hint" style="margin:14px 0 0">
        Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø§ Ø§ØªØ­Ø¯Ø«ØªØ´ ÙÙˆØ±Ù‹Ø§ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ¹Ù…Ù„ Refresh.
      </p>

      <p class="hint" id="swMsg" style="margin:10px 0 0"></p>
      <p class="hint" id="errMsg" style="margin:8px 0 0"></p>
    </div>
  </div>

  <!-- Debug errors -->
  <script>
    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{
        errMsg.textContent = "âš ï¸ Ø®Ø·Ø£: " + (e.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
      }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{
        errMsg.textContent = "âš ï¸ Promise Error: " + (e.reason?.message || e.reason || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
      }catch{}
    });
  </script>

  <!-- Firebase + Auto redirect -->
  <script type="module">
    import { auth, db } from "./app.js";

    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const meBox = document.getElementById("meBox");
    const meText = document.getElementById("meText");
    const goBtn = document.getElementById("goBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function fallbackNameFromEmail(email){
      const x = (email || "").split("@")[0] || "Ù…Ø³ØªØ®Ø¯Ù…";
      return x.replace(/[._-]+/g, " ").trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
    }

    async function getUserDocX(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    logoutBtn.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
      }catch{}
      location.href = "./index.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        meBox.style.display = "none";
        return;
      }

      const data = await getUserDocX(user.uid).catch(()=>null);

      const role = data?.role || null;
      const name = (data?.name || "").trim() || fallbackNameFromEmail(user.email);

      if(role !== "passenger" && role !== "driver"){
        meBox.style.display = "block";
        meText.innerHTML = `ğŸ‘¤ <b>${name}</b><br>âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Role. Ø§ÙØªØ­ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.`;
        goBtn.textContent = "ÙØªØ­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        goBtn.href = "./login.html";
        return;
      }

      const roleText = (role === "passenger") ? "Ø±Ø§ÙƒØ¨" : "Ø³Ø§Ø¦Ù‚";
      const target = (role === "passenger") ? "./passenger.html" : "./driver.html";

      meBox.style.display = "block";
      meText.innerHTML =
        `ğŸ‘¤ <b>${name}</b> â€¢ ${roleText}<br>` +
        `ğŸ“§ ${user.email}<br>` +
        `ğŸ“ ${(data?.governorate || "-")} / ${(data?.center || "-")}`;

      goBtn.textContent = (role === "passenger") ? "ÙØªØ­ Ø§Ù„Ø±Ø§ÙƒØ¨" : "ÙØªØ­ Ø§Ù„Ø³Ø§Ø¦Ù‚";
      goBtn.href = target;
    });
  </script>

  <!-- Service Worker (force update) -->
  <script>
    const swMsg = document.getElementById("swMsg");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");

    async function hardRefresh(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      location.reload(true);
    }

    hardRefreshBtn.addEventListener("click", hardRefresh);

    if ("serviceWorker" in navigator) {
      // âœ… ÙƒØ§Ø´-Ø¨Ø§Ø³ØªØ± Ù„Ù…Ù„Ù sw.js
      const v = Date.now();
      navigator.serviceWorker.register("./sw.js?v=" + v)
        .then(()=>{
          swMsg.textContent = "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ ÙƒÙ€ PWA (SW Ø´ØºØ§Ù„).";
        })
        .catch(()=>{
          swMsg.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Service Worker (Ù…Ø´ Ù…Ø´ÙƒÙ„Ø© ÙƒØ¨ÙŠØ±Ø©).";
        });
    }
  </script>
</body>
</html>
