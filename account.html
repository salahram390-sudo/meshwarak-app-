<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>ูุดูุงุฑู - ุญุณุงุจู</title>
  <link rel="stylesheet" href="./styles.css?v=10">
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" style="width:42px;height:42px;border-radius:14px">ู</div>
        <div>
          <h1>ุญุณุงุจู</h1>
          <p id="sub" class="muted">...</p>
        </div>
      </div>
      <a class="btn" href="./index.html?v=10">ุงูุฑุฆูุณูุฉ</a>
    </div>
  </div>

  <div class="container" style="padding-top:14px">
    <div class="card" style="max-width:720px;margin:0 auto">

      <div class="hint" id="status" style="min-height:22px">ุฌุงุฑู ุชุญููู ุงูุญุณุงุจโฆ</div>

      <div class="sep"></div>

      <div class="field">
        <label>ุงูุฅูููู</label>
        <input id="email" disabled />
      </div>

      <div class="field">
        <label>ุงูุฏูุฑ ุงูุญุงูู</label>
        <input id="role" disabled />
      </div>

      <div class="sep"></div>

      <div class="hint" style="margin-bottom:10px">ุชุจุฏูู ุงูุฏูุฑ (ุจุฏูู ูุง ูุฎุฑุจ ุฃู ุญุงุฌุฉ)</div>

      <div class="pillRow">
        <button type="button" class="pillBtn" id="goPassenger">ุฑุงูุจ ๐</button>
        <button type="button" class="pillBtn" id="goDriver">ุณุงุฆู ๐งโโ๏ธ</button>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <a class="btn success" id="openRolePage" href="./index.html?v=10">ูุชุญ ุตูุญุฉ ุงูุฏูุฑ</a>
        <button class="btn danger" id="logoutBtn" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>

      <div class="sep"></div>

      <button class="btn primary" id="hardRefreshBtn" type="button">โฉ ุชุญุฏูุซ ููู (ุญู ุงููุดุงูู)</button>
      <div class="hint" id="swHint" style="margin-top:10px"></div>

    </div>
  </div>

  <script type="module">
    import {
      requireAuthAndRole,
      doLogout,
      setActiveRole,
      getActiveRole
    } from "./app.js?v=10";

    const status = document.getElementById("status");
    const sub = document.getElementById("sub");
    const email = document.getElementById("email");
    const role = document.getElementById("role");

    const goPassenger = document.getElementById("goPassenger");
    const goDriver = document.getElementById("goDriver");
    const openRolePage = document.getElementById("openRolePage");

    const logoutBtn = document.getElementById("logoutBtn");
    const hardRefreshBtn = document.getElementById("hardRefreshBtn");
    const swHint = document.getElementById("swHint");

    function setRoleUI(r){
      goPassenger.classList.toggle("active", r === "passenger");
      goDriver.classList.toggle("active", r === "driver");
      role.value = (r === "driver") ? "ุณุงุฆู" : "ุฑุงูุจ";
      openRolePage.href = (r === "driver") ? "./driver.html?v=10" : "./passenger.html?v=10";
    }

    async function nukeSW(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for(const r of regs) await r.unregister();
        }
        if("caches" in window){
          const keys = await caches.keys();
          for(const k of keys) await caches.delete(k);
        }
        swHint.textContent = "โ ุชู ูุณุญ ุงููุงุด ู Service Worker.";
      }catch(e){
        swHint.textContent = "โ๏ธ ุชุนุฐุฑ ุงููุณุญ (ูุด ูุดููุฉ ูุจูุฑุฉ).";
      }
    }

    hardRefreshBtn.addEventListener("click", async ()=>{
      swHint.textContent = "ุฌุงุฑู ุงูุชูุธููโฆ";
      await nukeSW();
      location.href = "./account.html?v=" + Date.now();
    });

    logoutBtn.addEventListener("click", async ()=>{
      status.textContent = "ุฌุงุฑู ุชุณุฌูู ุงูุฎุฑูุฌโฆ";
      await doLogout();
    });

    goPassenger.addEventListener("click", ()=>{
      const r = setActiveRole("passenger");
      setRoleUI(r);
      status.textContent = "โ ุชู ุงูุชุจุฏูู ุฅูู ุฑุงูุจ.";
    });

    goDriver.addEventListener("click", ()=>{
      const r = setActiveRole("driver");
      setRoleUI(r);
      status.textContent = "โ ุชู ุงูุชุจุฏูู ุฅูู ุณุงุฆู.";
    });

    (async ()=>{
      try{
        const { user, data } = await requireAuthAndRole(null);
        email.value = user?.email || "";
        sub.textContent = user?.email || "";
        const r = (data?.role) || getActiveRole();
        setRoleUI(r);
        status.textContent = "โ ุงูุญุณุงุจ ุฌุงูุฒ.";
      }catch(e){
        // requireAuthAndRole ูููุฌูู ููู login ูู ูุด ูุณุฌู
        console.error(e);
      }
    })();
  </script>
</body>
</html>
```๎จ0๎จ
