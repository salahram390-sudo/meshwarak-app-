<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <meta name="theme-color" content="#050B16">
  <link rel="manifest" href="./manifest.json">

  <!-- âœ… Ù…Ù†Ø¹ ÙÙ„Ø§Ø´/ØµÙØ­Ø© Ø¨ÙŠØ¶Ø§ Ù„Ùˆ CSS Ø§ØªØ£Ø®Ø± -->
  <style>
    html,body{margin:0;background:#050B16;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a,button{font-family:inherit}
  </style>

  <link rel="stylesheet" href="./styles.css?v=fix-1" />
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card" style="width:min(520px,100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:64px;height:64px;border-radius:22px;font-size:26px">Ù…</div>
      </div>

      <h1 style="margin:0;font-size:22px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h1>
      <p class="hint" style="margin:10px 0 12px">Ø§Ø®ØªØ± ØªØ¯Ø®Ù„ Ùƒ Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚ â€” Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ø§ØªÙ†ÙŠÙ† âœ…</p>

      <!-- Role segmented -->
      <div class="seg" style="display:flex;gap:10px;justify-content:center;margin:10px 0 12px">
        <button class="btn" id="rolePassenger" type="button" style="min-width:170px">ğŸš• Ø±Ø§ÙƒØ¨</button>
        <button class="btn" id="roleDriver" type="button" style="min-width:170px">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</button>
      </div>

      <div class="field" style="text-align:right">
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="email" placeholder="example@gmail.com" inputmode="email" autocomplete="email" />
      </div>

      <div class="field" style="text-align:right">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
        <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div>

      <div class="actions" style="flex-direction:column;gap:12px">
        <button class="btn primary" id="signUpBtn" type="button" style="width:100%">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button class="btn success" id="signInBtn" type="button" style="width:100%">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      </div>

      <div class="actions" style="justify-content:center;margin-top:12px">
        <a class="btn" href="./index.html" style="min-width:220px">â†©ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>

      <p class="hint" id="msg" style="margin:12px 0 0"></p>
      <p class="hint" id="err" style="margin:8px 0 0;color:#ffb4b4"></p>
    </div>
  </div>

  <script type="module">
    import {
      auth,
      setActiveRole,
      getActiveRole,
      ensureUserDoc,
      emailSignIn,
      emailSignUp
    } from "./app.js?v=fix-1";

    const msg = document.getElementById("msg");
    const err = document.getElementById("err");

    const rolePassenger = document.getElementById("rolePassenger");
    const roleDriver = document.getElementById("roleDriver");

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("pass");

    const signUpBtn = document.getElementById("signUpBtn");
    const signInBtn = document.getElementById("signInBtn");

    function setRoleUI(role){
      // Ø¨Ø³ÙŠØ·: Ø²Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ¨Ù‚Ù‰ primary
      if(role === "driver"){
        roleDriver.classList.add("primary");
        rolePassenger.classList.remove("primary");
      }else{
        rolePassenger.classList.add("primary");
        roleDriver.classList.remove("primary");
      }
    }

    // role Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ù† localStorage
    const roleFromUrl = new URL(location.href).searchParams.get("role");
    const role = setActiveRole(roleFromUrl || getActiveRole());
    setRoleUI(role);

    rolePassenger.addEventListener("click", ()=>{
      setActiveRole("passenger");
      setRoleUI("passenger");
    });

    roleDriver.addEventListener("click", ()=>{
      setActiveRole("driver");
      setRoleUI("driver");
    });

    function goAfterLogin(){
      const r = getActiveRole();
      location.href = (r === "driver") ? "./driver.html" : "./passenger.html";
    }

    async function commonAfterAuth(user){
      // Ø¶Ù…Ø§Ù† user doc
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: getActiveRole(),
        email: user.email || null,
      }).catch(()=>{});
    }

    signUpBtn.addEventListener("click", async ()=>{
      err.textContent = "";
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦";
      signUpBtn.disabled = true;
      signInBtn.disabled = true;

      try{
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if(!email || !pass) throw new Error("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
        if(pass.length < 6) throw new Error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

        const cred = await emailSignUp(email, pass);
        await commonAfterAuth(cred.user);
        msg.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.";
        goAfterLogin();
      }catch(e){
        console.error(e);
        err.textContent = "âŒ " + (e?.message || "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.");
        msg.textContent = "";
      }finally{
        signUpBtn.disabled = false;
        signInBtn.disabled = false;
      }
    });

    signInBtn.addEventListener("click", async ()=>{
      err.textContent = "";
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦";
      signUpBtn.disabled = true;
      signInBtn.disabled = true;

      try{
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if(!email || !pass) throw new Error("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");

        const cred = await emailSignIn(email, pass);
        await commonAfterAuth(cred.user);
        msg.textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        goAfterLogin();
      }catch(e){
        console.error(e);
        err.textContent = "âŒ " + (e?.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
        msg.textContent = "";
      }finally{
        signUpBtn.disabled = false;
        signInBtn.disabled = false;
      }
    });

    // âœ… Ù„Ùˆ Ø±Ø¬Ø¹Øª Ù„Ù„ØµÙØ­Ø© Ù…Ù† Back (bfCache) Ø®Ù„ÙŠÙ‡ ÙŠØ¹ÙŠØ¯ Ø±Ø³Ù… Ø§Ù„Ø³ØªØ§ÙŠÙ„
    window.addEventListener("pageshow", (ev)=>{
      if(ev.persisted){
        document.documentElement.style.background = "#050B16";
        document.body.style.background = "#050B16";
      }
    });
  </script>
</body>
</html>
