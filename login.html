<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>ูุดูุงุฑู - ุชุณุฌูู ุงูุฏุฎูู</title>
  <link rel="stylesheet" href="./styles.css?v=9">
</head>

<body>
  <div class="container auth" style="padding-top:18px">
    <div class="card auth-card">
      <div class="auth-logo">
        <div class="logoBig">ู</div>
        <h1>ุชุณุฌูู ุงูุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ</h1>
        <p class="hint">ุงุฎุชุฑ ุชุฏุฎู ู ุฑุงูุจ ุฃู ุณุงุฆู โ ููุณ ุงูุฅูููู ูุดุชุบู ูู ุงูุงุชููู โ</p>
      </div>

      <div class="pillRow">
        <button type="button" class="pillBtn" id="rolePassenger">ุฑุงูุจ ๐</button>
        <button type="button" class="pillBtn" id="roleDriver">ุณุงุฆู ๐งโโ๏ธ</button>
      </div>

      <div class="hint" id="roleHint" style="text-align:center;margin-top:8px"></div>

      <div class="field">
        <label>ุงูุฅูููู</label>
        <input id="email" placeholder="example@gmail.com" inputmode="email" autocomplete="email" />
      </div>

      <div class="field">
        <label>ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)</label>
        <input id="password" type="password" placeholder="โขโขโขโขโขโขโขโข" autocomplete="current-password" />
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <button class="btn primary" id="loginBtn" type="button">ุชุณุฌูู ุฏุฎูู</button>
        <button class="btn" id="signupBtn" type="button">ุฅูุดุงุก ุญุณุงุจ</button>
      </div>

      <div id="driverFields" style="display:none;margin-top:10px">
        <div class="sep"></div>

        <div class="hint" style="margin-bottom:10px">
          ุจูุงูุงุช ุงูุณุงุฆู ุชุธูุฑ ููุง (ูุชุชุญูุธ ูู ููู ุญุณุงุจู ุจุนุฏ ุงูุฏุฎูู)
        </div>

        <div class="grid2">
          <div class="field" style="margin-top:0">
            <label>ููุน ุงููุฑูุจุฉ</label>
            <select id="vehicle">
              <option value="tuktuk">ุชููุชูู</option>
              <option value="motor_delivery">ููุชุณููู ุฏูููุฑู</option>
              <option value="car">ุณูุงุฑุฉ ููุงูู</option>
              <option value="microbus">ูููุฑูุจุงุต</option>
              <option value="tamanya">ุชููุงูุฉ</option>
              <option value="caboot">ุนุฑุจูุฉ ูุงุจูุช</option>
            </select>
          </div>
          <div class="field" style="margin-top:0">
            <label>ููุฏูู / ุณูุฉ ุงูุตูุน</label>
            <input id="model" placeholder="ูุซุงู: 2020" />
          </div>
        </div>

        <div class="field">
          <label>ุฑูู ุงูููุญุฉ / ููุฏ</label>
          <input id="plate" placeholder="ูุซุงู: ุจ ุณ 1234" />
        </div>
      </div>

      <div class="sep"></div>

      <a class="btn" href="./index.html">โฉ ุฑุฌูุน ููุฑุฆูุณูุฉ</a>

      <div class="hint" id="msg" style="margin-top:10px;min-height:22px"></div>
    </div>
  </div>

  <script type="module">
    import {
      setActiveRole, getActiveRole,
      ensureUserDoc, saveUserProfile,
      emailSignIn, emailSignUp
    } from "./app.js?v=9";

    const msg = document.getElementById("msg");

    const rolePassengerBtn = document.getElementById("rolePassenger");
    const roleDriverBtn = document.getElementById("roleDriver");
    const roleHint = document.getElementById("roleHint");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    const driverFields = document.getElementById("driverFields");
    const vehicleEl = document.getElementById("vehicle");
    const modelEl = document.getElementById("model");
    const plateEl = document.getElementById("plate");

    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");

    function setRoleUI(role){
      const r = setActiveRole(role);
      rolePassengerBtn.classList.toggle("active", r === "passenger");
      roleDriverBtn.classList.toggle("active", r === "driver");
      driverFields.style.display = (r === "driver") ? "block" : "none";
      roleHint.textContent = (r === "driver")
        ? "โ ูุถุน ุงูุณุงุฆู ููุนู"
        : "โ ูุถุน ุงูุฑุงูุจ ููุนู";
    }

    // init
    setRoleUI(getActiveRole());

    rolePassengerBtn.addEventListener("click", ()=> setRoleUI("passenger"));
    roleDriverBtn.addEventListener("click", ()=> setRoleUI("driver"));

    function normEmail(x){ return (x||"").trim().toLowerCase(); }

    function showFirebaseError(e, mode){
      const code = e?.code || "";
      if(mode === "signin"){
        if(code.includes("user-not-found")) return "โ ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ. ุฌุฑูุจ (ุฅูุดุงุก ุญุณุงุจ).";
        if(code.includes("wrong-password")) return "โ ูููุฉ ุงููุฑูุฑ ุบูุท.";
        if(code.includes("invalid-email")) return "โ ุงูุฅูููู ุบูุฑ ุตุญูุญ.";
        if(code.includes("too-many-requests")) return "โ๏ธ ูุญุงููุงุช ูุซูุฑุฉ. ุฌุฑูุจ ุจุนุฏ ุดููุฉ.";
        return "โ ูุดู ุชุณุฌูู ุงูุฏุฎูู: " + code;
      }else{
        if(code.includes("email-already-in-use")) return "โ ุงูุฅูููู ูุณุชุฎุฏู ุจุงููุนู. ุฌุฑูุจ (ุชุณุฌูู ุฏุฎูู).";
        if(code.includes("weak-password")) return "โ ูููุฉ ุงููุฑูุฑ ุถุนููุฉ. ูุงุฒู 6 ุฃุญุฑู ุฃู ุฃูุซุฑ.";
        if(code.includes("invalid-email")) return "โ ุงูุฅูููู ุบูุฑ ุตุญูุญ.";
        return "โ ูุดู ุฅูุดุงุก ุงูุญุณุงุจ: " + code;
      }
    }

    async function afterAuth(user){
      const role = getActiveRole();

      // ุฅูุดุงุก/ุชุญุฏูุซ user doc + ุญูุธ ุงูุฏูุฑ
      await ensureUserDoc(user.uid, { activeRole: role });

      // ูู ุณุงุฆู: ุฎุฒูู ุจูุงูุงุช ุงููุฑูุจุฉ (ุงุฎุชูุงุฑู)
      if(role === "driver"){
        await saveUserProfile(user.uid, {
          vehicle: vehicleEl.value || null,
          model: modelEl.value.trim() || null,
          plate: plateEl.value.trim() || null,
        }).catch(()=>{});
      }

      // ุชูุฌูู ุญุณุจ ุงูุฏูุฑ
      location.href = (role === "driver") ? "./driver.html" : "./passenger.html";
    }

    async function lockUI(locked){
      loginBtn.disabled = locked;
      signupBtn.disabled = locked;
      rolePassengerBtn.disabled = locked;
      roleDriverBtn.disabled = locked;
    }

    loginBtn.addEventListener("click", async ()=>{
      msg.textContent = "ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎููโฆ";
      await lockUI(true);
      try{
        const email = normEmail(emailEl.value);
        const password = passEl.value || "";
        const cred = await emailSignIn(email, password);
        await afterAuth(cred.user);
      }catch(e){
        console.error(e);
        msg.textContent = showFirebaseError(e, "signin");
      }finally{
        await lockUI(false);
      }
    });

    signupBtn.addEventListener("click", async ()=>{
      msg.textContent = "ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจโฆ";
      await lockUI(true);
      try{
        const email = normEmail(emailEl.value);
        const password = passEl.value || "";
        const cred = await emailSignUp(email, password);
        await afterAuth(cred.user);
      }catch(e){
        console.error(e);
        msg.textContent = showFirebaseError(e, "signup");
      }finally{
        await lockUI(false);
      }
    });
  </script>
</body>
</html>
