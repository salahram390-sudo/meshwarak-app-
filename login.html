<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูุดูุงุฑู - ุชุณุฌูู ุงูุฏุฎูู</title>
  <link rel="stylesheet" href="./styles.css">
</head>

<body>

  <!-- Toast -->
  <div id="toast"></div>

  <div class="container" style="padding-top:18px;padding-bottom:30px">

    <!-- Card -->
    <div class="card" style="max-width:520px;margin:0 auto;padding:18px 18px 20px">

      <!-- Header -->
      <div class="center" style="margin-top:6px">
        <div style="display:grid;place-items:center;margin-bottom:10px">
          <div class="logo" style="width:72px;height:72px;border-radius:24px;font-size:26px">ู</div>
        </div>

        <div class="page-title" style="margin-top:0">
          <h2>ุชุณุฌูู ุงูุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ</h2>
          <p>ุงุฎุชุฑ ุชุฏุฎู ู ุฑุงูุจ ุฃู ุณุงุฆู โ ููุณ ุงูุฅูููู ูุดุชุบู ูู ุงูุงุซููู</p>

          <div class="hint" style="margin-top:10px;display:inline-flex;align-items:center;gap:10px;
               padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
               background:rgba(255,255,255,.04)">
            <span style="font-size:18px">โ</span>
            <span>ููุณ ุงูุฅูููู ูุดุชุบู ูู ุงูุงุซููู</span>
          </div>
        </div>
      </div>

      <!-- Role Switch -->
      <div class="roleSwitch" style="margin-top:16px">
        <button class="roleBtn active" id="rolePassenger" type="button">
          <span class="ico">๐</span>
          <span>ุฑุงูุจ</span>
        </button>
        <button class="roleBtn" id="roleDriver" type="button">
          <span class="ico">๐งโโ๏ธ</span>
          <span>ุณุงุฆู</span>
        </button>
      </div>

      <!-- FORM -->
      <div style="margin-top:14px">

        <div class="field">
          <label>ุงูุฅูููู</label>
          <input id="email" placeholder="example@gmail.com" inputmode="email" autocomplete="email">
        </div>

        <div class="field">
          <label>ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)</label>
          <input id="password" type="password" placeholder="โขโขโขโขโขโขโขโข" autocomplete="current-password">
        </div>

        <!-- Buttons -->
        <div class="actions">
          <!-- ุชุณุฌูู ุฏุฎูู (ุฃุฒุฑู) -->
          <button class="btn blue full" id="loginBtn" type="button">ุชุณุฌูู ุฏุฎูู</button>

          <!-- ุฅูุดุงุก ุญุณุงุจ (ุจููุณุฌู) -->
          <button class="btn primary full" id="registerBtn" type="button">ุฅูุดุงุก ุญุณุงุจ</button>
        </div>

        <div class="hr"></div>

        <!-- Optional profile fields for first time -->
        <div class="field">
          <label>ุงูุงุณู (ุงุฎุชูุงุฑู)</label>
          <input id="name" placeholder="ุงุณูู" autocomplete="name">
        </div>

        <div class="field">
          <label>ุฅูู (ุฑูู ูุชุฌูุจ ุงูุทูุจุงุช ุงูููููุฉ)</label>
          <input id="phone" placeholder="01xxxxxxxxx" inputmode="tel" autocomplete="tel">
        </div>

        <div class="hint mt10" id="msg"></div>

        <div class="center mt14">
          <a class="btn" href="./index.html">ุงูุฑุฆูุณูุฉ</a>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    import {
      auth,
      db,
      go,
      setRoleLocal,
      saveUserProfile,
      toast,
      requireNoAuth
    } from "./app.js";

    import {
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ูู ุงููุณุชุฎุฏู ุจุงููุนู ุฏุงุฎู
    await requireNoAuth().catch(()=>{});

    const rolePassenger = document.getElementById("rolePassenger");
    const roleDriver = document.getElementById("roleDriver");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");

    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const msg = document.getElementById("msg");

    let role = localStorage.getItem("meshwarak_role") || "passenger";

    function setRoleUI(r){
      role = r;
      localStorage.setItem("meshwarak_role", role);

      rolePassenger.classList.toggle("active", role === "passenger");
      roleDriver.classList.toggle("active", role === "driver");
    }

    rolePassenger.onclick = ()=> setRoleUI("passenger");
    roleDriver.onclick = ()=> setRoleUI("driver");

    setRoleUI(role);

    function normalizePhone(p){
      const x = (p || "").trim();
      if(!x) return null;
      const cleaned = x.replace(/[^\d+]/g, "");
      return cleaned.length >= 8 ? cleaned : null;
    }

    function getCred(){
      const email = (emailEl.value || "").trim();
      const password = (passEl.value || "").trim();
      return { email, password };
    }

    function setBusy(b){
      loginBtn.disabled = b;
      registerBtn.disabled = b;
      loginBtn.style.opacity = b ? .75 : 1;
      registerBtn.style.opacity = b ? .75 : 1;
    }

    async function afterAuth(user){
      // ุญูุธ role ูุญูู
      setRoleLocal(role);

      // ุญูุธ ุจูุงูุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)
      const payload = {
        role,
        name: nameEl.value.trim() || null,
        phone: normalizePhone(phoneEl.value),
      };

      await saveUserProfile(user.uid, payload);

      // ุชูุฌูู ุญุณุจ ุงูุฏูุฑ
      if(role === "driver") go("./driver.html");
      else go("./passenger.html");
    }

    loginBtn.onclick = async ()=>{
      msg.textContent = "";
      const { email, password } = getCred();

      if(!email || !password){
        msg.textContent = "โ ุงูุชุจ ุงูุฅูููู ููููุฉ ุงููุฑูุฑ.";
        return;
      }

      setBusy(true);
      msg.textContent = "ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎููโฆ";

      try{
        const res = await signInWithEmailAndPassword(auth, email, password);
        toast("โ ุชู ุชุณุฌูู ุงูุฏุฎูู");
        await afterAuth(res.user);
      }catch(e){
        console.error(e);
        msg.textContent = "โ ูุดู ุชุณุฌูู ุงูุฏุฎูู. ุชุฃูุฏ ูู ุงูุจูุงูุงุช.";
      }finally{
        setBusy(false);
      }
    };

    registerBtn.onclick = async ()=>{
      msg.textContent = "";
      const { email, password } = getCred();

      if(!email || !password){
        msg.textContent = "โ ุงูุชุจ ุงูุฅูููู ููููุฉ ุงููุฑูุฑ.";
        return;
      }
      if(password.length < 6){
        msg.textContent = "โ ูููุฉ ุงููุฑูุฑ ูุงุฒู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู.";
        return;
      }

      setBusy(true);
      msg.textContent = "ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจโฆ";

      try{
        const res = await createUserWithEmailAndPassword(auth, email, password);
        toast("โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ");
        await afterAuth(res.user);
      }catch(e){
        console.error(e);

        // ุฑุณุงุฆู ุฃูุถุญ
        const code = e?.code || "";
        if(code.includes("email-already-in-use")){
          msg.textContent = "โ ุงูุฅูููู ูุณุชุฎุฏู ุจุงููุนู. ุงุถุบุท (ุชุณุฌูู ุฏุฎูู).";
        }else if(code.includes("invalid-email")){
          msg.textContent = "โ ุงูุฅูููู ุบูุฑ ุตุญูุญ.";
        }else{
          msg.textContent = "โ ูุดู ุฅูุดุงุก ุงูุญุณุงุจ.";
        }
      }finally{
        setBusy(false);
      }
    };
  </script>

</body>
</html>
