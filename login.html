<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <link rel="icon" href="./favicon.png">
  <meta name="theme-color" content="#050B16" />

  <style>
    :root{
      --bg:#050A14;
      --card: rgba(12,18,32,.62);
      --stroke: rgba(255,255,255,.10);
      --txt:#EAF0FF;
      --muted: rgba(234,240,255,.72);
      --primary:#2B6CFF;
      --primary2:#5C8CFF;
      --violet:#7C3AED;
      --success:#22C55E;
      --danger:#FF5C7A;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --r: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 80% 20%, rgba(43,108,255,.18), transparent 55%),
        radial-gradient(700px 520px at 20% 0%, rgba(124,58,237,.16), transparent 55%),
        radial-gradient(1000px 700px at 30% 90%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    /* subtle stars */
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.18) 50%, transparent 52%),
        radial-gradient(1px 1px at 35% 70%, rgba(255,255,255,.14) 50%, transparent 52%),
        radial-gradient(1px 1px at 60% 35%, rgba(255,255,255,.12) 50%, transparent 52%),
        radial-gradient(1px 1px at 80% 75%, rgba(255,255,255,.10) 50%, transparent 52%),
        radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,.10) 50%, transparent 52%),
        radial-gradient(1px 1px at 55% 85%, rgba(255,255,255,.08) 50%, transparent 52%);
      opacity:.9;
      pointer-events:none;
    }

    .wrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px 14px 28px;
    }

    .card{
      width:min(560px, 100%);
      background: linear-gradient(180deg, rgba(12,18,32,.72), rgba(10,18,34,.52));
      border:1px solid var(--stroke);
      border-radius: 26px;
      padding:18px 16px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 220px at 70% 0%, rgba(43,108,255,.16), transparent 60%),
        radial-gradient(520px 220px at 20% 20%, rgba(124,58,237,.14), transparent 62%);
      pointer-events:none;
      filter: blur(.2px);
    }
    .card > *{ position:relative; }

    .logoWrap{display:flex;justify-content:center;margin-bottom:10px}
    .logo{
      width:64px;height:64px;border-radius:20px;
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(34,197,94,.55));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.42);
      display:grid;place-items:center;
      font-weight:900;
      font-size:26px;
    }

    h1{margin:6px 0 6px;font-size:22px;letter-spacing:.2px;text-align:center}
    .sub{
      margin:0 0 12px;
      text-align:center;
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
    }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.82);
      font-size:12px;
      margin:0 auto 12px;
    }
    .chipWrap{display:flex;justify-content:center}

    /* segmented role */
    .seg{
      display:flex;
      width:min(440px, 100%);
      margin: 8px auto 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .seg button{
      flex:1;
      appearance:none;
      border:0;
      background: transparent;
      color: rgba(234,240,255,.78);
      padding:12px 10px;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      -webkit-tap-highlight-color: transparent;
      transition: .18s ease;
    }
    .seg button svg{width:20px;height:20px;opacity:.85}
    .seg button.active{
      color: var(--txt);
      background: linear-gradient(135deg, rgba(43,108,255,.32), rgba(124,58,237,.22));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    }
    .seg button.active svg{opacity:1}
    .seg button:not(.active):active{filter:brightness(1.08)}

    .field{width:min(460px, 100%); margin: 0 auto; text-align:right; margin-top:12px}
    label{display:block;margin:0 0 8px;color:rgba(234,240,255,.78);font-size:12px}
    input, select{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(234,240,255,.42)}

    .row2{
      width:min(460px,100%);
      margin:14px auto 0;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 18px;
      padding:14px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:active{transform: translateY(1px); filter: brightness(1.06)}
    .btn:disabled{opacity:.55;cursor:not-allowed; transform:none; filter:none;}

    .btn.primary{
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(43,108,255,.70));
      border-color: rgba(43,108,255,.38);
      box-shadow: 0 14px 34px rgba(43,108,255,.18);
    }

    .btn.alt{
      background: linear-gradient(135deg, rgba(124,58,237,.88), rgba(124,58,237,.58));
      border-color: rgba(124,58,237,.36);
      box-shadow: 0 14px 34px rgba(124,58,237,.16);
    }

    .divider{
      width:min(460px, 100%);
      margin:14px auto 0;
      height:1px;
      background: rgba(255,255,255,.10);
    }

    .hint{width:min(460px,100%); margin:12px auto 0; color:var(--muted); font-size:13px; line-height:1.7}
    .msgOk{color:#bfffe0}
    .msgBad{color:#ffd0d8}

    /* Driver box */
    #driverBox{
      width:min(460px,100%);
      margin: 12px auto 0;
      padding: 12px 12px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:none;
    }
    #driverBox .row2b{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){ #driverBox .row2b{grid-template-columns:1fr} }

    .backWrap{display:flex;justify-content:center;margin-top:12px}
    .backLink{
      width:min(460px,100%);
      display:inline-flex;
      justify-content:center;
      text-decoration:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="logoWrap">
        <div class="logo">Ù…</div>
      </div>

      <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h1>
      <p class="sub">Ø§Ø®ØªØ± ØªØ¯Ø®Ù„ ÙƒÙ€ Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚ â€” Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ø§Ø«Ù†ÙŠÙ† âœ…</p>

      <div class="chipWrap">
        <div class="chip">âœ… <span>Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</span></div>
      </div>

      <div class="seg" role="tablist" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±">
        <button id="rolePassenger" type="button">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 16h10l1.5 3H5.5L7 16Z" stroke="currentColor" stroke-width="1.6" opacity=".9"/>
            <path d="M7.5 16 9 9.5h6L16.5 16" stroke="currentColor" stroke-width="1.6"/>
            <path d="M9 9.5c0-1.2.9-2.2 2-2.2h2c1.1 0 2 1 2 2.2" stroke="currentColor" stroke-width="1.6"/>
            <circle cx="8" cy="19" r="1" fill="currentColor"/>
            <circle cx="16" cy="19" r="1" fill="currentColor"/>
          </svg>
          Ø±Ø§ÙƒØ¨
        </button>

        <button id="roleDriver" type="button">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4Z" stroke="currentColor" stroke-width="1.6"/>
            <path d="M4.8 20c.7-3.1 3.6-5.4 7.2-5.4S18.5 16.9 19.2 20" stroke="currentColor" stroke-width="1.6" opacity=".9"/>
          </svg>
          Ø³Ø§Ø¦Ù‚
        </button>
      </div>

      <div class="field">
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="email" type="ASSERT_CODE_INJECTION placeholder="example@gmail.com" autocomplete="email" />
      </div>

      <div class="field">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span style="opacity:.75">(6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</span></label>
        <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div>

      <!-- âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø§Ù„Ø§ØªÙ†ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†) -->
      <div class="row2">
        <button class="btn alt" id="signupBtn" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button class="btn primary" id="loginBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Ø§Ù„Ø§Ø³Ù… <span style="opacity:.75">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
        <input id="name" type="text" placeholder="Ø§Ø³Ù…Ùƒ" autocomplete="name" />
      </div>

      <div class="field">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span style="opacity:.75">(Ù…Ù‡Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©)</span></label>
        <input id="phone" type="tel" placeholder="01xxxxxxxxx" autocomplete="tel" />
      </div>

      <!-- Driver extra fields -->
      <div id="driverBox">
        <div class="hint" style="margin:0 0 10px">ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ø§Ø²Ù… Ø¹Ù„Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)</div>

        <div class="field" style="margin-top:0">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ù„Ù„Ø³Ø§Ø¦Ù‚)</label>
          <select id="vehicle">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©â€¦</option>
            <option value="tuktuk">ØªÙˆÙƒØªÙˆÙƒ</option>
            <option value="motor_delivery">Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
            <option value="car">Ù…Ù„Ø§ÙƒÙŠ</option>
            <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
            <option value="tamanya">ØªÙ…Ù†Ø§ÙŠØ©</option>
            <option value="caboot">Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</option>
          </select>
        </div>

        <div class="row2b" style="margin-top:10px">
          <div class="field" style="margin-top:0">
            <label>Ù…ÙˆØ¯ÙŠÙ„/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
            <input id="model" type="text" placeholder="Ù…Ø«Ø§Ù„: 2020 / BYD / Ø¥Ù„Ø®" />
          </div>
          <div class="field" style="margin-top:0">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© <span style="opacity:.75">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
            <input id="plate" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¬ 1234" />
          </div>
        </div>

        <p class="hint" style="margin:10px 0 0">* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ØªØ¸Ù‡Ø± Ù„Ù„Ø±Ø§ÙƒØ¨ Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©.</p>
      </div>

      <p id="msg" class="hint" style="margin-top:12px"></p>

      <div class="backWrap">
        <a class="btn backLink" href="./index.html">â†©ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>

    </div>
  </div>

  <script type="module">
    import {
      emailSignUp, emailSignIn,
      ensureUserDoc, saveUserProfile,
      setActiveRole
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");

    const rolePassengerBtn = $("rolePassenger");
    const roleDriverBtn = $("roleDriver");
    const driverBox = $("driverBox");

    const emailEl = $("email");
    const passEl = $("pass");
    const nameEl = $("name");
    const phoneEl = $("phone");

    const vehicleEl = $("vehicle");
    const modelEl = $("model");
    const plateEl = $("plate");

    const signupBtn = $("signupBtn");
    const loginBtn = $("loginBtn");
    const msg = $("msg");

    const url = new URL(location.href);
    const LS_ROLE = "mw_last_role";
    let role =
      (url.searchParams.get("role")==="driver") ? "driver" :
      (url.searchParams.get("role")==="passenger") ? "passenger" :
      (localStorage.getItem(LS_ROLE)==="driver") ? "driver" : "passenger";

    function setRole(r){
      role = (r === "driver") ? "driver" : "passenger";
      try{ localStorage.setItem(LS_ROLE, role); }catch{}
      rolePassengerBtn.classList.toggle("active", role==="passenger");
      roleDriverBtn.classList.toggle("active", role==="driver");
      driverBox.style.display = (role==="driver") ? "block" : "none";
    }

    rolePassengerBtn.addEventListener("click", ()=>setRole("passenger"));
    roleDriverBtn.addEventListener("click", ()=>setRole("driver"));
    setRole(role);

    function setMsg(text, ok=false){
      msg.className = "hint " + (ok ? "msgOk" : "msgBad");
      msg.textContent = text || "";
    }

    function niceAuthError(e){
      const code = e?.code || "";
      if(code.includes("auth/email-already-in-use")) return "âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡. Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.";
      if(code.includes("auth/invalid-email")) return "âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.";
      if(code.includes("auth/weak-password")) return "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. Ù„Ø§Ø²Ù… 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
      if(code.includes("auth/user-not-found")) return "âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø¬Ø±Ù‘Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.";
      if(code.includes("auth/wrong-password")) return "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      if(code.includes("auth/invalid-credential")) return "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      if(code.includes("auth/network-request-failed")) return "âŒ Ù…Ø´ÙƒÙ„Ø© Ø´Ø¨ÙƒØ©. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      if(code.includes("auth/too-many-requests")) return "âŒ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø§Ø³ØªÙ†Ù‰ Ø´ÙˆÙŠØ© ÙˆØ¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      return "âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. " + (e?.message || "");
    }

    function validateRoleFields(){
      if(role !== "driver") return { ok:true };
      const v = clean(vehicleEl?.value);
      const m = clean(modelEl?.value);
      if(!v) return { ok:false, msg:"âŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©." };
      if(m.length < 2) return { ok:false, msg:"âŒ Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)." };
      return { ok:true };
    }

    async function afterAuth(user){
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: role,
        email: user.email || clean(emailEl.value) || null
      });

      const payload = {
        roles: { passenger:true, driver:true },
        activeRole: role,
        name: clean(nameEl.value) || null,
        phone: clean(phoneEl.value) || null,
        email: user.email || clean(emailEl.value) || null
      };

      if(role === "driver"){
        payload.vehicle = clean(vehicleEl.value) || null;
        payload.model = clean(modelEl.value) || null;
        payload.plate = clean(plateEl.value) || null;
      }

      await saveUserProfile(user.uid, payload);
      setActiveRole(role);

      location.href = (role === "driver") ? "./driver.html" : "./passenger.html";
    }

    async function doSignup(){
      try{
        const v = validateRoleFields();
        if(!v.ok){ setMsg(v.msg); return; }

        setMsg("Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignUp(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    async function doLogin(){
      try{
        const v = validateRoleFields();
        if(role==="driver" && !v.ok){ setMsg(v.msg); return; }

        setMsg("Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignIn(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    signupBtn.addEventListener("click", doSignup);
    loginBtn.addEventListener("click", doLogin);
  </script>
</body>
</html>
