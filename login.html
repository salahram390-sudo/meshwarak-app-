<script type="module">
  import { auth, db, qs, emailLoginOrSignup, ensureUserDoc, saveUserProfile } from "./app.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const $ = (id)=>document.getElementById(id);

  const emailEl = $("email");
  const passEl  = $("password");
  const msg     = $("msg");

  const rolePassenger = $("rolePassenger");
  const roleDriver = $("roleDriver");

  const govEl = $("gov");
  const centerEl = $("center");
  const centerOtherEl = $("centerOther");
  const otherWrap = $("otherCenterWrap");

  const nameEl = $("name"); // لو موجود
  const vehicleEl = $("vehicle");
  const modelEl = $("model");
  const driverFields = $("driverFields");

  const loginBtn = $("loginBtn");

  const OTHER="__other__";
  let selectedRole = null;

  // ✅ حفظ الإدخالات حتى بعد تسجيل خروج
  const LS = {
    email:"mw_login_email",
    gov:"mw_login_gov",
    center:"mw_login_center",
    centerOther:"mw_login_center_other",
    role:"mw_login_role",
    name:"mw_login_name",
    vehicle:"mw_login_vehicle",
    model:"mw_login_model",
  };

  function normalizeEmail(x){
    let v = String(x||"").trim();
    if(!v) return null;

    // لو كتب اسم بدون @ -> ايميل وهمي
    if(!v.includes("@")){
      v = v.replace(/\s+/g,"").replace(/[^\w.-]/g,"");
      if(!v) v = "user";
      v = `${v}@meshwarak.local`;
    }
    if(/^[^@]+@$/.test(v)) v = v + "meshwarak.local";

    return v.toLowerCase();
  }

  function saveDraft(){
    try{
      localStorage.setItem(LS.email, emailEl?.value || "");
      localStorage.setItem(LS.gov, govEl?.value || "");
      localStorage.setItem(LS.center, centerEl?.value || "");
      localStorage.setItem(LS.centerOther, centerOtherEl?.value || "");
      localStorage.setItem(LS.role, selectedRole || "");
      if(nameEl) localStorage.setItem(LS.name, nameEl.value || "");
      if(vehicleEl) localStorage.setItem(LS.vehicle, vehicleEl.value || "");
      if(modelEl) localStorage.setItem(LS.model, modelEl.value || "");
    }catch{}
  }

  function setRole(role){
    selectedRole = role;
    rolePassenger?.classList.remove("active");
    roleDriver?.classList.remove("active","driver");
    if(driverFields) driverFields.style.display="none";

    if(role==="passenger"){
      rolePassenger?.classList.add("active");
    }else if(role==="driver"){
      roleDriver?.classList.add("active","driver");
      if(driverFields) driverFields.style.display="block";
    }
    saveDraft();
  }

  rolePassenger?.addEventListener("click", ()=> setRole("passenger"));
  roleDriver?.addEventListener("click", ()=> setRole("driver"));

  function restoreDraft(){
    try{
      if(emailEl) emailEl.value = localStorage.getItem(LS.email) || "";
      if(nameEl) nameEl.value = localStorage.getItem(LS.name) || "";

      const role = localStorage.getItem(LS.role) || "";
      if(role==="passenger" || role==="driver") setRole(role);

      if(vehicleEl) vehicleEl.value = localStorage.getItem(LS.vehicle) || vehicleEl.value;
      if(modelEl) modelEl.value = localStorage.getItem(LS.model) || "";

      // gov ثم change عشان fillCenters يحصل من كودك الأساسي
      const g = localStorage.getItem(LS.gov) || "";
      if(govEl && g){
        govEl.value = g;
        govEl.dispatchEvent(new Event("change"));
      }

      // بعد ما centers اتملا
      const c = localStorage.getItem(LS.center) || "";
      const co = localStorage.getItem(LS.centerOther) || "";
      if(centerEl && c){
        centerEl.value = c;
        if(c===OTHER){
          if(otherWrap) otherWrap.style.display="block";
          if(centerOtherEl) centerOtherEl.value = co || "";
        }else{
          if(otherWrap) otherWrap.style.display="none";
          if(centerOtherEl) centerOtherEl.value = "";
        }
      }
    }catch{}
  }

  [emailEl, passEl, govEl, centerEl, centerOtherEl, nameEl, vehicleEl, modelEl]
    .filter(Boolean)
    .forEach(el => {
      el.addEventListener("input", saveDraft);
      el.addEventListener("change", saveDraft);
    });

  restoreDraft();

  function getArea(){
    const governorate = (govEl?.value || "").trim() || null;
    const cVal = (centerEl?.value || "").trim();
    if(!governorate) return { governorate:null, center:null };
    if(!cVal) return { governorate, center:null };
    if(cVal===OTHER){
      const manual = (centerOtherEl?.value || "").trim();
      return { governorate, center: (manual.length>=2 ? manual : null) };
    }
    return { governorate, center: cVal || null };
  }

  function goAfterLogin(role){
    const returnTo = qs("returnTo");
    if(returnTo){ location.href = returnTo; return; }
    location.href = (role==="passenger") ? "passenger.html" : "driver.html";
  }

  async function handleLogin(){
    msg.textContent = "";
    saveDraft();

    const email = normalizeEmail(emailEl?.value || "");
    const password = String(passEl?.value || "");

    if(!email){ msg.textContent = "❌ اكتب الإيميل (أو اكتب اسم فقط وسيُحوَّل لوهمي)."; return; }
    if(!password || password.length < 6){ msg.textContent = "❌ كلمة المرور أقل شيء 6 أحرف."; return; }

    if(!selectedRole) { msg.textContent = "❌ اختر راكب أو سائق."; return; }

    const area = getArea();
    if(!area.governorate || !area.center){
      msg.textContent = "❌ اختر المحافظة + المركز.";
      return;
    }

    if(selectedRole==="driver"){
      const v = (vehicleEl?.value || "").trim();
      const m = (modelEl?.value || "").trim();
      if(!v){ msg.textContent="❌ اختر نوع المركبة."; return; }
      if(!m || m.length<2){ msg.textContent="❌ اكتب موديل المركبة."; return; }
    }

    loginBtn.disabled = true;
    msg.textContent = "جارٍ الدخول…";

    try{
      const res = await emailLoginOrSignup(email, password);
      const uid = res.user.uid;

      await ensureUserDoc(uid, {
        role: selectedRole,
        email: res.user.email || email,
        name: nameEl?.value?.trim() || null,
        governorate: area.governorate,
        center: area.center,
        vehicle: selectedRole==="driver" ? (vehicleEl?.value||null) : null,
        model: selectedRole==="driver" ? (modelEl?.value?.trim()||null) : null,
      });

      await saveUserProfile(uid, {
        role: selectedRole,
        email: res.user.email || email,
        name: nameEl?.value?.trim() || null,
        governororate: area.governorate, // (لو عندك typo قديم تجاهله) 
        governorate: area.governorate,
        center: area.center,
        vehicle: selectedRole==="driver" ? (vehicleEl?.value||null) : null,
        model: selectedRole==="driver" ? (modelEl?.value?.trim()||null) : null,
        updatedAt: serverTimestamp()
      });

      msg.textContent = "✅ تم الدخول.";
      goAfterLogin(selectedRole);
    }catch(e){
      console.error(e);
      const code = e?.code || "";
      if(code==="auth/wrong-password" || code==="auth/invalid-login-credentials"){
        msg.textContent = "❌ كلمة المرور غير صحيحة.";
      }else if(code==="auth/invalid-email"){
        msg.textContent = "❌ الإيميل غير صحيح.";
      }else{
        msg.textContent = "❌ فشل الدخول. جرّب مرة أخرى.";
      }
    }finally{
      loginBtn.disabled = false;
    }
  }

  loginBtn?.addEventListener("click", handleLogin);

  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    const snap = await getDoc(doc(db,"users",user.uid)).catch(()=>null);
    const role = (snap && typeof snap.exists === "function" && snap.exists()) ? (snap.data().role || null) : null;
    if(role==="passenger" || role==="driver") goAfterLogin(role);
  });
</script>
