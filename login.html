<script type="module">
  import { auth, db, qs, emailLoginOrSignup, ensureUserDoc, saveUserProfile } from "./app.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const $ = (id)=>document.getElementById(id);

  const emailEl = $("email");
  const passEl  = $("password");
  const msg     = $("msg");

  const rolePassenger = $("rolePassenger");
  const roleDriver = $("roleDriver");

  const govEl = $("gov");
  const centerEl = $("center");
  const centerOtherEl = $("centerOther");
  const otherWrap = $("otherCenterWrap");
  const nameEl = $("name"); // لو موجود عندك
  const vehicleEl = $("vehicle");
  const modelEl = $("model");
  const driverFields = $("driverFields");

  const loginBtn = $("loginBtn"); // زر "تسجيل/دخول"

  const OTHER="__other__";
  let selectedRole = null;

  // ✅ حفظ الإدخالات حتى بعد تسجيل خروج
  const LS = {
    email:"mw_login_email",
    gov:"mw_login_gov",
    center:"mw_login_center",
    centerOther:"mw_login_center_other",
    role:"mw_login_role",
    name:"mw_login_name",
    vehicle:"mw_login_vehicle",
    model:"mw_login_model",
  };

  function saveDraft(){
    try{
      localStorage.setItem(LS.email, emailEl?.value || "");
      localStorage.setItem(LS.gov, govEl?.value || "");
      localStorage.setItem(LS.center, centerEl?.value || "");
      localStorage.setItem(LS.centerOther, centerOtherEl?.value || "");
      localStorage.setItem(LS.role, selectedRole || "");
      if(nameEl) localStorage.setItem(LS.name, nameEl.value || "");
      if(vehicleEl) localStorage.setItem(LS.vehicle, vehicleEl.value || "");
      if(modelEl) localStorage.setItem(LS.model, modelEl.value || "");
    }catch{}
  }

  function restoreDraft(){
    try{
      if(emailEl) emailEl.value = localStorage.getItem(LS.email) || "";
      if(govEl) govEl.value = localStorage.getItem(LS.gov) || "";
      // center يتملّي بعد اختيار gov في كودك
      const role = localStorage.getItem(LS.role) || "";
      if(role==="passenger" || role==="driver") setRole(role);
      if(nameEl) nameEl.value = localStorage.getItem(LS.name) || "";
      if(vehicleEl) vehicleEl.value = localStorage.getItem(LS.vehicle) || vehicleEl.value;
      if(modelEl) modelEl.value = localStorage.getItem(LS.model) || "";
      // center + other بعد fillCenters
      const c = localStorage.getItem(LS.center) || "";
      const co = localStorage.getItem(LS.centerOther) || "";
      if(centerEl){
        centerEl.value = c;
        if(c===OTHER){
          otherWrap && (otherWrap.style.display="block");
          centerOtherEl && (centerOtherEl.value=co);
        }
      }
    }catch{}
  }

  function setRole(role){
    selectedRole = role;
    rolePassenger?.classList.remove("active");
    roleDriver?.classList.remove("active","driver");
    if(driverFields) driverFields.style.display="none";

    if(role==="passenger"){
      rolePassenger?.classList.add("active");
    }else if(role==="driver"){
      roleDriver?.classList.add("active","driver");
      if(driverFields) driverFields.style.display="block";
    }
    saveDraft();
  }

  rolePassenger?.addEventListener("click", ()=> setRole("passenger"));
  roleDriver?.addEventListener("click", ()=> setRole("driver"));

  // احفظ مع أي تغيير
  [emailEl, passEl, govEl, centerEl, centerOtherEl, nameEl, vehicleEl, modelEl]
    .filter(Boolean)
    .forEach(el => el.addEventListener("input", saveDraft));

  restoreDraft();

  function getArea(){
    const governorate = (govEl?.value || "").trim() || null;
    const cVal = (centerEl?.value || "").trim();
    if(!governorate) return { governorate:null, center:null };
    if(!cVal) return { governorate, center:null };
    if(cVal===OTHER){
      const manual = (centerOtherEl?.value || "").trim();
      return { governorate, center: (manual.length>=2 ? manual : null) };
    }
    return { governorate, center: cVal || null };
  }

  function goAfterLogin(role){
    const returnTo = qs("returnTo");
    if(returnTo){ location.href = returnTo; return; }
    location.href = (role==="passenger") ? "passenger.html" : "driver.html";
  }

  async function handleLogin(){
    msg.textContent = "";
    saveDraft();

    const email = emailEl?.value || "";
    const password = passEl?.value || "";

    if(!selectedRole) {
      msg.textContent = "❌ اختر راكب أو سائق.";
      return;
    }

    const area = getArea();
    if(!area.governorate || !area.center){
      msg.textContent = "❌ اختر المحافظة + المركز.";
      return;
    }

    if(selectedRole==="driver"){
      const v = (vehicleEl?.value || "").trim();
      const m = (modelEl?.value || "").trim();
      if(!v){ msg.textContent="❌ اختر نوع المركبة."; return; }
      if(!m || m.length<2){ msg.textContent="❌ اكتب موديل المركبة."; return; }
    }

    loginBtn.disabled = true;
    msg.textContent = "جارٍ الدخول…";

    try{
      const res = await emailLoginOrSignup(email, password);
      const uid = res.user.uid;

      // users doc
      await ensureUserDoc(uid, {
        role: selectedRole,
        email: res.user.email || null,
        name: nameEl?.value?.trim() || null,
        governorate: area.governorate,
        center: area.center,
        vehicle: selectedRole==="driver" ? (vehicleEl?.value||null) : null,
        model: selectedRole==="driver" ? (modelEl?.value?.trim()||null) : null,
      });

      // تحديث بيانات الملف الشخصي (ولا تمسحها بعد logout)
      await saveUserProfile(uid, {
        role: selectedRole,
        email: res.user.email || null,
        name: nameEl?.value?.trim() || null,
        governorate: area.governorate,
        center: area.center,
        vehicle: selectedRole==="driver" ? (vehicleEl?.value||null) : null,
        model: selectedRole==="driver" ? (modelEl?.value?.trim()||null) : null,
        updatedAt: serverTimestamp()
      });

      msg.textContent = "✅ تم الدخول.";
      goAfterLogin(selectedRole);
    }catch(e){
      console.error(e);
      // رسائل واضحة
      if((e?.code||"")==="auth/email-already-in-use"){
        msg.textContent = "❌ الإيميل مستخدم من قبل. جرّب دخول بنفس الباسورد الصحيح.";
      }else if((e?.code||"")==="auth/wrong-password"){
        msg.textContent = "❌ كلمة المرور غير صحيحة.";
      }else if((e?.code||"")==="auth/invalid-email"){
        msg.textContent = "❌ اكتب إيميل صحيح أو اكتب أي اسم بدون @ وسيتم تحويله تلقائياً لإيميل وهمي.";
      }else{
        msg.textContent = "❌ فشل الدخول. جرّب مرة أخرى.";
      }
    }finally{
      loginBtn.disabled = false;
    }
  }

  loginBtn?.addEventListener("click", handleLogin);

  // لو بالفعل مسجل دخول، دخّله حسب role الموجود
  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    const snap = await getDoc(doc(db,"users",user.uid)).catch(()=>null);
    const role = snap?.exists?.() ? (snap.data().role || null) : null;
    if(role==="passenger" || role==="driver") goAfterLogin(role);
  });
</script>
