<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>مشوارك - تسجيل الدخول</title>

  <link rel="icon" href="./favicon.png">
  <link rel="stylesheet" href="./styles.css">
  <meta name="theme-color" content="#050B16" />

  <style>
    /* ===== Login polish (UI only) ===== */
    :root{
      --login-card-w: 540px;
      --login-radius: 22px;
      --login-stroke: rgba(255,255,255,.12);
      --login-stroke2: rgba(43,108,255,.35);
      --login-soft: rgba(255,255,255,.06);
      --login-soft2: rgba(0,0,0,.18);
      --login-txt: rgba(234,240,255,.92);
      --login-muted: rgba(234,240,255,.72);
    }

    .container{
      max-width: 100%;
    }

    .loginShell{
      min-height: calc(100vh - 24px);
      display: grid;
      place-items: center;
      padding: 14px 12px;
    }

    .loginCard{
      width: min(var(--login-card-w), 100%);
      text-align: center;
      border-radius: var(--login-radius);
      padding: 18px 16px 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(12,18,32,.96), rgba(10,18,34,.86));
      box-shadow: 0 22px 70px rgba(0,0,0,.42);
      overflow: hidden;
    }

    .loginTitle{
      margin: 0;
      font-size: 20px;
      letter-spacing: .2px;
    }

    .loginSub{
      margin: 8px 0 14px;
      color: var(--login-muted);
      font-size: 13px;
      line-height: 1.6;
    }

    /* Role tabs */
    .roleTabs{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 0 0 14px;
    }

    .roleBtn{
      border: 1px solid var(--login-stroke);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding: 12px 14px;
      cursor: pointer;
      user-select: none;
      font-weight: 900;
      -webkit-tap-highlight-color: transparent;
      color: rgba(234,240,255,.82);
      transition: transform .08s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      position: relative;
      overflow: hidden;
    }
    .roleBtn:active{ transform: translateY(1px); filter: brightness(1.05); }
    .roleBtn::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(420px 160px at 70% 20%, rgba(43,108,255,.18), transparent 60%),
                  radial-gradient(420px 160px at 25% 120%, rgba(34,197,94,.12), transparent 60%);
      opacity: .55;
      pointer-events:none;
    }
    .roleBtn.active{
      background: rgba(43,108,255,.12);
      border-color: var(--login-stroke2);
      color: rgba(234,240,255,.98);
      box-shadow: 0 10px 30px rgba(43,108,255,.14);
    }
    .roleBtn.active::before{
      content:"";
      position:absolute; inset:0;
      border-radius: 18px;
      box-shadow: inset 0 0 0 1px rgba(43,108,255,.22);
      pointer-events:none;
    }

    /* Fields */
    .field{
      text-align: right;
      margin-top: 12px;
    }
    .field:first-of-type{ margin-top: 10px; }
    .field label{
      display: block;
      margin-bottom: 8px;
      color: rgba(234,240,255,.82);
      font-size: 12px;
      letter-spacing: .2px;
    }

    input, select{
      width: 100%;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(234,240,255,.98);
      outline: none;
      font-size: 16px;
      transition: border-color .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    input::placeholder{ color: rgba(234,240,255,.52); }
    input:focus, select:focus{
      border-color: rgba(43,108,255,.45);
      box-shadow: 0 0 0 4px rgba(43,108,255,.12);
      filter: brightness(1.02);
    }

    .row2{ display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    @media (max-width:520px){ .row2{ grid-template-columns: 1fr; } }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    /* Message */
    .msgOk{ color:#7CFFB2; }
    .msgBad{ color:#FF8E8E; }

    /* Buttons sizing polish */
    .row2 .btn{
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 16px;
    }

    /* Driver box */
    #driverBox{
      text-align: right;
      margin-top: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 12px 12px 10px;
    }
    #driverBox .divider{ margin: 10px 0 12px; }

    /* Bottom back link */
    .backBtn{
      min-width: 220px;
      text-align: center;
      border-radius: 18px;
      padding: 12px 14px;
    }
  </style>
</head>

<body>
  <div class="loginShell">
    <div class="loginCard">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:58px;height:58px;border-radius:20px;font-size:22px">م</div>
      </div>

      <h1 class="loginTitle">تسجيل الدخول / إنشاء حساب</h1>
      <p class="loginSub">اختر تدخل كـ راكب أو سائق — نفس الإيميل يشتغل في الاثنين ✅</p>

      <div class="roleTabs">
        <button class="roleBtn" id="rolePassenger" type="button" aria-pressed="false">راكب</button>
        <button class="roleBtn" id="roleDriver" type="button" aria-pressed="false">سائق</button>
      </div>

      <div class="field">
        <label>الإيميل</label>
        <input id="email" type="email" placeholder="example@gmail.com" autocomplete="email" />
      </div>

      <div class="field">
        <label>كلمة المرور <span class="hint">(6 أحرف على الأقل)</span></label>
        <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>

      <div class="row2">
        <button class="btn success" id="signupBtn" type="button">إنشاء حساب</button>
        <button class="btn primary" id="loginBtn" type="button">تسجيل دخول</button>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>الاسم <span class="hint">(اختياري)</span></label>
        <input id="name" type="text" placeholder="اسمك" autocomplete="name" />
      </div>

      <div class="field">
        <label>رقم الهاتف <span class="hint">(مهم لتجنب الطلبات الوهمية)</span></label>
        <input id="phone" type="tel" placeholder="01xxxxxxxxx" autocomplete="tel" />
      </div>

      <!-- Driver extra fields -->
      <div id="driverBox" style="display:none">
        <div class="divider"></div>

        <div class="field" style="margin-top:0">
          <label>نوع المركبة (للسائق)</label>
          <select id="vehicle">
            <option value="">اختر نوع المركبة…</option>
            <option value="tuktuk">توكتوك</option>
            <option value="motor_delivery">موتسيكل دليفري</option>
            <option value="car">ملاكي</option>
            <option value="microbus">ميكروباص</option>
            <option value="tamanya">تمناية</option>
            <option value="caboot">عربية كابوت</option>
          </select>
        </div>

        <div class="row2" style="margin-top:12px">
          <div class="field" style="margin-top:0">
            <label>موديل/كود المركبة</label>
            <input id="model" type="text" placeholder="مثال: 2020 / BYD / إلخ" />
          </div>
          <div class="field" style="margin-top:0">
            <label>رقم اللوحة <span class="hint">(اختياري)</span></label>
            <input id="plate" type="text" placeholder="مثال: س ج 1234" />
          </div>
        </div>

        <p class="hint" style="margin:10px 0 0">
          * بيانات المركبة تظهر للراكب عند قبول الرحلة.
        </p>
      </div>

      <p id="msg" class="hint" style="margin:14px 0 0"></p>

      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <a class="btn backBtn" href="./index.html">↩️ رجوع للرئيسية</a>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      emailSignUp, emailSignIn,
      ensureUserDoc, saveUserProfile,
      setActiveRole
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");

    const rolePassengerBtn = $("rolePassenger");
    const roleDriverBtn = $("roleDriver");
    const driverBox = $("driverBox");

    const emailEl = $("email");
    const passEl = $("pass");
    const nameEl = $("name");
    const phoneEl = $("phone");

    const vehicleEl = $("vehicle");
    const modelEl = $("model");
    const plateEl = $("plate");

    const signupBtn = $("signupBtn");
    const loginBtn = $("loginBtn");
    const msg = $("msg");

    // ===== role (query + last choice)
    const url = new URL(location.href);
    const LS_ROLE = "mw_last_role";
    let role =
      (url.searchParams.get("role")==="driver") ? "driver" :
      (url.searchParams.get("role")==="passenger") ? "passenger" :
      (localStorage.getItem(LS_ROLE)==="driver") ? "driver" : "passenger";

    function setRole(r){
      role = (r === "driver") ? "driver" : "passenger";
      try{ localStorage.setItem(LS_ROLE, role); }catch{}
      rolePassengerBtn.classList.toggle("active", role==="passenger");
      roleDriverBtn.classList.toggle("active", role==="driver");
      rolePassengerBtn.setAttribute("aria-pressed", String(role==="passenger"));
      roleDriverBtn.setAttribute("aria-pressed", String(role==="driver"));
      driverBox.style.display = (role==="driver") ? "block" : "none";
    }

    rolePassengerBtn.addEventListener("click", ()=>setRole("passenger"));
    roleDriverBtn.addEventListener("click", ()=>setRole("driver"));
    setRole(role);

    function setMsg(text, ok=false){
      msg.className = "hint " + (ok ? "msgOk" : "msgBad");
      msg.textContent = text || "";
    }

    function niceAuthError(e){
      const code = e?.code || "";
      if(code.includes("auth/email-already-in-use")) return "❌ الإيميل مستخدم قبل كده. جرّب تسجيل دخول.";
      if(code.includes("auth/invalid-email")) return "❌ الإيميل غير صحيح.";
      if(code.includes("auth/weak-password")) return "❌ كلمة المرور ضعيفة. لازم 6 أحرف على الأقل.";
      if(code.includes("auth/user-not-found")) return "❌ الحساب غير موجود. جرّب إنشاء حساب.";
      if(code.includes("auth/wrong-password")) return "❌ كلمة المرور غير صحيحة.";
      if(code.includes("auth/invalid-credential")) return "❌ بيانات الدخول غير صحيحة.";
      if(code.includes("auth/network-request-failed")) return "❌ مشكلة شبكة. جرّب تاني.";
      if(code.includes("auth/too-many-requests")) return "❌ محاولات كثيرة. استنى شوية وجرّب تاني.";
      return "❌ فشل العملية. " + (e?.message || "");
    }

    function validateRoleFields(){
      if(role !== "driver") return { ok:true };

      const v = clean(vehicleEl.value);
      const m = clean(modelEl.value);
      if(!v) return { ok:false, msg:"❌ اختر نوع المركبة." };
      if(m.length < 2) return { ok:false, msg:"❌ اكتب موديل/كود المركبة (حرفين على الأقل)." };
      return { ok:true };
    }

    async function afterAuth(user){
      // ✅ نفس الإيميل يشتغل للدورين
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: role,
        email: user.email || clean(emailEl.value) || null
      });

      // ✅ حفظ البروفايل (وتحديث بيانات السائق لو مختار سائق)
      const payload = {
        roles: { passenger:true, driver:true },
        activeRole: role,
        name: clean(nameEl.value) || null,
        phone: clean(phoneEl.value) || null,
        email: user.email || clean(emailEl.value) || null
      };

      if(role === "driver"){
        payload.vehicle = clean(vehicleEl.value) || null;
        payload.model = clean(modelEl.value) || null;
        payload.plate = clean(plateEl.value) || null;
      }

      await saveUserProfile(user.uid, payload);

      // ✅ يمنع التحويل التلقائي لراكب
      setActiveRole(role);

      location.href = (role === "driver") ? "./driver.html" : "./passenger.html";
    }

    async function doSignup(){
      try{
        const v = validateRoleFields();
        if(!v.ok){ setMsg(v.msg); return; }

        setMsg("جارٍ إنشاء الحساب…", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignUp(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    async function doLogin(){
      try{
        const v = validateRoleFields();
        if(role==="driver" && !v.ok){ setMsg(v.msg); return; }

        setMsg("جارٍ تسجيل الدخول…", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignIn(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    signupBtn.addEventListener("click", doSignup);
    loginBtn.addEventListener("click", doLogin);
  </script>
</body>
</html>
