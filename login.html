<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - ØªØ³Ø¬ÙŠÙ„</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">ğŸš–</div>
        <div>
          <h1>Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
          <p>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</p>
        </div>
      </div>
      <a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2 class="title">ğŸ” Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹</h2>
      <div class="hint">Ø§ÙƒØªØ¨ Gmail + Ø¨Ø§Ø³ÙˆØ±Ø¯ØŒ Ø«Ù… Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø±Ø§ÙƒØ¨/Ø³Ø§Ø¦Ù‚).</div>

      <div class="field">
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù„Ø§Ø²Ù… ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com)</label>
        <input id="email" placeholder="example@gmail.com" autocomplete="email"/>
      </div>

      <div class="field">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6+)</label>
        <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>

      <div class="field">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
        <div class="grid2">
          <button class="btn" id="rolePassenger">ğŸš• Ø±Ø§ÙƒØ¨</button>
          <button class="btn" id="roleDriver">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</button>
        </div>
        <div class="pills">
          <span class="pill" id="rolePill">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</span>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="signupBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button class="btn" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      </div>

      <div class="hr"></div>
      <div class="hint" id="msg"></div>
    </div>
  </div>

  <script type="module">
    import { auth, saveUserRole, getUserDoc, ensureUserDoc } from "./app.js";
    import { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("pass");
    const msg     = document.getElementById("msg");
    const signupBtn = document.getElementById("signupBtn");
    const loginBtn  = document.getElementById("loginBtn");

    const rolePassenger = document.getElementById("rolePassenger");
    const roleDriver    = document.getElementById("roleDriver");
    const rolePill      = document.getElementById("rolePill");

    let selectedRole = null;

    function setRole(role){
      selectedRole = role;
      rolePassenger.classList.toggle("primary", role === "passenger");
      roleDriver.classList.toggle("primary", role === "driver");
      rolePill.textContent = role === "passenger" ? "âœ… Ø±Ø§ÙƒØ¨" : "âœ… Ø³Ø§Ø¦Ù‚";
      rolePill.className = "pill ok";
    }

    rolePassenger.addEventListener("click", (e)=>{ e.preventDefault(); setRole("passenger"); });
    roleDriver.addEventListener("click", (e)=>{ e.preventDefault(); setRole("driver"); });

    function isGmail(email){ return /@gmail\.com$/i.test(email.trim()); }

    onAuthStateChanged(auth, async (user) => {
  if(user){
    const data = await getUserDoc(user.uid);
    if(data?.role === "passenger") location.href = "passenger.html";
    else if(data?.role === "driver") location.href = "driver.html";
    else location.href = "index.html";
  }
});
    function lock(v){
      signupBtn.disabled = v;
      loginBtn.disabled = v;
    }

    async function handleSignup(){
      msg.innerHTML = "";
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();

      if(!isGmail(email)) return msg.innerHTML = `<span class="pill bad">Ù„Ø§Ø²Ù… ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com</span>`;
      if(pass.length < 6) return msg.innerHTML = `<span class="pill bad">Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ 6+ Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…</span>`;
      if(!selectedRole) return msg.innerHTML = `<span class="pill bad">Ø§Ø®ØªØ± Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚</span>`;

      lock(true);
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦";

      try{
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await ensureUserDoc(res.user.uid, { email });
        await saveUserRole(res.user.uid, selectedRole);

        msg.innerHTML = `<span class="pill ok">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span>`;
        location.href = selectedRole === "passenger" ? "passenger.html" : "driver.html";
      }catch(e){
        console.error(e);
        msg.innerHTML = `<span class="pill bad">âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡)</span>`;
      }finally{
        lock(false);
      }
    }

    async function handleLogin(){
      msg.innerHTML = "";
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();

      if(!isGmail(email)) return msg.innerHTML = `<span class="pill bad">Ù„Ø§Ø²Ù… ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com</span>`;
      if(pass.length < 6) return msg.innerHTML = `<span class="pill bad">Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ 6+ Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…</span>`;

      lock(true);
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦";

      try{
        const res = await signInWithEmailAndPassword(auth, email, pass);
        await ensureUserDoc(res.user.uid, { email });

        const data = await getUserDoc(res.user.uid);
        let role = data?.role || null;

        // Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø© ÙˆÙ…ÙÙŠØ´ role: Ù„Ø§Ø²Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ®ØªØ§Ø±
        if(!role){
          if(!selectedRole){
            msg.innerHTML = `<span class="pill bad">Ø§Ø®ØªØ± Ø±Ø§ÙƒØ¨/Ø³Ø§Ø¦Ù‚ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</span>`;
            lock(false);
            return;
          }
          await saveUserRole(res.user.uid, selectedRole);
          role = selectedRole;
        }

        msg.innerHTML = `<span class="pill ok">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>`;
        location.href = role === "passenger" ? "passenger.html" : "driver.html";
      }catch(e){
        console.error(e);
        msg.innerHTML = `<span class="pill bad">âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­</span>`;
      }finally{
        lock(false);
      }
    }

    signupBtn.addEventListener("click", handleSignup);
    loginBtn.addEventListener("click", handleLogin);
  </script>
</body>
</html>
