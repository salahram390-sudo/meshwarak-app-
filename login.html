<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>مشوارك - تسجيل الدخول</title>
  <link rel="icon" href="./favicon.png">
  <link rel="stylesheet" href="./styles.css">
  <meta name="theme-color" content="#050B16" />
  <style>
    .wrap{ width:min(520px,92%); margin:18px auto; }
    .card{
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.28);
    }
    .title{font-weight:900;font-size:18px;margin:0 0 8px}
    .hint{opacity:.9;line-height:1.7}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{margin-top:10px}
    .field label{display:block;margin-bottom:6px;opacity:.9}
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
    }
    .btn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      background:rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:800;
      width:100%;
    }
    .btn.primary{background:rgba(43,108,255,.85);border-color:rgba(43,108,255,.35)}
    .btn.success{background:rgba(34,197,94,.78);border-color:rgba(34,197,94,.35);color:#04110a}
    .roleRow{display:flex;gap:10px;margin-top:10px}
    .roleBtn{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      padding:12px 10px;
      background:rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .roleBtn.active{
      background: rgba(43,108,255,.14);
      border-color: rgba(43,108,255,.35);
    }
    .msg{margin-top:10px;opacity:.95;line-height:1.7}
    .bad{color:#ffb4b4}
    .ok{color:#b7ffcf}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">تسجيل الدخول / إنشاء حساب</h1>
      <div class="hint">اختار تدخل كـ <b>راكب</b> أو <b>سائق</b> — نفس الإيميل يشتغل في الاتنين ✅</div>

      <div class="roleRow">
        <button class="roleBtn active" id="rolePassenger" type="button">راكب</button>
        <button class="roleBtn" id="roleDriver" type="button">سائق</button>
      </div>

      <div class="field">
        <label>الإيميل</label>
        <input id="email" placeholder="مثال: test@gmail.com" autocomplete="username" />
      </div>

      <div class="field">
        <label>كلمة المرور (6 أحرف على الأقل)</label>
        <input id="pass" type="password" placeholder="******" autocomplete="current-password" />
      </div>

      <div class="grid2" style="margin-top:10px">
        <button class="btn primary" id="loginBtn" type="button">تسجيل دخول</button>
        <button class="btn success" id="signupBtn" type="button">إنشاء حساب</button>
      </div>

      <div class="field" style="margin-top:14px">
        <label>الاسم (اختياري)</label>
        <input id="name" placeholder="اسمك" />
      </div>

      <div class="field">
        <label>رقم الهاتف (مهم لتجنب الطلبات الوهمية)</label>
        <input id="phone" placeholder="01xxxxxxxxx" inputmode="tel" />
      </div>

      <div id="driverFields" style="display:none">
        <div class="field">
          <label>نوع المركبة (للسائق)</label>
          <select id="vehicle">
            <option value="">اختر…</option>
            <option value="tuktuk">توكتوك</option>
            <option value="motor_delivery">موتسيكل دليفري</option>
            <option value="car">ملاكي</option>
            <option value="microbus">ميكروباص</option>
            <option value="tamanya">تمناية</option>
            <option value="caboot">عربية كابوت</option>
          </select>
        </div>

        <div class="field">
          <label>الموديل (اختياري)</label>
          <input id="model" placeholder="مثال: 2020" />
        </div>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script type="module">
    import {
      emailSignIn, emailSignUp, saveUserProfile,
      normalizeEmail, normalizePassword, normalizePhone,
      ensureUserDoc, setActiveRole
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");

    let role = "passenger";
    function setRole(r){
      role = r;
      $("rolePassenger").classList.toggle("active", r==="passenger");
      $("roleDriver").classList.toggle("active", r==="driver");
      $("driverFields").style.display = (r==="driver") ? "block" : "none";
      setActiveRole(r); // ✅ ده اللي يمنع التحويل التلقائي
    }

    $("rolePassenger").addEventListener("click", ()=>setRole("passenger"));
    $("roleDriver").addEventListener("click", ()=>setRole("driver"));
    setRole("passenger");

    function goAfterLogin(){
      location.href = (role==="driver") ? "./driver.html" : "./passenger.html";
    }

    function show(text, ok=false){
      $("msg").innerHTML = `<span class="${ok?'ok':'bad'}">${text}</span>`;
    }

    async function afterAuth(user){
      // ✅ أنشئ/حدّث user doc + خلي roles الاتنين شغالين + ثبت activeRole
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: role,
        email: user.email || null,
      });

      const payload = {
        roles: { passenger:true, driver:true },
        activeRole: role,
        email: user.email || null,
      };

      const name = clean($("name").value);
      const phone = normalizePhone($("phone").value);
      if(name) payload.name = name;
      if(phone) payload.phone = phone;

      if(role==="driver"){
        const veh = clean($("vehicle").value);
        const model = clean($("model").value);
        if(veh) payload.vehicle = veh;
        if(model) payload.model = model;
      }

      await saveUserProfile(user.uid, payload);
      setActiveRole(role);
      goAfterLogin();
    }

    async function doLogin(){
      const email = normalizeEmail($("email").value);
      const pass = normalizePassword($("pass").value);
      if(!email) return show("❌ اكتب إيميل صحيح.");
      if(!pass) return show("❌ كلمة المرور لازم 6 أحرف على الأقل.");

      show("جارٍ تسجيل الدخول…", true);
      try{
        const cred = await emailSignIn(email, pass);
        await afterAuth(cred.user);
      }catch(e){
        console.error(e);
        show("❌ فشل تسجيل الدخول. تأكد من الإيميل وكلمة المرور.");
      }
    }

    async function doSignup(){
      const email = normalizeEmail($("email").value);
      const pass = normalizePassword($("pass").value);
      if(!email) return show("❌ اكتب إيميل صحيح.");
      if(!pass) return show("❌ كلمة المرور لازم 6 أحرف على الأقل.");

      show("جارٍ إنشاء الحساب…", true);
      try{
        const cred = await emailSignUp(email, pass);
        await afterAuth(cred.user);
      }catch(e){
        console.error(e);
        show("❌ فشل إنشاء الحساب. جرّب إيميل مختلف أو كلمة مرور أقوى.");
      }
    }

    $("loginBtn").addEventListener("click", doLogin);
    $("signupBtn").addEventListener("click", doSignup);
  </script>
</body>
</html>
