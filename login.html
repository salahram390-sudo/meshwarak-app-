<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <meta name="theme-color" content="#050B16" />
  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">

  <!-- âœ… Cache-bust -->
  <link rel="stylesheet" href="./styles.css?v=13">

  <style>
    /* âœ… Ù„Ù…Ø¹Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ¬ÙŠÙ† ÙÙ‚Ø· */
    .auth-wrap{
      min-height: 100vh;
      display:grid;
      place-items:center;
      padding: 16px;
    }
    .auth-card{
      width:min(560px, 100%);
      text-align:center;
      padding: 18px;
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(12,18,32,.78), rgba(10,18,34,.62));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 70px rgba(0,0,0,.48);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position: relative;
      overflow:hidden;
    }
    .auth-card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 340px at 20% 10%, rgba(43,108,255,.24), transparent 55%),
        radial-gradient(700px 340px at 80% 10%, rgba(130,87,255,.18), transparent 55%),
        radial-gradient(900px 500px at 50% 120%, rgba(34,197,94,.10), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .auth-card > *{ position:relative; }

    .seg{
      display:flex;
      gap:0;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      margin: 14px 0 10px;
    }
    .seg button{
      flex:1;
      padding: 14px 12px;
      border:0;
      background: transparent;
      color: rgba(234,240,255,.85);
      font-weight: 900;
      font-size: 15px;
      cursor:pointer;
    }
    .seg button.active{
      background: linear-gradient(135deg, rgba(43,108,255,.55), rgba(43,108,255,.22));
      box-shadow: inset 0 0 0 1px rgba(43,108,255,.25);
      color: #fff;
    }
    .seg .ic{
      opacity:.95;
      margin-inline-start: 8px;
    }
    .two-btns{ display:grid; gap:10px; margin-top: 14px; }
    .btn.big{ padding: 14px 14px; border-radius: 18px; font-size: 18px; font-weight: 900; }
    .btn.soft{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .mini-links{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mini-links a{ font-weight:800; }
  </style>
</head>

<body>
  <!-- âœ… Ù…Ù†Ø¹ â€œØ±Ø¬ÙˆØ¹â€ Ù„Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© (bfcache) -->
  <script>
    window.addEventListener("pageshow", (e) => {
      try{
        if (e.persisted) location.reload();
      }catch{}
    });
  </script>

  <div class="auth-wrap">
    <div class="auth-card">

      <div style="display:flex;justify-content:center;margin-bottom:10px">
        <div class="logo" style="width:76px;height:76px;border-radius:24px;font-size:28px">Ù…</div>
      </div>

      <h1 style="margin:0;font-size:24px;letter-spacing:.2px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h1>
      <p class="hint" style="margin:10px 0 6px">Ø§Ø®ØªØ± ØªØ¯Ø®Ù„ Ùƒ Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚ â€” Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ø§ØªÙ†ÙŠÙ† âœ…</p>

      <!-- âœ… Role segmented -->
      <div class="seg" role="tablist" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±">
        <button id="rolePassenger" type="button"><span class="ic">ğŸš–</span> Ø±Ø§ÙƒØ¨</button>
        <button id="roleDriver" type="button"><span class="ic">ğŸ§‘â€âœˆï¸</span> Ø³Ø§Ø¦Ù‚</button>
      </div>

      <div class="field" style="text-align:right">
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input id="email" autocomplete="email" inputmode="email" placeholder="example@gmail.com" />
      </div>

      <div class="field" style="text-align:right">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
        <input id="pass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>

      <div class="sep" style="height:1px;background:rgba(255,255,255,.10);margin:16px 0"></div>

      <div class="field" style="text-align:right">
        <label>Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="name" placeholder="Ø§Ø³Ù…Ùƒ" />
      </div>

      <div class="field" style="text-align:right">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø±Ù‚Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©)</label>
        <input id="phone" inputmode="tel" placeholder="01xxxxxxxxx" />
      </div>

      <!-- âœ… Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø£Ùˆ role=driver) -->
      <div id="driverFields" style="display:none">
        <div class="sep" style="height:1px;background:rgba(255,255,255,.10);margin:16px 0"></div>

        <div class="grid2" style="text-align:right">
          <div class="field" style="margin-top:0">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ù„Ù„Ø³Ø§Ø¦Ù‚)</label>
            <select id="vehicle">
              <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©â€¦</option>
              <option value="tuktuk">ØªÙˆÙƒØªÙˆÙƒ</option>
              <option value="motor_delivery">Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
              <option value="car">Ù…Ù„Ø§ÙƒÙŠ</option>
              <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
              <option value="tamanya">ØªÙ…Ù†Ø§ÙŠØ©</option>
              <option value="caboot">Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</option>
            </select>
          </div>

          <div class="field" style="margin-top:0">
            <label>Ù…ÙˆØ¯ÙŠÙ„/Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label>
            <input id="model" placeholder="Ù…Ø«Ø§Ù„: 2020 / BYD / Ø¥Ù„Ø®" />
          </div>
        </div>

        <div class="field" style="text-align:right">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="plate" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¬ 1234" />
        </div>

        <div class="hint" style="margin-top:6px">* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ØªØ¸Ù‡Ø± Ù„Ù„Ø±Ø§ÙƒØ¨ Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©.</div>
      </div>

      <!-- âœ… Ø²Ø±Ø§Ø±ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† -->
      <div class="two-btns">
        <button class="btn primary big" id="signInBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn soft big" id="signUpBtn" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      </div>

      <div class="mini-links">
        <a class="btn" href="./index.html">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn" id="hardFixBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ (Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„)</button>
      </div>

      <p class="hint" id="msg" style="margin:12px 0 0"></p>
      <p class="hint" id="errMsg" style="margin:8px 0 0"></p>
    </div>
  </div>

  <script>
    const errMsg = document.getElementById("errMsg");
    window.addEventListener("error", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Ø®Ø·Ø£: " + (e.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{ errMsg.textContent = "âš ï¸ Promise Error: " + (e.reason?.message || e.reason || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"); }catch{}
    });
  </script>

  <script type="module">
    import { auth, db, setActiveRole, ensureUserDoc } from "./app.js?v=13";

    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      doc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const msg = document.getElementById("msg");

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("pass");
    const nameEl  = document.getElementById("name");
    const phoneEl = document.getElementById("phone");

    const driverFields = document.getElementById("driverFields");
    const vehicleEl = document.getElementById("vehicle");
    const modelEl   = document.getElementById("model");
    const plateEl   = document.getElementById("plate");

    const rolePassengerBtn = document.getElementById("rolePassenger");
    const roleDriverBtn = document.getElementById("roleDriver");

    const signInBtn = document.getElementById("signInBtn");
    const signUpBtn = document.getElementById("signUpBtn");

    // âœ… Ù‚Ø±Ø§Ø¡Ø© role Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    function qs(key){
      try{
        const u = new URL(location.href);
        return u.searchParams.get(key);
      }catch{ return null; }
    }

    // âœ… ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    function normalizePhone(p){
      const x = (p || "").trim();
      if(!x) return null;
      const cleaned = x.replace(/[^\d+]/g, "");
      return cleaned.length >= 8 ? cleaned : null;
    }

    let role = (qs("role") || "passenger").toLowerCase();
    if(role !== "driver") role = "passenger";

    function applyRoleUI(){
      const isDriver = role === "driver";
      rolePassengerBtn.classList.toggle("active", !isDriver);
      roleDriverBtn.classList.toggle("active", isDriver);
      driverFields.style.display = isDriver ? "block" : "none";
      try{ setActiveRole(role); }catch{}
    }

    rolePassengerBtn.addEventListener("click", ()=>{
      role = "passenger";
      applyRoleUI();
    });
    roleDriverBtn.addEventListener("click", ()=>{
      role = "driver";
      applyRoleUI();
    });

    applyRoleUI();

    async function saveUserBasics(uid, email){
      const payload = {
        email: email || null,
        name: (nameEl.value || "").trim() || null,
        phone: normalizePhone(phoneEl.value),
        roles: { passenger:true, driver:true },
        activeRole: role,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp(),
      };

      // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø· Ù„Ùˆ Ù…Ø®ØªØ§Ø± driver
      if(role === "driver"){
        payload.vehicle = vehicleEl.value || null;
        payload.model   = (modelEl.value || "").trim() || null;
        payload.plate   = (plateEl.value || "").trim() || null;
      }

      await ensureUserDoc(uid, payload).catch(async ()=>{
        // fallback
        await setDoc(doc(db, "users", uid), payload, { merge:true });
      });
    }

    function setBusy(b){
      signInBtn.disabled = b;
      signUpBtn.disabled = b;
      rolePassengerBtn.disabled = b;
      roleDriverBtn.disabled = b;
    }

    signInBtn.addEventListener("click", async ()=>{
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦";
      setBusy(true);
      try{
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if(!email || !pass) throw new Error("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");

        const cred = await signInWithEmailAndPassword(auth, email, pass);

        // âœ… role Ø«Ø§Ø¨Øª + Ø­ÙØ¸ doc
        await saveUserBasics(cred.user.uid, cred.user.email);

        // âœ… ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        if(role === "driver") location.href = "./driver.html";
        else location.href = "./passenger.html";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ " + (e?.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      }finally{
        setBusy(false);
      }
    });

    signUpBtn.addEventListener("click", async ()=>{
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦";
      setBusy(true);
      try{
        const email = (emailEl.value || "").trim();
        const pass  = (passEl.value || "").trim();
        if(!email || !pass) throw new Error("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
        if(pass.length < 6) throw new Error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // âœ… displayName
        const nm = (nameEl.value || "").trim();
        if(nm){
          try{ await updateProfile(cred.user, { displayName: nm }); }catch{}
        }

        await saveUserBasics(cred.user.uid, cred.user.email);

        if(role === "driver") location.href = "./driver.html";
        else location.href = "./passenger.html";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ " + (e?.message || "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
      }finally{
        setBusy(false);
      }
    });

    // âœ… ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ
    document.getElementById("hardFixBtn").addEventListener("click", async ()=>{
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if("caches" in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}
      location.href = "./login.html?role=" + role + "&v=" + Date.now();
    });
  </script>
</body>
</html>
