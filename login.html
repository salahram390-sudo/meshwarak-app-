<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</title>

  <!-- âœ… Favicon -->
  <link rel="icon" href="./favicon.png">

  <link rel="stylesheet" href="./styles.css" />
  <style>
    html,body{overflow:auto}
    .box{
      width:92%;max-width:520px;margin:18px auto;padding:18px;
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid var(--stroke);border-radius:22px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    h1{margin:0 0 10px;font-size:18px;text-align:center}
    p{margin:0 0 12px;opacity:.85;text-align:center;color:var(--muted)}
    .roleBtn{background: rgba(255,255,255,.06)}
    .roleBtn.active{
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(43,108,255,.72));
      border:1px solid rgba(43,108,255,.35);
    }
    .roleBtn.active.driver{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.62));
      border:1px solid rgba(34,197,94,.35);
      color:#04110a;
    }
    .btns{display:grid;gap:10px;margin-top:12px}
    .sep{height:1px;background:var(--stroke);margin:14px 0}
    #driverFields{display:none}
    #otherCenterWrap{display:none}
  </style>
</head>

<body>
  <div class="box">
    <h1>ğŸ” Ù…Ø´ÙˆØ§Ø±Ùƒ â€” ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h1>
    <p>Ø¥ÙŠÙ…ÙŠÙ„ + ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ + (Ø±Ø§ÙƒØ¨/Ø³Ø§Ø¦Ù‚) + Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ²</p>

    <div class="field" style="margin-top:0">
      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="name" placeholder="Ù…Ø«Ø§Ù„: ØµÙ„Ø§Ø­" autocomplete="name"/>
    </div>

    <!-- âœ… NEW: Phone -->
    <div class="field">
      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input id="phone" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 01012345678" autocomplete="tel"/>
      <div class="small" style="margin-top:6px">Ù‡ÙŠØ¸Ù‡Ø± Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙÙ‚Ø·.</div>
    </div>

    <div class="field">
      <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù…Ù…ÙƒÙ† ØªÙƒØªØ¨ Ø§Ø³Ù… ÙÙ‚Ø·)</label>
      <input id="email" placeholder="Ù…Ø«Ø§Ù„: salah@gmail.com Ø£Ùˆ: salah" autocomplete="email"/>
      <div class="small" style="margin-top:6px">Ù„Ùˆ ÙƒØªØ¨Øª Ø§Ø³Ù… Ø¨Ø¯ÙˆÙ† @ Ù‡ÙŠØªØ­ÙˆÙ„ Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙ‡Ù…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    </div>

    <div class="field">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="password" type="password" placeholder="6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±" autocomplete="current-password"/>
    </div>

    <div class="field">
      <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
      <div class="row">
        <button class="btn roleBtn" id="rolePassenger" type="button">ğŸš• Ø±Ø§ÙƒØ¨</button>
        <button class="btn roleBtn" id="roleDriver" type="button">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</button>
      </div>
      <div class="small" style="margin-top:8px">
        Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±. Ø¨Ø¹Ø¯ ÙƒØ¯Ù‡ Ù‡ÙŠØªØ«Ø¨Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø´ Ù‡ÙŠØªØºÙŠØ±).
      </div>
    </div>

    <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driverFields" class="card" style="margin-top:10px">
      <div class="field" style="margin-top:0">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <select id="vehicle">
          <option value="tuktuk">ØªÙˆÙƒØªÙˆÙƒ</option>
          <option value="motor_delivery">Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
          <option value="car">Ø³ÙŠØ§Ø±Ø© Ù…Ù„Ø§ÙƒÙŠ</option>
          <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
          <option value="tamanya">ØªÙ…Ù†Ø§ÙŠØ©</option>
          <option value="caboot">Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</option>
        </select>
      </div>
      <div class="field">
        <label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <input id="model" placeholder="Ù…Ø«Ø§Ù„: 2020" />
      </div>
      <div class="small">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†ÙˆØ¹ + Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù„Ù„Ø±Ø§ÙƒØ¨ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.</div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div class="field" style="margin-top:0">
        <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
        <select id="gov">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
        </select>
      </div>

      <div class="field" style="margin-top:0">
        <label>Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ø­ÙŠ</label>
        <select id="center" disabled>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
        </select>
      </div>
    </div>

    <div id="otherCenterWrap" class="field">
      <label>Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ² (Ù„Ùˆ Ø§Ø®ØªØ±Øª "Ø£Ø®Ø±Ù‰")</label>
      <input id="centerOther" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙƒØ² Ø¬Ø¯ÙŠØ¯â€¦" />
      <div class="small" style="margin-top:6px">Ø§ÙƒØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±ÙÙŠÙ†.</div>
    </div>

    <div class="btns">
      <button class="btn primary" id="loginBtn" type="button">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="hint" id="msg" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { auth, db, qs, emailLoginOrSignup, ensureUserDoc, saveUserProfile } from "./app.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);

    const emailEl = $("email");
    const passEl  = $("password");
    const phoneEl = $("phone"); // âœ… NEW
    const msg     = $("msg");

    const rolePassenger = $("rolePassenger");
    const roleDriver = $("roleDriver");

    const govEl = $("gov");
    const centerEl = $("center");
    const centerOtherEl = $("centerOther");
    const otherWrap = $("otherCenterWrap");

    const nameEl = $("name");
    const vehicleEl = $("vehicle");
    const modelEl = $("model");
    const driverFields = $("driverFields");

    const loginBtn = $("loginBtn");

    window.addEventListener("error", (e)=>{
      try{ msg.textContent = "âŒ Ø®Ø·Ø£: " + (e?.message || "unknown"); }catch{}
    });
    window.addEventListener("unhandledrejection", (e)=>{
      try{
        const r = e?.reason;
        msg.textContent = "âŒ Ø®Ø·Ø£: " + (r?.code || r?.message || String(r || "unknown"));
      }catch{}
    });

    const OTHER="__other__";
    let selectedRole = null;

    const LS = {
      email:"mw_login_email",
      gov:"mw_login_gov",
      center:"mw_login_center",
      centerOther:"mw_login_center_other",
      role:"mw_login_role",
      name:"mw_login_name",
      phone:"mw_login_phone", // âœ… NEW
      vehicle:"mw_login_vehicle",
      model:"mw_login_model",
    };

    // âœ… phone normalize (ÙŠØ­Ø°Ù Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø´Ø±Ø·Ø§Øªâ€¦)
    function normalizePhone(x){
      let v = String(x||"").trim();
      if(!v) return null;
      v = v.replace(/[^\d+]/g,"");       // Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ùˆ +
      if(v.startsWith("00")) v = "+" + v.slice(2);
      // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù…Ù†Ø·Ù‚ÙŠ
      const digits = v.replace(/\D/g,"");
      if(digits.length < 8 || digits.length > 15) return null;
      return v;
    }

    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    function fillGov(){
      Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
        const opt=document.createElement("option");
        opt.value=g; opt.textContent=g;
        govEl.appendChild(opt);
      });
    }

    function fillCenters(gov, pre=null){
      centerEl.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>`;
      otherWrap.style.display="none";
      centerOtherEl.value="";

      const arr=(AREAS[gov]||[]).slice().sort((a,b)=>a.localeCompare(b,"ar"));
      arr.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c; opt.textContent=c;
        centerEl.appendChild(opt);
      });

      const other=document.createElement("option");
      other.value=OTHER;
      other.textContent="Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      centerEl.appendChild(other);

      centerEl.disabled = !gov;

      if(pre){
        const exists=[...centerEl.options].some(o=>o.value===pre);
        if(exists){
          centerEl.value=pre;
        }else{
          centerEl.value=OTHER;
          otherWrap.style.display="block";
          centerOtherEl.value=pre;
        }
      }
    }

    fillGov();

    govEl.addEventListener("change", ()=>{
      const g=(govEl.value||"").trim();
      if(!g){
        centerEl.disabled=true;
        centerEl.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>`;
        otherWrap.style.display="none";
        centerOtherEl.value="";
        saveDraft();
        return;
      }
      fillCenters(g);
      saveDraft();
    });

    centerEl.addEventListener("change", ()=>{
      if(centerEl.value===OTHER){
        otherWrap.style.display="block";
        centerOtherEl.focus();
      }else{
        otherWrap.style.display="none";
        centerOtherEl.value="";
      }
      saveDraft();
    });

    function normalizeEmail(x){
      let v = String(x||"").trim();
      if(!v) return null;

      if(!v.includes("@")){
        v = v.replace(/\s+/g,"").replace(/[^\w.-]/g,"");
        if(!v) v = "user";
        v = `${v}@meshwarak.local`;
      }
      if(/^[^@]+@$/.test(v)) v = v + "meshwarak.local";
      return v.toLowerCase();
    }

    function saveDraft(){
      try{
        localStorage.setItem(LS.email, emailEl?.value || "");
        localStorage.setItem(LS.phone, phoneEl?.value || ""); // âœ… NEW
        localStorage.setItem(LS.gov, govEl?.value || "");
        localStorage.setItem(LS.center, centerEl?.value || "");
        localStorage.setItem(LS.centerOther, centerOtherEl?.value || "");
        localStorage.setItem(LS.role, selectedRole || "");
        localStorage.setItem(LS.name, nameEl?.value || "");
        localStorage.setItem(LS.vehicle, vehicleEl?.value || "");
        localStorage.setItem(LS.model, modelEl?.value || "");
      }catch{}
    }

    function setRole(role){
      selectedRole = role;
      rolePassenger.classList.remove("active");
      roleDriver.classList.remove("active","driver");
      driverFields.style.display="none";

      if(role==="passenger"){
        rolePassenger.classList.add("active");
      }else if(role==="driver"){
        roleDriver.classList.add("active","driver");
        driverFields.style.display="block";
      }
      saveDraft();
    }

    rolePassenger.addEventListener("click", ()=> setRole("passenger"));
    roleDriver.addEventListener("click", ()=> setRole("driver"));

    function restoreDraft(){
      try{
        emailEl.value = localStorage.getItem(LS.email) || "";
        phoneEl.value = localStorage.getItem(LS.phone) || ""; // âœ… NEW
        nameEl.value = localStorage.getItem(LS.name) || "";

        const role = localStorage.getItem(LS.role) || "";
        if(role==="passenger" || role==="driver") setRole(role);

        vehicleEl.value = localStorage.getItem(LS.vehicle) || vehicleEl.value;
        modelEl.value = localStorage.getItem(LS.model) || "";

        const g = localStorage.getItem(LS.gov) || "";
        const c = localStorage.getItem(LS.center) || "";
        const co = localStorage.getItem(LS.centerOther) || "";

        if(g){
          govEl.value = g;
          const pre = (c===OTHER) ? (co||null) : (c||null);
          fillCenters(g, pre);

          if(c){
            centerEl.value = c;
            if(c===OTHER){
              otherWrap.style.display="block";
              centerOtherEl.value = co || "";
            }else{
              otherWrap.style.display="none";
              centerOtherEl.value = "";
            }
          }
        }
      }catch{}
    }

    [emailEl, passEl, phoneEl, govEl, centerEl, centerOtherEl, nameEl, vehicleEl, modelEl]
      .filter(Boolean)
      .forEach(el => {
        el.addEventListener("input", saveDraft);
        el.addEventListener("change", saveDraft);
      });

    restoreDraft();

    function getArea(){
      const governorate = (govEl.value || "").trim() || null;
      const cVal = (centerEl.value || "").trim();
      if(!governorate) return { governorate:null, center:null };
      if(!cVal) return { governorate, center:null };
      if(cVal===OTHER){
        const manual = (centerOtherEl.value || "").trim();
        return { governorate, center: (manual.length>=2 ? manual : null) };
      }
      return { governorate, center: cVal || null };
    }

    function goAfterLogin(role){
      const returnTo = qs("returnTo");
      if(returnTo){ location.href = returnTo; return; }
      location.href = (role==="passenger") ? "passenger.html" : "driver.html";
    }

    function lockUI(locked){
      loginBtn.disabled = locked;
      rolePassenger.disabled = locked;
      roleDriver.disabled = locked;
      govEl.disabled = locked;
      centerEl.disabled = locked || !govEl.value;
      centerOtherEl.disabled = locked;
      emailEl.disabled = locked;
      passEl.disabled = locked;
      phoneEl.disabled = locked; // âœ… NEW
      nameEl.disabled = locked;
      vehicleEl.disabled = locked;
      modelEl.disabled = locked;
    }

    async function handleLogin(){
      msg.textContent = "";
      saveDraft();

      const email = normalizeEmail(emailEl.value || "");
      const password = String(passEl.value || "");
      const phone = normalizePhone(phoneEl.value || ""); // âœ… NEW

      if(!phone){ msg.textContent = "âŒ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (8 Ø¥Ù„Ù‰ 15 Ø±Ù‚Ù…)."; return; }
      if(!email){ msg.textContent = "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø£Ùˆ Ø§Ø³Ù… ÙÙ‚Ø· ÙˆØ³ÙŠÙØ­ÙˆÙ‘ÙÙ„ Ù„ÙˆÙ‡Ù…ÙŠ)."; return; }
      if(!password || password.length < 6){ msg.textContent = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ù‚Ù„ Ø´ÙŠØ¡ 6 Ø£Ø­Ø±Ù."; return; }
      if(!selectedRole){ msg.textContent = "âŒ Ø§Ø®ØªØ± Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚."; return; }

      const area = getArea();
      if(!area.governorate || !area.center){
        msg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².";
        return;
      }

      if(selectedRole==="driver"){
        const v=(vehicleEl.value||"").trim();
        const m=(modelEl.value||"").trim();
        if(!v){ msg.textContent="âŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."; return; }
        if(!m || m.length<2){ msg.textContent="âŒ Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."; return; }
      }

      lockUI(true);
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦";

      try{
        const res = await emailLoginOrSignup(email, password);
        const uid = res.user.uid;

        const snap = await getDoc(doc(db,"users",uid)).catch(()=>null);
        const existing = (snap && typeof snap.exists==="function" && snap.exists()) ? snap.data() : null;

        const finalRole = (existing?.role === "passenger" || existing?.role === "driver")
          ? existing.role
          : selectedRole;

        if(existing?.role && existing.role !== selectedRole){
          msg.textContent = "âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø¯ÙˆØ± Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ).";
        }

        if(finalRole === "driver"){
          const vNeed = (existing?.vehicle || vehicleEl.value || "").trim();
          const mNeed = (existing?.model || modelEl.value || "").trim();
          if(!vNeed || !mNeed || mNeed.length < 2){
            lockUI(false);
            setRole("driver");
            msg.textContent = "âŒ Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ù†ÙˆØ¹ + Ù…ÙˆØ¯ÙŠÙ„) Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ø¬ÙŠÙ„.";
            return;
          }
        }

        await ensureUserDoc(uid, {
          role: finalRole,
          email: res.user.email || email,
          name: (nameEl.value||"").trim() || existing?.name || null,
          phone: phone || existing?.phone || null, // âœ… NEW
          governorate: area.governorate,
          center: area.center,
          vehicle: finalRole==="driver" ? ((existing?.vehicle)||vehicleEl.value||null) : null,
          model: finalRole==="driver" ? ((existing?.model)||((modelEl.value||"").trim()||null)) : null,
        });

        await saveUserProfile(uid, {
          role: finalRole,
          email: res.user.email || email,
          name: (nameEl.value||"").trim() || existing?.name || null,
          phone: phone || existing?.phone || null, // âœ… NEW
          governorate: area.governorate,
          center: area.center,
          vehicle: finalRole==="driver" ? ((existing?.vehicle)||vehicleEl.value||null) : null,
          model: finalRole==="driver" ? ((existing?.model)||((modelEl.value||"").trim()||null)) : null,
          updatedAt: serverTimestamp()
        });

        msg.textContent = "âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        goAfterLogin(finalRole);
      }catch(e){
        console.error(e);
        const code = e?.code || e?.message || "unknown";

        if(code === "bad-email"){
          msg.textContent = "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ø³Ù… ÙÙ‚Ø·.";
        }else if(code === "bad-pass"){
          msg.textContent = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ù‚Ù„ Ø´ÙŠØ¡ 6 Ø£Ø­Ø±Ù.";
        }else if(code==="auth/operation-not-allowed"){
          msg.textContent = "âŒ ÙØ¹Ù„ Email/Password Ù…Ù† Firebase Auth Ø£ÙˆÙ„Ø§Ù‹ (Sign-in method).";
        }else if(code==="auth/invalid-api-key" || code==="auth/configuration-not-found"){
          msg.textContent = "âŒ Firebase config ØºÙ„Ø· ÙÙŠ app.js (apiKey/authDomain...).";
        }else if(code==="auth/wrong-password" || code==="auth/invalid-login-credentials"){
          msg.textContent = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        }else if(code==="auth/network-request-failed"){
          msg.textContent = "âŒ Ù…Ø´ÙƒÙ„Ø© Ø´Ø¨ÙƒØ©/Ø­Ø¸Ø±/VPN. Ø¬Ø±Ù‘Ø¨ Ø¨Ø¯ÙˆÙ† VPN.";
        }else{
          msg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + code;
        }
      }finally{
        lockUI(false);
      }
    }

    loginBtn.addEventListener("click", handleLogin);

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      const snap = await getDoc(doc(db,"users",user.uid)).catch(()=>null);
      const role = (snap && typeof snap.exists === "function" && snap.exists()) ? (snap.data().role || null) : null;
      if(role==="passenger" || role==="driver") goAfterLogin(role);
    });
  </script>
</body>
</html>
