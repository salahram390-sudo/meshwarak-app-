<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>مشوارك - تسجيل الدخول</title>
  <link rel="icon" href="./favicon.png">
  <link rel="stylesheet" href="./styles.css">
  <meta name="theme-color" content="#050B16" />
</head>

<body>
  <div class="container" style="min-height:calc(100vh - 32px);display:grid;place-items:center">
    <div class="card" style="width:min(560px, 100%); text-align:center">

      <div style="display:flex;justify-content:center;margin-bottom:12px">
        <div class="logo" style="width:54px;height:54px;border-radius:18px;font-size:22px">م</div>
      </div>

      <h1 style="margin:0;font-size:20px">تسجيل الدخول / إنشاء حساب</h1>
      <p class="hint" style="margin:8px 0 14px">اختار تدخل كـ راكب أو سائق — نفس الإيميل يشتغل في الاتنين ✅</p>

      <div class="actions" style="justify-content:center;gap:10px;flex-wrap:wrap">
        <button class="btn" id="roleDriver" type="button" style="min-width:160px">سائق</button>
        <button class="btn primary" id="rolePassenger" type="button" style="min-width:160px">راكب</button>
      </div>

      <div class="field" style="margin-top:14px;text-align:right">
        <label>الإيميل</label>
        <input id="email" inputmode="email" autocomplete="email" placeholder="example@gmail.com" />
      </div>

      <div class="field" style="margin-top:10px;text-align:right">
        <label>كلمة المرور (6 أحرف على الأقل)</label>
        <input id="password" type="password" autocomplete="current-password" placeholder="******" />
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="field" style="margin-top:0;text-align:right">
          <label>الاسم (اختياري)</label>
          <input id="name" placeholder="اسمك" />
        </div>
        <div class="field" style="margin-top:0;text-align:right">
          <label>رقم الهاتف (مهم لتجنب الطلبات الوهمية)</label>
          <input id="phone" inputmode="tel" placeholder="01xxxxxxxxx" />
        </div>
      </div>

      <div class="actions" style="justify-content:center;margin-top:14px;flex-wrap:wrap">
        <button class="btn success" id="signupBtn" type="button" style="min-width:200px">إنشاء حساب</button>
        <button class="btn primary" id="loginBtn" type="button" style="min-width:200px">تسجيل دخول</button>
      </div>

      <p id="msg" class="hint" style="margin:12px 0 0"></p>
      <p id="err" class="hint" style="margin:8px 0 0;color:#ff6b6b"></p>

      <div class="actions" style="justify-content:center;margin-top:12px">
        <a class="btn" href="./index.html" style="min-width:220px">⬅️ رجوع للرئيسية</a>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      emailSignIn, emailSignUp, normalizeEmail, normalizePassword, normalizePhone,
      ensureUserDoc, saveUserProfile, enableRole, setActiveRole, qs, auth
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);

    const roleDriverBtn = $("roleDriver");
    const rolePassengerBtn = $("rolePassenger");
    const emailEl = $("email");
    const passEl = $("password");
    const nameEl = $("name");
    const phoneEl = $("phone");
    const msgEl = $("msg");
    const errEl = $("err");

    // role from query ?role=driver/passenger
    let role = (qs("role")==="driver") ? "driver" : "passenger";

    function renderRole(){
      roleDriverBtn.classList.toggle("primary", role==="driver");
      rolePassengerBtn.classList.toggle("primary", role==="passenger");
    }
    roleDriverBtn.onclick = ()=>{ role="driver"; renderRole(); };
    rolePassengerBtn.onclick = ()=>{ role="passenger"; renderRole(); };
    renderRole();

    function niceErr(e){
      const code = e?.code || "";
      const msg  = e?.message || "";

      // ✅ أهم سبب على GitHub Pages
      if(code === "auth/unauthorized-domain"){
        return "❌ الدومين غير مسموح في Firebase. لازم تضيف 0-sudo.github.io في Authorized domains.";
      }

      if(code === "auth/operation-not-allowed"){
        return "❌ Email/Password مش متفعّل في Firebase. فعّله من Authentication → Sign-in method.";
      }

      if(code === "auth/invalid-email") return "❌ الإيميل غير صحيح.";
      if(code === "auth/missing-password") return "❌ اكتب كلمة المرور.";
      if(code === "auth/weak-password") return "❌ كلمة المرور ضعيفة. لازم 6 أحرف أو أكثر.";
      if(code === "auth/email-already-in-use") return "❌ الإيميل مستخدم قبل كده. اضغط تسجيل دخول.";
      if(code === "auth/invalid-credential" || code === "auth/wrong-password") return "❌ بيانات الدخول غير صحيحة.";
      if(code === "auth/user-not-found") return "❌ الحساب غير موجود. اضغط إنشاء حساب.";

      if(msg.includes("bad-email")) return "❌ اكتب الإيميل.";
      if(msg.includes("bad-pass")) return "❌ كلمة المرور لازم 6 أحرف أو أكثر.";

      return "❌ فشل. " + (code || msg || "سبب غير معروف");
    }

    async function afterAuth(user){
      // ✅ ارفع الدور لFirestore + LocalStorage (نفس الإيميل يشتغل في الاتنين)
      await enableRole(user.uid, role);

      // ✅ حفظ الاسم/الهاتف (لو موجودين)
      const name = String(nameEl.value||"").trim() || null;
      const phone = normalizePhone(phoneEl.value) || null;

      // ✅ امنع الطلبات الوهمية: هنسمح بالتسجيل بدون رقم، بس الطلب نفسه يمنع (زي ما عندك)
      await ensureUserDoc(user.uid, {
        roles: { passenger:true }, // default
        activeRole: role,
        email: user.email || normalizeEmail(emailEl.value) || null,
        name, phone
      });

      if(name || phone){
        await saveUserProfile(user.uid, {
          name: name || null,
          phone: phone || null,
          email: user.email || null
        });
      }

      // redirect
      setActiveRole(role);
      location.href = (role==="driver") ? "./driver.html" : "./passenger.html";
    }

    $("signupBtn").onclick = async ()=>{
      errEl.textContent = "";
      msgEl.textContent = "جارٍ إنشاء الحساب...";
      try{
        const email = normalizeEmail(emailEl.value);
        const pass  = normalizePassword(passEl.value);
        if(!email) throw new Error("bad-email");
        if(!pass) throw new Error("bad-pass");

        const cred = await emailSignUp(email, pass);
        msgEl.textContent = "✅ تم إنشاء الحساب.";
        await afterAuth(cred.user);
      }catch(e){
        msgEl.textContent = "";
        errEl.textContent = niceErr(e);
      }
    };

    $("loginBtn").onclick = async ()=>{
      errEl.textContent = "";
      msgEl.textContent = "جارٍ تسجيل الدخول...";
      try{
        const email = normalizeEmail(emailEl.value);
        const pass  = normalizePassword(passEl.value);
        if(!email) throw new Error("bad-email");
        if(!pass) throw new Error("bad-pass");

        const cred = await emailSignIn(email, pass);
        msgEl.textContent = "✅ تم تسجيل الدخول.";
        await afterAuth(cred.user);
      }catch(e){
        msgEl.textContent = "";
        errEl.textContent = niceErr(e);
      }
    };
  </script>
</body>
</html>
