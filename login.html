<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    html,body{overflow:auto}
    .box{
      width:92%;max-width:520px;margin:18px auto;padding:18px;
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid var(--stroke);border-radius:22px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    h1{margin:0 0 10px;font-size:18px;text-align:center}
    p{margin:0 0 12px;opacity:.85;text-align:center;color:var(--muted)}
    .roleBtn{background: rgba(255,255,255,.06)}
    .roleBtn.active{
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(43,108,255,.72));
      border:1px solid rgba(43,108,255,.35);
    }
    .roleBtn.active.driver{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.62));
      border:1px solid rgba(34,197,94,.35);
      color:#04110a;
    }
    .btns{display:grid;gap:10px;margin-top:12px}
    .sep{height:1px;background:var(--stroke);margin:14px 0}

    /* Toast (Ø®Ù„ÙŠÙ‡Ø§ Ù‡Ù†Ø§ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ØµÙØ­Ø© ØªØ´ØªØºÙ„ Ù„ÙˆØ­Ø¯Ù‡Ø§ Ø­ØªÙ‰ Ù„Ùˆ styles.css Ù…Ø´ ÙÙŠÙ‡) */
    .toast-wrap{position:fixed;left:12px;right:12px;top:12px;z-index:9999;display:grid;gap:10px;pointer-events:none}
    .toast{
      pointer-events:none;
      display:flex;gap:10px;align-items:center;
      padding:12px 14px;border-radius:16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,18,32,.92), rgba(10,18,34,.85));
      box-shadow:0 18px 55px rgba(0,0,0,.35);
      animation:toastIn .18s ease;
    }
    .toast .t-ic{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;background:rgba(255,255,255,.07);border:1px solid var(--stroke)}
    .toast.ok{border-color: rgba(34,197,94,.25)}
    .toast.bad{border-color: rgba(255,92,122,.25)}
    @keyframes toastIn{from{transform:translateY(-6px);opacity:.0}to{transform:none;opacity:1}}
  </style>
</head>

<body>
  <div class="toast-wrap" id="toasts"></div>

  <div class="box">
    <h1>ğŸ” Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h1>
    <p>Gmail + Ø¨Ø§Ø³ÙˆØ±Ø¯ + Ø§Ø³Ù…Ùƒ + Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ + (Ø±Ø§ÙƒØ¨/Ø³Ø§Ø¦Ù‚) + Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ²</p>

    <div class="field" style="margin-top:0">
      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="name" placeholder="Ù…Ø«Ø§Ù„: ØµÙ„Ø§Ø­" autocomplete="name"/>
    </div>

    <div class="field">
      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù‡ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨)</label>
      <input id="phone" placeholder="01xxxxxxxxx" inputmode="tel" autocomplete="tel"/>
      <div class="small" style="margin-top:6px">ÙŠÙØ¶Ù„ Ø±Ù‚Ù… Ù…ØµØ±ÙŠ: 01 + 9 Ø£Ø±Ù‚Ø§Ù…</div>
    </div>

    <div class="field">
      <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù„Ø§Ø²Ù… ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com)</label>
      <input id="email" placeholder="example@gmail.com" autocomplete="email"/>
    </div>

    <div class="field">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="pass" type="password" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø§Ø³ÙˆØ±Ø¯" autocomplete="current-password"/>
    </div>

    <div class="field">
      <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
      <div class="row">
        <button class="btn roleBtn" id="rolePassenger" type="button">ğŸš• Ø±Ø§ÙƒØ¨</button>
        <button class="btn roleBtn" id="roleDriver" type="button">ğŸ§‘â€âœˆï¸ Ø³Ø§Ø¦Ù‚</button>
      </div>
      <div class="small" style="margin-top:8px">
        Ù„Ùˆ Ø¨ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¯Ù‡ØŒ Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø§Ù„Ø¯ÙˆØ±.
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div class="field" style="margin-top:0">
        <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
        <select id="gov">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
        </select>
      </div>

      <div class="field" style="margin-top:0">
        <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
        <select id="center" disabled>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
        </select>
      </div>
    </div>

    <div id="otherCenterWrap" class="field" style="display:none">
      <label>Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø§Ø®ØªØ±Øª "Ø£Ø®Ø±Ù‰")</label>
      <input id="centerOther" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙƒØ² Ø¬Ø¯ÙŠØ¯â€¦" />
      <div class="small" style="margin-top:6px">Ø§ÙƒØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±ÙÙŠÙ†.</div>
    </div>

    <div class="btns">
      <button class="btn primary" id="signupBtn" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <button class="btn secondary" id="loginBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="hint" id="msg" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { auth, db } from "./app.js";

    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Helpers
    const $ = (id)=> document.getElementById(id);
    const qs = (k)=> new URLSearchParams(location.search).get(k);

    const toasts = $("toasts");
    function toast(text, type="ok", icon="âœ…", ms=2600){
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `<div class="t-ic">${icon}</div><div>${text}</div>`;
      toasts.appendChild(el);
      setTimeout(()=>{ try{el.remove();}catch{} }, ms);
    }

    const nameEl  = $("name");
    const phoneEl = $("phone");
    const emailEl = $("email");
    const passEl  = $("pass");
    const msg     = $("msg");

    const signupBtn = $("signupBtn");
    const loginBtn  = $("loginBtn");

    const rolePassenger = $("rolePassenger");
    const roleDriver    = $("roleDriver");

    const govEl = $("gov");
    const centerEl = $("center");
    const otherWrap = $("otherCenterWrap");
    const centerOtherEl = $("centerOther");

    const OTHER = "__other__";

    const LS = {
      role: "mw_role",
      gov: "mw_gov",
      center: "mw_center",
      centerOther: "mw_center_other",
      name: "mw_name",
      phone: "mw_phone",
      email: "mw_email"
    };

    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    function isGmail(email){ return /@gmail\.com$/i.test((email||"").trim()); }

    function normalizePhone(p){
      const x = (p||"").trim().replace(/\s+/g,"");
      if(!x) return null;
      // ÙŠÙ‚Ø¨Ù„ 01xxxxxxxxx Ø£Ùˆ +20/0020
      if(/^01\d{9}$/.test(x)) return x;
      if(/^(?:\+20|0020)1\d{9}$/.test(x)) return x.replace(/^0020/,"+20");
      return null;
    }

    function lockUI(locked){
      signupBtn.disabled = locked;
      loginBtn.disabled  = locked;
      rolePassenger.disabled = locked;
      roleDriver.disabled = locked;
      govEl.disabled = locked;
      centerEl.disabled = locked || !govEl.value;
      centerOtherEl.disabled = locked;
      nameEl.disabled = locked;
      phoneEl.disabled = locked;
      emailEl.disabled = locked;
      passEl.disabled = locked;
    }

    function setRole(role){
      localStorage.setItem(LS.role, role || "");
      rolePassenger.classList.remove("active");
      roleDriver.classList.remove("active","driver");
      if(role === "passenger") rolePassenger.classList.add("active");
      if(role === "driver") roleDriver.classList.add("active","driver");
    }

    function getRole(){
      const r = localStorage.getItem(LS.role) || null;
      return (r==="passenger"||r==="driver") ? r : null;
    }

    function fillGov(){
      Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(k=>{
        const opt = document.createElement("option");
        opt.value = k; opt.textContent = k;
        govEl.appendChild(opt);
      });
    }

    function fillCenters(gov, preselect=null){
      centerEl.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>`;
      otherWrap.style.display = "none";
      centerOtherEl.value = "";

      const arr = (AREAS[gov] || []).slice().sort((a,b)=>a.localeCompare(b,"ar"));
      arr.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        centerEl.appendChild(opt);
      });

      const other = document.createElement("option");
      other.value = OTHER;
      other.textContent = "Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      centerEl.appendChild(other);

      centerEl.disabled = !gov;

      if(preselect){
        const exists = Array.from(centerEl.options).some(o=>o.value===preselect);
        if(exists) centerEl.value = preselect;
        else{
          centerEl.value = OTHER;
          otherWrap.style.display = "block";
          centerOtherEl.value = preselect;
        }
      }
    }

    function getArea(){
      const governorate = (govEl.value || "").trim() || null;
      const cVal = (centerEl.value || "").trim();
      if(!governorate) return { governorate:null, center:null };
      if(!cVal) return { governorate, center:null };
      if(cVal === OTHER){
        const manual = (centerOtherEl.value || "").trim();
        return { governorate, center: (manual.length >= 2 ? manual : null) };
      }
      return { governorate, center: cVal || null };
    }

    function saveAreaLS(){
      const { governorate, center } = getArea();
      localStorage.setItem(LS.gov, governorate || "");
      if(centerEl.value === OTHER){
        localStorage.setItem(LS.center, OTHER);
        localStorage.setItem(LS.centerOther, centerOtherEl.value || "");
      }else{
        localStorage.setItem(LS.center, center || "");
        localStorage.removeItem(LS.centerOther);
      }
    }

    function restoreAreaLS(){
      const g = localStorage.getItem(LS.gov) || "";
      const c = localStorage.getItem(LS.center) || "";
      const co = localStorage.getItem(LS.centerOther) || "";
      if(g){
        govEl.value = g;
        fillCenters(g, (c && c !== OTHER) ? c : (co || null));
        if(c === OTHER){
          centerEl.value = OTHER;
          otherWrap.style.display = "block";
          centerOtherEl.value = co;
        }
      }
    }

    function goAfterLogin(role){
      const returnTo = qs("returnTo");
      if(returnTo){ location.href = returnTo; return; }
      location.href = (role === "passenger") ? "passenger.html" : "driver.html";
    }

    async function getUserDoc(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function upsertUser(uid, payload){
      const ref = doc(db, "users", uid);
      await setDoc(ref, { ...payload, updatedAt: serverTimestamp() }, { merge: true });
    }

    // ===== Init UI
    fillGov();

    // restore cached inputs
    nameEl.value  = localStorage.getItem(LS.name) || "";
    phoneEl.value = localStorage.getItem(LS.phone) || "";
    emailEl.value = localStorage.getItem(LS.email) || "";

    nameEl.addEventListener("input", ()=> localStorage.setItem(LS.name, nameEl.value || ""));
    phoneEl.addEventListener("input", ()=> localStorage.setItem(LS.phone, phoneEl.value || ""));
    emailEl.addEventListener("input", ()=> localStorage.setItem(LS.email, emailEl.value || ""));

    govEl.addEventListener("change", ()=>{
      fillCenters(govEl.value);
      saveAreaLS();
      msg.textContent = "";
    });

    centerEl.addEventListener("change", ()=>{
      if(centerEl.value === OTHER){
        otherWrap.style.display = "block";
        centerOtherEl.focus();
      }else{
        otherWrap.style.display = "none";
        centerOtherEl.value = "";
      }
      saveAreaLS();
      msg.textContent = "";
    });

    centerOtherEl.addEventListener("input", saveAreaLS);

    rolePassenger.addEventListener("click", ()=> setRole("passenger"));
    roleDriver.addEventListener("click", ()=> setRole("driver"));

    // role from url has priority
    const roleFromUrl = qs("role");
    if(roleFromUrl === "passenger" || roleFromUrl === "driver") setRole(roleFromUrl);
    else setRole(getRole());

    restoreAreaLS();

    // ===== Auto redirect if already logged
    onAuthStateChanged(auth, async (u) => {
      if(!u) return;
      try{
        const data = await getUserDoc(u.uid);
        if(data?.role === "passenger" || data?.role === "driver"){
          goAfterLogin(data.role);
        }
      }catch(e){ console.error(e); }
    });

    // ===== Actions
    async function handleSignup(){
      msg.textContent = "";

      const name  = nameEl.value.trim();
      const phone = normalizePhone(phoneEl.value);
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      const role  = getRole();
      const area  = getArea();

      if(!name || name.length < 2) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).","bad","âœï¸");
      if(!phone) return toast("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 01xxxxxxxxx).","bad","ğŸ“");
      if(!isGmail(email)) return toast("Ù„Ø§Ø²Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com","bad","ğŸ“§");
      if(pass.length < 6) return toast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… 6 Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±.","bad","ğŸ”’");
      if(!role) return toast("Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚.","bad","ğŸš–");
      if(!area.governorate || !area.center) return toast("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².","bad","ğŸ“");

      lockUI(true);
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦";

      try{
        const res = await createUserWithEmailAndPassword(auth, email, pass);

        await upsertUser(res.user.uid, {
          name, phone, email,
          role,
          governorate: area.governorate,
          center: area.center,
          createdAt: serverTimestamp()
        });

        msg.textContent = "";
        toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…","ok","âœ…",2200);
        goAfterLogin(role);
      }catch(e){
        console.error(e);
        msg.textContent = "";
        toast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ù…ÙƒÙ† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡).","bad","âŒ",3200);
      }finally{
        lockUI(false);
      }
    }

    async function handleLogin(){
      msg.textContent = "";

      const name  = nameEl.value.trim();
      const phone = normalizePhone(phoneEl.value); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      const area  = getArea();
      const chosenRole = getRole(); // Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬Ù‡ Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø¯ÙŠÙ… Ø¨Ø¯ÙˆÙ† role

      if(!isGmail(email)) return toast("Ù„Ø§Ø²Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @gmail.com","bad","ğŸ“§");
      if(pass.length < 6) return toast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… 6 Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±.","bad","ğŸ”’");

      lockUI(true);
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦";

      try{
        const res = await signInWithEmailAndPassword(auth, email, pass);
        const data = await getUserDoc(res.user.uid);

        let finalRole = data?.role || null;
        if(!finalRole){
          if(!chosenRole){
            msg.textContent = "";
            toast("Ø§Ø®ØªØ± Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚ Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·).","bad","ğŸš–",3000);
            return;
          }
          finalRole = chosenRole;
        }

        // Ù„Ùˆ Ù…ÙÙŠØ´ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ØŒ Ù„Ø§Ø²Ù… ÙŠØ®ØªØ§Ø±Ù‡Ø§ Ù‡Ù†Ø§
        const hasArea = !!(data?.governorate && data?.center);
        if(!hasArea && (!area.governorate || !area.center)){
          msg.textContent = "";
          toast("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².","bad","ğŸ“");
          return;
        }

        const patch = { email, role: finalRole };

        // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        if(name && name.length >= 2) patch.name = name;
        if(phone) patch.phone = phone;

        if(area.governorate && area.center){
          patch.governorate = area.governorate;
          patch.center = area.center;
        }

        await upsertUser(res.user.uid, patch);

        msg.textContent = "";
        toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…","ok","âœ…",1800);
        goAfterLogin(finalRole);
      }catch(e){
        console.error(e);
        msg.textContent = "";
        toast("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø·.","bad","âŒ",2600);
      }finally{
        lockUI(false);
      }
    }

    signupBtn.addEventListener("click", handleSignup);
    loginBtn.addEventListener("click", handleLogin);
  </script>
</body>
</html>
