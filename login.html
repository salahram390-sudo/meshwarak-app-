<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ูุดูุงุฑู - ุชุณุฌูู ุงูุฏุฎูู</title>

  <link rel="icon" href="./favicon.png">
  <link rel="stylesheet" href="./styles.css?v=auth1">
  <meta name="theme-color" content="#050B16" />
</head>

<body>
  <div class="auth-page">
    <div class="auth-glass card">

      <div style="display:flex;justify-content:center;margin-bottom:14px">
        <div class="logo" style="width:70px;height:70px;border-radius:22px;font-size:28px">ู</div>
      </div>

      <h1 class="auth-title">ุชุณุฌูู ุงูุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ</h1>

      <p class="auth-sub">
        ุงุฎุชุฑ ุชุฏุฎู ูู ุฑุงูุจ ุฃู ุณุงุฆู โ ููุณ ุงูุฅูููู ูุดุชุบู ูู ุงูุงุซููู
      </p>

      <div class="auth-chip">โ ููุณ ุงูุฅูููู ูุดุชุบู ูู ุงูุงุซููู</div>

      <!-- โ Segmented role -->
      <div class="seg" style="margin-top:14px">
        <button id="rolePassenger" type="button">
          <span class="ic">๐</span><span>ุฑุงูุจ</span>
        </button>
        <button id="roleDriver" type="button">
          <span class="ic">๐งโโ๏ธ</span><span>ุณุงุฆู</span>
        </button>
      </div>

      <div class="field" style="text-align:right;margin-top:10px">
        <label>ุงูุฅูููู</label>
        <input id="email" type="email" placeholder="example@gmail.com" autocomplete="email" />
      </div>

      <div class="field" style="text-align:right;margin-top:12px">
        <label>ูููุฉ ุงููุฑูุฑ <span class="hint">(6 ุฃุญุฑู ุนูู ุงูุฃูู)</span></label>
        <input id="pass" type="password" placeholder="โขโขโขโขโขโขโขโข" autocomplete="current-password" />
      </div>

      <!-- โ Buttons: login primary / signup secondary -->
      <div class="auth-actions">
        <button class="btn primary" id="loginBtn" type="button">ุชุณุฌูู ุฏุฎูู</button>
        <button class="btn secondary" id="signupBtn" type="button">ุฅูุดุงุก ุญุณุงุจ</button>
      </div>

      <div class="auth-divider"></div>

      <div class="field" style="text-align:right">
        <label>ุงูุงุณู <span class="hint">(ุงุฎุชูุงุฑู)</span></label>
        <input id="name" type="text" placeholder="ุงุณูู" autocomplete="name" />
      </div>

      <div class="field" style="text-align:right;margin-top:12px">
        <label>ุฑูู ุงููุงุชู <span class="hint">(ููู ูุชุฌูุจ ุงูุทูุจุงุช ุงูููููุฉ)</span></label>
        <input id="phone" type="tel" placeholder="01xxxxxxxxx" autocomplete="tel" />
      </div>

      <!-- Driver extra fields -->
      <div id="driverBox" style="display:none;text-align:right;margin-top:14px">
        <div class="auth-divider"></div>

        <div class="field">
          <label>ููุน ุงููุฑูุจุฉ (ููุณุงุฆู)</label>
          <select id="vehicle">
            <option value="">ุงุฎุชุฑ ููุน ุงููุฑูุจุฉโฆ</option>
            <option value="tuktuk">ุชููุชูู</option>
            <option value="motor_delivery">ููุชุณููู ุฏูููุฑู</option>
            <option value="car">ููุงูู</option>
            <option value="microbus">ูููุฑูุจุงุต</option>
            <option value="tamanya">ุชููุงูุฉ</option>
            <option value="caboot">ุนุฑุจูุฉ ูุงุจูุช</option>
          </select>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="field" style="margin-top:0">
            <label>ููุฏูู/ููุฏ ุงููุฑูุจุฉ</label>
            <input id="model" type="text" placeholder="ูุซุงู: 2020 / BYD / ุฅูุฎ" />
          </div>
          <div class="field" style="margin-top:0">
            <label>ุฑูู ุงูููุญุฉ <span class="hint">(ุงุฎุชูุงุฑู)</span></label>
            <input id="plate" type="text" placeholder="ูุซุงู: ุณ ุฌ 1234" />
          </div>
        </div>

        <p class="hint" style="margin:10px 0 0">
          * ุจูุงูุงุช ุงููุฑูุจุฉ ุชุธูุฑ ููุฑุงูุจ ุนูุฏ ูุจูู ุงูุฑุญูุฉ.
        </p>
      </div>

      <p id="msg" class="hint auth-msg"></p>

      <div class="actions" style="justify-content:center;margin-top:12px;flex-wrap:wrap">
        <a class="btn" href="./index.html" style="min-width:220px;text-align:center">โฉ๏ธ ุฑุฌูุน ููุฑุฆูุณูุฉ</a>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      emailSignUp, emailSignIn,
      ensureUserDoc, saveUserProfile,
      setActiveRole
    } from "./app.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");

    const rolePassengerBtn = $("rolePassenger");
    const roleDriverBtn = $("roleDriver");
    const driverBox = $("driverBox");

    const emailEl = $("email");
    const passEl = $("pass");
    const nameEl = $("name");
    const phoneEl = $("phone");

    const vehicleEl = $("vehicle");
    const modelEl = $("model");
    const plateEl = $("plate");

    const signupBtn = $("signupBtn");
    const loginBtn = $("loginBtn");
    const msg = $("msg");

    const url = new URL(location.href);
    const LS_ROLE = "mw_last_role";
    let role =
      (url.searchParams.get("role")==="driver") ? "driver" :
      (url.searchParams.get("role")==="passenger") ? "passenger" :
      (localStorage.getItem(LS_ROLE)==="driver") ? "driver" : "passenger";

    function setRole(r){
      role = (r === "driver") ? "driver" : "passenger";
      try{ localStorage.setItem(LS_ROLE, role); }catch{}
      rolePassengerBtn.classList.toggle("active", role==="passenger");
      roleDriverBtn.classList.toggle("active", role==="driver");
      driverBox.style.display = (role==="driver") ? "block" : "none";
    }
    rolePassengerBtn.addEventListener("click", ()=>setRole("passenger"));
    roleDriverBtn.addEventListener("click", ()=>setRole("driver"));
    setRole(role);

    function setMsg(text, ok=false){
      msg.className = "hint auth-msg " + (ok ? "msgOk" : "msgBad");
      msg.textContent = text || "";
    }

    function niceAuthError(e){
      const code = e?.code || "";
      if(code.includes("auth/email-already-in-use")) return "โ ุงูุฅูููู ูุณุชุฎุฏู ูุจู ูุฏู. ุฌุฑูุจ ุชุณุฌูู ุฏุฎูู.";
      if(code.includes("auth/invalid-email")) return "โ ุงูุฅูููู ุบูุฑ ุตุญูุญ.";
      if(code.includes("auth/weak-password")) return "โ ูููุฉ ุงููุฑูุฑ ุถุนููุฉ. ูุงุฒู 6 ุฃุญุฑู ุนูู ุงูุฃูู.";
      if(code.includes("auth/user-not-found")) return "โ ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ. ุฌุฑูุจ ุฅูุดุงุก ุญุณุงุจ.";
      if(code.includes("auth/wrong-password")) return "โ ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.";
      if(code.includes("auth/invalid-credential")) return "โ ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ.";
      if(code.includes("auth/network-request-failed")) return "โ ูุดููุฉ ุดุจูุฉ. ุฌุฑูุจ ุชุงูู.";
      if(code.includes("auth/too-many-requests")) return "โ ูุญุงููุงุช ูุซูุฑุฉ. ุงุณุชูู ุดููุฉ ูุฌุฑูุจ ุชุงูู.";
      return "โ ูุดู ุงูุนูููุฉ. " + (e?.message || "");
    }

    function validateRoleFields(){
      if(role !== "driver") return { ok:true };
      const v = clean(vehicleEl.value);
      const m = clean(modelEl.value);
      if(!v) return { ok:false, msg:"โ ุงุฎุชุฑ ููุน ุงููุฑูุจุฉ." };
      if(m.length < 2) return { ok:false, msg:"โ ุงูุชุจ ููุฏูู/ููุฏ ุงููุฑูุจุฉ (ุญุฑููู ุนูู ุงูุฃูู)." };
      return { ok:true };
    }

    async function afterAuth(user){
      await ensureUserDoc(user.uid, {
        roles: { passenger:true, driver:true },
        activeRole: role,
        email: user.email || clean(emailEl.value) || null
      });

      const payload = {
        roles: { passenger:true, driver:true },
        activeRole: role,
        name: clean(nameEl.value) || null,
        phone: clean(phoneEl.value) || null,
        email: user.email || clean(emailEl.value) || null
      };

      if(role === "driver"){
        payload.vehicle = clean(vehicleEl.value) || null;
        payload.model = clean(modelEl.value) || null;
        payload.plate = clean(plateEl.value) || null;
      }

      await saveUserProfile(user.uid, payload);
      setActiveRole(role);

      location.href = (role === "driver") ? "./driver.html" : "./passenger.html";
    }

    async function doSignup(){
      try{
        const v = validateRoleFields();
        if(!v.ok){ setMsg(v.msg); return; }

        setMsg("ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจโฆ", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignUp(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    async function doLogin(){
      try{
        const v = validateRoleFields();
        if(role==="driver" && !v.ok){ setMsg(v.msg); return; }

        setMsg("ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎููโฆ", true);
        signupBtn.disabled = true; loginBtn.disabled = true;

        const cred = await emailSignIn(emailEl.value, passEl.value);
        await afterAuth(cred.user);
      }catch(e){
        setMsg(niceAuthError(e));
      }finally{
        signupBtn.disabled = false; loginBtn.disabled = false;
      }
    }

    signupBtn.addEventListener("click", doSignup);
    loginBtn.addEventListener("click", doLogin);
  </script>
</body>
</html>
