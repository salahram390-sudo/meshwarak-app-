<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø±Ø­Ù„Ø©</title>
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./driver.html">Ø±Ø¬ÙˆØ¹</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:14px">
    <div class="card">
      <div class="pills" style="margin-top:0">
        <span class="pill" id="statusPill">Ø§Ù„Ø­Ø§Ù„Ø©: -</span>
        <span class="pill" id="areaPill">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</span>
      </div>

      <div class="hint" id="info" style="margin-top:10px"></div>

      <div class="actions" style="margin-top:12px;flex-wrap:wrap">
        <a class="btn" id="openPickupBtn" target="_blank" style="display:none">ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</a>
        <a class="btn" id="openDropBtn" target="_blank" style="display:none">ÙØªØ­ Ø§Ù„ÙˆØµÙˆÙ„</a>

        <button class="btn primary" id="arrivedBtn" type="button" style="display:none">ÙˆØµÙ„Øª âœ…</button>
        <button class="btn primary" id="startBtn" type="button" style="display:none">Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø© â–¶ï¸</button>
        <button class="btn danger" id="completeBtn" type="button" style="display:none">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ</button>

        <button class="btn" id="backToListBtn" type="button" style="display:none">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc, qs } from "./app.js";

    import {
      doc, onSnapshot, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    const msg = document.getElementById("msg");
    const info = document.getElementById("info");
    const statusPill = document.getElementById("statusPill");
    const areaPill = document.getElementById("areaPill");

    const openPickupBtn = document.getElementById("openPickupBtn");
    const openDropBtn   = document.getElementById("openDropBtn");
    const arrivedBtn    = document.getElementById("arrivedBtn");
    const startBtn      = document.getElementById("startBtn");
    const completeBtn   = document.getElementById("completeBtn");
    const backToListBtn = document.getElementById("backToListBtn");

    // rideId Ù…Ù† ?id=... Ø£Ùˆ Ù…Ù† localStorage
    const rideId = qs("id") || localStorage.getItem("currentTripId");
    if(!rideId){
      info.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
      backToListBtn.style.display = "inline-flex";
      backToListBtn.onclick = ()=> location.href = "driver.html";
      throw new Error("no rideId");
    }

    localStorage.setItem("currentTripId", rideId);

    const rideRef = doc(db, "rides", rideId);

    function osmLink(lat,lng){
      return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`;
    }
    function googleNavLink(lat,lng){
      return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    function render(r){
      statusPill.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status || "-"}`;
      areaPill.textContent = `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${r.governorate || "-"} / ${r.center || "-"}`;

      const pName = r.passengerName || "Ø±Ø§ÙƒØ¨";
      const pEmail = r.passengerEmail || "-";
      const pPhone = r.passengerPhone || null;

      info.innerHTML = `
        <b>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</b> ${rideId}<br>
        <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${pName} (${pEmail})<br>
        <b>Ù…Ù†:</b> ${r.fromText || "-"}<br>
        <b>Ø¥Ù„Ù‰:</b> ${r.toText || "-"}<br>
        ${pPhone ? `<b>Ù‡Ø§ØªÙ:</b> <a href="tel:${pPhone}">${pPhone}</a><br>` : ``}
      `;

      const fromLat = Number(r.from?.lat), fromLng = Number(r.from?.lng);
      const toLat = Number(r.to?.lat), toLng = Number(r.to?.lng);

      // Ø±ÙˆØ§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø·
      if(Number.isFinite(fromLat) && Number.isFinite(fromLng)){
        openPickupBtn.style.display = "inline-flex";
        // Ù„Ùˆ Ø¹Ø§ÙŠØ² â€œÙ…Ù„Ø§Ø­Ø©â€ Ø¨Ø¯Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø©ØŒ Ø¨Ø¯Ù‘Ù„ osmLink Ø¨Ù€ googleNavLink
        openPickupBtn.href = googleNavLink(fromLat, fromLng);
        openPickupBtn.textContent = "ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ (Ù…Ù„Ø§Ø­Ø©)";
      }else{
        openPickupBtn.style.display = "none";
      }

      if(Number.isFinite(toLat) && Number.isFinite(toLng)){
        openDropBtn.style.display = "inline-flex";
        openDropBtn.href = googleNavLink(toLat, toLng);
        openDropBtn.textContent = "ÙØªØ­ Ø§Ù„ÙˆØµÙˆÙ„ (Ù…Ù„Ø§Ø­Ø©)";
      }else{
        openDropBtn.style.display = "none";
      }

      // Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      arrivedBtn.style.display  = "none";
      startBtn.style.display    = "none";
      completeBtn.style.display = "none";
      backToListBtn.style.display = "none";

      if(r.status === "accepted"){
        arrivedBtn.style.display = "inline-flex";
      }
      if(r.status === "arrived"){
        startBtn.style.display = "inline-flex";
      }
      if(r.status === "started"){
        completeBtn.style.display = "inline-flex";
      }
      if(r.status === "completed" || r.status === "canceled"){
        backToListBtn.style.display = "inline-flex";
        backToListBtn.onclick = ()=>{
          localStorage.removeItem("currentTripId");
          location.href = "driver.html";
        };
      }

      // âœ… ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
      // (Ø¹Ù„Ø´Ø§Ù† â€œÙŠÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨â€)
      if(r.status === "accepted" && !localStorage.getItem("autoOpenedPickup_"+rideId)){
        localStorage.setItem("autoOpenedPickup_"+rideId, "1");
        if(openPickupBtn.href) window.open(openPickupBtn.href, "_blank");
      }
    }

    // Ø£Ø²Ø±Ø§Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø­Ù…ÙŠØ© Ø¨Ù€ Rules)
    async function updateStatus(next){
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦";
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(rideRef);
          if(!snap.exists()) throw new Error("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
          const r = snap.data();

          // Ù„Ø§Ø²Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù†ÙØ³Ù‡
          if(r.driverUid !== user.uid) throw new Error("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");

          // Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª ØµØ­ÙŠØ­Ø©
          const ok =
            (r.status === "accepted" && next === "arrived") ||
            (r.status === "arrived"  && next === "started") ||
            (r.status === "started"  && next === "completed");

          if(!ok) throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ù‡Ù†Ø§");

          const patch = { status: next, updatedAt: serverTimestamp() };
          if(next === "arrived")   patch.arrivedAt = serverTimestamp();
          if(next === "started")   patch.startedAt = serverTimestamp();
          if(next === "completed") patch.completedAt = serverTimestamp();

          tx.update(rideRef, patch);
        });
        msg.textContent = "âœ… ØªÙ….";
      }catch(e){
        console.error(e);
        msg.textContent = `âŒ ${e.message || e}`;
      }
    }

    arrivedBtn.onclick  = ()=> updateStatus("arrived");
    startBtn.onclick    = ()=> updateStatus("started");
    completeBtn.onclick = ()=> updateStatus("completed");

    // Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø­Ø¸ÙŠØ©
    onSnapshot(rideRef, (snap)=>{
      if(!snap.exists()){
        statusPill.textContent = "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        info.textContent = "";
        return;
      }
      render(snap.data());
    });
  </script>
</body>
</html>
