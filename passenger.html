<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
  <link rel="stylesheet" href="./styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ===== Topbar ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 90;
      background: rgba(5, 11, 22, 0.78);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .brand p{
      margin:0;
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 52vw;
    }
    .logo{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      font-size: 18px;
    }

    body.page{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      overflow-x: hidden;
    }

    /* ===== Map ===== */
    .mapWrap{
      position: relative;
      flex: 1;
      min-height: calc(100vh - 70px);
      overflow:hidden;
    }
    #map{
      position:absolute;
      inset:0;
      z-index: 1;
    }

    /* ===== Bottom Sheet (Centered + Draggable) ===== */
    .sheet{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(720px, calc(100vw - 24px));
      z-index: 120;

      background: rgba(15, 24, 45, 0.72);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 28px 28px 22px 22px;
      box-shadow: 0 30px 95px rgba(0,0,0,.62);
      backdrop-filter: blur(18px);

      overflow: hidden;
      will-change: transform;
      touch-action: none; /* Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ù„Ù„Ø³Ø­Ø¨ */
    }

    .sheetHeader{
      padding: 10px 14px 8px;
      display:flex;
      justify-content:center;
      cursor: grab;
      user-select:none;
    }
    .sheetHeader:active{ cursor: grabbing; }

    .sheetHandle{
      width: 64px;
      height: 7px;
      border-radius: 99px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.10);
    }

    .sheetBody{
      padding: 14px 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(80vh - 48px);
      touch-action: pan-y; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´ÙŠØª */
    }

    /* ===== Content ===== */
    .sectionTitle{
      margin: 4px 0 10px;
      font-weight: 900;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      text-align: center;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width:520px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      line-height: 1.6;
      text-align:center;
    }

    .sep{
      height: 1px;
      background: rgba(255,255,255,0.06);
      margin: 14px 0;
    }

    /* ===== Vehicle Pills ===== */
    .pills{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .pillBtn{
      flex: 1;
      min-width: 120px;
      border-radius: 18px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(10, 16, 32, 0.55);
      cursor:pointer;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }

    .pillBtn:active{ transform: scale(.985); }

    .pillBtn.active{
      background: linear-gradient(135deg, var(--blue1), var(--blue2));
      border-color: rgba(255,255,255,0.16);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.35),
        0 0 0 3px rgba(46,107,255,0.14),
        inset 0 1px 0 rgba(255,255,255,0.16);
    }

    /* ===== Actions ===== */
    .actions{
      display:flex;
      gap: 12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .actions .btn{
      flex: 1;
      min-width: 160px;
    }

    /* ===== Fix select arrows ===== */
    select{ appearance:none; }

    /* ===== Leaflet Controls fix (always above map but below sheet) ===== */
    .leaflet-control-container{
      z-index: 10;
    }
    .leaflet-top, .leaflet-bottom{
      z-index: 10;
    }
  </style>
</head>

<body class="page">

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div class="mapWrap">
    <div id="map"></div>
  </div>

  <!-- Bottom Sheet -->
  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader">
      <div class="sheetHandle"></div>
    </div>

    <div class="sheetBody" id="sheetBody">
      <div class="sectionTitle">Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)</div>

      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
          </select>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
          <select id="centerSelect" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
          </select>
        </div>
      </div>

      <div class="note">* Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².</div>

      <div class="sep"></div>

      <div class="sectionTitle">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
      <div class="pills" id="vehiclePills">
        <button class="pillBtn" data-type="car" type="button">ğŸš— Ø³ÙŠØ§Ø±Ø©</button>
        <button class="pillBtn" data-type="tuktuk" type="button">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</button>
        <button class="pillBtn" data-type="motor" type="button">ğŸï¸ Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„</button>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</div>

      <div class="field">
        <label>Ù…Ù†</label>
        <input id="fromText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚" />
      </div>

      <div class="field">
        <label>Ø¥Ù„Ù‰</label>
        <input id="toText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„" />
      </div>

      <div class="actions">
        <button class="btn success" id="pickFromMapBtn" type="button">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
        <button class="btn success" id="pickToMapBtn" type="button">ğŸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØµÙˆÙ„</button>
      </div>

      <div class="actions">
        <button class="btn primary" id="createRideBtn" type="button" style="width:100%">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px;text-align:center"></div>

      <div class="actions">
        <a class="btn" href="./index.html" style="width:100%">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, setActiveRole } from "./app.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Auth
    setActiveRole("passenger");
    const { user } = await requireAuthAndRole("passenger");
    document.getElementById("who").textContent = user.email || user.phoneNumber || "-";
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    const msg = document.getElementById("msg");

    // ===== Leaflet Map
    let map, markerFrom=null, markerTo=null;
    let pickMode = null; // "from" | "to"
    let fromLatLng=null, toLatLng=null;

    function initMap(){
      const center = [24.0889, 32.8998]; // Ø£Ø³ÙˆØ§Ù†

      map = L.map("map", { zoomControl: true }).setView(center, 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø§ ØªØªÙƒØ³Ø±Ø´ Ù…Ø¹ Ø§Ù„Ø´ÙŠØª
      setTimeout(()=>{ try{ map.invalidateSize(true); }catch{} }, 300);

      map.on("click", (e)=>{
        if(!pickMode) return;

        if(pickMode === "from"){
          fromLatLng = e.latlng;
          if(markerFrom) markerFrom.remove();
          markerFrom = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚").openPopup();
          pickMode = null;
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.";
        }else if(pickMode === "to"){
          toLatLng = e.latlng;
          if(markerTo) markerTo.remove();
          markerTo = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
          pickMode = null;
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„.";
        }
      });
    }

    // Ø§Ù†ØªØ¸Ø± Leaflet
    const waitLeaflet = setInterval(()=>{
      if(window.L){
        clearInterval(waitLeaflet);
        initMap();
      }
    }, 30);

    // ===== Regions
    const regions = {
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†", "Ø¯Ø±Ø§Ùˆ", "ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ", "Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø­Ù„ÙˆØ§Ù†", "Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ø¯Ù‚ÙŠ", "Ø§Ù„Ù‡Ø±Ù…", "ÙÙŠØµÙ„", "Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©"]
    };

    const govSelect = document.getElementById("govSelect");
    const centerSelect = document.getElementById("centerSelect");

    Object.keys(regions).forEach(g=>{
      const op = document.createElement("option");
      op.value = g;
      op.textContent = g;
      govSelect.appendChild(op);
    });

    govSelect.addEventListener("change", ()=>{
      const g = govSelect.value;
      centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>';
      if(!g){
        centerSelect.disabled = true;
        return;
      }
      regions[g].forEach(c=>{
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        centerSelect.appendChild(op);
      });
      centerSelect.disabled = false;
    });

    // ===== Vehicle pills
    let vehicleType = "car";
    const pillsWrap = document.getElementById("vehiclePills");

    function setVehicle(v){
      vehicleType = v;
      [...pillsWrap.querySelectorAll(".pillBtn")].forEach(b=>{
        b.classList.toggle("active", b.dataset.type === v);
      });
    }

    pillsWrap.addEventListener("click", (e)=>{
      const btn = e.target.closest(".pillBtn");
      if(!btn) return;
      setVehicle(btn.dataset.type);
    });

    setVehicle("car");

    // ===== Buttons
    document.getElementById("pickFromMapBtn").onclick = ()=>{
      pickMode = "from";
      msg.textContent = "ğŸ“ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.";
      collapseSheet();
    };

    document.getElementById("pickToMapBtn").onclick = ()=>{
      pickMode = "to";
      msg.textContent = "ğŸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„.";
      collapseSheet();
    };

    const fromText = document.getElementById("fromText");
    const toText = document.getElementById("toText");
    const createRideBtn = document.getElementById("createRideBtn");

    createRideBtn.onclick = async ()=>{
      msg.textContent = "";
      const governorate = govSelect.value;
      const center = centerSelect.value;

      if(!governorate || !center){
        msg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ø±ÙƒØ².";
        return;
      }
      if(!fromText.value.trim() || !toText.value.trim()){
        msg.textContent = "âŒ Ø§ÙƒØªØ¨ (Ù…Ù†) Ùˆ(Ø¥Ù„Ù‰).";
        return;
      }
      if(!fromLatLng || !toLatLng){
        msg.textContent = "âŒ Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
        return;
      }

      createRideBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨â€¦";

      try{
        const ridesRef = collection(db, "rides");
        const docRef = await addDoc(ridesRef, {
          passengerUid: user.uid,
          passengerEmail: user.email || null,
          passengerPhone: user.phoneNumber || null,
          passengerName: null,

          governorate,
          center,

          requestedVehicle: vehicleType,   // â­ Ù…Ù‡Ù… Ù„Ù„Ø³Ø§Ø¦Ù‚
          vehicleType,                     // Ø§Ø­ØªÙŠØ§Ø·ÙŠ

          fromText: fromText.value.trim(),
          toText: toText.value.trim(),
          from: { lat: fromLatLng.lat, lng: fromLatLng.lng },
          to:   { lat: toLatLng.lat,   lng: toLatLng.lng },

          status: "open",                  // â­ Ù…Ù‡Ù… Ù„Ù„Ø³Ø§Ø¦Ù‚
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        msg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
        localStorage.setItem("currentRideId", docRef.id);
        expandSheet();

      }catch(e){
        console.error(e);
        msg.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
      }finally{
        createRideBtn.disabled = false;
      }
    };

    // ==========================================================
    // âœ… Draggable Sheet (Uber-like)
    // ==========================================================
    const sheet = document.getElementById("sheet");
    const sheetHeader = document.getElementById("sheetHeader");
    const sheetBody = document.getElementById("sheetBody");

    // Snap positions
    const SNAP = {
      expanded: 0,   // fully up
      mid: 0.38,     // middle
      collapsed: 0.72 // down
    };

    let currentSnap = "mid";
    let startY = 0;
    let startTranslate = 0;
    let isDragging = false;

    function sheetMaxTranslate(){
      // translateY value in px (down)
      const vh = window.innerHeight;
      return Math.max(260, Math.floor(vh * 0.72));
    }

    function getSnapPx(name){
      const maxT = sheetMaxTranslate();
      if(name === "expanded") return Math.floor(maxT * SNAP.expanded);
      if(name === "mid") return Math.floor(maxT * SNAP.mid);
      return Math.floor(maxT * SNAP.collapsed);
    }

    function setSheetTo(name, animate=true){
      currentSnap = name;
      const y = getSnapPx(name);
      sheet.style.transition = animate ? "transform .22s cubic-bezier(.2,.9,.2,1)" : "none";
      sheet.style.transform = `translateX(-50%) translateY(${y}px)`;

      // Ù„Ùˆ expanded Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
      if(name === "expanded"){
        sheetBody.style.pointerEvents = "auto";
      }else{
        sheetBody.style.pointerEvents = "auto";
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      setTimeout(()=>{ try{ map?.invalidateSize(true); }catch{} }, 120);
    }

    function expandSheet(){ setSheetTo("expanded", true); }
    function collapseSheet(){ setSheetTo("collapsed", true); }
    function midSheet(){ setSheetTo("mid", true); }

    // initial
    window.addEventListener("load", ()=> setTimeout(()=> midSheet(), 80));
    window.addEventListener("resize", ()=> setSheetTo(currentSnap, false));

    // Drag logic
    function onDown(e){
      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ³ÙƒØ±ÙˆÙ„ Ø¬ÙˆÙ‡ Ø§Ù„Ø´ÙŠØª Ù…Ø§ Ù†Ø³Ø­Ø¨Ø´
      const target = e.target;
      const insideScrollable = target.closest("#sheetBody");
      if(insideScrollable && sheetBody.scrollTop > 0) return;

      isDragging = true;
      sheet.style.transition = "none";

      startY = (e.touches ? e.touches[0].clientY : e.clientY);
      const cur = getSnapPx(currentSnap);
      startTranslate = cur;

      try{ e.preventDefault(); }catch{}
    }

    function onMove(e){
      if(!isDragging) return;
      const y = (e.touches ? e.touches[0].clientY : e.clientY);
      const dy = y - startY;

      const maxT = sheetMaxTranslate();
      let next = startTranslate + dy;
      next = Math.max(0, Math.min(maxT, next));

      sheet.style.transform = `translateX(-50%) translateY(${next}px)`;
      try{ e.preventDefault(); }catch{}
    }

    function onUp(e){
      if(!isDragging) return;
      isDragging = false;

      // Decide snap based on current translate
      const style = getComputedStyle(sheet);
      const matrix = new DOMMatrixReadOnly(style.transform);
      const translateY = matrix.m42;

      const maxT = sheetMaxTranslate();
      const p = translateY / maxT;

      // nearest snap
      let target = "mid";
      if(p < 0.22) target = "expanded";
      else if(p < 0.55) target = "mid";
      else target = "collapsed";

      setSheetTo(target, true);
    }

    // Events
    sheetHeader.addEventListener("touchstart", onDown, {passive:false});
    sheetHeader.addEventListener("touchmove", onMove, {passive:false});
    sheetHeader.addEventListener("touchend", onUp, {passive:true});

    sheetHeader.addEventListener("mousedown", onDown);
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);

  </script>
</body>
</html>
