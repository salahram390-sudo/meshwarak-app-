<script type="module">
  // âœ… Ø­Ø§Ø±Ø³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ "Ø±Ø§ÙƒØ¨"
  import { requireAuthAndRole, db } from "./app.js";
  await requireAuthAndRole("passenger");

  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Ø®Ø±ÙŠØ·Ø© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
  const map = L.map('map').setView([30.0444, 31.2357], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let from = null, to = null;
  let fromMarker = null, toMarker = null;
  let line = null;

  const statusEl = document.getElementById('status');
  const createBtn = document.getElementById('createBtn');
  const resetBtn = document.getElementById('resetBtn');
  const resultEl = document.getElementById('result');
  const geoMsg = document.getElementById('geoMsg');

  const fromText = document.getElementById('fromText');
  const toText = document.getElementById('toText');
  const fromSearchBtn = document.getElementById('fromSearchBtn');
  const toSearchBtn = document.getElementById('toSearchBtn');

  const myLocBtn = document.getElementById('myLocBtn');
  let myLocMarker = null;

  function updateUI(){
    if(!from){
      statusEl.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
      createBtn.disabled = true;
    } else if(from && !to){
      statusEl.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
      createBtn.disabled = true;
    } else {
      statusEl.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ âœ…";
      createBtn.disabled = false;
    }
  }

  function drawLineIfReady(){
    if(from && to){
      if(line) map.removeLayer(line);
      line = L.polyline([from, to], {}).addTo(map);
      map.fitBounds(line.getBounds(), { padding: [30,30] });
    }
  }

  function setFrom(lat, lng){
    from = { lat, lng };
    if(fromMarker) map.removeLayer(fromMarker);
    fromMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
    map.setView([lat, lng], 14);
    drawLineIfReady();
    updateUI();
  }

  function setTo(lat, lng){
    to = { lat, lng };
    if(toMarker) map.removeLayer(toMarker);
    toMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
    map.setView([lat, lng], 14);
    drawLineIfReady();
    updateUI();
  }

  async function geocode(q){
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" }});
    if(!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø«");
    const data = await res.json();
    if(!data || data.length === 0) return null;
    return { lat: Number(data[0].lat), lng: Number(data[0].lon) };
  }

  async function handleSearch(type){
    geoMsg.textContent = "";
    const text = (type === "from" ? fromText.value : toText.value).trim();
    if(!text){ geoMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«."; return; }

    const btn = (type === "from" ? fromSearchBtn : toSearchBtn);
    btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±Ùâ€¦";

    try{
      const r = await geocode(text);
      if(!r){ geoMsg.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†. Ø¬Ø±Ø¨ ØªÙƒØªØ¨ Ø§Ø³Ù… Ø£ÙˆØ¶Ø­ + Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©."; return; }
      if(type === "from") setFrom(r.lat, r.lng);
      else setTo(r.lat, r.lng);
    }catch(e){
      console.error(e);
      geoMsg.textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ.";
    }finally{
      btn.disabled = false; btn.textContent = "Ø¨Ø­Ø«";
    }
  }

  fromSearchBtn.addEventListener('click', () => handleSearch("from"));
  toSearchBtn.addEventListener('click', () => handleSearch("to"));
  fromText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("from"); });
  toText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("to"); });

  function showMyLocation(){
    geoMsg.textContent = "";
    if(!navigator.geolocation){ geoMsg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹."; return; }

    myLocBtn.disabled = true;
    myLocBtn.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦";

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if(myLocMarker) map.removeLayer(myLocMarker);
        myLocMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
        map.setView([lat, lng], 16);

        myLocBtn.disabled = false;
        myLocBtn.textContent = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ";
      },
      (err) => {
        console.error(err);
        geoMsg.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§ÙØªØ­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.";
        myLocBtn.disabled = false;
        myLocBtn.textContent = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }
  myLocBtn.addEventListener('click', showMyLocation);

  function resetAll(){
    from = null; to = null;
    fromText.value = ""; toText.value = "";

    if(fromMarker) map.removeLayer(fromMarker);
    if(toMarker) map.removeLayer(toMarker);
    if(line) map.removeLayer(line);
    fromMarker = null; toMarker = null; line = null;

    if(myLocMarker) map.removeLayer(myLocMarker);
    myLocMarker = null;

    geoMsg.textContent = "";
    resultEl.textContent = "";
    updateUI();
  }
  resetBtn.addEventListener('click', resetAll);

  createBtn.addEventListener('click', async () => {
    try{
      createBtn.disabled = true;
      resultEl.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

      const phone = document.getElementById('phone').value.trim();
      const passengers = Number(document.getElementById('passengers').value || 0);
      const note = document.getElementById('note').value.trim();

      const docRef = await addDoc(collection(db, "rides"), {
        status: "open",
        createdAt: serverTimestamp(),
        from, to,
        phone: phone || null,
        passengers: passengers || null,
        note: note || null,
        fromText: fromText.value.trim() || null,
        toText: toText.value.trim() || null
      });

      resultEl.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${docRef.id}`;
    }catch(err){
      console.error(err);
      resultEl.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules ÙˆØ§Ø³Ù… Collection rides.";
    }finally{
      updateUI();
    }
  });

  updateUI();
</script>
