<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <meta name="theme-color" content="#050B16" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .toast{
      position:fixed; left:12px; right:12px; top:76px; z-index:9999;
      display:none;
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    .toast.show{display:block; animation:pop .22s ease}
    @keyframes pop{from{transform:translateY(-8px);opacity:.0}to{transform:none;opacity:1}}
    .rangeWrap{
      padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .rangeTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .priceBig{font-weight:900;font-size:18px}
    input[type="range"]{width:100%}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"></div>
      <div class="sheet-content" id="sheetContent">

        <div class="card" style="margin-top:0">
          <div class="field" style="margin-top:0">
            <label>Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙ‚Ø·)</label>
            <div class="grid2">
              <div>
                <select id="govSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option></select>
              </div>
              <div>
                <select id="centerSelect" disabled><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option></select>
              </div>
            </div>
            <div id="centerOtherWrap" style="display:none;margin-top:10px">
              <input id="centerOtherInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§â€¦" />
            </div>
            <div class="hint" style="margin-top:10px">
              * Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø¥Ù„Ø§ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
            <div class="grid3">
              <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
              <button class="btn" id="fromSearchBtn" type="button">Ø¨Ø­Ø«</button>
            </div>
          </div>

          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
            <div class="grid3">
              <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
              <button class="btn" id="toSearchBtn" type="button">Ø¨Ø­Ø«</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <label style="display:block;margin-bottom:8px">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­</label>
          <div class="rangeWrap">
            <div class="rangeTop">
              <div class="hint" style="margin:0">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø³Ù‡Ù… Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø±</div>
              <div class="priceBig"><span id="priceVal">15</span> EG</div>
            </div>
            <input id="priceRange" type="range" min="15" max="300" step="5" value="15" />
            <div class="small" style="margin-top:8px">Ø£Ù‚Ù„ Ø³Ø¹Ø± 15 â€¢ ÙŠØ²ÙŠØ¯ ÙƒÙ„ Ù…Ø±Ø© 5 â€¢ Ø£Ù‚ØµÙ‰ 300</div>
          </div>
        </div>

        <div class="pills">
          <span class="pill" id="statusPill">Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦</span>
          <span class="pill" id="ridePill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨</span>
          <span class="pill" id="permPill">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          <span class="pill" id="areaPill">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</span>
        </div>

        <div id="contactBox" class="card" style="margin-top:12px; display:none"></div>

        <div class="actions">
          <button class="btn primary" id="createBtn" disabled type="button">Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
          <button class="btn danger" id="cancelBtn" disabled type="button">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          <button class="btn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>

        <div id="msg" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    import {
      collection, addDoc, serverTimestamp,
      doc, onSnapshot, setDoc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const toast = $("toast");
    const showToast = (html, ms=2400)=>{
      toast.innerHTML = html;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), ms);
    };

    // ØµÙˆØª: Ù„Ùˆ Ø­Ø·ÙŠØª MP3 ÙÙŠ sounds/ Ù‡ÙŠØ´ØªØºÙ„ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù‡ÙŠØ¹Ù…Ù„ beep
    const playSound = async (name, fallbackType="ok")=>{
      try{
        const a = new Audio(`./sounds/${name}.mp3`);
        a.volume = 0.9;
        await a.play();
      }catch{
        try{
          const ctx = new (window.AudioContext||window.webkitAudioContext)();
          const o = ctx.createOscillator(); const g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.type = "sine";
          const now = ctx.currentTime;
          const f1 = (fallbackType==="new") ? 880 : 660;
          const f2 = (fallbackType==="new") ? 660 : 990;
          o.frequency.setValueAtTime(f1, now);
          o.frequency.linearRampToValueAtTime(f2, now+0.08);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.25, now+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+0.25);
          o.start(now); o.stop(now+0.28);
          setTimeout(()=>ctx.close().catch(()=>{}), 350);
        }catch{}
      }
    };

    // ========= auth
    const { user } = await requireAuthAndRole("passenger");
    $("logoutBtn").addEventListener("click", doLogout);

    const msg = $("msg");
    const whoEl = $("who");

    const LS = {
      areaGov:"mw_area_gov", areaCenter:"mw_area_center", areaCenterOther:"mw_area_center_other",
      fromText:"mw_from_text", toText:"mw_to_text", lastRideId:"lastRideId", price:"mw_price"
    };
    const OTHER="__other__";

    // ========= areas
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","Ø§Ù„ØªØ¬Ù…Ø¹"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","Ø§Ù„Ù‡Ø±Ù…","ÙÙŠØµÙ„","Ø¥Ù…Ø¨Ø§Ø¨Ø©","Ø§Ù„ÙˆØ±Ø§Ù‚","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†","Ø§Ù„Ø¹ÙŠØ§Ø·"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ø§Ù„Ø¹Ø¬Ù…ÙŠ","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø±Ù…Ù„"]
    };

    const govSelect=$("govSelect"), centerSelect=$("centerSelect");
    const centerOtherWrap=$("centerOtherWrap"), centerOtherInput=$("centerOtherInput");
    const areaPill=$("areaPill");

    Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const o=document.createElement("option"); o.value=g; o.textContent=g; govSelect.appendChild(o);
    });

    const fillCenters=(gov, pre=null)=>{
      centerSelect.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>`;
      (AREAS[gov]||[]).forEach(c=>{
        const o=document.createElement("option"); o.value=c; o.textContent=c; centerSelect.appendChild(o);
      });
      const other=document.createElement("option"); other.value=OTHER; other.textContent="Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      centerSelect.appendChild(other);

      centerSelect.disabled=false;
      centerOtherWrap.style.display="none"; centerOtherInput.value="";
      if(pre){
        const exists=[...centerSelect.options].some(o=>o.value===pre);
        if(exists){ centerSelect.value=pre; }
        else{ centerSelect.value=OTHER; centerOtherWrap.style.display="block"; centerOtherInput.value=pre; }
      }
    };

    const getSelectedArea=()=>{
      const gov=govSelect.value.trim(); if(!gov) return {gov:null, center:null};
      const cv=centerSelect.value; if(!cv) return {gov, center:null};
      if(cv===OTHER){ const m=centerOtherInput.value.trim(); return {gov, center: (m.length>=2?m:null)}; }
      return {gov, center: cv.trim()};
    };

    const renderAreaPill=()=>{
      const {gov,center}=getSelectedArea();
      areaPill.textContent = (gov && center) ? `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${center}` : "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -";
    };

    const saveAreaToLS=()=>{
      const {gov,center}=getSelectedArea();
      if(gov) localStorage.setItem(LS.areaGov, gov);
      if(centerSelect.value===OTHER){
        localStorage.setItem(LS.areaCenter, OTHER);
        localStorage.setItem(LS.areaCenterOther, centerOtherInput.value||"");
      }else{
        if(center) localStorage.setItem(LS.areaCenter, center);
        localStorage.removeItem(LS.areaCenterOther);
      }
    };

    const restoreAreaFromLS=()=>{
      const g=localStorage.getItem(LS.areaGov)||"";
      const c=localStorage.getItem(LS.areaCenter)||"";
      const co=localStorage.getItem(LS.areaCenterOther)||"";
      if(g){
        govSelect.value=g;
        fillCenters(g, (c && c!==OTHER) ? c : (co||null));
        if(c===OTHER){ centerSelect.value=OTHER; centerOtherWrap.style.display="block"; centerOtherInput.value=co; }
      }
      renderAreaPill();
    };

    govSelect.addEventListener("change", ()=>{
      const g=govSelect.value.trim();
      if(!g){
        centerSelect.disabled=true; centerSelect.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>`;
        centerOtherWrap.style.display="none"; centerOtherInput.value="";
        renderAreaPill(); updateUI(); return;
      }
      fillCenters(g); saveAreaToLS(); renderAreaPill(); updateUI();
    });

    centerSelect.addEventListener("change", ()=>{
      if(centerSelect.value===OTHER){ centerOtherWrap.style.display="block"; centerOtherInput.focus(); }
      else{ centerOtherWrap.style.display="none"; centerOtherInput.value=""; }
      saveAreaToLS(); renderAreaPill(); updateUI();
    });

    centerOtherInput.addEventListener("input", ()=>{ saveAreaToLS(); renderAreaPill(); updateUI(); });

    // ========= passenger profile
    let passengerProfile = await getUserDoc(user.uid).catch(()=>null);
    const fallbackNameFromEmail = (email)=>((email||"").split("@")[0]||"Ù…Ø³ØªØ®Ø¯Ù…").replace(/[._-]+/g," ").trim()||"Ù…Ø³ØªØ®Ø¯Ù…";
    let passengerName  = passengerProfile?.name?.trim() || fallbackNameFromEmail(user.email);
    let passengerPhone = passengerProfile?.phone?.trim() || null;

    whoEl.textContent = `${passengerName} â€¢ ${user.email}`;

    if(passengerProfile?.governorate){
      govSelect.value = passengerProfile.governorate;
      fillCenters(passengerProfile.governorate, passengerProfile?.center || null);
      renderAreaPill();
    }else restoreAreaFromLS();

    // ========= price
    const priceRange=$("priceRange"), priceVal=$("priceVal");
    const savedPrice = Number(localStorage.getItem(LS.price)||"15");
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    priceRange.value = String(clamp(savedPrice, 15, 300));
    priceVal.textContent = priceRange.value;
    priceRange.addEventListener("input", ()=>{
      priceVal.textContent = priceRange.value;
      localStorage.setItem(LS.price, priceRange.value);
    });

    // ========= map
    const map = L.map("map", { zoomControl:false }).setView([30.0444,31.2357], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:"&copy; OpenStreetMap"}).addTo(map);
    const fixMap=()=>{ try{map.invalidateSize(true)}catch{} setTimeout(()=>{try{map.invalidateSize(true)}catch{}},250); };
    setTimeout(fixMap, 450);
    addEventListener("load", ()=>setTimeout(fixMap, 250));
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 200); });

    const divPin=(emoji)=>L.divIcon({
      className:"pin-emoji",
      html:`<div class="pin-bubble">${emoji}</div>`,
      iconSize:[44,44], iconAnchor:[22,44], popupAnchor:[0,-36]
    });

    let from=null,to=null, fromMarker=null,toMarker=null,line=null;
    let myMarker=null,myPos=null;

    let driverMarker=null, driverLine=null, unsubDriver=null;
    let routeLine=null; // route between from->to
    let routeMeta=null; // {distanceKm, durationMin}

    const statusPill=$("statusPill"), ridePill=$("ridePill"), permPill=$("permPill");
    const createBtn=$("createBtn"), cancelBtn=$("cancelBtn");
    const fromText=$("fromText"), toText=$("toText"), contactBox=$("contactBox");

    fromText.value = localStorage.getItem(LS.fromText)||"";
    toText.value   = localStorage.getItem(LS.toText)||"";
    fromText.addEventListener("input", ()=>localStorage.setItem(LS.fromText, fromText.value));
    toText.addEventListener("input", ()=>localStorage.setItem(LS.toText, toText.value));

    const setPermPill=(state)=>{
      permPill.classList.remove("ok","bad");
      if(state==="granted"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø³Ù…ÙˆØ­ âœ…"; permPill.classList.add("ok"); }
      else if(state==="denied"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶ âŒ"; permPill.classList.add("bad"); }
      else permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    };

    (async ()=>{
      try{
        if(!navigator.permissions?.query) return;
        const p=await navigator.permissions.query({name:"geolocation"});
        setPermPill(p.state); p.onchange=()=>setPermPill(p.state);
      }catch{}
    })();

    const drawLine=()=>{
      if(from && to){
        if(line) map.removeLayer(line);
        line=L.polyline([[from.lat,from.lng],[to.lat,to.lng]]).addTo(map);
      }
    };

    const setFrom=(lat,lng)=>{
      from={lat,lng};
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker=L.marker([lat,lng],{icon:divPin("ğŸš©")}).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…");
      map.setView([lat,lng], 14, {animate:false});
      drawLine(); updateUI(); fixMap();
    };

    const setTo=(lat,lng)=>{
      to={lat,lng};
      if(toMarker) map.removeLayer(toMarker);
      toMarker=L.marker([lat,lng],{icon:divPin("ğŸ")}).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„");
      map.setView([lat,lng], 14, {animate:false});
      drawLine(); updateUI(); fixMap();
    };

    const explainLocationDenied=()=>{
      msg.innerHTML="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
    };

    const autoLocate=({force=false}={})=>{
      if(!navigator.geolocation){
        msg.textContent="Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        statusPill.textContent="Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        return;
      }
      statusPill.textContent="Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";
      navigator.geolocation.getCurrentPosition((pos)=>{
        setPermPill("granted");
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        myPos={lat,lng};
        if(myMarker) map.removeLayer(myMarker);
        myMarker=L.circleMarker([lat,lng],{radius:9, weight:2, fillOpacity:.85}).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");
        map.setView([lat,lng], 16, {animate:false});
        fixMap();
        if(!from || force) setFrom(lat,lng); else updateUI();
      }, (err)=>{
        console.error(err);
        if(err?.code===1){ setPermPill("denied"); explainLocationDenied(); }
        else msg.textContent="ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        statusPill.textContent="Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        updateUI();
      }, {enableHighAccuracy:true, timeout:20000, maximumAge:0});
    };

    $("myLocBtn").addEventListener("click", ()=>autoLocate({force:true}));

    const resetAll=()=>{
      from=null; to=null;
      fromText.value=""; toText.value="";
      localStorage.removeItem(LS.fromText); localStorage.removeItem(LS.toText);

      [fromMarker,toMarker,line,myMarker,driverMarker,driverLine,routeLine].forEach(x=>{ if(x) try{map.removeLayer(x)}catch{} });
      fromMarker=toMarker=line=myMarker=driverMarker=driverLine=routeLine=null;
      routeMeta=null;

      stopDriverWatch();
      msg.textContent="";
      updateUI(); fixMap();
    };
    $("resetBtn").addEventListener("click", resetAll);

    // geocode (biased by area + myPos)
    const geocode=async(q)=>{
      const {gov,center}=getSelectedArea();
      let query=(q||"").trim();
      if(gov) query+=`, ${gov}`;
      if(center) query+=`, ${center}`;
      query+=`, Egypt`;

      const params=new URLSearchParams({format:"json",limit:"5",countrycodes:"eg",q:query});

      if(myPos){
        const d=0.35;
        params.set("viewbox", `${myPos.lng-d},${myPos.lat+d},${myPos.lng+d},${myPos.lat-d}`);
        params.set("bounded","1");
      }

      const url=`https://nominatim.openstreetmap.org/search?${params.toString()}`;
      const res=await fetch(url,{headers:{Accept:"application/json"}});
      if(!res.ok) throw new Error("geocode failed");
      const data=await res.json();
      if(!data?.length) return null;
      return {lat:Number(data[0].lat), lng:Number(data[0].lon), display:data[0].display_name};
    };

    const search=async(type)=>{
      msg.textContent="";
      const text=(type==="from"?fromText.value:toText.value).trim();
      if(!text) return msg.textContent="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
      try{
        msg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦";
        const r=await geocode(text);
        if(!r) return msg.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† (Ø¬Ø±Ù‘Ø¨ Ø§Ø³Ù… Ø£ÙˆØ¶Ø­).";
        msg.textContent="";
        if(type==="from") setFrom(r.lat,r.lng); else setTo(r.lat,r.lng);
      }catch(e){
        console.error(e);
        msg.textContent="Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }
    };

    $("fromSearchBtn").addEventListener("click", ()=>search("from"));
    $("toSearchBtn").addEventListener("click", ()=>search("to"));

    // OSRM route
    const drawRoute=async ()=>{
      if(!from || !to) return;
      try{
        const url=`https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
        const res=await fetch(url);
        const data=await res.json();
        const r=data?.routes?.[0];
        if(!r?.geometry?.coordinates?.length) return;

        routeMeta = {
          distanceKm: Math.round((r.distance/1000)*10)/10,
          durationMin: Math.round((r.duration/60))
        };

        const latlngs = r.geometry.coordinates.map(([lng,lat])=>[lat,lng]);
        if(routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(latlngs).addTo(map);
      }catch{}
    };

    const stopDriverWatch=()=>{
      if(unsubDriver){ try{unsubDriver()}catch{} unsubDriver=null; }
      if(driverMarker){ try{map.removeLayer(driverMarker)}catch{} driverMarker=null; }
      if(driverLine){ try{map.removeLayer(driverLine)}catch{} driverLine=null; }
    };

    const startDriverWatch=(driverUid)=>{
      stopDriverWatch();
      if(!driverUid) return;
      const ref=doc(db,"driver_status",driverUid);
      unsubDriver=onSnapshot(ref,(snap)=>{
        const st=snap.exists()?snap.data():null;
        const lat=Number(st?.lat), lng=Number(st?.lng);
        if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;

        if(!driverMarker) driverMarker=L.marker([lat,lng],{icon:divPin("ğŸ§‘â€âœˆï¸")}).addTo(map).bindPopup("ğŸ§‘â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚");
        else driverMarker.setLatLng([lat,lng]);

        if(from){
          if(driverLine) map.removeLayer(driverLine);
          driverLine=L.polyline([[lat,lng],[from.lat,from.lng]]).addTo(map);
        }
      });
    };

    // rides state
    let unsubRide=null;
    let currentRideId = localStorage.getItem(LS.lastRideId) || null;

    const setRideUI=(state)=>{
      cancelBtn.disabled = !(state==="open" || state==="offered");
      createBtn.disabled = (state==="open" || state==="offered" || state==="accepted" || state==="arrived" || state==="started");
    };

    const hasAreaReady=()=>{
      const {gov,center}=getSelectedArea(); return !!(gov && center);
    };

    const updateUI=()=>{
      renderAreaPill();
      if(currentRideId) return;
      if(!hasAreaReady()){ statusPill.textContent="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ø§Ù‹â€¦"; createBtn.disabled=true; return; }
      if(!from){ statusPill.textContent="Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦"; createBtn.disabled=true; }
      else if(from && !to){ statusPill.textContent="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦"; createBtn.disabled=true; }
      else{ statusPill.textContent="Ø¬Ø§Ù‡Ø² âœ…"; createBtn.disabled=false; }
    };

    const watchRide=(rideId)=>{
      if(unsubRide) unsubRide();
      const ref=doc(db,"rides",rideId);

      unsubRide=onSnapshot(ref, async (snap)=>{
        if(!snap.exists()){
          ridePill.textContent="Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          contactBox.style.display="none"; contactBox.innerHTML="";
          currentRideId=null; localStorage.removeItem(LS.lastRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          setRideUI("none"); stopDriverWatch(); updateUI();
          return;
        }

        const r=snap.data();
        const st=r.status || "-";

        if(st==="open"){
          ridePill.textContent="âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø±â€¦ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚";
          contactBox.style.display="none"; contactBox.innerHTML="";
          setRideUI("open"); stopDriverWatch();
          return;
        }

        if(st==="offered"){
          // Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ‚Ø¯Ù… Ø³Ø¹Ø±
          ridePill.textContent = "ğŸ’° ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚";
          setRideUI("offered");

          const dName=r.driverName||"Ø³Ø§Ø¦Ù‚";
          const dPhone=r.driverPhone||"";
          const dVehicle=r.driverVehicle||"-";
          const dModel=r.driverModel||"-";
          const offer = Number(r.offerPriceEGP || r.priceEGP || 15);

          contactBox.style.display="block";
          contactBox.innerHTML = `
            <div class="hint" style="margin-top:0">
              <b>ğŸ‘¤ ${dName}</b> ${dPhone ? `â€¢ ğŸ“ ${dPhone}` : ""}
              <br><span class="small">ğŸš— ${dVehicle} â€¢ Ù…ÙˆØ¯ÙŠÙ„: ${dModel}</span>
              <br><span class="small">ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: <b>${offer}</b> EG</span>
              <br><span class="small">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${rideId}</span>
            </div>

            <div class="actions" style="margin-top:12px">
              <button class="btn success" id="acceptOfferBtn" type="button">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø¹Ø±</button>
              <button class="btn" id="counterBtn" type="button">Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø± ØªØ§Ù†ÙŠ</button>
              ${dPhone ? `<a class="btn" href="tel:${dPhone}">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>` : ``}
            </div>

            <div id="counterWrap" style="display:none;margin-top:10px">
              <div class="field" style="margin-top:0">
                <label>Ø§ÙƒØªØ¨ Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯</label>
                <input id="counterPrice" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 50" />
              </div>
              <button class="btn primary" id="sendCounterBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
              <div class="hint" id="counterMsg" style="margin-top:8px"></div>
            </div>
          `;

          const acceptOfferBtn = document.getElementById("acceptOfferBtn");
          const counterBtn = document.getElementById("counterBtn");
          const counterWrap = document.getElementById("counterWrap");
          const sendCounterBtn = document.getElementById("sendCounterBtn");
          const counterMsg = document.getElementById("counterMsg");

          acceptOfferBtn?.addEventListener("click", async ()=>{
            try{
              acceptOfferBtn.disabled=true;
              counterMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";
              await updateDoc(ref, {
                status:"accepted",
                priceEGP: offer,
                acceptedAt: serverTimestamp()
              });
            }catch(e){
              console.error(e);
              counterMsg.textContent="âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„.";
            }finally{
              acceptOfferBtn.disabled=false;
            }
          });

          counterBtn?.addEventListener("click", ()=>{
            counterWrap.style.display = (counterWrap.style.display==="none") ? "block" : "none";
          });

          sendCounterBtn?.addEventListener("click", async ()=>{
            try{
              const v = Number((document.getElementById("counterPrice")?.value||"").trim());
              if(!Number.isFinite(v) || v<15 || v>300) return counterMsg.textContent="âŒ Ø§ÙƒØªØ¨ Ø³Ø¹Ø± Ù…Ù† 15 Ø¥Ù„Ù‰ 300.";
              sendCounterBtn.disabled=true;
              counterMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦";
              await updateDoc(ref, {
                status:"offered",
                offerPriceEGP: v,
                offerBy: "passenger",
                offerAt: serverTimestamp()
              });
              counterMsg.textContent="âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ø§Ø¦Ù‚.";
            }catch(e){
              console.error(e);
              counterMsg.textContent="âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
            }finally{
              sendCounterBtn.disabled=false;
            }
          });

          return;
        }

        if(["accepted","arrived","started"].includes(st)){
          ridePill.textContent =
            (st==="accepted") ? "âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚" :
            (st==="arrived")  ? "ğŸ“ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØµÙ„ Ù…ÙƒØ§Ù†Ùƒ" :
            "ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª";

          setRideUI(st);

          // ØµÙˆØª Ù‚Ø¨ÙˆÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
          if(st==="accepted" && !localStorage.getItem("mw_accept_"+rideId)){
            localStorage.setItem("mw_accept_"+rideId,"1");
            await playSound("accepted","ok");
            showToast("âœ… <b>Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚</b> â€” Ø¬Ø§Ø±ÙŠ ØªØªØ¨Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©");
          }

          startDriverWatch(r.driverUid);

          // route Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
          if(!routeLine){
            await drawRoute();
          }

          const dName=r.driverName||"Ø³Ø§Ø¦Ù‚";
          const dPhone=r.driverPhone||"";
          const dVehicle=r.driverVehicle||"-";
          const dModel=r.driverModel||"-";
          const price = r.priceEGP ?? "-";
          const dist = routeMeta?.distanceKm ? `${routeMeta.distanceKm} ÙƒÙ…` : "-";
          const dur  = routeMeta?.durationMin ? `${routeMeta.durationMin} Ø¯Ù‚ÙŠÙ‚Ø©` : "-";

          contactBox.style.display="block";
          contactBox.innerHTML = `
            <div class="hint" style="margin-top:0">
              <b>ğŸ‘¤ ${dName}</b> ${dPhone ? `â€¢ ğŸ“ ${dPhone}` : "â€¢ ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…"}
              <br><span class="small">ğŸš— ${dVehicle} â€¢ Ù…ÙˆØ¯ÙŠÙ„: ${dModel}</span>
              <br><span class="small">ğŸ’° Ø§Ù„Ø³Ø¹Ø±: <b>${price}</b> EG</span>
              <br><span class="small">ğŸ§­ Ø§Ù„Ù…Ø³Ø§ÙØ©/Ø§Ù„ÙˆÙ‚Øª: ${dist} â€¢ ${dur}</span>
              <br><span class="small">Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©: <b>${st}</b></span>
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              ${dPhone ? `<a class="btn success" href="tel:${dPhone}">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>` : ``}
              <span class="pill ok">ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ âœ…</span>
            </div>
          `;
          return;
        }

        if(st==="canceled" || st==="completed"){
          ridePill.textContent = (st==="completed") ? "âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù†ØªÙ‡Øª" : "âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨";
          contactBox.style.display="none"; contactBox.innerHTML="";
          stopDriverWatch();

          currentRideId=null; localStorage.removeItem(LS.lastRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          setRideUI("none"); updateUI();
          return;
        }

        ridePill.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${st}`;
      });
    };

    if(currentRideId) watchRide(currentRideId);

    // create ride
    createBtn.addEventListener("click", async ()=>{
      try{
        msg.textContent="";
        if(currentRideId) return msg.textContent="âš ï¸ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";

        const {gov,center}=getSelectedArea();
        if(!gov||!center){ msg.textContent="âŒ Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ²."; updateUI(); return; }
        if(!from||!to){ msg.textContent="âŒ Ø­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."; updateUI(); return; }
        if(!passengerPhone){ msg.textContent="âŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„. Ø§ÙØªØ­ ØµÙØ­Ø© Ø­Ø³Ø§Ø¨ÙŠ ÙˆØ§Ø­ÙØ¸Ù‡."; return; }

        createBtn.disabled=true;

        const priceEGP = Number(priceRange.value) || 15;

        msg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";
        showToast("ğŸš– <b>ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</b>â€¦ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚", 2200);

        await setDoc(doc(db,"users",user.uid), { governorate:gov, center:center, updatedAt:serverTimestamp() }, {merge:true});

        const docRef = await addDoc(collection(db,"rides"),{
          status:"open", createdAt:serverTimestamp(),
          governorate:gov, center:center,
          from, to,
          fromText: fromText.value.trim()||null,
          toText:   toText.value.trim()||null,
          priceEGP,
          passengerUid:user.uid,
          passengerEmail:user.email,
          passengerName:passengerName||null,
          passengerPhone:passengerPhone||null,
          rejectedByDrivers: []
        });

        currentRideId=docRef.id;
        localStorage.setItem(LS.lastRideId, docRef.id);

        await setDoc(doc(db,"users",user.uid), { currentRideId:docRef.id, updatedAt:serverTimestamp() }, {merge:true});

        watchRide(docRef.id);
        msg.textContent="âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­.";
        ridePill.textContent="âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø±â€¦ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚";
        setRideUI("open");
      }catch(e){
        console.error(e);
        msg.textContent=`âŒ Ø­ØµÙ„ Ø®Ø·Ø£: ${e?.message||e}`;
        showToast("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
      }finally{
        updateUI(); fixMap();
      }
    });

    cancelBtn.addEventListener("click", async ()=>{
      if(!currentRideId) return;
      try{
        cancelBtn.disabled=true;
        msg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";
        const ref=doc(db,"rides",currentRideId);
        const snap=await getDoc(ref);
        if(!snap.exists()){
          msg.textContent="Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          currentRideId=null; localStorage.removeItem(LS.lastRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          setRideUI("none"); updateUI(); return;
        }
        const r=snap.data();
        if(!["open","offered"].includes(r.status)){
          msg.textContent="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
          setRideUI(r.status); return;
        }
        await updateDoc(ref, {status:"canceled", canceledAt:serverTimestamp(), canceledBy:"passenger"});
        await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});

        msg.textContent="âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.";
        showToast("âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨");
        currentRideId=null; localStorage.removeItem(LS.lastRideId);
        contactBox.style.display="none"; contactBox.innerHTML="";
        stopDriverWatch();
        setRideUI("none"); updateUI();
      }catch(e){
        console.error(e);
        msg.textContent=`âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: ${e?.message||e}`;
      }finally{
        updateUI(); fixMap();
      }
    });

    // init
    setRideUI(currentRideId ? "open" : "none");
    updateUI();
    autoLocate();

    // Bottom sheet drag
    const sheet=$("sheet"), handle=$("sheetHandle"), content=$("sheetContent");
    const clamp2=(v,min,max)=>Math.max(min,Math.min(max,v));
    const getPoints=()=>{
      const vh=innerHeight;
      return {
        collapsed: Math.max(150, Math.round(vh*0.22)),
        mid: Math.round(vh*0.46),
        expanded: Math.round(vh*0.82),
      };
    };
    let points=getPoints();
    let current=points.mid, startY=0, startCurrent=0, dragging=false;

    const renderSheet=(y, animate=true)=>{
      current=clamp2(y, points.collapsed, points.expanded);
      sheet.style.transition= animate ? "transform .18s ease" : "none";
      sheet.style.transform=`translateY(${points.expanded-current}px)`;
      content.style.maxHeight=(current>=points.mid)?"72vh":"58vh";
      if(animate) setTimeout(()=>sheet.style.transition="",200);
    };
    const nearestSnap=(y)=>[points.collapsed,points.mid,points.expanded].reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);

    const down=(e)=>{ dragging=true; sheet.classList.add("dragging"); startY=(e.touches?e.touches[0].clientY:e.clientY); startCurrent=current; };
    const move=(e)=>{ if(!dragging) return; const y=(e.touches?e.touches[0].clientY:e.clientY); renderSheet(startCurrent+(startY-y), false); e.preventDefault(); };
    const up=()=>{ if(!dragging) return; dragging=false; sheet.classList.remove("dragging"); renderSheet(nearestSnap(current), true); setTimeout(fixMap,220); };

    renderSheet(current,false);
    handle.addEventListener("touchstart", down, {passive:false});
    handle.addEventListener("touchmove", move, {passive:false});
    handle.addEventListener("touchend", up);
    handle.addEventListener("mousedown", down);
    addEventListener("mousemove", move, {passive:false});
    addEventListener("mouseup", up);
    addEventListener("resize", ()=>{ points=getPoints(); current=clamp2(current,points.collapsed,points.expanded); renderSheet(current,false); setTimeout(fixMap,220); });

  </script>
</body>
</html>
