<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</title>

  <!-- Leaflet + OSM -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#070A10;
      --card:#0E1624;
      --card2:#0B111C;
      --stroke:#1E2A3C;
      --text:#EAF1FF;
      --muted:#A9B7D0;
      --primary:#6D5BFF;     /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
      --primary2:#2B6CFF;    /* Ø£Ø²Ø±Ù‚ */
      --good:#22C55E;
      --bad:#FF6B6B;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r16:16px;
      --r18:18px;
      --r22:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* App Bar */
    .appbar{
      position:fixed;
      inset:0 0 auto 0;
      height:62px;
      padding: env(safe-area-inset-top) 14px 0 14px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      z-index:1000;
      background: linear-gradient(180deg, rgba(7,10,16,.92), rgba(7,10,16,.55), rgba(7,10,16,0));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(14,22,36,.55);
      border:1px solid rgba(30,42,60,.55);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(109,91,255,.75), rgba(43,108,255,.25));
      border:1px solid rgba(255,255,255,.08);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .brand small{display:block; color:var(--muted); font-weight:600; font-size:11px; margin-top:2px}

    .iconbtn{
      border:1px solid rgba(30,42,60,.65);
      background: rgba(14,22,36,.55);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      box-shadow: 0 8px 18px rgba(0,0,0,.2);
    }
    .iconbtn:active{transform:scale(.98)}
    .iconbtn.secondary{opacity:.9}

    /* Map */
    #map{
      position:fixed;
      inset:0;
      z-index:1;
    }

    /* Floating quick actions */
    .fabcol{
      position:fixed;
      left:12px;
      bottom: 260px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:900;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .fab{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(14,22,36,.78);
      color:var(--text);
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      cursor:pointer;
      backdrop-filter: blur(10px);
      font-size:18px;
      user-select:none;
    }
    .fab:active{transform:scale(.98)}
    .fab.primary{
      background: linear-gradient(135deg, rgba(109,91,255,.95), rgba(43,108,255,.85));
      border:1px solid rgba(255,255,255,.12);
    }

    /* Bottom Sheet */
    .sheet{
      position:fixed;
      inset:auto 0 0 0;
      z-index:950;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 14px) 12px;
    }
    .panel{
      background: rgba(14,22,36,.92);
      border:1px solid rgba(30,42,60,.7);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      max-width: 720px;
      margin: 0 auto;
    }
    .handle{
      width:44px;height:5px;border-radius:999px;
      background: rgba(255,255,255,.18);
      margin: 10px auto 6px;
    }
    .panelhead{
      padding: 10px 14px 6px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      display:flex;flex-direction:column;gap:2px;
    }
    .title b{font-size:14px}
    .title span{font-size:12px;color:var(--muted);font-weight:600}

    .statusrow{
      padding: 0 14px 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(11,17,28,.9);
      border:1px solid rgba(30,42,60,.65);
      color:var(--text);
      font-size:12px;
      font-weight:800;
    }
    .pill small{color:var(--muted); font-weight:700}

    .content{
      padding: 0 14px 14px 14px;
      display:grid;
      gap:12px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .grid2{grid-template-columns:1fr}
      .fabcol{bottom: 320px;}
    }

    .field{
      background: rgba(11,17,28,.85);
      border:1px solid rgba(30,42,60,.65);
      border-radius: 16px;
      padding: 10px;
      display:grid;
      gap:8px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .inputrow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,16,.65);
      color: var(--text);
      outline:none;
      font-weight:700;
    }
    input::placeholder, textarea::placeholder{color: rgba(169,183,208,.65); font-weight:700}
    textarea{resize:none}

    .mini{
      padding:11px 14px;
      border-radius: 14px;
      border:0;
      cursor:pointer;
      font-weight:900;
      color:white;
      background: linear-gradient(135deg, rgba(109,91,255,.95), rgba(43,108,255,.9));
      box-shadow: 0 10px 22px rgba(43,108,255,.18);
      white-space:nowrap;
    }
    .mini:disabled{opacity:.55; cursor:not-allowed}
    .mini.secondary{
      background: rgba(36,52,74,.9);
      box-shadow:none;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:2px;
    }
    @media (max-width:520px){
      .actions{grid-template-columns:1fr}
    }

    .cta{
      padding:14px 14px;
      border-radius: 16px;
      border:0;
      cursor:pointer;
      font-weight:1000;
      color:white;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(43,108,255,.75));
      box-shadow: 0 14px 26px rgba(34,197,94,.12);
    }
    .cta:disabled{opacity:.55; cursor:not-allowed}
    .mutedBtn{
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      font-weight:1000;
      color:var(--text);
      background: rgba(36,52,74,.85);
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      font-weight:700;
    }
    .err{color: var(--bad); font-weight:900}
    .ok{color: #7CFFB2; font-weight:900}

    /* Toast */
    .toast{
      position:fixed;
      right:12px;
      top: 72px;
      z-index:1200;
      max-width: 92vw;
      background: rgba(14,22,36,.92);
      border:1px solid rgba(30,42,60,.7);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:none;
    }
    .toast.show{display:block}
    .toast b{display:block; font-size:13px}
    .toast span{display:block; font-size:12px; color:var(--muted); margin-top:3px}
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- AppBar -->
  <div class="appbar">
    <div class="brand">
      <div class="logo">ğŸš–</div>
      <div>
        <h1>Ù…Ø´ÙˆØ§Ø±Ùƒ</h1>
        <small>Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø± â€” Ø±Ø§ÙƒØ¨</small>
      </div>
    </div>
    <button class="iconbtn secondary" id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Floating buttons -->
  <div class="fabcol">
    <div class="fab primary" id="myLocFab" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ“</div>
    <div class="fab" id="resetFab" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">â†»</div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <b id="toastTitle">...</b>
    <span id="toastDesc">...</span>
  </div>

  <!-- Bottom sheet -->
  <div class="sheet">
    <div class="panel">
      <div class="handle"></div>

      <div class="panelhead">
        <div class="title">
          <b>Ø­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„</b>
          <span>Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ø¶ØºØ· Ø¨Ø­Ø«ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</span>
        </div>
        <div class="pill" id="status"><small>Ø§Ù„Ø­Ø§Ù„Ø©:</small> Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦</div>
      </div>

      <div class="statusrow">
        <div class="hint" id="geoMsg"></div>
        <div class="hint" id="result"></div>
      </div>

      <div class="content">
        <div class="grid2">
          <div class="field">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
            <div class="inputrow">
              <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
              <button class="mini" id="fromSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>

          <div class="field">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
            <div class="inputrow">
              <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
              <button class="mini" id="toSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 010..." inputmode="tel" />
          </div>

          <div class="field">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="passengers" type="number" min="1" placeholder="1" />
          </div>
        </div>

        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="note" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ÙŠ Ø´Ù†Ø·Ø©â€¦"></textarea>
        </div>

        <div class="actions">
          <button class="cta" id="createBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
          <button class="mutedBtn" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="hint">ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚: <b>driver.html</b></div>
      </div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    // âœ… Ø­Ø§Ø±Ø³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ "Ø±Ø§ÙƒØ¨"
    import { requireAuthAndRole, doLogout } from "./app.js";
    await requireAuthAndRole("passenger");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¹Ù†Ø§ØµØ± UI
    const statusEl = document.getElementById('status');
    const createBtn = document.getElementById('createBtn');
    const resetBtn = document.getElementById('resetBtn');
    const geoMsg = document.getElementById('geoMsg');
    const resultEl = document.getElementById('result');

    const fromText = document.getElementById('fromText');
    const toText = document.getElementById('toText');
    const fromSearchBtn = document.getElementById('fromSearchBtn');
    const toSearchBtn = document.getElementById('toSearchBtn');

    const myLocFab = document.getElementById('myLocFab');
    const resetFab = document.getElementById('resetFab');

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", doLogout);

    // Toast
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastDesc = document.getElementById("toastDesc");
    let toastTimer = null;
    function showToast(title, desc=""){
      toastTitle.textContent = title;
      toastDesc.textContent = desc;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2800);
    }

    // Ø®Ø±ÙŠØ·Ø© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
    const map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 12);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let from = null, to = null;
    let fromMarker = null, toMarker = null;
    let line = null;

    let myLocMarker = null;

    function updateUI(){
      geoMsg.classList.remove("err");
      if(!from){
        statusEl.innerHTML = `<small>Ø§Ù„Ø­Ø§Ù„Ø©:</small> Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦`;
        createBtn.disabled = true;
      } else if(from && !to){
        statusEl.innerHTML = `<small>Ø§Ù„Ø­Ø§Ù„Ø©:</small> ØªÙ… Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦`;
        createBtn.disabled = true;
      } else {
        statusEl.innerHTML = `<small>Ø§Ù„Ø­Ø§Ù„Ø©:</small> Ø¬Ø§Ù‡Ø² âœ…`;
        createBtn.disabled = false;
      }
    }

    function drawLineIfReady(){
      if(from && to){
        if(line) map.removeLayer(line);
        line = L.polyline([from, to], { weight: 5, opacity: .85 }).addTo(map);
        map.fitBounds(line.getBounds(), { padding: [40,40] });
      }
    }

    function setFrom(lat, lng){
      from = { lat, lng };
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸš© Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…");
      fromMarker.openPopup();
      map.setView([lat, lng], 15);
      drawLineIfReady();
      updateUI();
      showToast("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù…", `${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    }

    function setTo(lat, lng){
      to = { lat, lng };
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„");
      toMarker.openPopup();
      map.setView([lat, lng], 15);
      drawLineIfReady();
      updateUI();
      showToast("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„", `${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    }

    // Ø¨Ø­Ø« Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ø¨Ø± Nominatim (OSM)
    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {
        headers: {
          "Accept": "application/json",
          "User-Agent": "MeshwarakApp/1.0 (demo)"
        }
      });
      if(!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø«");
      const data = await res.json();
      if(!data || data.length === 0) return null;
      return { lat: Number(data[0].lat), lng: Number(data[0].lon), display: data[0].display_name };
    }

    async function handleSearch(type){
      geoMsg.textContent = "";
      geoMsg.classList.remove("err");

      const text = (type === "from" ? fromText.value : toText.value).trim();
      if(!text){
        geoMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
        geoMsg.classList.add("err");
        return;
      }

      const btn = (type === "from" ? fromSearchBtn : toSearchBtn);
      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±Ùâ€¦";

      try{
        const r = await geocode(text);
        if(!r){
          geoMsg.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†. Ø¬Ø±Ù‘Ø¨ ØªÙƒØªØ¨ Ø§Ø³Ù… Ø£ÙˆØ¶Ø­ + Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.";
          geoMsg.classList.add("err");
          return;
        }
        geoMsg.textContent = "";
        if(type === "from") setFrom(r.lat, r.lng);
        else setTo(r.lat, r.lng);
      }catch(e){
        console.error(e);
        geoMsg.textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ.";
        geoMsg.classList.add("err");
      }finally{
        btn.disabled = false;
        btn.textContent = "Ø¨Ø­Ø«";
      }
    }

    fromSearchBtn.addEventListener('click', () => handleSearch("from"));
    toSearchBtn.addEventListener('click', () => handleSearch("to"));
    fromText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("from"); });
    toText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("to"); });

    function showMyLocation(){
      geoMsg.textContent = "";
      geoMsg.classList.remove("err");

      if(!navigator.geolocation){
        geoMsg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        geoMsg.classList.add("err");
        return;
      }

      myLocFab.textContent = "â€¦";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if(myLocMarker) map.removeLayer(myLocMarker);
          myLocMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
          myLocMarker.openPopup();

          map.setView([lat, lng], 16);

          myLocFab.textContent = "ğŸ“";
          showToast("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ", "Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ®Ù„ÙŠÙ‡ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø« Ø¨Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ø£Ùˆ Ø§Ø®ØªÙØ± Ø§Ù„Ù‚ÙŠØ§Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
        },
        (err) => {
          console.error(err);
          geoMsg.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.";
          geoMsg.classList.add("err");
          myLocFab.textContent = "ğŸ“";
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    }

    myLocFab.addEventListener('click', showMyLocation);

    function resetAll(){
      from = null; to = null;
      fromText.value = "";
      toText.value = "";

      if(fromMarker) map.removeLayer(fromMarker);
      if(toMarker) map.removeLayer(toMarker);
      if(line) map.removeLayer(line);

      fromMarker = null;
      toMarker = null;
      line = null;

      if(myLocMarker) map.removeLayer(myLocMarker);
      myLocMarker = null;

      geoMsg.textContent = "";
      resultEl.textContent = "";
      updateUI();
      showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©", "Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø«Ù… Ø§Ù„ÙˆØµÙˆÙ„.");
    }

    resetBtn.addEventListener('click', resetAll);
    resetFab.addEventListener('click', resetAll);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    createBtn.addEventListener('click', async () => {
      try{
        createBtn.disabled = true;
        resultEl.innerHTML = `<span class="hint">Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦</span>`;

        const phone = document.getElementById('phone').value.trim();
        const passengers = Number(document.getElementById('passengers').value || 0);
        const note = document.getElementById('note').value.trim();

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),
          from, to,
          phone: phone || null,
          passengers: passengers || null,
          note: note || null,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null
        });

        resultEl.innerHTML = `<span class="ok">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨!</span> <span class="hint">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <b>${docRef.id}</b></span>`;
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ âœ…", `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${docRef.id}`);
      }catch(err){
        console.error(err);
        resultEl.innerHTML = `<span class="err">âŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules ÙˆØ§Ø³Ù… Collection rides.</span>`;
        showToast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨", "Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Firestore (Rules) ÙˆØ§Ø³Ù… Collection rides.");
      }finally{
        updateUI();
      }
    });

    updateUI();
  </script>
</body>
</html>
