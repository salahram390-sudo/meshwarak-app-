<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#050B16" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./styles.css?v=11">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body.page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      touch-action: manipulation;
    }

    /* ===== Topbar ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 60;
      background: rgba(5, 11, 22, 0.72);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color: rgba(255,255,255,0.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 52vw;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:16px;
      font-size:18px;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .top-actions .btn{
      width:auto;
      padding:10px 12px;
      border-radius:18px;
      font-size:14px;
      min-height:44px;
    }

    /* ===== Map ===== */
    .mapWrap{
      position:relative;
      flex:1;
      min-height: calc(100vh - 70px);
      overflow:hidden;
      background:#0b1222;
    }
    #map{
      position:absolute;
      inset:0;
      z-index:1;
    }

    /* âœ… Bottom Sheet (Centered + Draggable) */
    .sheet{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(620px, calc(100% - 24px));
      z-index: 2000;

      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(18px);
      overflow: hidden;

      height: 52vh;
      transition: height .22s ease;
      will-change: height;
    }
    .sheet.dragging{ transition:none; }

    .sheetHeader{
      padding: 10px 14px 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: pan-y;
      cursor: grab;
    }
    .sheet.dragging .sheetHeader{ cursor: grabbing; }

    .sheetHandle{
      width:56px;
      height:6px;
      border-radius:99px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.10);
    }
    .sheetBody{
      padding: 14px;
      overflow-y: auto;
      height: calc(100% - 44px);
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    .sectionTitle{
      margin: 6px 0 10px;
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.88);
      text-align:center;
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .note{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.65);
      line-height:1.5;
      text-align:center;
    }
    .sep{ height:1px; background: rgba(255,255,255,0.06); margin:14px 0; }

    /* Vehicle pills */
    .pills{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .pillBtn{
      border-radius: 18px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(10, 16, 32, 0.55);
      cursor:pointer;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      min-height: 52px;
    }
    .pillBtn.active{
      background: linear-gradient(135deg, var(--blue1), var(--blue2));
      border-color: rgba(255,255,255,0.16);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.35),
        0 0 0 3px rgba(46,107,255,0.14),
        inset 0 1px 0 rgba(255,255,255,0.16);
    }

    .actions{
      display:flex;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }
    .actions .btn{
      width:auto;
      flex: 1 1 150px;
      min-height:52px;
    }
    .actions .btn.primary{ width:100%; flex: 1 1 100%; }

    .footerActions{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .footerActions .btn{ width:100%; }

    select{ appearance:none; }

    /* helper chips */
    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:center;
    }
    .miniChip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .miniChip.ok{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.25); }
    .miniChip.bad{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.25); }

    @media (max-width:420px){
      .grid2{ grid-template-columns: 1fr; }
      .pills{ grid-template-columns: 1fr 1fr; }
      .top-actions .btn{ padding:10px 10px; }
    }
  </style>
</head>

<body class="page">

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div style="min-width:0">
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>

      <div class="top-actions">
        <a class="btn" href="./index.html?v=11">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="mapWrap">
    <div id="map"></div>
  </div>

  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader">
      <div class="sheetHandle"></div>
    </div>

    <div class="sheetBody" id="sheetBody">
      <div class="sectionTitle">Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)</div>

      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
          </select>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
          <select id="centerSelect" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
          </select>
        </div>
      </div>

      <div class="note">* Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².</div>

      <div class="sep"></div>

      <div class="sectionTitle">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
      <div class="pills" id="vehiclePills">
        <button class="pillBtn" data-type="car" type="button">ğŸš— Ù…Ù„Ø§ÙƒÙŠ</button>
        <button class="pillBtn" data-type="tuktuk" type="button">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</button>
        <button class="pillBtn" data-type="motor_delivery" type="button">ğŸï¸ Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</button>
        <button class="pillBtn" data-type="microbus" type="button">ğŸšŒ Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</button>
        <button class="pillBtn" data-type="tamanya" type="button">ğŸš ØªÙ…Ù†Ø§ÙŠØ©</button>
        <button class="pillBtn" data-type="caboot" type="button">ğŸšš Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</button>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</div>

      <div class="field">
        <label>Ù…Ù†</label>
        <input id="fromText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚" autocomplete="off" />
      </div>

      <div class="field">
        <label>Ø¥Ù„Ù‰</label>
        <input id="toText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„" autocomplete="off" />
      </div>

      <div class="miniRow">
        <span class="miniChip bad" id="fromChip">Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
        <span class="miniChip bad" id="toChip">Ø§Ù„ÙˆØµÙˆÙ„: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
      </div>

      <div class="actions">
        <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn success" id="pickFromMapBtn" type="button">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
        <button class="btn success" id="pickToMapBtn" type="button">ğŸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØµÙˆÙ„</button>
      </div>

      <div class="actions">
        <button class="btn primary" id="createRideBtn" type="button">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>

      <div class="footerActions">
        <a class="btn" href="./index.html?v=11">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, setActiveRole } from "./app.js?v=10";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Auth
    setActiveRole("passenger");
    const { user } = await requireAuthAndRole("passenger");
    document.getElementById("who").textContent = user.email || user.phoneNumber || "-";
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    const msg = document.getElementById("msg");
    const fromChip = document.getElementById("fromChip");
    const toChip = document.getElementById("toChip");

    // ===== Leaflet Map
    let map, markerFrom=null, markerTo=null, meMarker=null;
    let pickMode = null; // "from" | "to"
    let fromLatLng=null, toLatLng=null;

    function setChip(el, ok, text){
      el.textContent = text;
      el.classList.remove("ok","bad");
      el.classList.add(ok ? "ok" : "bad");
    }

    function invalidateMapSoon(){
      try{ map?.invalidateSize?.(true); }catch{}
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 180);
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 420);
    }

    function fitBothIfReady(){
      if(!map) return;
      const pts = [];
      if(fromLatLng) pts.push([fromLatLng.lat, fromLatLng.lng]);
      if(toLatLng) pts.push([toLatLng.lat, toLatLng.lng]);
      if(pts.length === 1){
        map.setView(pts[0], 15, { animate:false });
        return;
      }
      if(pts.length === 2){
        try{
          const b = L.latLngBounds(pts);
          map.fitBounds(b, { padding:[40,40] });
        }catch{}
      }
    }

    function initMap(){
      const fallbackCenter = [24.0889, 32.8998]; // Ø£Ø³ÙˆØ§Ù†
      map = L.map("map", { zoomControl: true }).setView(fallbackCenter, 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      map.on("click", (e)=>{
        if(!pickMode) return;

        if(pickMode === "from"){
          fromLatLng = e.latlng;
          if(markerFrom) markerFrom.remove();
          markerFrom = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚").openPopup();
          pickMode = null;
          setChip(fromChip, true, `Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…`);
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.";
          fitBothIfReady();
        }else if(pickMode === "to"){
          toLatLng = e.latlng;
          if(markerTo) markerTo.remove();
          markerTo = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
          pickMode = null;
          setChip(toChip, true, `Ø§Ù„ÙˆØµÙˆÙ„: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…`);
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„.";
          fitBothIfReady();
        }
      });

      setTimeout(()=>{ locateMe(false); }, 450);
      invalidateMapSoon();
    }

    const waitLeaflet = setInterval(()=>{
      if(window.L){
        clearInterval(waitLeaflet);
        initMap();
      }
    }, 30);

    // ===== Ø²Ø± Ù…ÙˆÙ‚Ø¹ÙŠ
    function locateMe(showMsg=true){
      if(!navigator.geolocation){
        if(showMsg) msg.textContent="âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      if(showMsg) msg.textContent="ğŸ“ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";

      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if(map){
          map.setView([lat,lng], 16, { animate:false });
          if(!meMarker){
            meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
              .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");
          }else{
            meMarker.setLatLng([lat,lng]);
          }
        }
        if(showMsg) msg.textContent="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.";
      }, (err)=>{
        console.error(err);
        if(!showMsg) return;
        if(err?.code === 1) msg.textContent="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.";
        else msg.textContent="âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }
    document.getElementById("myLocBtn").addEventListener("click", ()=> locateMe(true));

    // ===== Regions (ÙƒØ§Ù…Ù„Ø©)
    const regions = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    const govSelect = document.getElementById("govSelect");
    const centerSelect = document.getElementById("centerSelect");

    Object.keys(regions).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const op = document.createElement("option");
      op.value = g;
      op.textContent = g;
      govSelect.appendChild(op);
    });

    govSelect.addEventListener("change", ()=>{
      const g = govSelect.value;
      centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>';
      if(!g){
        centerSelect.disabled = true;
        return;
      }
      regions[g].slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        centerSelect.appendChild(op);
      });
      centerSelect.disabled = false;
    });

    // ===== Vehicle pills
    let vehicleType = "car";
    const pillsWrap = document.getElementById("vehiclePills");
    function setVehicle(v){
      vehicleType = v;
      [...pillsWrap.querySelectorAll(".pillBtn")].forEach(b=>{
        b.classList.toggle("active", b.dataset.type === v);
      });
    }
    pillsWrap.addEventListener("click", (e)=>{
      const btn = e.target.closest(".pillBtn");
      if(!btn) return;
      setVehicle(btn.dataset.type);
    });
    setVehicle("car");

    // ======================================================
    // âœ… Geocoding: ÙƒØªØ§Ø¨Ø© "Ù…Ù†/Ø¥Ù„Ù‰" ØªØ­Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    // ======================================================
    let lastGeoAt = 0;
    function debounce(fn, ms){
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), ms);
      };
    }

    async function geocodeNominatim(q){
      const now = Date.now();
      if(now - lastGeoAt < 800) await new Promise(r=>setTimeout(r, 800 - (now - lastGeoAt)));
      lastGeoAt = Date.now();

      const url =
        "https://nominatim.openstreetmap.org/search" +
        "?format=json&limit=1&addressdetails=1" +
        "&accept-language=ar" +
        "&q=" + encodeURIComponent(q);

      const res = await fetch(url, { headers:{ "Accept":"application/json" } });
      if(!res.ok) throw new Error("geocode_failed");
      const data = await res.json();
      if(!data || !data.length) return null;
      const it = data[0];
      return { lat: Number(it.lat), lng: Number(it.lon), name: it.display_name || q };
    }

    const fromText = document.getElementById("fromText");
    const toText = document.getElementById("toText");

    async function applyGeocode(kind, q){
      const text = (q || "").trim();
      if(text.length < 3 || !map) return;

      msg.textContent = "ğŸ” Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ù†Øµâ€¦";
      try{
        const r = await geocodeNominatim(text);
        if(!r){
          msg.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø·Ø§Ø¨Ù‚.";
          return;
        }

        const ll = L.latLng(r.lat, r.lng);

        if(kind === "from"){
          fromLatLng = ll;
          if(markerFrom) markerFrom.remove();
          markerFrom = L.marker(ll).addTo(map).bindPopup("Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚").openPopup();
          setChip(fromChip, true, "Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }else{
          toLatLng = ll;
          if(markerTo) markerTo.remove();
          markerTo = L.marker(ll).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
          setChip(toChip, true, "Ø§Ù„ÙˆØµÙˆÙ„: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }

        fitBothIfReady();
        msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }
    }

    const debFrom = debounce(()=> applyGeocode("from", fromText.value), 750);
    const debTo   = debounce(()=> applyGeocode("to", toText.value), 750);

    fromText.addEventListener("input", debFrom);
    toText.addEventListener("input", debTo);
    fromText.addEventListener("blur", ()=> applyGeocode("from", fromText.value));
    toText.addEventListener("blur", ()=> applyGeocode("to", toText.value));

    // ===== Pick from map buttons
    const createRideBtn = document.getElementById("createRideBtn");
    document.getElementById("pickFromMapBtn").onclick = ()=>{
      pickMode = "from";
      msg.textContent = "ğŸ“ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.";
      setSheetSnap("mid");
    };
    document.getElementById("pickToMapBtn").onclick = ()=>{
      pickMode = "to";
      msg.textContent = "ğŸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„.";
      setSheetSnap("mid");
    };

    // ===== Send ride
    createRideBtn.onclick = async ()=>{
      msg.textContent = "";
      const governorate = govSelect.value;
      const center = centerSelect.value;

      if(!governorate || !center){
        msg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ø±ÙƒØ².";
        return;
      }
      if(!fromText.value.trim() || !toText.value.trim()){
        msg.textContent = "âŒ Ø§ÙƒØªØ¨ (Ù…Ù†) Ùˆ(Ø¥Ù„Ù‰).";
        return;
      }

      if(!fromLatLng) await applyGeocode("from", fromText.value);
      if(!toLatLng) await applyGeocode("to", toText.value);

      if(!fromLatLng || !toLatLng){
        msg.textContent = "âŒ Ù„Ø§Ø²Ù… ÙŠØªØ­Ø¯Ø¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù…Ù† Ø§Ù„Ù†Øµ Ø£Ùˆ Ø¨Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ).";
        return;
      }

      createRideBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨â€¦";

      try{
        const ridesRef = collection(db, "rides");
        const docRef = await addDoc(ridesRef, {
          passengerUid: user.uid,
          passengerEmail: user.email || null,
          passengerPhone: user.phoneNumber || null,
          passengerName: null,

          governorate,
          center,

          requestedVehicle: vehicleType,
          vehicleType,

          fromText: fromText.value.trim(),
          toText: toText.value.trim(),
          from: { lat: fromLatLng.lat, lng: fromLatLng.lng },
          to:   { lat: toLatLng.lat,   lng: toLatLng.lng },

          status: "open",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        msg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
        localStorage.setItem("currentRideId", docRef.id);
        setSheetSnap("min");
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
      }finally{
        createRideBtn.disabled = false;
      }
    };

    // ======================================================
    // âœ… Draggable Bottom Sheet (Uber-like Snap)
    // ======================================================
    const sheet = document.getElementById("sheet");
    const sheetHeader = document.getElementById("sheetHeader");

    const SNAP = { min: 0.28, mid: 0.52, max: 0.84 };
    let currentSnap = "mid";

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function setSheetHeight(px){
      const maxPx = Math.round(window.innerHeight * SNAP.max);
      const minPx = Math.round(window.innerHeight * SNAP.min);
      const v = clamp(px, minPx, maxPx);
      sheet.style.height = v + "px";
      invalidateMapSoon();
    }

    function setSheetSnap(name){
      currentSnap = name;
      setSheetHeight(Math.round(window.innerHeight * SNAP[name]));
    }

    setSheetSnap("mid");

    let dragging = false;
    let startY = 0;
    let startH = 0;

    sheetHeader.addEventListener("pointerdown", (e)=>{
      dragging = true;
      sheet.classList.add("dragging");
      startY = e.clientY;
      startH = sheet.getBoundingClientRect().height;
      sheetHeader.setPointerCapture(e.pointerId);
      try{ map?.dragging?.disable(); map?.scrollWheelZoom?.disable(); }catch{}
    });

    sheetHeader.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const dy = e.clientY - startY;
      setSheetHeight(startH - dy);
      e.preventDefault();
    }, { passive:false });

    function endDrag(){
      if(!dragging) return;
      dragging = false;
      sheet.classList.remove("dragging");

      const h = sheet.getBoundingClientRect().height;
      const targets = [
        { k:"min", h: window.innerHeight * SNAP.min },
        { k:"mid", h: window.innerHeight * SNAP.mid },
        { k:"max", h: window.innerHeight * SNAP.max },
      ];
      targets.sort((a,b)=>Math.abs(a.h - h) - Math.abs(b.h - h));
      setSheetSnap(targets[0].k);

      try{ map?.dragging?.enable(); map?.scrollWheelZoom?.enable(); }catch{}
    }

    sheetHeader.addEventListener("pointerup", endDrag);
    sheetHeader.addEventListener("pointercancel", endDrag);

    window.addEventListener("resize", ()=> setSheetSnap(currentSnap));
  </script>
</body>
</html>
