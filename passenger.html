<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body.page{ min-height:100vh; display:flex; flex-direction:column; overflow:hidden; }

    .topbar{
      position: sticky; top: 0; z-index: 60;
      background: rgba(5, 11, 22, 0.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand h1{
      margin:0; font-size:16px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:0; font-size:12px; color: rgba(255,255,255,0.70);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .logo{ width:44px; height:44px; border-radius:16px; font-size:18px; flex:0 0 auto; display:grid; place-items:center; }
    .top-actions{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
    .top-actions .btn{ padding:10px 12px; border-radius:18px; font-size:14px; min-height:44px; width:auto; }

    .mapWrap{ position:relative; flex:1; min-height: calc(100vh - 70px); overflow:hidden; background:#0b1222; }
    #map{ position:absolute; inset:0; z-index:1; }

    .sheet{
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      z-index: 2000;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: 0 26px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(10px);
      overflow: hidden;
      height: 54vh;
      transition: height .18s ease;
      will-change: height;
    }
    .sheet.dragging{ transition:none; }

    .sheetHeader{
      padding: 10px 14px 12px;
      display:flex; justify-content:center; align-items:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: pan-y;
    }
    .sheetHandle{
      width:56px; height:6px; border-radius:99px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.10);
    }
    .sheetBody{
      padding: 14px;
      overflow-y: auto;
      height: calc(100% - 44px);
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    .sectionTitle{ margin: 6px 0 10px; font-weight:900; font-size:14px; color: rgba(255,255,255,.90); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .note{ margin-top:10px; font-size:12px; color: rgba(255,255,255,.65); line-height:1.5; }
    .sep{ height:1px; background: rgba(255,255,255,0.06); margin:14px 0; }

    .pills{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .pillBtn{
      border-radius: 18px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(10, 16, 32, 0.55);
      cursor:pointer;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      min-height: 52px;
    }
    .pillBtn.active{
      background: linear-gradient(135deg, var(--blue1), var(--blue2));
      border-color: rgba(255,255,255,0.16);
      box-shadow:
        0 16px 44px rgba(0,0,0,0.30),
        0 0 0 3px rgba(46,107,255,0.12),
        inset 0 1px 0 rgba(255,255,255,0.16);
    }

    .actions{ display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
    .actions .btn{ flex: 1 1 140px; min-height:52px; width:auto; }

    .footerActions{ display:flex; gap:10px; margin-top:14px; }
    .footerActions .btn{ width:100%; }

    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .miniChip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .miniChip.ok{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.25); }
    .miniChip.bad{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.25); }

    .inputRow{ display:flex; gap:10px; align-items:stretch; }
    .inputRow input{ flex:1 1 auto; min-width:0; }
    .iconBtn{
      min-width: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10, 16, 32, 0.55);
      color: #fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .iconBtn:active{ transform: scale(.985); }

    /* âœ… Driver card */
    .driverCard{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10, 16, 32, 0.55);
      border-radius: 20px;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .driverRow{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .driverName{ font-weight:900; font-size:14px; }
    .driverMeta{ font-size:12px; color: rgba(255,255,255,.75); line-height:1.6; margin-top:6px; }
    .driverActions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .driverActions .btn{ flex: 1 1 140px; min-height:48px; }

    @media (max-width:420px){
      .grid2{ grid-template-columns: 1fr; }
      .pills{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body class="page">

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div style="min-width:0">
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>

      <div class="top-actions">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="mapWrap">
    <div id="map"></div>
  </div>

  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader">
      <div class="sheetHandle"></div>
    </div>

    <div class="sheetBody" id="sheetBody">
      <div class="sectionTitle">Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)</div>

      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
          </select>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
          <select id="centerSelect" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
          </select>
        </div>
      </div>

      <div class="note">* Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².</div>

      <div class="sep"></div>

      <div class="sectionTitle">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
      <div class="pills" id="vehiclePills">
        <button class="pillBtn" data-type="car" type="button">ğŸš— Ù…Ù„Ø§ÙƒÙŠ</button>
        <button class="pillBtn" data-type="tuktuk" type="button">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</button>
        <button class="pillBtn" data-type="motor_delivery" type="button">ğŸï¸ Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</button>
        <button class="pillBtn" data-type="microbus" type="button">ğŸšŒ Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</button>
        <button class="pillBtn" data-type="tamanya" type="button">ğŸš ØªÙ…Ù†Ø§ÙŠØ©</button>
        <button class="pillBtn" data-type="caboot" type="button">ğŸšš Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</button>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</div>

      <div class="field">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
        <div class="inputRow">
          <input id="fromText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…" autocomplete="off" />
          <button class="iconBtn" id="fromSearchBtn" type="button" title="Ø¨Ø­Ø«">ğŸ”</button>
        </div>
      </div>

      <div class="field">
        <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
        <div class="inputRow">
          <input id="toText" type="text" placeholder="Ø§ÙƒØªØ¨ Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„" autocomplete="off" />
          <button class="iconBtn" id="toSearchBtn" type="button" title="Ø¨Ø­Ø«">ğŸ”</button>
        </div>
      </div>

      <div class="miniRow">
        <span class="miniChip" id="fromChip">Ø§Ù„Ù‚ÙŠØ§Ù…: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
        <span class="miniChip" id="toChip">Ø§Ù„ÙˆØµÙˆÙ„: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
      </div>

      <div class="actions">
        <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn success" id="pickFromMapBtn" type="button">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚ÙŠØ§Ù… Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        <button class="btn success" id="pickToMapBtn" type="button">ğŸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      </div>

      <div class="actions">
  <button class="btn primary" id="createRideBtn" type="button" style="width:100%">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
</div>

<div class="actions">
  <button class="btn danger" id="cancelRideBtn" type="button" style="width:100%; display:none">â›” Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
</div>
      <div class="sep"></div>

      <div class="sectionTitle">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªØªØ¨Ø¹</div>
      <div class="actions">
        <button class="btn" id="trackBtn" type="button">ğŸ“¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹</button>
        <button class="btn" id="focusBtn" type="button">ğŸ§­ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      </div>
      <div class="hint" id="trackHint" style="margin-top:10px"></div>

      <!-- âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ØªØ¸Ù‡Ø± Ù„Ù„Ø±Ø§ÙƒØ¨ -->
      <div id="driverCard" class="driverCard" style="margin-top:12px; display:none">
        <div class="driverRow">
          <div class="driverName" id="dName">ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
          <span class="miniChip ok" id="dState">â€”</span>
        </div>

        <div class="driverMeta" id="dMeta">â€”</div>

        <div class="driverActions">
          <a class="btn success" id="callDriverBtn" href="javascript:void(0)" style="display:none">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>
          <button class="btn" id="navDriverBtn" type="button" style="display:none">ğŸ§­ Ù…Ù„Ø§Ø­Ø© Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
        </div>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>

      <div class="footerActions">
        <a class="btn" href="./index.html">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, setActiveRole, getUserDoc } from "./app.js";
    import {
      collection, addDoc, serverTimestamp,
      doc, onSnapshot, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");
    const safeNum = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };
    function dist2(a,b){ const dx=a.lat-b.lat, dy=a.lng-b.lng; return dx*dx+dy*dy; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function debounce(fn, ms){ let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    function escapeHTML(s){ return String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

    function vehText(v){
      v = clean(v);
      return (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":
        (v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":
        (v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":
        (v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":
        (v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":
        (v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª": (v||"-");
    }
    function statusText(st){
      st = clean(st);
      if(st==="open") return "Ù…ÙØªÙˆØ­";
      if(st==="offered") return "ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±";
      if(st==="accepted") return "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„";
      if(st==="arrived") return "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØµÙ„";
      if(st==="started") return "Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª";
      if(st==="completed"||st==="done") return "Ø§Ù†ØªÙ‡Øª";
      if(st==="canceled") return "Ù…Ù„ØºÙŠ";
      return st || "â€”";
    }
async function fetchRouteStatsOSRM(a, b){
  const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false`;
  const res = await fetch(url);
  const data = await res.json();
  const r = data?.routes?.[0];
  if(!r) return null;
  return { distanceM: r.distance, durationS: r.duration };
}

function estimatePriceEGP(vehicleType, distanceM){
  const km = (Number(distanceM) || 0) / 1000;

  const PRICING = {
    tuktuk:        { base: 10, perKm: 6 },
    motor_delivery:{ base: 10, perKm: 5 },
    car:           { base: 15, perKm: 8 },
    microbus:      { base: 20, perKm: 10 },
    tamanya:       { base: 25, perKm: 12 },
    caboot:        { base: 18, perKm: 9 },
  };

  const p = PRICING[vehicleType] || PRICING.car;
  const price = p.base + (km * p.perKm);
  return Math.max(p.base, Math.round(price));
}
    // ===== Auth
    setActiveRole("passenger");
    const { user } = await requireAuthAndRole("passenger");
    document.getElementById("who").textContent = user.email || user.phoneNumber || "-";
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    // load profile (phone/address/name)
    let passengerProfile = null;
    try{ passengerProfile = await getUserDoc(user.uid); }catch{ passengerProfile=null; }

    const msg = document.getElementById("msg");
    const fromChip = document.getElementById("fromChip"); 
    const toChip = document.getElementById("toChip");
    const trackHint = document.getElementById("trackHint");

    // driver card
    const driverCard = document.getElementById("driverCard");
    const dName = document.getElementById("dName");
    const dState = document.getElementById("dState");
    const dMeta = document.getElementById("dMeta");
    const callDriverBtn = document.getElementById("callDriverBtn");
    const navDriverBtn = document.getElementById("navDriverBtn");

    // ===== Leaflet
    let map, markerFrom=null, markerTo=null, meMarker=null, driverMarker=null, routeLine=null;
    let pickMode = null;
    let fromLatLng=null, toLatLng=null;
    let meLatLng = null;
    let lastDriverLL = null;

    function setChip(el, ok, text){
      el.textContent = text;
      el.classList.remove("ok","bad");
      el.classList.add(ok ? "ok" : "bad");
    }

    function invalidateMapSoon(){
      try{ map?.invalidateSize?.(true); }catch{}
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 180);
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 420);
    }

    function fitAll(){
      if(!map) return;
      const layers = [];
      if(meMarker) layers.push(meMarker);
      if(driverMarker) layers.push(driverMarker);
      if(markerFrom) layers.push(markerFrom);
      if(markerTo) layers.push(markerTo);
      if(routeLine) layers.push(routeLine);
      if(!layers.length) return;
      try{
        const g = L.featureGroup(layers);
        map.fitBounds(g.getBounds(), { padding:[40,40] });
      }catch{}
    }

    function fitFromTo(){
      if(!map) return;
      const pts = [];
      if(fromLatLng) pts.push([fromLatLng.lat, fromLatLng.lng]);
      if(toLatLng) pts.push([toLatLng.lat, toLatLng.lng]);
      if(pts.length === 1){Ø­
        map.setView(pts[0], 15, { animate:false });
        return;
      }
      if(pts.length === 2){
        try{
          map.fitBounds(L.latLngBounds(pts), { padding:[40,40] });
        }catch{}
      }
    }

    function initMap(){
      const fallbackCenter = [30.0444, 31.2357];
      map = L.map("map", { zoomControl: true }).setView(fallbackCenter, 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      map.on("click", (e)=>{
        if(!pickMode) return;

        if(pickMode === "from"){
          fromLatLng = e.latlng;
          if(markerFrom) markerFrom.remove();
          markerFrom = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
          pickMode = null;
          setChip(fromChip, true, `Ø§Ù„Ù‚ÙŠØ§Ù…: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…`);
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù….";
          drawRouteFromTo();
          fitFromTo();
        }else if(pickMode === "to"){
          toLatLng = e.latlng;
          if(markerTo) markerTo.remove();
          markerTo = L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
          pickMode = null;
          setChip(toChip, true, `Ø§Ù„ÙˆØµÙˆÙ„: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…`);
          msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„.";
          drawRouteFromTo();
          fitFromTo();
        }
      });

      setTimeout(()=>{ locateMe(false); }, 450);
      invalidateMapSoon();
    }

    const waitLeaflet = setInterval(()=>{
      if(window.L){
        clearInterval(waitLeaflet);
        initMap();
      }
    }, 30);

    function locateMe(showMsg=true){
      if(!navigator.geolocation){
        if(showMsg) msg.textContent="âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      if(showMsg) msg.textContent="ğŸ“ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";

      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        meLatLng = { lat, lng };

        if(map){
          map.setView([lat,lng], 16, { animate:false });
          if(!meMarker){
            meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
              .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");
          }else{
            meMarker.setLatLng([lat,lng]);
          }
        }

        if(showMsg) msg.textContent="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.";
      }, (err)=>{
        console.error(err);
        if(showMsg){
          if(err?.code === 1) msg.textContent="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.";
          else msg.textContent="âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    document.getElementById("myLocBtn").addEventListener("click", ()=> locateMe(true));

    // ===== Regions
    const regions = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    const govSelect = document.getElementById("govSelect");
    const centerSelect = document.getElementById("centerSelect");

    Object.keys(regions).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const op = document.createElement("option");
      op.value = g;
      op.textContent = g;
      govSelect.appendChild(op);
    });

    govSelect.addEventListener("change", ()=>{
      const g = govSelect.value;
      centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>';
      if(!g){
        centerSelect.disabled = true;
        return;
      }
      regions[g].slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        centerSelect.appendChild(op);
      });
      centerSelect.disabled = false;
    });

    // ===== Vehicle pills
    let vehicleType = "car";
    const pillsWrap = document.getElementById("vehiclePills");
    function setVehicle(v){
      vehicleType = v;
      [...pillsWrap.querySelectorAll(".pillBtn")].forEach(b=>{
        b.classList.toggle("active", b.dataset.type === v);
      });
    }
    pillsWrap.addEventListener("click", (e)=>{
      const btn = e.target.closest(".pillBtn");
      if(!btn) return;
      setVehicle(btn.dataset.type);
    });
    setVehicle("car");

    // ======================================================
    // âœ… Geocoding
    // ======================================================
    let lastGeoAt = 0;

async function geocodeNominatim(q, { governorate="", near=null } = {}){
  const now = Date.now();
  if(now - lastGeoAt < 650) await new Promise(r=>setTimeout(r, 650 - (now - lastGeoAt)));
  lastGeoAt = Date.now();

  const text = clean(q);
  if(text.length < 2) return null;

  // Ù†ÙƒÙˆÙ‘Ù† Ù†Øµ Ø§Ù„Ø¨Ø­Ø« (Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
  const wantGov = clean(governorate);
  const queryText = wantGov ? `${text}, ${wantGov}, Egypt` : `${text}, Egypt`;

  // Ù†Ø£Ø³Ù‘Ø³ Ø§Ù„Ù€ params
  let params =
    `format=json` +
    `&q=${encodeURIComponent(queryText)}` +
    `&countrycodes=eg` +and 
    
    `&limit=10` +
    `&addressdetails=1` +
    `&accept-language=ar`;

  // Ù„Ùˆ Ø¹Ù†Ø§ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ("bias")
  if(near && Number.isFinite(near.lat) && Number.isFinite(near.lng)){
    const d = 0.35; // Ø¯Ù‡ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ 35 ÙƒÙ…
    const left   = (near.lng - d);
    const right  = (near.lng + d);
    const top    = (near.lat + d);
    const bottom = (near.lat - d);
    params += `&viewbox=${left},${top},${right},${bottom}`;
  }

  const url = `https://nominatim.openstreetmap.org/search?${params}`;

  const res = await fetch(url, { headers: { "Accept": "application/json" }});
  if(!res.ok) throw new Error("geocode_failed");

  const data = await res.json();
  if(!data || !data.length) return null;

  const mapped = data.map(it=>{
    const lat = Number(it.lat);
    const lng = Number(it.lon);
    const addr = it.address || {};

    const state = clean(addr.state || addr.county || addr.city || addr.town || "");

    const scoreGov = (wantGov && state && (state.includes(wantGov) || wantGov.includes(state))) ? 1 : 0;

    const scoreDist = (near && Number.isFinite(lat) && Number.isFinite(lng))
      ? ((lat - near.lat)**2 + (lng - near.lng)**2)
      : 999999;

    return { lat, lng, name: it.display_name || text, scoreGov, scoreDist };
  }).filter(x=>Number.isFinite(x.lat) && Number.isFinite(x.lng));

  if(!mapped.length) return null;

  mapped.sort((a,b)=>{
    if(b.scoreGov !== a.scoreGov){
      const distRatio = (a.scoreDist + 1) / (b.scoreDist + 1);
      if(distRatio > 6) return a.scoreDist - b.scoreDist;
      return b.scoreGov - a.scoreGov;
    }
    return a.scoreDist - b.scoreDist;
  });

  return mapped[0];
}
    const fromText = document.getElementById("fromText");
    const toText = document.getElementById("toText");
    const fromSearchBtn = document.getElementById("fromSearchBtn");
    const toSearchBtn = document.getElementById("toSearchBtn");

    async function applyGeocode(kind, q, { silent=false } = {}){
      const text = clean(q);
      if(text.length < 3){
        if(!silent) msg.textContent = "âš ï¸ Ø§ÙƒØªØ¨ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
        return false;
      }

      if(!silent) msg.textContent = "ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù…ÙƒØ§Ù†â€¦";

      try{
        const gov = govSelect.value || "";
        const r = await geocodeNominatim(text, { governorate: gov, near: meLatLng });
        if(!r){
          if(!silent) msg.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ù‚Ø±ÙŠØ¨ Ù…Ø·Ø§Ø¨Ù‚.";
          return false;
        }

        const ll = L.latLng(r.lat, r.lng);

        if(kind === "from"){
          fromLatLng = ll;
          if(markerFrom) markerFrom.remove();
          markerFrom = L.marker(ll).addTo(map).bindPopup("Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
          setChip(fromChip, true, "Ø§Ù„Ù‚ÙŠØ§Ù…: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }else{
          toLatLng = ll;
          if(markerTo) markerTo.remove();
          markerTo = L.marker(ll).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
          setChip(toChip, true, "Ø§Ù„ÙˆØµÙˆÙ„: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }

        drawRouteFromTo();
        fitFromTo();
        if(!silent) msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚Ø±Ø¨ Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
        return true;
      }catch(e){
        console.error(e);
        if(!silent) msg.textContent = "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        return false;
      }
    }

    const debFrom = debounce(()=> applyGeocode("from", fromText.value, { silent:true }), 700);
    const debTo   = debounce(()=> applyGeocode("to", toText.value, { silent:true }), 700);

    fromText.addEventListener("input", debFrom);
    toText.addEventListener("input", debTo);

    fromText.addEventListener("blur", ()=> applyGeocode("from", fromText.value));
    toText.addEventListener("blur", ()=> applyGeocode("to", toText.value));

    fromSearchBtn.addEventListener("click", ()=> applyGeocode("from", fromText.value));
    toSearchBtn.addEventListener("click", ()=> applyGeocode("to", toText.value));

    // ======================================================
    // âœ… Route (OSRM)
    // ======================================================
    let lastRouteAt = 0;

    async function fetchRouteOSRM(a,b){
      const url =
        `https://router.project-osrm.org/route/v1/driving/`+
        `${a.lng},${a.lat};${b.lng},${b.lat}`+
        `?overview=full&geometries=geojson`;

      const res = await fetch(url, { headers:{ Accept:"application/json" } });
      if(!res.ok) throw new Error("osrm_failed");
      const data = await res.json();
      const coords = data?.routes?.[0]?.geometry?.coordinates;
      if(!coords?.length) return null;
      return coords.map(([lng,lat])=>[lat,lng]);
    }

    async function drawRouteFromTo(){
      if(!map || !fromLatLng || !toLatLng) return;

      const now = Date.now();
      if(now - lastRouteAt < 1200) return;
      lastRouteAt = now;

      try{
        const pts = await fetchRouteOSRM(
          {lat: fromLatLng.lat, lng: fromLatLng.lng},
          {lat: toLatLng.lat,   lng: toLatLng.lng}
        );
        if(!pts) return;

        if(routeLine){ try{ map.removeLayer(routeLine); }catch{} }
        routeLine = L.polyline(pts, { weight: 5, opacity: 0.92 }).addTo(map);

        fitFromTo();
        invalidateMapSoon();
      }catch(e){
        console.error(e);
      }
    }

    // ===== Pick from map
    const createRideBtn = document.getElementById("createRideBtn");
const cancelRideBtn = document.getElementById("cancelRideBtn");
    document.getElementById("pickFromMapBtn").onclick = ()=>{
  pickMode = "from";
  msg.textContent = "ğŸ“ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù….";
  setSheetSnap("mid");
};
    document.getElementById("pickToMapBtn").onclick = ()=>{
      pickMode = "to";
      msg.textContent = "ğŸ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„.";
      setSheetSnap("mid");
    };

    // ===== Send ride
    createRideBtn.onclick = async ()=>{
      msg.textContent = "";
      const governorate = govSelect.value;
      const center = centerSelect.value;

      if(!governorate || !center){
        msg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ø±ÙƒØ².";
        return;
      }
      if(!clean(fromText.value) || !clean(toText.value)){
        msg.textContent = "âŒ Ø§ÙƒØªØ¨ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆÙ…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„.";
        return;
      }

      if(!fromLatLng){
        const ok = await applyGeocode("from", fromText.value);
        if(!ok) return;
      }
      if(!toLatLng){
        const ok = await applyGeocode("to", toText.value);
        if(!ok) return;
      }

      if(!fromLatLng || !toLatLng){
        msg.textContent = "âŒ Ù„Ø§Ø²Ù… ÙŠØªØ­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
        return;
      }

      createRideBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨â€¦";

        // âœ… Ø§Ø­Ø³Ø¨ Ø³Ø¹Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ ÙˆØ§Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø©
let priceEGP = null;
try{
  const stats = await fetchRouteStatsOSRM(
    { lat: fromLatLng.lat, lng: fromLatLng.lng },
    { lat: toLatLng.lat,   lng: toLatLng.lng }
  );
  if(stats?.distanceM) priceEGP = estimatePriceEGP(vehicleType, stats.distanceM);
}catch(e){}
        try{ passengerProfile = await getUserDoc(user.uid); }catch{}

        const passengerPhone = passengerProfile?.phone || user.phoneNumber || null;
        const passengerAddress = passengerProfile?.address || null;
        const passengerName = passengerProfile?.name || null;

        const ridesRef = collection(db, "rides");
        const docRef = await addDoc(ridesRef, {
          passengerUid: user.uid,
          passengerEmail: user.email || null,
          passengerPhone: passengerPhone || null,
          passengerAddress: passengerAddress || null,
          passengerName: passengerName || null,

          governorate,
          center,

          requestedVehicle: vehicleType,
          vehicleType,
          priceEGP: priceEGP,

          fromText: clean(fromText.value),
          toText: clean(toText.value),
          from: { lat: fromLatLng.lat, lng: fromLatLng.lng },
          to:   { lat: toLatLng.lat,   lng: toLatLng.lng },

          passengerLive: meLatLng ? { lat: meLatLng.lat, lng: meLatLng.lng, at: serverTimestamp() } : null,
          passengerLiveAt: meLatLng ? serverTimestamp() : null,

          status: "open",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        msg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
        localStorage.setItem("currentRideId", docRef.id);
        startWatchRide(docRef.id);
        setSheetSnap("min");
        cancelRideBtn.style.display = "inline-flex";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.";
      }finally{
  cancelRideBtn.disabled = false;
  cancelRideBtn.textContent = "ğŸ›‘ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©";
}
    };
function clearCurrentRideUI(){
  localStorage.removeItem("currentRideId");
  currentRideId = null;
  try{ hideDriverCard(); }catch(e){}
  cancelRideBtn.style.display = "none";
}

cancelRideBtn.addEventListener("click", async ()=>{
  if(!currentRideId) return;

  cancelRideBtn.disabled = true;
  try{
    await updateDoc(doc(db, "rides", currentRideId), {
      status: "canceled",
      canceledBy: "passenger",
      updatedAt: serverTimestamp(),
    });

    msg.textContent = "ğŸ›‘ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
    clearCurrentRideUI();
  }catch(e){
    console.error(e);
    msg.textContent = "âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡.";
  }finally{
    cancelRideBtn.disabled = false;
  }
});
    // ======================================================
    // âœ… Draggable Bottom Sheet
    // ======================================================
    const sheet = document.getElementById("sheet");
    const sheetHeader = document.getElementById("sheetHeader");

    const SNAP = { min: 0.30, mid: 0.54, max: 0.84 };
    let currentSnap = "mid";

    function setSheetHeight(px){
      const maxPx = Math.round(window.innerHeight * SNAP.max);
      const minPx = Math.round(window.innerHeight * SNAP.min);
      const v = clamp(px, minPx, maxPx);
      sheet.style.height = v + "px";
      invalidateMapSoon();
    }

    function setSheetSnap(name){
      currentSnap = name;
      setSheetHeight(Math.round(window.innerHeight * SNAP[name]));
    }

    setSheetSnap("mid");

    let dragging = false;
    let startY = 0;
    let startH = 0;

    sheetHeader.addEventListener("pointerdown", (e)=>{
      dragging = true;
      sheet.classList.add("dragging");
      startY = e.clientY;
      startH = sheet.getBoundingClientRect().height;
      sheetHeader.setPointerCapture(e.pointerId);
      try{ map?.dragging?.disable(); map?.scrollWheelZoom?.disable(); }catch{}
    });

    sheetHeader.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const dy = e.clientY - startY;
      setSheetHeight(startH - dy);
      e.preventDefault();
    }, { passive:false });

    function endDrag(){
      if(!dragging) return;
      dragging = false;
      sheet.classList.remove("dragging");

      const h = sheet.getBoundingClientRect().height;
      const targets = [
        { k:"min", h: window.innerHeight * SNAP.min },
        { k:"mid", h: window.innerHeight * SNAP.mid },
        { k:"max", h: window.innerHeight * SNAP.max },
      ];
      targets.sort((a,b)=>Math.abs(a.h - h) - Math.abs(b.h - h));
      setSheetSnap(targets[0].k);

      try{ map?.dragging?.enable(); map?.scrollWheelZoom?.enable(); }catch{}
    }

    sheetHeader.addEventListener("pointerup", endDrag);
    sheetHeader.addEventListener("pointercancel", endDrag);
    window.addEventListener("resize", ()=> setSheetSnap(currentSnap));

    // ======================================================
    // âœ… LIVE TRACKING
    // ======================================================
    const trackBtn = document.getElementById("trackBtn");
    const focusBtn = document.getElementById("focusBtn");

    let currentRideId = localStorage.getItem("currentRideId") || null;
    let unsubRide = null;
    let unsubDriverStatus = null;
    let trackingOn = false;
    let watchId = null;
    let rideRef = null;
    let currentDriverUid = null;

    focusBtn.addEventListener("click", ()=>{
      fitAll();
      msg.textContent = "ğŸ§­ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
    });

    function stopTracking(){
      trackingOn = false;
      trackBtn.textContent = "ğŸ“¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹";
      trackHint.textContent = "Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªÙˆÙ‚Ù.";
      if(watchId != null){
        try{ navigator.geolocation.clearWatch(watchId); }catch{}
        watchId = null;
      }
    }

    async function startTracking(){
      if(!currentRideId){
        trackHint.textContent = "âš ï¸ Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }
      if(!navigator.geolocation){
        trackHint.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      if(trackingOn) return;

      trackingOn = true;
      trackBtn.textContent = "â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹";
      trackHint.textContent = "ğŸ“¡ Ø§Ù„ØªØªØ¨Ø¹ Ø´ØºØ§Ù„â€¦";

      watchId = navigator.geolocation.watchPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        meLatLng = { lat, lng };

        if(map){
          if(!meMarker){
            meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
              .addTo(map).bindPopup("ğŸ“ Ø£Ù†Øª");
          }else{
            meMarker.setLatLng([lat,lng]);
          }
        }

        try{
          if(rideRef){
            await updateDoc(rideRef, {
              passengerLive: { lat, lng, at: serverTimestamp() },
              passengerLiveAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
          }
        }catch(e){}
      }, (err)=>{
        console.error(err);
        trackHint.textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªØªØ¨Ø¹. ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        stopTracking();
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    trackBtn.addEventListener("click", async ()=>{
      if(trackingOn) stopTracking();
      else await startTracking();
    });

    // fallback: driver_status
    function watchDriverStatusFallback(uid){
      if(unsubDriverStatus){ try{unsubDriverStatus()}catch{} unsubDriverStatus=null; }
      if(!uid) return;

      const stRef = doc(db, "driver_status", uid);
      unsubDriverStatus = onSnapshot(stRef, (snap)=>{
        if(!snap.exists()) return;
        const d = snap.data();
        const lat = safeNum(d.lat);
        const lng = safeNum(d.lng);
        if(lat==null || lng==null) return;
        setDriverOnMap(lat, lng, { name: null });
      });
    }

    function setDriverOnMap(lat, lng, { name=null } = {}){
      if(!map) return;
      lastDriverLL = { lat, lng };

      const popupText = name ? `ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚: ${name}` : "ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚";
      if(!driverMarker){
        driverMarker = L.marker([lat,lng]).addTo(map).bindPopup(popupText);
      }else{
        driverMarker.setLatLng([lat,lng]);
        try{ driverMarker.setPopupContent(popupText); }catch{}
      }

      navDriverBtn.style.display = "inline-flex";
    }

    function openGoogleMapsNav(lat, lng){
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
      window.open(url, "_blank");
    }

    navDriverBtn.addEventListener("click", ()=>{
      if(!lastDriverLL) return;
      openGoogleMapsNav(lastDriverLL.lat, lastDriverLL.lng);
    });

    function showDriverCard(driver, status){
      const name = clean(driver?.name) || "Ø§Ù„Ø³Ø§Ø¦Ù‚";
      const phone = clean(driver?.phone) || "";
      const vehicle = clean(driver?.vehicle) || "";
      const model = clean(driver?.model) || "";
      const plate = clean(driver?.plate) || "";
      const email = clean(driver?.email) || "";
      const priceEGP  = Number(driver?.priceEGP);
const priceTxt  = Number.isFinite(priceEGP) ? `${Math.round(priceEGP)} Ø¬.Ù…` : null;
      const stText = statusText(status);
      dName.textContent = `ğŸš— ${name}`;
      dState.textContent = stText;

      dState.classList.remove("ok","bad");
      const okStates = ["offered","accepted","arrived","started"];
      dState.classList.add(okStates.includes(clean(status)) ? "ok" : "bad");

      const parts = [];
if(priceText){
  parts.push(`<b>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</b> ${escapeHTML(priceText)}`);
}
      if(vehicle || model) parts.push(`<b>Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</b> ${escapeHTML(vehText(vehicle))}${model ? ` â€¢ ${escapeHTML(model)}` : ""}`);
      if(plate) parts.push(`<b>Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${escapeHTML(plate)}`);
      if(phone) parts.push(`<b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${escapeHTML(phone)}`);
      if(email) parts.push(`<b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${escapeHTML(email)}`);

      dMeta.innerHTML = parts.length ? parts.join("<br>") : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¦Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹.";

      if(phone){
        callDriverBtn.style.display = "inline-flex";
        callDriverBtn.href = `tel:${phone}`;
      }else{
        callDriverBtn.style.display = "none";
        callDriverBtn.href = "javascript:void(0)";
      }

      driverCard.style.display = "block";
    }

    function hideDriverCard(){
      driverCard.style.display = "none";
      lastDriverLL = null;
      navDriverBtn.style.display = "none";
      if(driverMarker){ try{ map.removeLayer(driverMarker); }catch{} driverMarker=null; }
    }

    function startWatchRide(id){
      currentRideId = id;
      rideRef = doc(db, "rides", id);

      if(unsubRide){ try{unsubRide()}catch{} unsubRide=null; }
      unsubRide = onSnapshot(rideRef, async (snap)=>{
        if(!snap.exists()){
          msg.textContent = "âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          hideDriverCard();
          return;
        }
        const r = snap.data();
        const st = r.status || "-";

        const duid = r.driverUid || null;

        if(duid && duid !== currentDriverUid){
          currentDriverUid = duid;
          watchDriverStatusFallback(duid);
        }

        const dLat = safeNum(r.driverLive?.lat);
        const dLng = safeNum(r.driverLive?.lng);
        const driverName = clean(r.driverName || "");

        if(dLat!=null && dLng!=null){
          setDriverOnMap(dLat, dLng, { name: driverName || null });
        }

        if(duid){
          showDriverCard({
            name: r.driverName || "Ø³Ø§Ø¦Ù‚",
            phone: r.driverPhone || "",
            vehicle: r.driverVehicle || "",
            model: r.driverModel || "",
            plate: r.driverPlate || "",   // âœ… Ù‡ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø§ Ù†Ø¶ÙŠÙÙ‡Ø§ ÙÙŠ driver.html
            priceEGP: (r.offerPriceEGP ?? r.priceEGP ?? r.fareEGP ?? null),
            email: r.driverEmail || ""
          }, st);
        }else{
          hideDriverCard();
        }

        const shouldAutoTrack = !!duid && ["accepted","arrived","started"].includes(st);
        if(shouldAutoTrack && !trackingOn){
          await startTracking();
        }

        trackHint.textContent = `Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${statusText(st)}${duid ? " â€¢ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚ âœ…" : ""}`;

        const pLat = safeNum(r.from?.lat), pLng = safeNum(r.from?.lng);
        const tLat = safeNum(r.to?.lat),   tLng = safeNum(r.to?.lng);

        if(pLat!=null && pLng!=null && map){
          fromLatLng = L.latLng(pLat,pLng);
          if(!markerFrom){
            markerFrom = L.marker([pLat,pLng]).addTo(map).bindPopup("Ø§Ù„Ù‚ÙŠØ§Ù…");
          }else markerFrom.setLatLng([pLat,pLng]);
          setChip(fromChip, true, "Ø§Ù„Ù‚ÙŠØ§Ù…: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }

        if(tLat!=null && tLng!=null && map){
          toLatLng = L.latLng(tLat,tLng);
          if(!markerTo){
            markerTo = L.marker([tLat,tLng]).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„");
          }else markerTo.setLatLng([tLat,tLng]);
          setChip(toChip, true, "Ø§Ù„ÙˆØµÙˆÙ„: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ âœ…");
        }

        drawRouteFromTo();

        if(["completed","canceled","done"].includes(st)){
          stopTracking();
          msg.textContent = "âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
        }
      });
    }

    // init watch if exists
    if(currentRideId){
      setTimeout(()=> startWatchRide(currentRideId), 700);
    }
  </script>
</body>
</html>
