<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ±Ø§Ùƒ - Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</title>

  <!-- Leaflet + OSM -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{font-family:system-ui,Arial; margin:0; background:#0b0f14; color:#e8eef7;}
    header{padding:14px 16px; background:#101825; position:sticky; top:0;}
    h1{margin:0; font-size:18px;}
    #map{height:52vh;}
    .wrap{padding:14px 16px; display:grid; gap:12px;}
    .card{background:#101825; border:1px solid #1f2a3a; border-radius:14px; padding:12px;}
    label{display:block; font-size:13px; opacity:.9; margin-bottom:6px;}
    input,textarea{width:100%; padding:10px; border-radius:10px; border:1px solid #273449; background:#0b0f14; color:#e8eef7;}
    button{padding:12px; border:0; border-radius:12px; background:#2b6cff; color:white; font-weight:800; cursor:pointer;}
    button.secondary{background:#24344a;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hint{font-size:13px; opacity:.85; line-height:1.5}
    .pill{display:inline-block; padding:4px 10px; border:1px solid #273449; border-radius:999px; font-size:12px; opacity:.9}
    .mini{padding:10px 10px; border-radius:10px; font-weight:800}
    .field{display:grid; gap:8px}
    .grid3{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end}
    .err{color:#ffb4b4}
  </style>
</head>
<body>
  <header>
    <h1>ğŸš– Ù…Ø´ÙˆØ±Ø§Ùƒ â€” Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</h1>
  </header>

  <div id="map"></div>

  <div class="wrap">
    <div class="card">
      <div class="hint">
        Ø§ÙƒØªØ¨ <b>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</b> Ùˆ<b>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</b> ÙˆØ§Ø¶ØºØ· â€œØ¨Ø­Ø«â€.
        <br><span class="pill" id="status">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦</span>
        <div id="geoMsg" class="hint err" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="card">
      <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù† -->
      <div class="row">
        <div class="field">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
          <div class="grid3">
            <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
            <button class="mini" id="fromSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>

        <div class="field">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
          <div class="grid3">
            <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
            <button class="mini" id="toSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 010..." />
        </div>
        <div>
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="passengers" type="number" min="1" placeholder="1" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="note" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ÙŠ Ø´Ù†Ø·Ø©â€¦"></textarea>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button id="createBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
        <button id="myLocBtn" class="secondary">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button id="resetBtn" class="secondary">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>

      <p class="hint" id="result"></p>
      <p class="hint">ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚: <b>driver.html</b></p>
    </div>
  </div>

  <!-- Firebase (CDN Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø®Ø±ÙŠØ·Ø© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
    const map = L.map('map').setView([30.0444, 31.2357], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let from = null, to = null;
    let fromMarker = null, toMarker = null;
    let line = null;

    const statusEl = document.getElementById('status');
    const createBtn = document.getElementById('createBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultEl = document.getElementById('result');
    const geoMsg = document.getElementById('geoMsg');

    const fromText = document.getElementById('fromText');
    const toText = document.getElementById('toText');
    const fromSearchBtn = document.getElementById('fromSearchBtn');
    const toSearchBtn = document.getElementById('toSearchBtn');

    const myLocBtn = document.getElementById('myLocBtn');
    let myLocMarker = null;

    function updateUI(){
      if(!from){
        statusEl.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        createBtn.disabled = true;
      } else if(from && !to){
        statusEl.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
        createBtn.disabled = true;
      } else {
        statusEl.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ âœ…";
        createBtn.disabled = false;
      }
    }

    function drawLineIfReady(){
      if(from && to){
        if(line) map.removeLayer(line);
        line = L.polyline([from, to], {}).addTo(map);
        map.fitBounds(line.getBounds(), { padding: [30,30] });
      }
    }

    function setFrom(lat, lng){
      from = { lat, lng };
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      map.setView([lat, lng], 14);
      drawLineIfReady();
      updateUI();
    }

    function setTo(lat, lng){
      to = { lat, lng };
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
      map.setView([lat, lng], 14);
      drawLineIfReady();
      updateUI();
    }

    // Ø¨Ø­Ø« Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ø¨Ø± Nominatim (OSM)
    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {
        headers: {
          "Accept": "application/json",
          "User-Agent": "MeshwarakApp/1.0 (demo)"
        }
      });
      if(!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø«");
      const data = await res.json();
      if(!data || data.length === 0) return null;
      return { lat: Number(data[0].lat), lng: Number(data[0].lon), display: data[0].display_name };
    }

    async function handleSearch(type){
      geoMsg.textContent = "";
      const text = (type === "from" ? fromText.value : toText.value).trim();
      if(!text){
        geoMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
        return;
      }

      const btn = (type === "from" ? fromSearchBtn : toSearchBtn);
      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±Ùâ€¦";

      try{
        const r = await geocode(text);
        if(!r){
          geoMsg.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†. Ø¬Ø±Ø¨ ØªÙƒØªØ¨ Ø§Ø³Ù… Ø£ÙˆØ¶Ø­ + Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.";
          return;
        }
        geoMsg.textContent = "";

        if(type === "from"){
          setFrom(r.lat, r.lng);
        } else {
          setTo(r.lat, r.lng);
        }
      }catch(e){
        console.error(e);
        geoMsg.textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ.";
      }finally{
        btn.disabled = false;
        btn.textContent = "Ø¨Ø­Ø«";
      }
    }

    fromSearchBtn.addEventListener('click', () => handleSearch("from"));
    toSearchBtn.addEventListener('click', () => handleSearch("to"));
    fromText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("from"); });
    toText.addEventListener('keydown', (e) => { if(e.key === "Enter") handleSearch("to"); });

    function showMyLocation(){
      geoMsg.textContent = "";

      if(!navigator.geolocation){
        geoMsg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        return;
      }

      myLocBtn.disabled = true;
      myLocBtn.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if(myLocMarker) map.removeLayer(myLocMarker);
          myLocMarker = L.marker([lat, lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();

          map.setView([lat, lng], 16);

          myLocBtn.disabled = false;
          myLocBtn.textContent = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ";
        },
        (err) => {
          console.error(err);
          geoMsg.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§ÙØªØ­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.";
          myLocBtn.disabled = false;
          myLocBtn.textContent = "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    myLocBtn.addEventListener('click', showMyLocation);

    function resetAll(){
      from = null; to = null;

      fromText.value = "";
      toText.value = "";

      if(fromMarker) map.removeLayer(fromMarker);
      if(toMarker) map.removeLayer(toMarker);
      if(line) map.removeLayer(line);

      fromMarker = null;
      toMarker = null;
      line = null;

      if(myLocMarker) map.removeLayer(myLocMarker);
      myLocMarker = null;

      geoMsg.textContent = "";
      resultEl.textContent = "";
      updateUI();
    }

    resetBtn.addEventListener('click', resetAll);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    createBtn.addEventListener('click', async () => {
      try{
        createBtn.disabled = true;
        resultEl.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const phone = document.getElementById('phone').value.trim();
        const passengers = Number(document.getElementById('passengers').value || 0);
        const note = document.getElementById('note').value.trim();

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),
          from, to,
          phone: phone || null,
          passengers: passengers || null,
          note: note || null,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null
        });

        resultEl.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${docRef.id}`;
      }catch(err){
        console.error(err);
        resultEl.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules ÙˆØ§Ø³Ù… Collection rides.";
      }finally{
        updateUI();
      }
    });

    updateUI();
  </script>
</body>
</html>
