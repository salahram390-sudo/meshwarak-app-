<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="styles.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">ğŸš•</div>
        <div>
          <h1>Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</h1>
          <p class="small">Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„</p>
        </div>
      </div>
      <a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet">
      <div class="sheet-handle"></div>

      <div class="pills">
        <span class="pill" id="statusPill">Ø§Ø¨Ø¯Ø£ Ø¨ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ</span>
        <span class="pill" id="kmPill">Ø§Ù„Ù…Ø³Ø§ÙØ©: -</span>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="field" style="margin-top:0">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
          <div class="grid3">
            <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
            <button class="btn" id="fromSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
          <div class="grid3">
            <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
            <button class="btn" id="toSearchBtn">Ø¨Ø­Ø«</button>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
          <select id="vehicle">
            <option value="tuktuk">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</option>
            <option value="car" selected>ğŸš— Ù…Ù„Ø§ÙƒÙŠ</option>
            <option value="microbus">ğŸš Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="passengers" type="number" min="1" placeholder="1" />
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="phone" placeholder="010..." />
        </div>
        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="note" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ÙŠ Ø´Ù†Ø·Ø©â€¦" />
        </div>
      </div>

      <div class="field">
        <label>Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ (ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø±Ù‡)</label>
        <input id="price" type="range" min="20" max="300" step="5" value="60">
        <div class="small">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="priceVal">60</b> Ø¬Ù†ÙŠÙ‡</div>
      </div>

      <div class="actions">
        <button class="btn" id="myLocBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn primary" id="createBtn" disabled>ğŸš• Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
      </div>

      <div class="hint" id="result" style="margin-top:10px"></div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole } from "./app.js";
    await requireAuthAndRole("passenger");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Fix Ø´Ø§Ø¦Ø¹: Ù„Ø§Ø²Ù… invalidateSize Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø¨ÙŠØ­Ù„ â€œØ§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø´ Ø¸Ø§Ù‡Ø±Ø©â€)
    const map = L.map('map', { zoomControl:false }).setView([30.0444, 31.2357], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    setTimeout(()=> map.invalidateSize(true), 250);

    let from=null, to=null, fromMarker=null, toMarker=null, line=null;

    const statusPill = document.getElementById("statusPill");
    const kmPill = document.getElementById("kmPill");
    const createBtn = document.getElementById("createBtn");
    const resultEl = document.getElementById("result");

    const fromText = document.getElementById("fromText");
    const toText = document.getElementById("toText");
    const fromSearchBtn = document.getElementById("fromSearchBtn");
    const toSearchBtn = document.getElementById("toSearchBtn");
    const myLocBtn = document.getElementById("myLocBtn");

    const vehicleEl = document.getElementById("vehicle");
    const priceEl = document.getElementById("price");
    const priceVal = document.getElementById("priceVal");

    function haversine(a,b){
      const R=6371;
      const dLat=(b.lat-a.lat)*Math.PI/180;
      const dLng=(b.lng-a.lng)*Math.PI/180;
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const q=s1*s1+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
      return 2*R*Math.asin(Math.sqrt(q));
    }

    function priceSuggest(km){
      const base = vehicleEl.value === "tuktuk" ? 12 : vehicleEl.value === "microbus" ? 18 : 15;
      const min = vehicleEl.value === "tuktuk" ? 20 : 35;
      const p = Math.max(min, Math.round((base * km + 20) / 5) * 5);
      return Math.min(300, p);
    }

    function updatePriceUI(){
      priceVal.textContent = priceEl.value;
    }
    priceEl.addEventListener("input", updatePriceUI);
    vehicleEl.addEventListener("change", ()=>{
      if(from && to){
        const km = haversine(from,to);
        priceEl.value = String(priceSuggest(km));
        updatePriceUI();
      }
    });

    function updateUI(){
      if(!from){
        statusPill.textContent = "Ø­Ø¯Ù‘Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…";
        statusPill.className = "pill";
        createBtn.disabled = true;
        kmPill.textContent = "Ø§Ù„Ù…Ø³Ø§ÙØ©: -";
        return;
      }
      if(from && !to){
        statusPill.textContent = "âœ… Ø§Ù„Ù‚ÙŠØ§Ù… Ù…Ø­Ø¯Ø¯ â€” Ø­Ø¯Ù‘Ø¯ Ø§Ù„ÙˆØµÙˆÙ„";
        statusPill.className = "pill ok";
        createBtn.disabled = true;
        kmPill.textContent = "Ø§Ù„Ù…Ø³Ø§ÙØ©: -";
        return;
      }
      const km = haversine(from,to);
      kmPill.textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${km.toFixed(2)} ÙƒÙ…`;
      statusPill.textContent = "âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ù„Ø¨";
      statusPill.className = "pill ok";
      createBtn.disabled = false;

      // Ø§Ù‚ØªØ±Ø­ Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
      priceEl.value = String(priceSuggest(km));
      updatePriceUI();
    }

    function drawLine(){
      if(from && to){
        if(line) map.removeLayer(line);
        line = L.polyline([[from.lat,from.lng],[to.lat,to.lng]], {}).addTo(map);
        map.fitBounds(line.getBounds(), { padding:[40,40] });
      }
    }

    function setFrom(lat,lng){
      from = {lat,lng};
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      map.setView([lat,lng], 15);
      drawLine(); updateUI();
    }

    function setTo(lat,lng){
      to = {lat,lng};
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
      map.setView([lat,lng], 15);
      drawLine(); updateUI();
    }

    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers:{ "Accept":"application/json" }});
      if(!res.ok) throw new Error("geocode fail");
      const data = await res.json();
      if(!data?.length) return null;
      return { lat:+data[0].lat, lng:+data[0].lon };
    }

    async function handleSearch(type){
      const text = (type==="from"?fromText.value:toText.value).trim();
      if(!text){ resultEl.textContent="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«."; return; }

      const btn = type==="from"?fromSearchBtn:toSearchBtn;
      btn.disabled=true; btn.textContent="â€¦";
      try{
        const r = await geocode(text);
        if(!r){ resultEl.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†."; return; }
        resultEl.textContent="";
        type==="from" ? setFrom(r.lat,r.lng) : setTo(r.lat,r.lng);
      }catch(e){
        console.error(e);
        resultEl.textContent="Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }finally{
        btn.disabled=false; btn.textContent="Ø¨Ø­Ø«";
      }
    }

    fromSearchBtn.addEventListener("click",()=>handleSearch("from"));
    toSearchBtn.addEventListener("click",()=>handleSearch("to"));

    myLocBtn.addEventListener("click", ()=>{
      if(!navigator.geolocation){
        resultEl.textContent="Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        return;
      }
      myLocBtn.disabled=true; myLocBtn.textContent="Ø¬Ø§Ø±Ùâ€¦";
      navigator.geolocation.getCurrentPosition((pos)=>{
        setFrom(pos.coords.latitude, pos.coords.longitude);
        myLocBtn.disabled=false; myLocBtn.textContent="ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ";
      }, ()=>{
        resultEl.textContent="ÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.";
        myLocBtn.disabled=false; myLocBtn.textContent="ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ";
      }, { enableHighAccuracy:true, timeout:10000 });
    });

    createBtn.addEventListener("click", async ()=>{
      try{
        createBtn.disabled=true;
        resultEl.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const phone = document.getElementById("phone").value.trim();
        const passengers = Number(document.getElementById("passengers").value || 0) || null;
        const note = document.getElementById("note").value.trim() || null;
        const vehicle = vehicleEl.value;
        const price = Number(priceEl.value);

        const docRef = await addDoc(collection(db,"rides"),{
          status:"open",
          createdAt: serverTimestamp(),
          from, to,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null,
          phone: phone || null,
          passengers,
          note,
          vehicle,
          price
        });

        resultEl.innerHTML = `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø±Ù‚Ù…: <b>${docRef.id}</b>`;
      }catch(e){
        console.error(e);
        resultEl.textContent="âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨. Ø±Ø§Ø¬Ø¹ Firestore Rules.";
      }finally{
        updateUI();
      }
    });

    updateUI();
  </script>
</body>
</html>
