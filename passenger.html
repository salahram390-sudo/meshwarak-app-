<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <!-- Leaflet + OSM -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#101825; --card2:#0f1622;
      --stroke:#1f2a3a; --stroke2:#273449;
      --text:#e8eef7; --muted:rgba(232,238,247,.78);
      --brand:#7c3aed; --brand2:#2b6cff; --ok:#22c55e; --bad:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    #map{height:100vh; width:100vw}

    /* Top bar */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      padding:12px 12px calc(12px + env(safe-area-inset-top));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:9999;
      pointer-events:none;
    }
    .topbar .pill{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      background:rgba(16,24,37,.88);
      border:1px solid rgba(31,42,58,.9);
      backdrop-filter: blur(8px);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .brandDot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2))}
    .title{font-weight:900;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .btnIcon{
      border:0; background:transparent; color:var(--text);
      padding:8px 10px; border-radius:12px; cursor:pointer;
    }
    .btnIcon:active{transform:scale(.98)}

    /* Bottom sheet */
    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(14px + env(safe-area-inset-bottom));
      z-index:9999;
    }
    .panel{
      max-width:560px; margin:0 auto;
      background:rgba(16,24,37,.92);
      border:1px solid rgba(31,42,58,.95);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .handle{width:44px;height:5px;border-radius:99px;background:rgba(232,238,247,.22);margin:10px auto}
    .content{padding:0 12px 12px}
    .grid2{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:520px){ .grid2{grid-template-columns:1fr 1fr;} }

    .field{
      background:rgba(11,15,20,.7);
      border:1px solid rgba(39,52,73,.9);
      border-radius:16px;
      padding:10px;
    }
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:flex;gap:8px;align-items:center}
    input, select, textarea{
      width:100%; border:0; outline:0;
      background:transparent; color:var(--text);
      font-size:14px;
    }
    textarea{resize:none}
    .miniBtn{
      flex:0 0 auto;
      border:0; cursor:pointer;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:white; font-weight:900;
      padding:10px 12px; border-radius:14px;
    }
    .miniBtn.secondary{
      background:rgba(36,52,74,.95);
      border:1px solid rgba(39,52,73,.95);
    }
    .miniBtn:disabled{opacity:.55; cursor:not-allowed}
    .status{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      margin-top:10px;
      padding:10px 12px;
      background:rgba(11,15,20,.65);
      border:1px solid rgba(39,52,73,.9);
      border-radius:16px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(39,52,73,.9);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(232,238,247,.35)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}

    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .cta{
      flex:1 1 160px;
      border:0; cursor:pointer;
      padding:13px 14px;
      border-radius:16px;
      font-weight:1000;
      color:white;
      background:linear-gradient(135deg,var(--ok),#16a34a);
    }
    .cta.secondary{
      background:rgba(36,52,74,.95);
      border:1px solid rgba(39,52,73,.95);
      color:var(--text);
      font-weight:900;
    }
    .cta:disabled{opacity:.55;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}
    .msgErr{color:#ffb4b4}
    .msgOk{color:#7CFFB2}

    .priceBox{
      margin-top:10px;
      padding:10px 12px;
      background:rgba(11,15,20,.65);
      border:1px solid rgba(39,52,73,.9);
      border-radius:16px;
    }
    .priceTop{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .priceTop b{font-size:13px}
    .range{width:100%}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="pill">
      <span class="brandDot"></span>
      <div>
        <div class="title">Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ø±Ø§ÙƒØ¨</div>
        <div class="sub" id="topSub">Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„</div>
      </div>
    </div>

    <div class="pill">
      <button class="btnIcon" id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">â‹</button>
    </div>
  </div>

  <!-- Bottom sheet -->
  <div class="sheet">
    <div class="panel">
      <div class="handle"></div>
      <div class="content">

        <div class="grid2">
          <div class="field">
            <div class="label">Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</div>
            <div class="row">
              <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
              <button class="miniBtn" id="fromSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>

          <div class="field">
            <div class="label">Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</div>
            <div class="row">
              <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
              <button class="miniBtn" id="toSearchBtn">Ø¨Ø­Ø«</button>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <div class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
            <select id="vehicle">
              <option value="tuktuk">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</option>
              <option value="car" selected>ğŸš— Ù…Ù„Ø§ÙƒÙŠ</option>
              <option value="microbus">ğŸš Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
            </select>
          </div>

          <div class="field">
            <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <input id="passengers" type="number" min="1" placeholder="1" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <div class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <input id="phone" placeholder="010..." />
          </div>

          <div class="field">
            <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <textarea id="note" rows="1" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹ÙŠ Ø´Ù†Ø·Ø©..."></textarea>
          </div>
        </div>

        <div class="status">
          <div class="badge" id="statusBadge">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦</span>
          </div>

          <button class="miniBtn secondary" id="myLocBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        </div>

        <div class="priceBox">
          <div class="priceTop">
            <b>Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­</b>
            <span class="badge"><span class="dot ok"></span><span id="kmText">â€” ÙƒÙ…</span></span>
          </div>
          <input class="range" id="priceRange" type="range" min="20" max="200" step="5" value="60">
          <div class="small">
            Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="priceNow">60</b> Ø¬Ù†ÙŠÙ‡
            <span style="opacity:.7"> â€¢ (ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø±Ù‡)</span>
          </div>
          <div class="small" id="suggestText">Ù‡ÙŠÙ†ØªØ¬ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„.</div>
        </div>

        <div class="ctaRow">
          <button id="createBtn" class="cta" disabled>ğŸš• Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
          <button id="resetBtn" class="cta secondary">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="hint msgErr" id="geoMsg"></div>
        <div class="hint" id="result"></div>

        <div class="hint">Ù„Ùˆ Ù‡ØªØ¬Ø±Ø¨ ÙƒØ³Ø§Ø¦Ù‚: Ø§ÙØªØ­ <b>driver.html</b></div>
      </div>
    </div>
  </div>

  <script type="module">
    // âœ… Ø­Ø§Ø±Ø³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ "Ø±Ø§ÙƒØ¨"
    import { requireAuthAndRole, doLogout } from "./app.js";
    await requireAuthAndRole("passenger");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¹Ù†Ø§ØµØ± UI
    const fromText = document.getElementById('fromText');
    const toText = document.getElementById('toText');
    const fromSearchBtn = document.getElementById('fromSearchBtn');
    const toSearchBtn = document.getElementById('toSearchBtn');
    const myLocBtn = document.getElementById('myLocBtn');
    const resetBtn = document.getElementById('resetBtn');
    const createBtn = document.getElementById('createBtn');
    const resultEl = document.getElementById('result');
    const geoMsg = document.getElementById('geoMsg');
    const vehicleEl = document.getElementById('vehicle');
    const phoneEl = document.getElementById('phone');
    const passengersEl = document.getElementById('passengers');
    const noteEl = document.getElementById('note');

    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const topSub = document.getElementById('topSub');

    const kmText = document.getElementById('kmText');
    const priceRange = document.getElementById('priceRange');
    const priceNow = document.getElementById('priceNow');
    const suggestText = document.getElementById('suggestText');

    document.getElementById('logoutBtn').addEventListener('click', doLogout);

    priceRange.addEventListener('input', () => {
      priceNow.textContent = String(priceRange.value);
    });

    // Ø®Ø±ÙŠØ·Ø© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
    const map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Zoom buttons Ø¨Ø´ÙƒÙ„ Ù„Ø·ÙŠÙ
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    let from = null, to = null;
    let fromMarker = null, toMarker = null;
    let myLocMarker = null;
    let line = null;
    let distKm = null;

    function setStatus(mode){
      // mode: "needFrom" | "needTo" | "ready"
      if(mode === "needFrom"){
        statusText.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        statusDot.className = "dot";
        createBtn.disabled = true;
        topSub.textContent = "Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…";
      } else if(mode === "needTo"){
        statusText.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
        statusDot.className = "dot ok";
        createBtn.disabled = true;
        topSub.textContent = "Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„";
      } else {
        statusText.textContent = "Ø¬Ø§Ù‡Ø² âœ… ØªÙ‚Ø¯Ø± ØªØ·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±";
        statusDot.className = "dot ok";
        createBtn.disabled = false;
        topSub.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ù„Ø¨";
      }
    }

    function haversineKm(a,b){
      const R = 6371;
      const dLat = (b.lat-a.lat) * Math.PI/180;
      const dLng = (b.lng-a.lng) * Math.PI/180;
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const x = s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function vehicleMultiplier(v){
      if(v === "tuktuk") return 0.9;
      if(v === "microbus") return 1.25;
      return 1.0; // car
    }

    function updatePriceSuggestion(){
      if(!from || !to) {
        kmText.textContent = "â€” ÙƒÙ…";
        suggestText.textContent = "Ù‡ÙŠÙ†ØªØ¬ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„.";
        return;
      }
      distKm = haversineKm(from, to);
      const km = Math.max(0.3, distKm);
      kmText.textContent = `${km.toFixed(1)} ÙƒÙ…`;

      // ØªØ³Ø¹ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ (Ù„Ù„Ø¯ÙŠÙ…Ùˆ): base + perKm * multiplier
      const base = 15;
      const perKm = 7;
      const mul = vehicleMultiplier(vehicleEl.value);

      const suggested = Math.round((base + km * perKm) * mul);
      // Ø®Ù„ÙŠ Ø§Ù„Ø±ÙŠÙ†Ø¬ Ø­ÙˆØ§Ù„ÙŠÙ† Ø§Ù„Ø³Ø¹Ø±
      const min = Math.max(10, suggested - 40);
      const max = suggested + 120;

      priceRange.min = String(Math.floor(min/5)*5);
      priceRange.max = String(Math.ceil(max/5)*5);

      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ù„Ù…Ø³Ø´ Ø§Ù„Ø±ÙŠÙ†Ø¬ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ø®Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚ØªØ±Ø­
      if(!priceRange.dataset.touched){
        priceRange.value = String(Math.round(suggested/5)*5);
      }
      priceNow.textContent = String(priceRange.value);

      suggestText.textContent = `Ø§Ù‚ØªØ±Ø§Ø­ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©. (ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©)`;
    }

    vehicleEl.addEventListener('change', updatePriceSuggestion);
    priceRange.addEventListener('change', () => priceRange.dataset.touched = "1");

    function redrawLine(){
      if(line) map.removeLayer(line);
      if(from && to){
        line = L.polyline([from, to], {}).addTo(map);
        map.fitBounds(line.getBounds(), { padding: [40, 40] });
      }
      updatePriceSuggestion();
      if(!from) setStatus("needFrom");
      else if(from && !to) setStatus("needTo");
      else setStatus("ready");
    }

    function setFrom(lat, lng){
      from = { lat, lng };
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      map.setView([lat,lng], 15);
      redrawLine();
    }

    function setTo(lat, lng){
      to = { lat, lng };
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„").openPopup();
      map.setView([lat,lng], 15);
      redrawLine();
    }

    // Click on map: first sets from then to
    map.on('click', (e) => {
      geoMsg.textContent = "";
      if(!from) setFrom(e.latlng.lat, e.latlng.lng);
      else if(!to) setTo(e.latlng.lat, e.latlng.lng);
      else resetAll();
    });

    // Ø¨Ø­Ø« Ù…Ø¬Ø§Ù†ÙŠ Ø¹Ø¨Ø± Nominatim (OSM)
    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {
        headers: {
          "Accept": "application/json",
          "User-Agent": "MeshwarakApp/1.0 (demo)"
        }
      });
      if(!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø«");
      const data = await res.json();
      if(!data || data.length === 0) return null;
      return { lat: Number(data[0].lat), lng: Number(data[0].lon), display: data[0].display_name };
    }

    async function handleSearch(type){
      geoMsg.textContent = "";
      const text = (type === "from" ? fromText.value : toText.value).trim();
      if(!text){
        geoMsg.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.";
        return;
      }
      const btn = (type === "from" ? fromSearchBtn : toSearchBtn);
      btn.disabled = true;
      btn.textContent = "â€¦";

      try{
        const r = await geocode(text);
        if(!r){
          geoMsg.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†. Ø¬Ø±Ø¨ Ø§Ø³Ù… Ø£ÙˆØ¶Ø­ + Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.";
          return;
        }
        if(type === "from") setFrom(r.lat, r.lng);
        else setTo(r.lat, r.lng);
      }catch(e){
        console.error(e);
        geoMsg.textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ.";
      }finally{
        btn.disabled = false;
        btn.textContent = "Ø¨Ø­Ø«";
      }
    }

    fromSearchBtn.addEventListener('click', () => handleSearch("from"));
    toSearchBtn.addEventListener('click', () => handleSearch("to"));
    fromText.addEventListener('keydown', (e)=>{ if(e.key==="Enter") handleSearch("from"); });
    toText.addEventListener('keydown', (e)=>{ if(e.key==="Enter") handleSearch("to"); });

    function showMyLocation(){
      geoMsg.textContent = "";
      if(!navigator.geolocation){
        geoMsg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        return;
      }
      myLocBtn.disabled = true;
      myLocBtn.textContent = "Ø¬Ø§Ø±Ùâ€¦";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if(myLocMarker) map.removeLayer(myLocMarker);
          myLocMarker = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();

          map.setView([lat,lng], 16);

          // Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø§Ø­Ø¯Ø¯Ø´ Ø§Ù„Ù‚ÙŠØ§Ù…: Ø®Ù„ÙŠÙ‡ Ø§Ù„Ù‚ÙŠØ§Ù… = Ù…ÙˆÙ‚Ø¹Ù‡ (Ù…Ø±ÙŠØ­)
          if(!from){
            fromText.value = "Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ";
            setFrom(lat, lng);
          }

          myLocBtn.disabled = false;
          myLocBtn.textContent = "ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ";
        },
        (err) => {
          console.error(err);
          geoMsg.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§ÙØªØ­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.";
          myLocBtn.disabled = false;
          myLocBtn.textContent = "ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ";
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    }
    myLocBtn.addEventListener('click', showMyLocation);

    function resetAll(){
      from = null; to = null; distKm = null;
      fromText.value = ""; toText.value = "";
      if(fromMarker) map.removeLayer(fromMarker);
      if(toMarker) map.removeLayer(toMarker);
      if(line) map.removeLayer(line);
      if(myLocMarker) map.removeLayer(myLocMarker);
      fromMarker = null; toMarker = null; line = null; myLocMarker = null;
      geoMsg.textContent = "";
      resultEl.textContent = "";
      delete priceRange.dataset.touched;
      priceRange.value = "60";
      priceNow.textContent = "60";
      updatePriceSuggestion();
      setStatus("needFrom");
    }
    resetBtn.addEventListener('click', resetAll);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    createBtn.addEventListener('click', async () => {
      geoMsg.textContent = "";
      resultEl.textContent = "";
      if(!from || !to){
        geoMsg.textContent = "Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„.";
        return;
      }
      try{
        createBtn.disabled = true;
        resultEl.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const passengers = Number(passengersEl.value || 0);
        const offerPrice = Number(priceRange.value || 0);

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),

          from, to,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null,

          phone: phoneEl.value.trim() || null,
          passengers: passengers || null,
          note: noteEl.value.trim() || null,

          vehicle: vehicleEl.value,
          distanceKm: distKm ? Number(distKm.toFixed(3)) : null,
          offerPrice: offerPrice || null,
        });

        resultEl.innerHTML = `<span class="msgOk">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨!</span> Ø±Ù‚Ù…: <b>${docRef.id}</b>`;
      }catch(err){
        console.error(err);
        resultEl.innerHTML = `<span class="msgErr">âŒ Ø­ØµÙ„ Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules ÙˆØ§Ø³Ù… Collection rides.</span>`;
      }finally{
        redrawLine();
      }
    });

    // Ø¨Ø¯Ø§ÙŠØ©
    setStatus("needFrom");
    updatePriceSuggestion();
  </script>
</body>
</html>
