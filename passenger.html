<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø±Ø§ÙƒØ¨</title>

  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <meta name="theme-color" content="#050B16" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Toast Ø®ÙÙŠÙ */
    .toast{
      position: fixed; z-index: 9999;
      left: 12px; right: 12px; top: 14px;
      background: rgba(16,24,37,.92);
      border: 1px solid rgba(255,255,255,.12);
      color: #e8eef7;
      padding: 12px 14px; border-radius: 14px;
      display:none; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .toast.show{display:flex}
    .toast b{font-size:14px}
    .toast small{opacity:.85}
    .toast .x{border:0;background:transparent;color:#e8eef7;font-size:18px;cursor:pointer}

    /* Ù…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù„Ù…Ø³ */
    #sheetHandle{ touch-action:none; }
    .actions .btn{ touch-action: manipulation; }
    input,select,button{ -webkit-tap-highlight-color: transparent; }
  </style>
</head>

<body>
  <div class="toast" id="toast">
    <div>
      <b id="toastTitle">ØªÙ… âœ…</b><br>
      <small id="toastText">...</small>
    </div>
    <button class="x" id="toastClose" type="button">âœ•</button>
  </div>

  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø±Ø§ÙƒØ¨</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"></div>

      <div class="sheet-content" id="sheetContent">

        <!-- Ø§Ù„Ù…Ù†Ø·Ù‚Ø© -->
        <div class="card" style="margin-top:0">
          <div class="field" style="margin-top:0">
            <label>Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙ‚Ø·)</label>
            <div class="grid2">
              <div>
                <select id="govSelect">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
                </select>
              </div>
              <div>
                <select id="centerSelect" disabled>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>
                </select>
              </div>
            </div>

            <div id="centerOtherWrap" style="display:none;margin-top:10px">
              <input id="centerOtherInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§â€¦" />
            </div>

            <div class="hint" style="margin-top:10px">
              * Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø¥Ù„Ø§ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².
            </div>
          </div>
        </div>

        <!-- Ù…Ù†/Ø¥Ù„Ù‰ -->
        <div class="grid2">
          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…</label>
            <div class="grid3">
              <input id="fromText" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" />
              <button class="btn" id="fromSearchBtn" type="button">Ø¨Ø­Ø«</button>
            </div>
          </div>

          <div class="field" style="margin-top:0">
            <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„</label>
            <div class="grid3">
              <input id="toText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‡Ø±Ù…ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©" />
              <button class="btn" id="toSearchBtn" type="button">Ø¨Ø­Ø«</button>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„ØªØ³Ø¹ÙŠØ± -->
        <div class="card" style="margin-top:12px">
          <div class="grid2" style="align-items:end">
            <div class="field" style="margin-top:0">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
              <select id="vehicleType">
                <option value="tuktuk">ØªÙˆÙƒØªÙˆÙƒ</option>
                <option value="car">Ø³ÙŠØ§Ø±Ø© Ù…Ù„Ø§ÙƒÙŠ</option>
                <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
              </select>
            </div>

            <div class="field" style="margin-top:0">
              <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø¹Ø±</label>
              <select id="tier">
                <option value="economy">Ø§Ù‚ØªØµØ§Ø¯ÙŠ</option>
                <option value="plus">Ø£Ø¹Ù„Ù‰ (Ø£Ø³Ø±Ø¹)</option>
                <option value="vip">VIP</option>
              </select>
            </div>
          </div>

          <div class="pills" style="margin-top:10px">
            <span class="pill" id="pricePill">Ø§Ù„Ø³Ø¹Ø±: -</span>
            <span class="pill" id="distPill">Ø§Ù„Ù…Ø³Ø§ÙØ©: -</span>
          </div>

          <div class="hint" style="margin-top:8px">Ø£Ù‚Ù„ Ø³Ø¹Ø±: 15 Ø¬Ù†ÙŠÙ‡.</div>
        </div>

        <div class="pills">
          <span class="pill" id="statusPill">Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦</span>
          <span class="pill" id="ridePill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨</span>
          <span class="pill" id="permPill">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          <span class="pill" id="areaPill">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</span>
        </div>

        <div id="contactBox" class="card" style="margin-top:12px; display:none"></div>

        <div class="actions">
          <button class="btn primary" id="createBtn" disabled type="button">Ø§Ø·Ù„Ø¨ Ù…Ø´ÙˆØ§Ø±</button>
          <button class="btn danger" id="cancelBtn" disabled type="button">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          <button class="btn" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>

        <div id="msg" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    import {
      collection, addDoc, serverTimestamp,
      doc, onSnapshot, setDoc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= DOM helpers
    const $ = (id)=> document.getElementById(id);

    // ========= Toast
    const toast = $("toast");
    const toastTitle = $("toastTitle");
    const toastText = $("toastText");
    $("toastClose").addEventListener("click", ()=> toast.classList.remove("show"));
    let toastTimer=null;
    function showToast(title, text, ms=2200){
      toastTitle.textContent = title || "ØªÙ… âœ…";
      toastText.textContent = text || "";
      toast.classList.add("show");
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove("show"), ms);
    }

    // ========= Auth
    const { user } = await requireAuthAndRole("passenger");
    $("logoutBtn").addEventListener("click", doLogout);

    const msg = $("msg");
    const whoEl = $("who");

    // ========= Local Storage Keys
    const LS = {
      areaGov: "mw_area_gov",
      areaCenter: "mw_area_center",
      areaCenterOther: "mw_area_center_other",
      fromText: "mw_from_text",
      toText: "mw_to_text",
      lastRideId: "lastRideId"
    };

    const OTHER = "__other__";

    // ========= Ù…Ù†Ø§Ø·Ù‚
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","Ø§Ù„ØªØ¬Ù…Ø¹","Ø§Ù„Ù‚Ø·Ø§Ù…ÙŠØ©","Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨","Ø§Ù„Ø¯Ø±Ø¨ Ø§Ù„Ø£Ø­Ù…Ø±","Ø¨Ø§Ø¨ Ø§Ù„Ø´Ø¹Ø±ÙŠØ©","Ø±ÙˆØ¶ Ø§Ù„ÙØ±Ø¬"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","Ø§Ù„Ù‡Ø±Ù…","ÙÙŠØµÙ„","Ø¥Ù…Ø¨Ø§Ø¨Ø©","Ø§Ù„ÙˆØ±Ø§Ù‚","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø£ÙˆØ³ÙŠÙ…","ÙƒØ±Ø¯Ø§Ø³Ø©","ØµÙ","Ø£Ø·ÙÙŠØ­"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ø§Ù„Ø¹Ø¬Ù…ÙŠ","Ø§Ù„Ø¹Ø§Ù…Ø±ÙŠØ©","Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø±Ù…Ù„","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø¯ÙƒØ±Ù†Ø³","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©","Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø§Ù„Ø¹Ø§Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†","Ø¨Ù„Ø¨ÙŠØ³","ÙØ§Ù‚ÙˆØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ù‡Ù‡ÙŠØ§"],
      "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©": ["Ø¨Ù†Ù‡Ø§","Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©","Ù‚Ù„ÙŠÙˆØ¨","Ø·ÙˆØ®","Ø§Ù„Ø®Ø§Ù†ÙƒØ©","ÙƒÙØ± Ø´ÙƒØ±","Ø´Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù†Ø§Ø·Ø±"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ù…Ù†ÙˆÙ","Ø£Ø´Ù…ÙˆÙ†","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§","Ø¨Ø±ÙƒØ© Ø§Ù„Ø³Ø¨Ø¹"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","Ø²ÙØªÙ‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø¨Ø³ÙŠÙˆÙ†","Ø³Ù…Ù†ÙˆØ¯"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø±Ø´ÙŠØ¯","Ø¥Ø¯ÙƒÙˆ","Ø£Ø¨Ùˆ Ø­Ù…Øµ","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø­ÙˆØ´ Ø¹ÙŠØ³Ù‰"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","Ø¨ÙŠÙ„Ø§","Ù…Ø·ÙˆØ¨Ø³"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","Ø±Ø£Ø³ Ø§Ù„Ø¨Ø±","ÙƒÙØ± Ø³Ø¹Ø¯","ÙØ§Ø±Ø³ÙƒÙˆØ±","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯","Ø¨ÙˆØ±ÙØ¤Ø§Ø¯"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ø§Ù„ÙˆØ§Ø³Ø·Ù‰","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø¨Ø¨Ø§","Ø³Ù…Ø³Ø·Ø§"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…ØºØ§ØºØ©","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±","Ù…Ø·Ø§ÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ø£Ø¨Ùˆ Ù‚Ø±Ù‚Ø§Øµ","Ù…Ù„ÙˆÙŠ"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ù…Ù†ÙÙ„ÙˆØ·","Ø£Ø¨Ùˆ ØªÙŠØ¬","Ø§Ù„ØºÙ†Ø§ÙŠÙ…"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø£Ø®Ù…ÙŠÙ…","Ø¬Ø±Ø¬Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§","Ø·Ù‡Ø·Ø§","Ø·Ù…Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ø¯Ø´Ù†Ø§","Ù‚ÙØ·","Ù‚ÙˆØµ","ÙØ±Ø´ÙˆØ·"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø£Ø±Ù…Ù†Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…","Ø±Ø£Ø³ ØºØ§Ø±Ø¨"],
      "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯": ["Ø§Ù„Ø®Ø§Ø±Ø¬Ø©","Ø§Ù„Ø¯Ø§Ø®Ù„Ø©","Ø§Ù„ÙØ±Ø§ÙØ±Ø©"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø­Ù…Ø§Ù…","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø³ÙŠÙˆØ©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·Ø§Ø¨Ø§","Ø±Ø£Ø³ Ø³Ø¯Ø±"]
    };

    // ========= UI refs
    const govSelect = $("govSelect");
    const centerSelect = $("centerSelect");
    const centerOtherWrap = $("centerOtherWrap");
    const centerOtherInput = $("centerOtherInput");
    const areaPill = $("areaPill");

    const statusPill = $("statusPill");
    const ridePill   = $("ridePill");
    const permPill   = $("permPill");

    const createBtn  = $("createBtn");
    const cancelBtn  = $("cancelBtn");

    const fromText = $("fromText");
    const toText   = $("toText");
    const contactBox = $("contactBox");

    const vehicleTypeEl = $("vehicleType");
    const tierEl = $("tier");
    const pricePill = $("pricePill");
    const distPill = $("distPill");

    // ========= Populate gov
    Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const o = document.createElement("option");
      o.value = g; o.textContent = g;
      govSelect.appendChild(o);
    });

    function fillCenters(gov, preselect=null){
      centerSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>`;
      (AREAS[gov] || []).forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.textContent = c;
        centerSelect.appendChild(o);
      });
      const other = document.createElement("option");
      other.value = OTHER;
      other.textContent = "Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      centerSelect.appendChild(other);

      centerSelect.disabled = !gov;
      centerOtherWrap.style.display = "none";
      centerOtherInput.value = "";

      if(preselect){
        const exists = Array.from(centerSelect.options).some(o=>o.value===preselect);
        if(exists){
          centerSelect.value = preselect;
        }else{
          centerSelect.value = OTHER;
          centerOtherWrap.style.display = "block";
          centerOtherInput.value = preselect;
        }
      }
    }

    function getSelectedArea(){
      const gov = (govSelect.value || "").trim();
      if(!gov) return { gov:null, center:null };

      const cVal = centerSelect.value;
      if(!cVal) return { gov, center:null };

      if(cVal === OTHER){
        const manual = (centerOtherInput.value || "").trim();
        return { gov, center: manual.length >= 2 ? manual : null };
      }
      return { gov, center: (cVal || "").trim() };
    }

    function renderAreaPill(){
      const { gov, center } = getSelectedArea();
      areaPill.textContent = gov && center ? `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${center}` : "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -";
    }

    function saveAreaToLS(){
      const { gov, center } = getSelectedArea();
      if(gov) localStorage.setItem(LS.areaGov, gov);

      if(centerSelect.value === OTHER){
        localStorage.setItem(LS.areaCenter, OTHER);
        localStorage.setItem(LS.areaCenterOther, centerOtherInput.value || "");
      }else{
        if(center) localStorage.setItem(LS.areaCenter, center);
        localStorage.removeItem(LS.areaCenterOther);
      }
    }

    function restoreAreaFromLS(){
      const g = localStorage.getItem(LS.areaGov) || "";
      const c = localStorage.getItem(LS.areaCenter) || "";
      const co = localStorage.getItem(LS.areaCenterOther) || "";

      if(g){
        govSelect.value = g;
        fillCenters(g, (c && c !== OTHER) ? c : (co || null));
        if(c === OTHER){
          centerSelect.value = OTHER;
          centerOtherWrap.style.display = "block";
          centerOtherInput.value = co;
        }
      }
      renderAreaPill();
    }

    govSelect.addEventListener("change", ()=>{
      fillCenters((govSelect.value || "").trim());
      saveAreaToLS();
      renderAreaPill();
      updateUI();
    });

    centerSelect.addEventListener("change", ()=>{
      if(centerSelect.value === OTHER){
        centerOtherWrap.style.display = "block";
        centerOtherInput.focus();
      }else{
        centerOtherWrap.style.display = "none";
        centerOtherInput.value = "";
      }
      saveAreaToLS();
      renderAreaPill();
      updateUI();
    });

    centerOtherInput.addEventListener("input", ()=>{
      saveAreaToLS();
      renderAreaPill();
      updateUI();
    });

    // ========= Passenger profile
    const passengerProfile = await getUserDoc(user.uid).catch(()=>null);
    const fallbackNameFromEmail = (email)=>{
      const x = (email || "").split("@")[0] || "Ù…Ø³ØªØ®Ø¯Ù…";
      return x.replace(/[._-]+/g, " ").trim() || "Ù…Ø³ØªØ®Ø¯Ù…";
    };
    const passengerName  = passengerProfile?.name?.trim() || fallbackNameFromEmail(user.email);
    const passengerPhone = passengerProfile?.phone?.trim() || null;

    whoEl.textContent = `${passengerName} â€¢ ${user.email}`;

    // area from user then LS
    if(passengerProfile?.governorate){
      govSelect.value = passengerProfile.governorate;
      fillCenters(passengerProfile.governorate, passengerProfile?.center || null);
      renderAreaPill();
    }else{
      restoreAreaFromLS();
    }

    // ========= Map
    const map = L.map("map", { zoomControl:false }).setView([30.0444, 31.2357], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const fixMap = ()=>{ try{ map.invalidateSize(true); }catch{} };

    const divPin = (emoji) => L.divIcon({
      className: "pin-emoji",
      html: `<div class="pin-bubble">${emoji}</div>`,
      iconSize: [44,44],
      iconAnchor: [22,44],
      popupAnchor: [0,-36]
    });

    const safeNum = (x)=>{
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    };

    let from=null, to=null, fromMarker=null, toMarker=null, routeLine=null;
    let myMarker=null, myPos=null;

    // driver tracking
    let driverMarker=null, driverLine=null, unsubDriver=null;

    function setPermPill(state){
      permPill.classList.remove("ok","bad");
      if(state==="granted"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø³Ù…ÙˆØ­ âœ…"; permPill.classList.add("ok"); }
      else if(state==="denied"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶ âŒ"; permPill.classList.add("bad"); }
      else permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }

    async function refreshPermissionState(){
      try{
        if(!navigator.permissions?.query) return setPermPill("unknown");
        const p = await navigator.permissions.query({ name:"geolocation" });
        setPermPill(p.state);
        p.onchange = ()=> setPermPill(p.state);
      }catch{ setPermPill("unknown"); }
    }
    refreshPermissionState();

    function drawRoute(){
      if(routeLine){ try{ map.removeLayer(routeLine); }catch{} routeLine=null; }
      if(from && to){
        routeLine = L.polyline([[from.lat,from.lng],[to.lat,to.lng]]).addTo(map);
        try{ map.fitBounds(routeLine.getBounds(), { padding:[30,30] }); }catch{}
      }
      updatePriceUI();
      setTimeout(fixMap, 50);
    }

    function setFrom(lat,lng){
      from={lat,lng};
      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker([lat,lng], { icon: divPin("ğŸš©") }).addTo(map).bindPopup("ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…");
      map.setView([lat,lng], 15, { animate:false });
      drawRoute(); updateUI();
    }

    function setTo(lat,lng){
      to={lat,lng};
      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker([lat,lng], { icon: divPin("ğŸ") }).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„");
      map.setView([lat,lng], 15, { animate:false });
      drawRoute(); updateUI();
    }

    // ========= Auto locate on open
    function explainDenied(){
      msg.innerHTML = "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
    }

    function autoLocate({force=false}={}){
      if(!navigator.geolocation){
        msg.textContent="Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        statusPill.textContent="Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        return;
      }
      if(force) msg.textContent="Ø¬Ø§Ø±Ù Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦";
      statusPill.textContent="Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";

      navigator.geolocation.getCurrentPosition((pos)=>{
        setPermPill("granted");
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        myPos = { lat, lng };

        if(myMarker) map.removeLayer(myMarker);
        myMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
          .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");

        map.setView([lat,lng], 16, { animate:false });
        setTimeout(fixMap, 50);

        msg.textContent="";
        statusPill.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";

        // Ù„Ùˆ Ø§Ù„Ù‚ÙŠØ§Ù… Ù„Ø³Ù‡ null Ø®Ù„ÙŠÙ‡ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ
        if(!from) setFrom(lat,lng);
      }, (err)=>{
        console.error(err);
        if(err?.code===1){ setPermPill("denied"); explainDenied(); }
        else msg.textContent="ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        statusPill.textContent = "Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    $("myLocBtn").addEventListener("click", ()=> autoLocate({force:true}));

    // ========= Better Geocode (biased to area + nearby)
    async function geocode(q){
      const { gov, center } = getSelectedArea();
      let queryText = (q||"").trim();
      if(gov) queryText += `, ${gov}`;
      if(center) queryText += `, ${center}`;
      queryText += `, Egypt`;

      const params = new URLSearchParams({
        format:"json",
        limit:"5",
        countrycodes:"eg",
        q: queryText
      });

      if(myPos){
        const d = 0.35; // ~35km
        params.set("viewbox", `${myPos.lng-d},${myPos.lat+d},${myPos.lng+d},${myPos.lat-d}`);
        params.set("bounded","1");
      }

      const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;
      const res = await fetch(url, { headers:{ "Accept":"application/json" } });
      if(!res.ok) throw new Error("geocode failed");
      const data = await res.json();
      if(!data?.length) return null;
      return { lat:Number(data[0].lat), lng:Number(data[0].lon) };
    }

    async function search(type){
      msg.textContent="";
      const text = (type==="from" ? fromText.value : toText.value).trim();
      if(!text) return (msg.textContent="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø«.");
      try{
        msg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦";
        const r = await geocode(text);
        if(!r) return (msg.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† (Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ø£ÙˆØ¶Ø­).");
        msg.textContent="";
        if(type==="from") setFrom(r.lat,r.lng); else setTo(r.lat,r.lng);
      }catch(e){
        console.error(e);
        msg.textContent="Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
      }
    }

    $("fromSearchBtn").addEventListener("click", ()=> search("from"));
    $("toSearchBtn").addEventListener("click", ()=> search("to"));

    // ========= Pricing
    function haversineKm(a,b){
      const R=6371;
      const dLat=(b.lat-a.lat)*Math.PI/180;
      const dLng=(b.lng-a.lng)*Math.PI/180;
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const x=s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(x)));
    }

    function calcFare(){
      if(!from || !to) return { distanceKm:null, fare:null };

      const km = haversineKm(from,to);
      const v = vehicleTypeEl.value;
      const tier = tierEl.value;

      const perKm = (v==="tuktuk") ? 4.5 : (v==="car") ? 6.5 : 7.5;
      const tierMul = (tier==="economy") ? 1 : (tier==="plus") ? 1.25 : 1.55;

      let fare = (15 + (km * perKm) * tierMul);
      fare = Math.max(15, Math.round(fare));
      return { distanceKm: Number(km.toFixed(1)), fare };
    }

    function updatePriceUI(){
      const { distanceKm, fare } = calcFare();
      distPill.textContent = distanceKm ? `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceKm} ÙƒÙ…` : "Ø§Ù„Ù…Ø³Ø§ÙØ©: -";
      pricePill.textContent = fare ? `Ø§Ù„Ø³Ø¹Ø±: ${fare} EG` : "Ø§Ù„Ø³Ø¹Ø±: -";
    }

    vehicleTypeEl.addEventListener("change", ()=>{ updatePriceUI(); });
    tierEl.addEventListener("change", ()=>{ updatePriceUI(); });

    // ========= Ride logic
    let unsubRide=null;
    let currentRideId = localStorage.getItem(LS.lastRideId) || null;

    function setRideUI(state){
      cancelBtn.disabled = !(state==="open");
      createBtn.disabled = (state==="open" || state==="accepted");
    }

    function stopDriverWatch(){
      if(unsubDriver){ try{ unsubDriver(); }catch{} unsubDriver=null; }
      if(driverMarker){ try{ map.removeLayer(driverMarker); }catch{} driverMarker=null; }
      if(driverLine){ try{ map.removeLayer(driverLine); }catch{} driverLine=null; }
    }

    function startDriverWatch(driverUid){
      stopDriverWatch();
      if(!driverUid) return;

      const ref = doc(db, "driver_status", driverUid);
      unsubDriver = onSnapshot(ref, (snap)=>{
        const st = snap.exists() ? snap.data() : null;
        const lat = safeNum(st?.lat);
        const lng = safeNum(st?.lng);
        if(lat===null || lng===null) return;

        if(!driverMarker){
          driverMarker = L.marker([lat,lng], { icon: divPin("ğŸ§‘â€âœˆï¸") }).addTo(map).bindPopup("ğŸ§‘â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚");
        }else{
          driverMarker.setLatLng([lat,lng]);
        }

        if(from){
          if(driverLine) map.removeLayer(driverLine);
          driverLine = L.polyline([[lat,lng],[from.lat,from.lng]]).addTo(map);
        }
      });
    }

    function watchRide(rideId){
      if(unsubRide) unsubRide();
      const ref = doc(db, "rides", rideId);

      unsubRide = onSnapshot(ref, (snap)=>{
        if(!snap.exists()){
          ridePill.textContent="Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          contactBox.style.display="none"; contactBox.innerHTML="";
          currentRideId=null;
          localStorage.removeItem(LS.lastRideId);
          setRideUI("none");
          stopDriverWatch();
          updateUI();
          return;
        }

        const r = snap.data();

        if(r.status==="open"){
          ridePill.textContent="Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚â€¦";
          contactBox.style.display="none"; contactBox.innerHTML="";
          setRideUI("open");
          stopDriverWatch();
          return;
        }

        if(r.status==="accepted"){
          ridePill.textContent="âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚";
          setRideUI("accepted");

          // Ø¥Ø´Ø¹Ø§Ø± Ø§Ø­ØªØ±Ø§ÙÙŠ
          showToast("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ø´ÙˆØ§Ø± âœ…", "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§ÙÙ‚ â€” ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø´ØºØ§Ù„.");

          // ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
          startDriverWatch(r.driverUid);

          const dName = r.driverName || "Ø³Ø§Ø¦Ù‚";
          const dPhone = r.driverPhone || "";

          contactBox.style.display="block";
          contactBox.innerHTML = `
            <div class="hint" style="margin-top:0">
              <b>ğŸ‘¤ ${dName}</b> ${dPhone ? `â€¢ ğŸ“ ${dPhone}` : "â€¢ ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…"}
              <br><span class="small">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${rideId}</span>
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              ${dPhone ? `<a class="btn success" href="tel:${dPhone}">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>` : ``}
              <span class="pill ok">ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø´ØºØ§Ù„ âœ…</span>
            </div>
          `;
          return;
        }

        // Ù†Ù‡Ø§ÙŠØ©/Ø¥Ù„ØºØ§Ø¡
        if(r.status==="canceled" || r.status==="done" || r.status==="completed"){
          ridePill.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status}`;
          contactBox.style.display="none"; contactBox.innerHTML="";
          stopDriverWatch();
          currentRideId=null;
          localStorage.removeItem(LS.lastRideId);
          setRideUI("none");
          updateUI();
          return;
        }

        ridePill.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status || "-"}`;
        setRideUI("other");
      });
    }

    // ========= UI gate
    function hasAreaReady(){
      const { gov, center } = getSelectedArea();
      return !!(gov && center);
    }

    function updateUI(){
      renderAreaPill();

      // Ù„Ùˆ ÙÙŠÙ‡ Ø·Ù„Ø¨ Ø´ØºØ§Ù„
      if(currentRideId) return;

      if(!hasAreaReady()){
        statusPill.textContent="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ø§Ù‹â€¦";
        createBtn.disabled = true;
        return;
      }

      if(!from){
        statusPill.textContent="Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…â€¦";
        createBtn.disabled=true;
        return;
      }
      if(from && !to){
        statusPill.textContent="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… âœ… Ø§Ø®ØªØ± Ø§Ù„ÙˆØµÙˆÙ„â€¦";
        createBtn.disabled=true;
        return;
      }

      statusPill.textContent="Ø¬Ø§Ù‡Ø² âœ…";
      createBtn.disabled=false;
      updatePriceUI();
    }

    // ========= Restore texts
    fromText.value = localStorage.getItem(LS.fromText) || "";
    toText.value   = localStorage.getItem(LS.toText) || "";
    fromText.addEventListener("input", ()=> localStorage.setItem(LS.fromText, fromText.value));
    toText.addEventListener("input",   ()=> localStorage.setItem(LS.toText, toText.value));

    // ========= Create Ride
    createBtn.addEventListener("click", async ()=>{
      try{
        if(currentRideId) return showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");

        const { gov, center } = getSelectedArea();
        if(!gov || !center) return (msg.textContent="âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ².");
        if(!from || !to) return (msg.textContent="âŒ Ø­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");

        const pricing = calcFare();
        if(!pricing.fare) return (msg.textContent="âŒ Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø£ÙˆÙ„Ø§Ù‹.");

        createBtn.disabled = true;
        msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        // Ø­ÙØ¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø§ÙƒØ¨
        await setDoc(doc(db, "users", user.uid), {
          governorate: gov,
          center: center,
          updatedAt: serverTimestamp()
        }, { merge:true });

        const docRef = await addDoc(collection(db, "rides"), {
          status: "open",
          createdAt: serverTimestamp(),

          governorate: gov,
          center: center,

          from, to,
          fromText: fromText.value.trim() || null,
          toText: toText.value.trim() || null,

          // pricing
          fare: pricing.fare,
          distanceKm: pricing.distanceKm,
          vehicleType: vehicleTypeEl.value,
          pricingTier: tierEl.value,

          passengerUid: user.uid,
          passengerEmail: user.email,
          passengerName: passengerName || null,
          passengerPhone: passengerPhone || null,

          paymentMethod: "cash"
        });

        currentRideId = docRef.id;
        localStorage.setItem(LS.lastRideId, docRef.id);
        watchRide(docRef.id);

        msg.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨! Ø±Ù‚Ù…: ${docRef.id}`;
        showToast("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ÙˆØ§Ø± âœ…", "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚â€¦");
        setRideUI("open");
      }catch(e){
        console.error(e);
        msg.textContent = `âŒ Ø­ØµÙ„ Ø®Ø·Ø£: ${e.message || e}`;
      }finally{
        updateUI();
        setTimeout(fixMap, 50);
      }
    });

    // ========= Cancel Ride
    cancelBtn.addEventListener("click", async ()=>{
      if(!currentRideId) return;
      try{
        cancelBtn.disabled = true;
        msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨â€¦";

        const ref = doc(db, "rides", currentRideId);
        const snap = await getDoc(ref);

        if(!snap.exists()){
          msg.textContent = "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          currentRideId=null;
          localStorage.removeItem(LS.lastRideId);
          setRideUI("none");
          updateUI();
          return;
        }

        const r = snap.data();
        if(r.status !== "open"){
          msg.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„.";
          return;
        }

        await updateDoc(ref, {
          status: "canceled",
          canceledAt: serverTimestamp(),
          canceledBy: "passenger"
        });

        msg.textContent = "âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.";
        showToast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ âœ…", "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");

        currentRideId=null;
        localStorage.removeItem(LS.lastRideId);
        contactBox.style.display="none"; contactBox.innerHTML="";
        ridePill.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨";
        stopDriverWatch();
        setRideUI("none");
        updateUI();
      }catch(e){
        console.error(e);
        msg.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: ${e.message || e}`;
      }finally{
        cancelBtn.disabled = false;
      }
    });

    // ========= Reset
    $("resetBtn").addEventListener("click", ()=>{
      from=null; to=null;

      fromText.value=""; toText.value="";
      localStorage.removeItem(LS.fromText);
      localStorage.removeItem(LS.toText);

      [fromMarker,toMarker,routeLine,driverLine].forEach(x=>{ if(x) try{ map.removeLayer(x);}catch{} });
      fromMarker=toMarker=routeLine=driverLine=null;

      msg.textContent="";
      updatePriceUI();
      updateUI();
      showToast("ØªÙ… âœ…", "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.");
      setTimeout(fixMap, 50);
    });

    // ========= Ride init
    if(currentRideId) watchRide(currentRideId);
    setRideUI(currentRideId ? "open" : "none");

    // ========= Bottom Sheet (Pointer events only) â€” Fix clicks issue âœ…
    const sheet   = $("sheet");
    const handle  = $("sheetHandle");
    const content = $("sheetContent");

    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const getPoints = ()=>{
      const vh = window.innerHeight;
      return {
        collapsed: Math.max(150, Math.round(vh * 0.22)),
        mid: Math.round(vh * 0.46),
        expanded: Math.round(vh * 0.82)
      };
    };

    let points = getPoints();
    let current = points.mid;

    function renderSheet(y, animate=true){
      current = clamp(y, points.collapsed, points.expanded);
      sheet.style.transition = animate ? "transform .18s ease" : "none";
      sheet.style.transform  = `translateY(${points.expanded - current}px)`;
      content.style.maxHeight = (current >= points.mid) ? "72vh" : "58vh";
      if(animate) setTimeout(()=> sheet.style.transition="", 200);
    }

    function nearestSnap(y){
      const arr=[points.collapsed, points.mid, points.expanded];
      return arr.reduce((a,b)=> (Math.abs(b-y) < Math.abs(a-y) ? b : a), arr[0]);
    }

    let dragging=false, startY=0, startCurrent=0;

    handle.addEventListener("pointerdown", (e)=>{
      dragging=true;
      handle.setPointerCapture(e.pointerId);
      startY = e.clientY;
      startCurrent = current;
      sheet.classList.add("dragging");
    });

    handle.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const dy = startY - e.clientY;
      renderSheet(startCurrent + dy, false);
      e.preventDefault();
    });

    handle.addEventListener("pointerup", ()=>{
      if(!dragging) return;
      dragging=false;
      sheet.classList.remove("dragging");
      renderSheet(nearestSnap(current), true);
      setTimeout(fixMap, 220);
    });

    window.addEventListener("resize", ()=>{
      points = getPoints();
      current = clamp(current, points.collapsed, points.expanded);
      renderSheet(current, false);
      setTimeout(fixMap, 220);
    });

    renderSheet(current, false);

    // ========= Init
    updatePriceUI();
    updateUI();
    setTimeout(()=>{ fixMap(); autoLocate(); }, 350);

    // ========= Global error hint (ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£)
    window.addEventListener("error", (e)=>{
      console.error("Global error:", e?.message || e);
    });
    window.addEventListener("unhandledrejection", (e)=>{
      console.error("Promise error:", e?.reason || e);
    });
  </script>
</body>
</html>
