<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø³Ø§Ø¦Ù‚</title>

  <link rel="icon" href="./favicon.png">
  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <meta name="theme-color" content="#050B16" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    /* Toast */
    #toast{
      position:fixed; left:14px; right:14px; top:78px;
      background:rgba(10,18,34,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px 14px;
      color:#fff;
      box-shadow:0 16px 55px rgba(0,0,0,.45);
      transform: translateY(-18px);
      opacity:0;
      pointer-events:none;
      transition:.25s ease;
      z-index:9999;
      max-width:720px;
      margin:auto;
    }
    #toast.show{opacity:1; transform: translateY(0);}

    /* Pins */
    .pin-emoji{background:transparent;border:none;}
    .pin-bubble{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(10,18,34,.92);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-size:22px;
    }

    /* Offer box */
    .offerWrap{
      padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .offerTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .priceBig{font-weight:900;font-size:18px}
    input[type="number"]{width:100%}

    /* Vehicle */
    .vehGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .vehBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-weight:900;
      transition: transform .08s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    }
    .vehBtn:active{ transform: translateY(1px); filter: brightness(1.05); }
    .vehBtn .ic{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      filter: grayscale(1) brightness(1.15);
      opacity:.92;
      font-size:18px;
    }
    .vehBtn.active{
      background: rgba(43,108,255,.10);
      border-color: rgba(43,108,255,.35);
    }
    .vehBtn.active .ic{
      filter: grayscale(0) brightness(1.0);
      opacity:1;
      background: rgba(43,108,255,.14);
      border-color: rgba(43,108,255,.30);
    }
    @media (max-width:520px){
      .vehGrid{ grid-template-columns: repeat(2, 1fr); }
    }

    .miniRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .miniRow .pill{white-space:nowrap}

    .rideCard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
    }
    .rideCard b{font-weight:900}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
  </style>
</head>

<body>
  <div id="toast"></div>

  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"></div>
      <div class="sheet-content" id="sheetContent">

        <!-- Area (driver) -->
        <div class="card" style="margin-top:0">
          <div class="field" style="margin-top:0">
            <label>Ù…Ù†Ø·Ù‚ØªÙƒ (Ø³ØªØ±Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ²)</label>
            <div class="grid2">
              <div>
                <select id="govSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option></select>
              </div>
              <div>
                <select id="centerSelect" disabled><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option></select>
              </div>
            </div>
            <div id="centerOtherWrap" style="display:none;margin-top:10px">
              <input id="centerOtherInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ²â€¦" />
            </div>
            <div class="hint" style="margin-top:10px">
              * Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªØ¸Ù‡Ø± Ø­Ø³Ø¨ (Ù…Ø­Ø§ÙØ¸Ø© + Ù…Ø±ÙƒØ²) + Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.
            </div>
          </div>
        </div>

        <!-- Vehicle (driver) -->
        <div class="card" style="margin-top:12px">
          <div class="field" style="margin-top:0">
            <label>Ù†ÙˆØ¹ Ù…Ø±ÙƒØ¨ØªÙƒ</label>
            <div class="vehGrid" id="vehGrid">
              <div class="vehBtn" data-veh="tuktuk"><div class="ic">ğŸ›º</div><div>ØªÙˆÙƒØªÙˆÙƒ</div></div>
              <div class="vehBtn" data-veh="motor_delivery"><div class="ic">ğŸï¸</div><div>Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</div></div>
              <div class="vehBtn" data-veh="car"><div class="ic">ğŸš—</div><div>Ù…Ù„Ø§ÙƒÙŠ</div></div>
              <div class="vehBtn" data-veh="microbus"><div class="ic">ğŸš</div><div>Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</div></div>
              <div class="vehBtn" data-veh="tamanya"><div class="ic">ğŸšš</div><div>ØªÙ…Ù†Ø§ÙŠØ©</div></div>
              <div class="vehBtn" data-veh="caboot"><div class="ic">ğŸš›</div><div>Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</div></div>
            </div>
            <div class="hint" style="margin-top:10px">
              * Ø³ØªØ±Ù‰ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ·Ù„Ø¨ Ù†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.
            </div>
          </div>
        </div>

        <!-- Status pills -->
        <div class="pills" style="margin-top:12px">
          <span class="pill" id="statusPill">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</span>
          <span class="pill" id="permPill">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          <span class="pill" id="areaPill">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</span>
          <span class="pill" id="vehPill">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: -</span>
        </div>

        <!-- Current ride / request -->
        <div id="rideBox" class="rideCard" style="margin-top:12px; display:none"></div>

        <!-- Actions -->
        <div class="actions" style="margin-top:12px">
          <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          <button class="btn" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div id="msg" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    import { initMessaging, notify, ensureNotificationPermission } from "./messaging.js";
    import {
      collection, query, where, orderBy, limit, getDocs,
      doc, onSnapshot, setDoc, getDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");

    // âœ… Messaging init
    await initMessaging({
      appName: "Ù…Ø´ÙˆØ§Ø±Ùƒ",
      icon: "./favicon.png",
      toastId: "toast",
      askPermissionOnLoad: true
    });

    // ===== Auth
    const { user } = await requireAuthAndRole("driver");
    $("logoutBtn").addEventListener("click", doLogout);

    const msg = $("msg");
    const whoEl = $("who");

    const statusPill = $("statusPill");
    const permPill   = $("permPill");
    const areaPill   = $("areaPill");
    const vehPill    = $("vehPill");

    const rideBox = $("rideBox");

    const govSelect = $("govSelect");
    const centerSelect = $("centerSelect");
    const centerOtherWrap = $("centerOtherWrap");
    const centerOtherInput = $("centerOtherInput");

    const vehGrid = $("vehGrid");

    // ===== LocalStorage
    const LS = {
      areaGov: "mw_d_area_gov",
      areaCenter: "mw_d_area_center",
      areaCenterOther: "mw_d_area_center_other",
      vehicle: "mw_d_vehicle",
      currentRideId: "mw_d_currentRideId"
    };

    const OTHER="__other__";
    const VEHICLES = ["tuktuk","motor_delivery","car","microbus","tamanya","caboot"];

    let selectedVehicle = localStorage.getItem(LS.vehicle) || null;
    let currentRideId = localStorage.getItem(LS.currentRideId) || null;

    // ===== Driver profile
    const driverProfile = await getUserDoc(user.uid).catch(()=>null);
    const fallbackName = (email)=>((email||"").split("@")[0]||"Ù…Ø³ØªØ®Ø¯Ù…").replace(/[._-]+/g," ").trim()||"Ù…Ø³ØªØ®Ø¯Ù…";
    const driverName  = clean(driverProfile?.name) || fallbackName(user.email);
    const driverPhone = clean(driverProfile?.phone) || null;
    const driverModel = clean(driverProfile?.model) || clean(driverProfile?.carModel) || null;

    whoEl.textContent = `${driverName} â€¢ ${(driverPhone || user.email || "-")}`;

    // ===== Areas
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const o=document.createElement("option");
      o.value=g; o.textContent=g;
      govSelect.appendChild(o);
    });

    function fillCenters(gov, pre=null){
      centerSelect.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>`;
      (AREAS[gov]||[]).slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        centerSelect.appendChild(o);
      });
      const other=document.createElement("option");
      other.value = OTHER;
      other.textContent="Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      centerSelect.appendChild(other);

      centerSelect.disabled = !gov;
      centerOtherWrap.style.display="none";
      centerOtherInput.value="";

      if(pre){
        const exists=[...centerSelect.options].some(o=>o.value===pre);
        if(exists) centerSelect.value=pre;
        else{
          centerSelect.value=OTHER;
          centerOtherWrap.style.display="block";
          centerOtherInput.value=pre;
        }
      }
    }

    function getSelectedArea(){
      const gov=clean(govSelect.value)||null;
      const cv=clean(centerSelect.value);
      if(!gov) return {gov:null, center:null};
      if(!cv) return {gov, center:null};
      if(cv===OTHER){
        const m=clean(centerOtherInput.value);
        return {gov, center:(m.length>=2?m:null)};
      }
      return {gov, center:cv||null};
    }

    function renderAreaPill(){
      const {gov,center}=getSelectedArea();
      areaPill.textContent = (gov && center) ? `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${center}` : "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -";
    }

    function renderVehPill(){
      vehPill.textContent = selectedVehicle ? `Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${selectedVehicle}` : "Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: -";
    }

    function saveAreaLS(){
      const {gov,center}=getSelectedArea();
      if(gov) localStorage.setItem(LS.areaGov, gov);
      if(centerSelect.value===OTHER){
        localStorage.setItem(LS.areaCenter, OTHER);
        localStorage.setItem(LS.areaCenterOther, centerOtherInput.value||"");
      }else{
        if(center) localStorage.setItem(LS.areaCenter, center);
        localStorage.removeItem(LS.areaCenterOther);
      }
    }

    function restoreAreaFromLS(){
      const g=localStorage.getItem(LS.areaGov)||"";
      const c=localStorage.getItem(LS.areaCenter)||"";
      const co=localStorage.getItem(LS.areaCenterOther)||"";
      if(g){
        govSelect.value=g;
        fillCenters(g, (c && c!==OTHER) ? c : (co||null));
        if(c===OTHER){
          centerSelect.value=OTHER;
          centerOtherWrap.style.display="block";
          centerOtherInput.value=co;
        }
      }
      renderAreaPill();
    }

    // ===== Save to user doc (driver area + vehicle)
    let saveTimer=null;
    function saveDriverPrefsDebounced(){
      clearTimeout(saveTimer);
      saveTimer=setTimeout(async ()=>{
        try{
          const a=getSelectedArea();
          if(!a.gov || !a.center) return;
          if(!selectedVehicle) return;
          await setDoc(doc(db,"users",user.uid), {
            role:"driver",
            governorate:a.gov,
            center:a.center,
            vehicle:selectedVehicle,
            updatedAt:serverTimestamp()
          }, {merge:true});
        }catch(e){ console.error(e); }
      }, 700);
    }

    govSelect.addEventListener("change", ()=>{
      const g=clean(govSelect.value);
      if(!g){
        centerSelect.disabled=true;
        centerSelect.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø­ÙŠâ€¦</option>`;
        centerOtherWrap.style.display="none";
        centerOtherInput.value="";
        saveAreaLS(); renderAreaPill(); updateUI();
        return;
      }
      fillCenters(g);
      saveAreaLS(); renderAreaPill(); updateUI();
      saveDriverPrefsDebounced();
    });

    centerSelect.addEventListener("change", ()=>{
      if(centerSelect.value===OTHER){
        centerOtherWrap.style.display="block";
        centerOtherInput.focus();
      }else{
        centerOtherWrap.style.display="none";
        centerOtherInput.value="";
      }
      saveAreaLS(); renderAreaPill(); updateUI();
      saveDriverPrefsDebounced();
    });

    centerOtherInput.addEventListener("input", ()=>{
      saveAreaLS(); renderAreaPill(); updateUI();
      saveDriverPrefsDebounced();
    });

    // ===== Vehicle selection
    function renderVehicleUI(){
      vehGrid.querySelectorAll(".vehBtn").forEach(b=>{
        const v = b.getAttribute("data-veh");
        b.classList.toggle("active", v === selectedVehicle);
      });
      renderVehPill();
    }
    function setVehicle(v){
      if(!VEHICLES.includes(v)) return;
      selectedVehicle = v;
      localStorage.setItem(LS.vehicle, v);
      renderVehicleUI();
      updateUI();
      saveDriverPrefsDebounced();
    }
    vehGrid.querySelectorAll(".vehBtn").forEach(b=>{
      b.addEventListener("click", ()=> setVehicle(b.getAttribute("data-veh")));
    });
    renderVehicleUI();

    // Init area from Firestore else LS
    if(driverProfile?.governorate){
      govSelect.value = driverProfile.governorate;
      fillCenters(driverProfile.governorate, driverProfile?.center || null);
      renderAreaPill();
    }else{
      restoreAreaFromLS();
    }
    if(driverProfile?.vehicle && VEHICLES.includes(driverProfile.vehicle)){
      selectedVehicle = driverProfile.vehicle;
      localStorage.setItem(LS.vehicle, selectedVehicle);
      renderVehicleUI();
    }
    saveDriverPrefsDebounced();

    // ===== Perm pill
    function setPermPill(state){
      permPill.classList.remove("ok","bad");
      if(state==="granted"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø³Ù…ÙˆØ­ âœ…"; permPill.classList.add("ok"); }
      else if(state==="denied"){ permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶ âŒ"; permPill.classList.add("bad"); }
      else permPill.textContent="Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }
    (async ()=>{
      try{
        const p=await navigator.permissions.query({name:"geolocation"});
        setPermPill(p.state);
        p.onchange=()=>setPermPill(p.state);
      }catch{}
    })();

    // =========================================================
    // MAP INIT
    // =========================================================
    let leafletOK=false;
    let map=null;
    let fixMap=()=>{};
    let divPin=()=>null;

    try{
      if(!window.L) throw new Error("Leaflet not loaded");

      map = L.map("map", { zoomControl:false }).setView([30.0444,31.2357], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      leafletOK=true;

      fixMap=()=>{ try{ map.invalidateSize(true);}catch{} setTimeout(()=>{try{map.invalidateSize(true)}catch{}},250); };
      setTimeout(fixMap, 450);
      window.addEventListener("load", ()=>setTimeout(fixMap, 250));
      document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 200); });

      divPin=(emoji)=>L.divIcon({
        className:"pin-emoji",
        html:`<div class="pin-bubble">${emoji}</div>`,
        iconSize:[44,44],
        iconAnchor:[22,44],
        popupAnchor:[0,-36]
      });
    }catch(e){
      console.error(e);
      leafletOK=false;
      msg.innerHTML = `<span class="text-bad">âŒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªÙØ­Ù…Ù‘Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</span>`;
    }

    let myMarker=null;
    let fromMarker=null, toMarker=null;
    let routeLine=null;
    let myPos=null;

    function clearRoute(){
      if(!leafletOK || !map) return;
      if(routeLine){ try{ map.removeLayer(routeLine); }catch{} routeLine=null; }
    }

    function setPassengerPins(from, to){
      if(!leafletOK || !map) return;
      if(fromMarker) try{ map.removeLayer(fromMarker); }catch{}
      if(toMarker) try{ map.removeLayer(toMarker); }catch{}
      fromMarker = L.marker([from.lat, from.lng], { icon: divPin("ğŸš©") }).addTo(map).bindPopup("ğŸš© Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…");
      toMarker   = L.marker([to.lat, to.lng],   { icon: divPin("ğŸ") }).addTo(map).bindPopup("ğŸ Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„");
    }

    async function fetchRouteOSRM(a, b){
      const url =
        `https://router.project-osrm.org/route/v1/driving/`+
        `${a.lng},${a.lat};${b.lng},${b.lat}`+
        `?overview=full&geometries=geojson`;

      const res = await fetch(url, { headers:{ Accept:"application/json" } });
      if(!res.ok) throw new Error("osrm failed");
      const data = await res.json();
      const coords = data?.routes?.[0]?.geometry?.coordinates;
      if(!coords?.length) return null;
      return coords.map(([lng,lat])=>({lat, lng}));
    }

    async function drawRouteReal(from, to){
      if(!leafletOK || !map) return;
      clearRoute();
      try{
        const pts = await fetchRouteOSRM(from, to);
        if(!pts) return;
        routeLine = L.polyline(pts, { weight: 5, opacity: 0.9 }).addTo(map);
        try{ map.fitBounds(routeLine.getBounds(), { padding:[30,30] }); }catch{}
        fixMap();
      }catch(e){
        console.error(e);
      }
    }

    function explainLocationDenied(){
      msg.innerHTML="âŒ ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
    }

    function autoLocate(){
      if(!navigator.geolocation){
        msg.textContent="Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        setPermPill("granted");
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        myPos={lat,lng};

        if(leafletOK && map){
          if(myMarker) map.removeLayer(myMarker);
          myMarker=L.circleMarker([lat,lng],{radius:9, weight:2, fillOpacity:.85}).addTo(map).bindPopup("ğŸ“ Ø£Ù†Øª");
          map.setView([lat,lng], 15, {animate:false});
          fixMap();
        }
      }, (err)=>{
        console.error(err);
        if(err?.code===1){ setPermPill("denied"); explainLocationDenied(); }
        else msg.textContent="ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
      }, {enableHighAccuracy:true, timeout:20000, maximumAge:0});
    }

    $("myLocBtn").addEventListener("click", autoLocate);

    // =========================================================
    // Matching rides (open/offered/accepted...)
    // =========================================================
    function hasPrefsReady(){
      const a=getSelectedArea();
      return !!(a.gov && a.center && selectedVehicle);
    }

    function updateUI(){
      renderAreaPill();
      renderVehPill();

      if(!hasPrefsReady()){
        statusPill.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ² + Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©â€¦";
        rideBox.style.display="none";
        return;
      }

      statusPill.textContent = "Ø¬Ø§Ù‡Ø² âœ… â€” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª...";
    }

    let unsubRide=null;
    let lastRideStatus=null;

    async function fireRideNotify(st){
      if(st === lastRideStatus) return;
      lastRideStatus = st;

      if(st === "new_open"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"Ø¸Ù‡Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ", tone:"offer", tag:"new_open",
          toastHtml:"ğŸ†• <b>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¸Ù‡Ø± ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ</b>", toastMs:3500 });
      }

      if(st === "offered"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶Ùƒ Ù„Ù„Ø±Ø§ÙƒØ¨", tone:"notify", tag:"offer_sent",
          toastHtml:"ğŸ’° <b>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</b>", toastMs:2500, forceSystemWhenHidden:false });
      }

      if(st === "accepted"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø±Ø­Ù„ØªÙƒ", tone:"accepted", tag:"ride_accepted",
          toastHtml:"âœ… <b>ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø±Ø­Ù„ØªÙƒ</b>", toastMs:3200 });
      }

      if(st === "canceled"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨", tone:"ended", tag:"ride_canceled",
          toastHtml:"âŒ <b>ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</b>", toastMs:3200 });
      }

      if(st === "completed"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©", tone:"ended", tag:"ride_completed",
          toastHtml:"ğŸ <b>ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</b>", toastMs:3500 });
      }
    }

    function renderRideCard(r, rideId){
      const fromText = r.fromText || "Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…";
      const toText   = r.toText || "Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„";
      const price    = Number(r.priceEGP || 0) || "-";
      const passengerName = r.passengerName || "Ø±Ø§ÙƒØ¨";
      const passengerPhone = r.passengerPhone || "";
      const st = r.status || "-";

      const canOffer = (st === "open") && (!r.driverUid);
      const offeredByMe = (st === "offered" && r.driverUid === user.uid);
      const acceptedByMe = (st === "accepted" && r.driverUid === user.uid);
      const startedByMe = (st === "started" && r.driverUid === user.uid);
      const arrivedByMe = (st === "arrived" && r.driverUid === user.uid);

      rideBox.style.display="block";
      rideBox.innerHTML = `
        <div class="miniRow">
          <span class="pill ok">Ø·Ù„Ø¨</span>
          <span class="pill">Ø§Ù„Ø­Ø§Ù„Ø©: <b>${st}</b></span>
          <span class="pill">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: <b>${price}</b> EG</span>
        </div>
        <div class="sep"></div>
        <div class="hint" style="margin-top:0">
          <b>ğŸ‘¤ ${passengerName}</b> ${passengerPhone ? `â€¢ ğŸ“ ${passengerPhone}` : ""}
          <br><span class="small">ğŸš© ${fromText}</span>
          <br><span class="small">ğŸ ${toText}</span>
        </div>

        <div class="sep"></div>

        <div class="offerWrap">
          <div class="offerTop">
            <div class="hint" style="margin:0">Ø§ÙƒØªØ¨ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>
            <div class="priceBig"><span id="offerPreview">${price}</span> EG</div>
          </div>
          <input id="offerInput" type="number" inputmode="numeric" min="15" step="5" value="${price !== "-" ? price : 15}">
          <div class="small" style="margin-top:8px">Ø£Ù‚Ù„ 15 â€¢ Ø®Ø·ÙˆØ© 5</div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn primary" id="sendOfferBtn" type="button" ${canOffer? "" : "disabled"}>
            ğŸ’° Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶
          </button>

          <button class="btn success" id="arrivedBtn" type="button" ${acceptedByMe ? "" : "disabled"}>
            ğŸ“ ÙˆØµÙ„Øª Ø§Ù„Ù‚ÙŠØ§Ù…
          </button>

          <button class="btn success" id="startBtn" type="button" ${arrivedByMe ? "" : "disabled"}>
            ğŸš– Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
          </button>

          <button class="btn danger" id="endBtn" type="button" ${startedByMe ? "" : "disabled"}>
            ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
          </button>
        </div>

        <div class="hint" id="rideMsg" style="margin-top:10px"></div>
      `;

      // Map pins + route
      if(r.from && r.to){
        setPassengerPins(r.from, r.to);
        drawRouteReal(r.from, r.to);
        try{
          // âœ… Ù„Ùˆ ÙÙŠÙ‡ "currentRideId" Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
          map.setView([r.from.lat, r.from.lng], 15, {animate:false});
          fixMap();
        }catch{}
      }

      const offerInput = document.getElementById("offerInput");
      const offerPreview = document.getElementById("offerPreview");
      const rideMsg = document.getElementById("rideMsg");

      const sendOfferBtn = document.getElementById("sendOfferBtn");
      const arrivedBtn = document.getElementById("arrivedBtn");
      const startBtn = document.getElementById("startBtn");
      const endBtn = document.getElementById("endBtn");

      offerInput?.addEventListener("input", ()=>{
        const v = Number(offerInput.value || 0);
        offerPreview.textContent = String(Math.max(15, v || 15));
      });

      // ===== Offer
      sendOfferBtn?.addEventListener("click", async ()=>{
        try{
          rideMsg.textContent="";
          sendOfferBtn.disabled=true;

          await ensureNotificationPermission();

          const offer = Math.max(15, Number(offerInput.value || 15));
          const ref = doc(db,"rides",rideId);

          // ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù„Ø³Ù‡ open
          const snap = await getDoc(ref);
          if(!snap.exists()){ rideMsg.textContent="Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."; return; }
          const rr = snap.data();
          if(rr.status !== "open"){ rideMsg.textContent="Ø§Ù„Ø·Ù„Ø¨ Ø§ØªØºÙŠØ±/Ø§ØªÙ‚ÙÙ„."; return; }

          await updateDoc(ref, {
            status:"offered",
            offerPriceEGP: offer,
            driverUid: user.uid,
            driverName: driverName || null,
            driverPhone: driverPhone || null,
            driverVehicle: selectedVehicle || null,
            driverModel: driverModel || null,
            offeredAt: serverTimestamp()
          });

          currentRideId = rideId;
          localStorage.setItem(LS.currentRideId, rideId);

          await setDoc(doc(db,"users",user.uid), { currentRideId: rideId, updatedAt: serverTimestamp() }, {merge:true}).catch(()=>{});

          rideMsg.textContent="âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶.";
          await fireRideNotify("offered");

        }catch(e){
          console.error(e);
          rideMsg.textContent="âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶.";
        }finally{
          sendOfferBtn.disabled=false;
        }
      });

      // ===== Arrived
      arrivedBtn?.addEventListener("click", async ()=>{
        try{
          rideMsg.textContent="";
          arrivedBtn.disabled=true;
          const ref = doc(db,"rides",rideId);
          await updateDoc(ref, { status:"arrived", arrivedAt: serverTimestamp() });
          rideMsg.textContent="âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„.";
        }catch(e){
          console.error(e);
          rideMsg.textContent="âŒ ÙØ´Ù„.";
        }finally{
          arrivedBtn.disabled=false;
        }
      });

      // ===== Start
      startBtn?.addEventListener("click", async ()=>{
        try{
          rideMsg.textContent="";
          startBtn.disabled=true;
          const ref = doc(db,"rides",rideId);
          await updateDoc(ref, { status:"started", startedAt: serverTimestamp() });
          rideMsg.textContent="âœ… Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©.";
        }catch(e){
          console.error(e);
          rideMsg.textContent="âŒ ÙØ´Ù„.";
        }finally{
          startBtn.disabled=false;
        }
      });

      // ===== End
      endBtn?.addEventListener("click", async ()=>{
        try{
          rideMsg.textContent="";
          endBtn.disabled=true;
          const ref = doc(db,"rides",rideId);
          await updateDoc(ref, { status:"completed", completedAt: serverTimestamp() });
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt: serverTimestamp() }, {merge:true}).catch(()=>{});

          currentRideId=null;
          localStorage.removeItem(LS.currentRideId);

          rideMsg.textContent="âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
          await fireRideNotify("completed");

        }catch(e){
          console.error(e);
          rideMsg.textContent="âŒ ÙØ´Ù„.";
        }finally{
          endBtn.disabled=false;
        }
      });
    }

    function clearRideUI(){
      rideBox.style.display="none";
      rideBox.innerHTML="";
      if(leafletOK && map){
        [fromMarker,toMarker,routeLine].forEach(x=>{ if(x) try{map.removeLayer(x)}catch{} });
      }
      fromMarker=toMarker=routeLine=null;
      clearRoute();
    }

    async function findOpenRide(){
      if(!hasPrefsReady()) return null;

      const a=getSelectedArea();
      // Ù†Ø¬ÙŠØ¨ Ø£Ø­Ø¯Ø« Ø·Ù„Ø¨ open ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆÙ†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
      const qy = query(
        collection(db,"rides"),
        where("status","==","open"),
        where("governorate","==", a.gov),
        where("center","==", a.center),
        where("requestedVehicle","==", selectedVehicle),
        orderBy("createdAt","desc"),
        limit(1)
      );

      const snap = await getDocs(qy);
      if(snap.empty) return null;
      const d = snap.docs[0];
      return { id: d.id, data: d.data() };
    }

    async function refresh(){
      msg.textContent="";
      if(!hasPrefsReady()){
        updateUI();
        return;
      }

      // Ù„Ùˆ Ø¹Ù†Ø¯Ù‡ Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ© (Ø¹Ø±Ø¶/Ù…Ù‚Ø¨ÙˆÙ„Ø©/Ø¨Ø¯Ø£Øª..) Ù†ØªØ§Ø¨Ø¹Ù‡Ø§
      if(currentRideId){
        watchRideDoc(currentRideId);
        return;
      }

      // ØºÙŠØ± ÙƒØ¯Ù‡: Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ open
      statusPill.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øªâ€¦";
      const found = await findOpenRide();
      if(!found){
        clearRideUI();
        statusPill.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†.";
        return;
      }

      // Ø¥Ø´Ø¹Ø§Ø± Ø¸Ù‡ÙˆØ± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
      await fireRideNotify("new_open");
      renderRideCard(found.data, found.id);
      statusPill.textContent="ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ âœ…";
    }

    $("refreshBtn").addEventListener("click", refresh);

    function watchRideDoc(rideId){
      if(unsubRide) unsubRide();
      const ref = doc(db,"rides",rideId);

      unsubRide = onSnapshot(ref, async (snap)=>{
        if(!snap.exists()){
          clearRideUI();
          statusPill.textContent="Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
          currentRideId=null;
          localStorage.removeItem(LS.currentRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          return;
        }

        const r = snap.data();
        const st = r.status || "-";

        // Ù„Ùˆ Ø§ØªÙ„ØºÙ‰ Ø£Ùˆ Ø®Ù„Øµ
        if(st === "canceled"){
          await fireRideNotify("canceled");
          clearRideUI();
          statusPill.textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.";
          currentRideId=null;
          localStorage.removeItem(LS.currentRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          return;
        }

        if(st === "completed"){
          clearRideUI();
          statusPill.textContent="ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
          currentRideId=null;
          localStorage.removeItem(LS.currentRideId);
          await setDoc(doc(db,"users",user.uid), { currentRideId:null, updatedAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          return;
        }

        // Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…Ø§Ø³Ùƒ Ø§Ù„Ø·Ù„Ø¨ (Ø£Ùˆ Ø­ØªÙ‰ open)
        renderRideCard(r, rideId);

        if(st === "accepted" && r.driverUid === user.uid){
          await fireRideNotify("accepted");
          // âœ… Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…)
          if(r.from?.lat && r.from?.lng){
            try{ map.setView([r.from.lat, r.from.lng], 16, {animate:false}); }catch{}
            fixMap();
          }
        }
      });
    }

    // ===== Init
    updateUI();
    autoLocate();
    ensureNotificationPermission().catch(()=>{});

    if(currentRideId){
      watchRideDoc(currentRideId);
    }else{
      refresh().catch(()=>{});
    }

    // ===== Bottom Sheet
    const sheet=$("sheet"), handle=$("sheetHandle"), content=$("sheetContent");
    const clamp2=(v,min,max)=>Math.max(min,Math.min(max,v));
    const getPoints=()=>{
      const vh=innerHeight;
      return {
        collapsed: Math.max(150, Math.round(vh*0.22)),
        mid: Math.round(vh*0.48),
        expanded: Math.round(vh*0.84),
      };
    };
    let points=getPoints();
    let current=points.mid, startY=0, startCurrent=0, dragging=false;

    const renderSheet=(y, animate=true)=>{
      current=clamp2(y, points.collapsed, points.expanded);
      sheet.style.transition= animate ? "transform .18s ease" : "none";
      sheet.style.transform=`translateY(${points.expanded-current}px)`;
      content.style.maxHeight=(current>=points.mid)?"72vh":"58vh";
      if(animate) setTimeout(()=>sheet.style.transition="",200);
    };
    const nearestSnap=(y)=>[points.collapsed,points.mid,points.expanded]
      .reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);

    const down=(e)=>{
      dragging=true;
      sheet.classList.add("dragging");
      startY=(e.touches?e.touches[0].clientY:e.clientY);
      startCurrent=current;
    };
    const move=(e)=>{
      if(!dragging) return;
      const y=(e.touches?e.touches[0].clientY:e.clientY);
      renderSheet(startCurrent+(startY-y), false);
      e.preventDefault();
    };
    const up=()=>{
      if(!dragging) return;
      dragging=false;
      sheet.classList.remove("dragging");
      renderSheet(nearestSnap(current), true);
      setTimeout(fixMap,220);
    };

    renderSheet(current,false);
    handle.addEventListener("touchstart", down, {passive:false});
    handle.addEventListener("touchmove", move, {passive:false});
    handle.addEventListener("touchend", up);
    handle.addEventListener("mousedown", down);
    addEventListener("mousemove", move, {passive:false});
    addEventListener("mouseup", up);
    addEventListener("resize", ()=>{
      points=getPoints();
      current=clamp2(current,points.collapsed,points.expanded);
      renderSheet(current,false);
      setTimeout(fixMap,220);
    });
  </script>
</body>
</html>
