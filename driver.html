<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <link rel="stylesheet" href="./style.css">
  <meta name="theme-color" content="#050B16" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Modal Trip Request */
    .modal{
      position:fixed; inset:0; z-index:5000;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .modal.show{display:flex}
    .modal-card{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,18,32,.96), rgba(10,18,34,.86));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-top{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
    }
    .timer{
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:13px;
    }
    .modal-body{padding:14px}
    .trip-kv{display:grid; gap:6px}
    .trip-kv b{font-size:14px}
    .trip-kv span{font-size:12px;color:var(--muted)}
    .modal-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .modal-actions .btn{flex:1; min-width:140px}
    .miniMapWrap{
      height:220px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:#0a0f16;
      margin-top:12px;
    }
    #miniMap{height:100%; width:100%}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"></div>

      <div class="sheet-content" id="sheetContent">
        <div class="card" style="margin-top:0">
          <div class="hint" id="profileHint">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚â€¦</div>

          <div class="pills" style="margin-top:10px">
            <span class="pill" id="onlinePill">Offline</span>
            <span class="pill" id="availPill">Available: -</span>
            <span class="pill" id="permPill">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          </div>

          <div class="actions" style="margin-top:12px">
            <button class="btn success" id="onlineBtn">ØªØ´ØºÙŠÙ„ Online</button>
            <button class="btn" id="myLocBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
          </div>

          <div id="msg" class="hint" style="margin-top:10px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hint">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ø±Ø¶Øª Ø¹Ù„ÙŠÙƒ (Offers).</div>
          <div id="offersList" class="list" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trip Request Modal -->
  <div class="modal" id="offerModal">
    <div class="modal-card">
      <div class="modal-top">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="pill ok">ğŸ”¥ Trip Request</div>
          <div class="timer" id="timerTxt">15s</div>
        </div>
        <button class="btn" id="closeModalBtn">Ø¥Ø®ÙØ§Ø¡</button>
      </div>
      <div class="modal-body">
        <div class="trip-kv">
          <b id="t_title">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</b>
          <span id="t_sub">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</span>
        </div>

        <div class="miniMapWrap"><div id="miniMap"></div></div>

        <div class="modal-actions">
          <button class="btn primary" id="acceptBtn">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn danger" id="rejectBtn">Ø±ÙØ¶</button>
        </div>

        <div class="hint" id="modalMsg" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      doc, getDoc, setDoc, updateDoc, serverTimestamp,
      onSnapshot, query, collectionGroup, where, orderBy,
      getDocs, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI refs
    const msg = document.getElementById("msg");
    const profileHint = document.getElementById("profileHint");
    const onlinePill = document.getElementById("onlinePill");
    const availPill  = document.getElementById("availPill");
    const permPill   = document.getElementById("permPill");

    const onlineBtn  = document.getElementById("onlineBtn");
    const myLocBtn   = document.getElementById("myLocBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const offersList = document.getElementById("offersList");

    // ===== Map (main)
    const map = L.map("map", { zoomControl:false }).setView([30.0444, 31.2357], 12);
    const base = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const fixMap = () => {
      try { map.invalidateSize(true); } catch {}
      setTimeout(()=>{ try{ map.invalidateSize(true); }catch{} }, 250);
    };
    setTimeout(fixMap, 450);
    window.addEventListener("load", ()=> setTimeout(fixMap, 250));
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 200); });

    let myMarker = null;

    // ===== Permission pill
    function setPermPill(state){
      permPill.classList.remove("ok","bad");
      if(state === "granted"){
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø³Ù…ÙˆØ­ âœ…";
        permPill.classList.add("ok");
      }else if(state === "denied"){
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø±ÙÙˆØ¶ âŒ";
        permPill.classList.add("bad");
      }else{
        permPill.textContent = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      }
    }

    async function refreshPermissionState(){
      try{
        if(!navigator.permissions?.query) return setPermPill("unknown");
        const p = await navigator.permissions.query({ name: "geolocation" });
        setPermPill(p.state);
        p.onchange = () => setPermPill(p.state);
      }catch{
        setPermPill("unknown");
      }
    }
    refreshPermissionState();

    // ===== Driver profile (governorate/center) + approval
    const profRef = doc(db, "driver_profiles", user.uid);
    let driverProfile = null;

    async function loadDriverProfile(){
      const snap = await getDoc(profRef);
      if(!snap.exists()){
        driverProfile = null;
        profileHint.innerHTML = "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ driver_profiles Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø§Ø¹Ù…Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }
      driverProfile = snap.data();
      const st = driverProfile.status || "pending";
      const gov = driverProfile.governorate || "-";
      const cen = driverProfile.center || "-";

      if(st !== "approved"){
        profileHint.innerHTML = `â³ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚: <b>${st}</b> â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Online Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.`;
        return;
      }

      profileHint.innerHTML = `âœ… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: <b>${gov}</b> â€” <b>${cen}</b>`;
    }

    await loadDriverProfile();

    // ===== driver_status realtime writing
    const statusRef = doc(db, "driver_status", user.uid);
    let isOnline = false;
    let isAvailable = false;
    let watchId = null;
    let lastSentAt = 0;

    function setOnlineUI(){
      onlinePill.textContent = isOnline ? "Online âœ…" : "Offline";
      onlinePill.classList.toggle("ok", isOnline);
      availPill.textContent = `Available: ${isOnline ? (isAvailable ? "Yes" : "No") : "-"}`;
      availPill.classList.toggle("ok", isOnline && isAvailable);
      onlineBtn.textContent = isOnline ? "Ø¥ÙŠÙ‚Ø§Ù Offline" : "ØªØ´ØºÙŠÙ„ Online";
      onlineBtn.classList.toggle("danger", isOnline);
      onlineBtn.classList.toggle("success", !isOnline);
    }

    async function writeStatus(payload){
      try{
        await setDoc(statusRef, {
          online: isOnline,
          available: isAvailable,
          governorate: driverProfile?.governorate || null,
          center: driverProfile?.center || null,
          lastSeenAt: serverTimestamp(),
          ...payload
        }, { merge:true });
      }catch(e){
        console.error(e);
      }
    }

    function startGps(){
      if(!navigator.geolocation){
        msg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        return;
      }
      if(watchId) return;

      watchId = navigator.geolocation.watchPosition((pos)=>{
        setPermPill("granted");

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // marker on map
        if(myMarker) map.removeLayer(myMarker);
        myMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
          .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
        map.setView([lat,lng], 16, { animate:false });
        fixMap();

        // throttle send to Firestore (every ~3s)
        const now = Date.now();
        if(now - lastSentAt < 3000) return;
        lastSentAt = now;

        if(isOnline){
          writeStatus({
            lat, lng,
            heading: Number.isFinite(pos.coords.heading) ? pos.coords.heading : null,
            speed: Number.isFinite(pos.coords.speed) ? pos.coords.speed : null
          });
        }
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setPermPill("denied");
          msg.innerHTML = "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          msg.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    function stopGps(){
      if(watchId){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    // Online toggle
    onlineBtn.addEventListener("click", async ()=>{
      msg.textContent = "";

      if(!driverProfile){
        msg.textContent = "Ù„Ø§Ø²Ù… ØªØ¹Ù…Ù„ driver_profiles Ø§Ù„Ø£ÙˆÙ„.";
        return;
      }
      if((driverProfile.status || "pending") !== "approved"){
        msg.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Online Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© (approved).";
        return;
      }

      isOnline = !isOnline;
      isAvailable = isOnline; // Ø£ÙˆÙ„ Ù…Ø§ Online ÙŠØ¨Ù‚Ù‰ Available
      setOnlineUI();

      if(isOnline){
        startGps();
        await writeStatus({});
        msg.textContent = "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Online.";
      }else{
        await writeStatus({ online:false, available:false });
        msg.textContent = "âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Online.";
      }
    });

    myLocBtn.addEventListener("click", ()=>{
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦";
      startGps();
      setTimeout(()=>{ msg.textContent = ""; }, 700);
    });

    // ===== Offers (collectionGroup: offers)
    // offers docs path: rides/{rideId}/offers/{driverId}
    // fields: status, sentAt, expiresAt
    let unsubOffers = null;

    function offerCard(o){
      const el = document.createElement("div");
      el.className = "card";

      const title = o.rideId ? `Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø·Ù„Ø¨: ${o.rideId}` : "Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯";
      const exp = o.expiresAt?.toDate ? o.expiresAt.toDate() : null;
      const expTxt = exp ? exp.toLocaleTimeString("ar-EG") : "-";

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <b>${title}</b>
          <span class="pill ok">sent</span>
        </div>
        <div class="hint" style="margin-top:6px">
          ÙŠÙ†ØªÙ‡ÙŠ: ${expTxt}
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-open="${o.id}">ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
      `;

      el.querySelector(`[data-open="${o.id}"]`).addEventListener("click", ()=>{
        openOfferModal(o);
      });

      return el;
    }

    // ===== Modal + mini map
    const offerModal = document.getElementById("offerModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const acceptBtn = document.getElementById("acceptBtn");
    const rejectBtn = document.getElementById("rejectBtn");
    const timerTxt = document.getElementById("timerTxt");
    const t_title = document.getElementById("t_title");
    const t_sub = document.getElementById("t_sub");
    const modalMsg = document.getElementById("modalMsg");

    let miniMap = null;
    let miniLine = null;
    let miniPickup = null;
    let currentOffer = null;
    let timerInt = null;

    function ensureMiniMap(){
      if(miniMap) return;
      miniMap = L.map("miniMap", { zoomControl:false, dragging:true, scrollWheelZoom:false }).setView([30.0444, 31.2357], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: "&copy; OpenStreetMap"
      }).addTo(miniMap);
      setTimeout(()=>{ try{ miniMap.invalidateSize(true); }catch{} }, 200);
    }

    function closeModal(){
      offerModal.classList.remove("show");
      currentOffer = null;
      modalMsg.textContent = "";
      if(timerInt){ clearInterval(timerInt); timerInt = null; }
    }

    closeModalBtn.addEventListener("click", closeModal);
    offerModal.addEventListener("click", (e)=>{ if(e.target === offerModal) closeModal(); });

    async function openOfferModal(o){
      currentOffer = o;
      modalMsg.textContent = "";
      offerModal.classList.add("show");

      ensureMiniMap();

      // load ride
      const rideRef = doc(db, "rides", o.rideId);
      const rideSnap = await getDoc(rideRef);

      if(!rideSnap.exists()){
        t_title.textContent = "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        t_sub.textContent = "";
        modalMsg.textContent = "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨.";
        return;
      }

      const r = rideSnap.data();
      const riderName = r.passengerName || "Ø±Ø§ÙƒØ¨";
      const fromText = r.fromText || "Ù…ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ§Ù…";
      const toText   = r.toText || "Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„";

      t_title.textContent = `ğŸ‘¤ ${riderName}`;
      t_sub.textContent = `ğŸš© ${fromText} â†’ ğŸ ${toText}`;

      // mini map view
      const pLat = r.from?.lat;
      const pLng = r.from?.lng;

      if(miniPickup){ miniMap.removeLayer(miniPickup); miniPickup = null; }
      if(miniLine){ miniMap.removeLayer(miniLine); miniLine = null; }

      if(pLat && pLng){
        miniPickup = L.circleMarker([pLat,pLng], { radius:9, weight:2, fillOpacity:.85 }).addTo(miniMap);
        miniMap.setView([pLat,pLng], 15, { animate:false });
      }

      setTimeout(()=>{ try{ miniMap.invalidateSize(true); }catch{} }, 250);

      // timer
      const exp = o.expiresAt?.toDate ? o.expiresAt.toDate().getTime() : (Date.now()+15000);
      if(timerInt) clearInterval(timerInt);

      timerInt = setInterval(()=>{
        const left = Math.max(0, Math.ceil((exp - Date.now())/1000));
        timerTxt.textContent = `${left}s`;
        if(left <= 0){
          clearInterval(timerInt);
          timerInt = null;
          modalMsg.textContent = "â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª.";
        }
      }, 250);
    }

    // Accept / Reject actions
    async function markOfferStatus(rideId, status){
      const offRef = doc(db, "rides", rideId, "offers", user.uid);
      await updateDoc(offRef, { status, respondedAt: serverTimestamp() });
    }

    acceptBtn.addEventListener("click", async ()=>{
      if(!currentOffer) return;
      modalMsg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";
      acceptBtn.disabled = true;
      rejectBtn.disabled = true;

      try{
        const d = await getUserDoc(user.uid);
        const driverName = d?.name || "Ø³Ø§Ø¦Ù‚";
        const driverPhone = d?.phone || null;

        const rideId = currentOffer.rideId;
        const rideRef = doc(db, "rides", rideId);

        await runTransaction(db, async (tx)=>{
          const rideSnap = await tx.get(rideRef);
          if(!rideSnap.exists()) throw new Error("ride_missing");

          const r = rideSnap.data();
          const status = r.status || "open";

          // Ù„Ùˆ Ø§ØªÙ‚Ø¨Ù„ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡
          if(r.driverUid && r.status === "accepted") throw new Error("already_accepted");

          // Ù…Ø³Ù…ÙˆØ­ Ù‚Ø¨ÙˆÙ„ Ù…Ù† searching/offered/open
          if(!["searching","offered","open"].includes(status)) throw new Error("bad_state");

          // Ø«Ø¨Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
          tx.update(rideRef, {
            status: "accepted",
            acceptedAt: serverTimestamp(),
            driverUid: user.uid,
            driverEmail: user.email,
            driverName,
            driverPhone
          });

          // Ø­Ø¯Ù‘Ø« offer Ø¨ØªØ§Ø¹ÙŠ
          const offRef = doc(db, "rides", rideId, "offers", user.uid);
          tx.set(offRef, {
            driverId: user.uid,
            status: "accepted",
            respondedAt: serverTimestamp()
          }, { merge:true });

          // Ø®Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ØªØ§Ø­ (Available=false)
          tx.set(statusRef, {
            online: true,
            available: false,
            lastSeenAt: serverTimestamp()
          }, { merge:true });
        });

        isOnline = true;
        isAvailable = false;
        setOnlineUI();

        modalMsg.textContent = "âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.";
        setTimeout(closeModal, 650);
        await loadOffers(); // refresh list
      }catch(e){
        console.error(e);
        if(String(e?.message || "").includes("already_accepted")){
          modalMsg.textContent = "Ø§Ù„Ø·Ù„Ø¨ Ø§ØªÙ‚Ø¨Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±.";
        }else{
          modalMsg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„. Ø±Ø§Ø¬Ø¹ Firestore Rules.";
        }
      }finally{
        acceptBtn.disabled = false;
        rejectBtn.disabled = false;
      }
    });

    rejectBtn.addEventListener("click", async ()=>{
      if(!currentOffer) return;
      modalMsg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¶â€¦";
      acceptBtn.disabled = true;
      rejectBtn.disabled = true;

      try{
        await markOfferStatus(currentOffer.rideId, "rejected");
        modalMsg.textContent = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¶.";
        setTimeout(closeModal, 450);
        await loadOffers();
      }catch(e){
        console.error(e);
        modalMsg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶.";
      }finally{
        acceptBtn.disabled = false;
        rejectBtn.disabled = false;
      }
    });

    // ===== Load offers list (manual)
    async function loadOffers(){
      offersList.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶â€¦</div>`;

      // collectionGroup offers where driverId == uid AND status == sent
      // NOTE: requires index for collectionGroup offers on (driverId, status, expiresAt)
      try{
        const q = query(
          collectionGroup(db, "offers"),
          where("driverId", "==", user.uid),
          where("status", "==", "sent"),
          orderBy("expiresAt", "desc")
        );

        const snap = await getDocs(q);

        offersList.innerHTML = "";
        if(snap.empty){
          offersList.innerHTML = `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
          return;
        }

        const now = Date.now();

        snap.forEach(d=>{
          const data = d.data();
          const expiresAt = data.expiresAt?.toDate ? data.expiresAt.toDate().getTime() : 0;

          // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ
          if(expiresAt && expiresAt < now) return;

          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ rideId Ù…Ù† path: rides/{rideId}/offers/{driverId}
          const parts = d.ref.path.split("/");
          const rideId = parts[1];

          offersList.appendChild(offerCard({
            id: d.id,
            rideId,
            ...data
          }));
        });

        if(!offersList.children.length){
          offersList.innerHTML = `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ ØµØ§Ù„Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        }
      }catch(e){
        console.error(e);
        offersList.innerHTML = `<div class="card">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶. (Ù…Ù…ÙƒÙ† ØªØ­ØªØ§Ø¬ Index Ù„Ù„Ù€ offers collectionGroup)</div>`;
      }
    }

    refreshBtn.addEventListener("click", async ()=>{
      msg.textContent = "";
      await loadDriverProfile();
      await loadOffers();
      fixMap();
    });

    // ===== realtime listening (optional)
    function startOffersListener(){
      if(unsubOffers) unsubOffers();
      try{
        const q = query(
          collectionGroup(db, "offers"),
          where("driverId", "==", user.uid),
          where("status", "==", "sent"),
          orderBy("expiresAt", "desc")
        );

        unsubOffers = onSnapshot(q, (snap)=>{
          // Ù„Ùˆ Ø¸Ù‡Ø± Offer Ø¬Ø¯ÙŠØ¯ Ø§ÙØªØ­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          let newest = null;
          snap.docChanges().forEach(ch=>{
            if(ch.type === "added"){
              const d = ch.doc;
              const parts = d.ref.path.split("/");
              const rideId = parts[1];
              newest = { id:d.id, rideId, ...d.data() };
            }
          });

          loadOffers();

          if(newest){
            const exp = newest.expiresAt?.toDate ? newest.expiresAt.toDate().getTime() : 0;
            if(!exp || exp > Date.now()){
              openOfferModal(newest);
            }
          }
        });
      }catch(e){
        console.error(e);
      }
    }

    // ===== Sheet drag (handle only)
    const sheet   = document.getElementById("sheet");
    const handle  = document.getElementById("sheetHandle");
    const content = document.getElementById("sheetContent");

    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const getPoints = () => {
      const vh = window.innerHeight;
      const collapsed = Math.max(160, Math.round(vh * 0.26));
      const mid       = Math.round(vh * 0.50);
      const expanded  = Math.round(vh * 0.86);
      return { collapsed, mid, expanded };
    };

    let points = getPoints();
    let current = points.mid;
    let startY = 0, startCurrent = 0, dragging = false;

    function render(y, animate=true){
      current = clamp(y, points.collapsed, points.expanded);
      sheet.style.transition = animate ? "transform .18s ease" : "none";
      sheet.style.transform  = `translateY(${points.expanded - current}px)`;
      content.style.maxHeight = (current >= points.mid) ? "74vh" : "60vh";
      if(animate) setTimeout(()=> sheet.style.transition="", 200);
    }

    function nearestSnap(y){
      const arr = [points.collapsed, points.mid, points.expanded];
      return arr.reduce((a,b)=> (Math.abs(b-y) < Math.abs(a-y) ? b : a), arr[0]);
    }

    function down(e){
      dragging = true;
      sheet.classList.add("dragging");
      startY = (e.touches ? e.touches[0].clientY : e.clientY);
      startCurrent = current;
    }

    function move(e){
      if(!dragging) return;
      const y = (e.touches ? e.touches[0].clientY : e.clientY);
      const dy = startY - y;
      render(startCurrent + dy, false);
      e.preventDefault();
    }

    function up(){
      if(!dragging) return;
      dragging = false;
      sheet.classList.remove("dragging");
      render(nearestSnap(current), true);
      setTimeout(fixMap, 220);
    }

    render(current, false);

    handle.addEventListener("touchstart", down, {passive:false});
    handle.addEventListener("touchmove", move, {passive:false});
    handle.addEventListener("touchend", up);

    handle.addEventListener("mousedown", down);
    window.addEventListener("mousemove", move, {passive:false});
    window.addEventListener("mouseup", up);

    window.addEventListener("resize", ()=>{
      points = getPoints();
      current = clamp(current, points.collapsed, points.expanded);
      render(current, false);
      setTimeout(fixMap, 220);
    });

    // ===== init UI
    setOnlineUI();
    await loadOffers();
    startOffersListener();
  </script>
</body>
</html>
