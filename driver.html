<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">ğŸ§‘â€âœˆï¸</div>
        <div>
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
          <p class="small">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</p>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
        <a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="hint">Ø§Ø¶ØºØ· <b>Ù‚Ø¨ÙˆÙ„</b> Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ <b>accepted</b>.</div>
    </div>

    <div class="list" id="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole } from "./app.js";
    await requireAuthAndRole("driver");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs, doc, updateDoc }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listEl = document.getElementById("list");
    const refreshBtn = document.getElementById("refreshBtn");

    function safeNum(x){ const n=Number(x); return Number.isFinite(n)?n:null; }

    function vehicleName(v){
      if(v==="tuktuk") return "ğŸ›º ØªÙˆÙƒØªÙˆÙƒ";
      if(v==="microbus") return "ğŸš Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ";
      return "ğŸš— Ù…Ù„Ø§ÙƒÙŠ";
    }

    function mapsLink(lat,lng){
      // ÙŠÙØªØ­ Google Maps Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
      return `https://www.google.com/maps?q=${lat},${lng}`;
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat), fromLng=safeNum(r.from?.lng);
      const toLat = safeNum(r.to?.lat), toLng=safeNum(r.to?.lng);

      const el = document.createElement("div");
      el.className = "card ride";

      el.innerHTML = `
        <div class="kv">
          <b>Ø·Ù„Ø¨ #${r.id}</b>
          <span>${vehicleName(r.vehicle)} â€¢ Ø§Ù„Ø³Ø¹Ø±: <b>${r.price ?? "-"} Ø¬Ù†ÙŠÙ‡</b></span>
        </div>

        <div class="hr"></div>

        <div class="kv">
          <b>Ù…Ù†</b>
          <span>${r.fromText || (fromLat?`${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}`:"-")}</span>
        </div>

        <div class="kv">
          <b>Ø¥Ù„Ù‰</b>
          <span>${r.toText || (toLat?`${toLat.toFixed(5)}, ${toLng.toFixed(5)}`:"-")}</span>
        </div>

        <div class="row">
          <span class="pill">Ø±ÙƒØ§Ø¨: ${r.passengers ?? "-"}</span>
          <span class="pill">Ù‡Ø§ØªÙ: ${r.phone ?? "-"}</span>
        </div>

        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note ?? "-"}</div>

        <div class="actions">
          <button class="btn primary" data-accept="${r.id}">Ù‚Ø¨ÙˆÙ„</button>
          ${fromLat && fromLng ? `<a class="btn" target="_blank" href="${mapsLink(fromLat,fromLng)}">ÙØªØ­ Ø§Ù„Ù‚ÙŠØ§Ù…</a>` : ""}
          ${toLat && toLng ? `<a class="btn" target="_blank" href="${mapsLink(toLat,toLng)}">ÙØªØ­ Ø§Ù„ÙˆØµÙˆÙ„</a>` : ""}
        </div>
      `;

      el.querySelector('[data-accept]')?.addEventListener("click", async ()=>{
        try{
          await updateDoc(doc(db,"rides",r.id), { status:"accepted" });
          await load();
        }catch(e){
          console.error(e);
          alert("ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø±Ø§Ø¬Ø¹ Firestore Rules.");
        }
      });

      return el;
    }

    async function load(){
      listEl.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      const q = query(
        collection(db,"rides"),
        where("status","==","open"),
        orderBy("createdAt","desc"),
        limit(30)
      );

      const snap = await getDocs(q);
      listEl.innerHTML = "";

      if(snap.empty){
        listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        return;
      }

      snap.forEach(d=>{
        listEl.appendChild(rideCard({ id:d.id, ...d.data() }));
      });
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
