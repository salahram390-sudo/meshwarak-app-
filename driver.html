<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <style>
    :root{
      --bg:#070A10;
      --card:#0E1624;
      --card2:#0B111C;
      --stroke:#1E2A3C;
      --text:#EAF1FF;
      --muted:#A9B7D0;
      --primary:#6D5BFF;     /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
      --primary2:#2B6CFF;    /* Ø£Ø²Ø±Ù‚ */
      --good:#22C55E;
      --bad:#FF6B6B;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r16:16px;
      --r18:18px;
      --r22:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(109,91,255,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 110%, rgba(43,108,255,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    /* AppBar */
    .appbar{
      position:sticky; top:0; z-index:1000;
      padding: env(safe-area-inset-top) 12px 10px 12px;
      background: rgba(7,10,16,.78);
      border-bottom: 1px solid rgba(30,42,60,.65);
      backdrop-filter: blur(12px);
    }
    .barrow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      max-width: 980px;
      margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(14,22,36,.55);
      border:1px solid rgba(30,42,60,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      min-width:0;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(109,91,255,.75), rgba(43,108,255,.25));
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .brand b{
      display:block;
      font-size:14px;
      line-height:1.15;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand small{
      display:block;
      color:var(--muted);
      font-weight:700;
      font-size:11px;
      margin-top:2px;
    }

    .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      color:white;
      background: linear-gradient(135deg, rgba(109,91,255,.95), rgba(43,108,255,.9));
      box-shadow: 0 12px 22px rgba(43,108,255,.12);
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background: rgba(36,52,74,.88);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:none;
    }

    /* Layout */
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
    }

    .info{
      background: rgba(14,22,36,.65);
      border:1px solid rgba(30,42,60,.65);
      border-radius: var(--r22);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .info .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      font-weight:700;
      margin:0;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }

    .card{
      background: rgba(14,22,36,.88);
      border:1px solid rgba(30,42,60,.75);
      border-radius: var(--r22);
      padding: 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .rid{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      font-weight:1000;
    }
    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(11,17,28,.85);
      color:var(--muted);
      font-weight:900;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:560px){
      .row2{grid-template-columns:1fr}
    }

    .box{
      background: rgba(11,17,28,.78);
      border:1px solid rgba(30,42,60,.65);
      border-radius: 18px;
      padding: 10px;
    }
    .box b{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:900;
    }
    .box div{
      font-weight:900;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.5;
      margin-top:8px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    .accept{
      border:0;
      border-radius: 16px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      color:#06140b;
      background: linear-gradient(135deg, rgba(34,197,94,.98), rgba(43,108,255,.65));
      box-shadow: 0 12px 26px rgba(34,197,94,.12);
    }
    .link{
      text-decoration:none;
      border-radius: 16px;
      padding:12px 14px;
      font-weight:1000;
      color:var(--text);
      background: rgba(36,52,74,.88);
      border:1px solid rgba(255,255,255,.08);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* Toast */
    .toast{
      position:fixed;
      right:12px;
      top: 76px;
      z-index:2000;
      max-width: 92vw;
      background: rgba(14,22,36,.92);
      border:1px solid rgba(30,42,60,.7);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:none;
    }
    .toast.show{display:block}
    .toast b{display:block; font-size:13px}
    .toast span{display:block; font-size:12px; color:var(--muted); margin-top:3px}
  </style>
</head>

<body>

  <!-- Toast -->
  <div class="toast" id="toast">
    <b id="toastTitle">...</b>
    <span id="toastDesc">...</span>
  </div>

  <!-- AppBar -->
  <div class="appbar">
    <div class="barrow">
      <div class="brand">
        <div class="logo">ğŸ§‘â€âœˆï¸</div>
        <div>
          <b>Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</b>
          <small>ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù…Ù† Firestore</small>
        </div>
      </div>

      <div class="btns">
        <button class="btn secondary" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn secondary" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="info">
      <p class="muted">
        ğŸ‘‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ ØªØ­Øª Ù‡ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© (Open). Ø§Ø¶ØºØ· <b>Ù‚Ø¨ÙˆÙ„</b> Ø¹Ù„Ø´Ø§Ù† ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ <b>accepted</b>.
      </p>
    </div>

    <div class="grid" id="list"></div>
  </div>

  <script type="module">
    // âœ… Ø­Ø§Ø±Ø³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ "Ø³Ø§Ø¦Ù‚"
    import { requireAuthAndRole, doLogout } from "./app.js";
    await requireAuthAndRole("driver");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listEl = document.getElementById('list');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", doLogout);

    // Toast
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastDesc = document.getElementById("toastDesc");
    let toastTimer = null;
    function showToast(title, desc=""){
      toastTitle.textContent = title;
      toastDesc.textContent = desc;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2800);
    }

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function mapLink(lat, lng, zoom=16){
      if(lat === null || lng === null) return "#";
      return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=${zoom}/${lat}/${lng}`;
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const toLat = safeNum(r.to?.lat);
      const toLng = safeNum(r.to?.lng);

      const fromText = (fromLat !== null && fromLng !== null)
        ? `${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}`
        : "-";

      const toText = (toLat !== null && toLng !== null)
        ? `${toLat.toFixed(5)}, ${toLng.toFixed(5)}`
        : "-";

      const el = document.createElement('div');
      el.className = 'card';

      el.innerHTML = `
        <div class="topline">
          <div class="rid">
            <span class="tag">Ø·Ù„Ø¨</span>
            <span>${r.id}</span>
          </div>
          <span class="tag">OPEN</span>
        </div>

        <div class="row2">
          <div class="box">
            <b>ğŸš© Ø§Ù„Ù‚ÙŠØ§Ù…</b>
            <div>${r.fromText ?? fromText}</div>
            <div class="small">${fromText}</div>
          </div>

          <div class="box">
            <b>ğŸ Ø§Ù„ÙˆØµÙˆÙ„</b>
            <div>${r.toText ?? toText}</div>
            <div class="small">${toText}</div>
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <div class="box">
            <b>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</b>
            <div>${r.phone ?? "-"}</div>
          </div>

          <div class="box">
            <b>ğŸ‘¥ Ø§Ù„Ø±ÙƒØ§Ø¨</b>
            <div>${r.passengers ?? "-"}</div>
          </div>
        </div>

        <div class="box" style="margin-top:10px">
          <b>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©</b>
          <div style="color:var(--muted); font-weight:800">${r.note ?? "-"}</div>
        </div>

        <div class="actions">
          <button class="accept" data-id="${r.id}">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>

          <a class="link" target="_blank" href="${mapLink(fromLat, fromLng)}">ğŸ“ ÙØªØ­ Ø§Ù„Ù‚ÙŠØ§Ù…</a>
          <a class="link" target="_blank" href="${mapLink(toLat, toLng)}">ğŸ ÙØªØ­ Ø§Ù„ÙˆØµÙˆÙ„</a>
        </div>
      `;

      el.querySelector('button').addEventListener('click', async () => {
        try{
          await updateDoc(doc(db, "rides", r.id), { status: "accepted" });
          showToast("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ âœ…", `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${r.id}`);
          await load();
        }catch(e){
          console.error(e);
          showToast("ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ âŒ", "ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules.");
        }
      });

      return el;
    }

    async function load(){
      listEl.innerHTML = `
        <div class="card">
          <div style="font-weight:1000">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>
          <div class="small">Ù„Ø­Ø¸Ø§Øª...</div>
        </div>
      `;

      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      const snap = await getDocs(q);

      listEl.innerHTML = "";

      if(snap.empty){
        listEl.innerHTML = `
          <div class="info">
            <p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
          </div>
        `;
        return;
      }

      snap.forEach(d => {
        listEl.appendChild(rideCard({ id: d.id, ...d.data() }));
      });
    }

    refreshBtn.addEventListener('click', () => {
      showToast("ØªØ­Ø¯ÙŠØ«", "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...");
      load();
    });

    load();
  </script>
</body>
</html>
