<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ±Ø§Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
  <style>
    body{font-family:system-ui,Arial; margin:0; background:#0b0f14; color:#e8eef7;}
    header{padding:14px 16px; background:#101825; position:sticky; top:0; display:flex; justify-content:space-between; align-items:center;}
    h1{margin:0; font-size:16px;}
    .wrap{padding:14px 16px; display:grid; gap:12px;}
    .card{background:#101825; border:1px solid #1f2a3a; border-radius:14px; padding:12px;}
    button{padding:10px 12px; border:0; border-radius:12px; background:#2b6cff; color:white; font-weight:700; cursor:pointer;}
    .muted{opacity:.85; font-size:13px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    a{color:#9ec1ff}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§‘â€âœˆï¸ Ù…Ø´ÙˆØ±Ø§Ùƒ â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
    <button id="refreshBtn" style="background:#24344a;">ØªØ­Ø¯ÙŠØ«</button>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="muted">
        ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù…Ù† Firestore. Ø§Ø¶ØºØ· â€œÙ‚Ø¨ÙˆÙ„â€ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ accepted.
      </div>
    </div>
    <div id="list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, where, orderBy, limit, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listEl = document.getElementById('list');
    const refreshBtn = document.getElementById('refreshBtn');

    function rideCard(r){
      const from = r.from ? `${Number(r.from.lat).toFixed(5)}, ${Number(r.from.lng).toFixed(5)}` : "-";
      const to   = r.to   ? `${Number(r.to.lat).toFixed(5)}, ${Number(r.to.lng).toFixed(5)}` : "-";

      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div><b>Ø·Ù„Ø¨:</b> ${r.id}</div>
        <div class="muted">Ù…Ù†: ${from}<br>Ø¥Ù„Ù‰: ${to}</div>
        <div class="muted">Ø±ÙƒØ§Ø¨: ${r.passengers ?? "-"} | Ù‡Ø§ØªÙ: ${r.phone ?? "-"} </div>
        <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note ?? "-"}</div>
        <div class="row">
          <button data-id="${r.id}">Ù‚Ø¨ÙˆÙ„</button>
          <a target="_blank" href="https://www.openstreetmap.org/?mlat=${r.from?.lat}&mlon=${r.from?.lng}#map=16/${r.from?.lat}/${r.from?.lng}">ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</a>
        </div>
      `;

      el.querySelector('button').addEventListener('click', async () => {
        try{
          await updateDoc(doc(db, "rides", r.id), { status: "accepted" });
          await load();
        }catch(e){
          console.error(e);
          alert("ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Rules Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.");
        }
      });

      return el;
    }

    async function load(){
      listEl.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      try{
        // Ù…Ù„Ø§Ø­Ø¸Ø©: orderBy(createdAt) ÙŠØ­ØªØ§Ø¬ createdAt Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª + Index (ÙˆØ§Ù„Ù€ Index Ø¹Ù†Ø¯Ùƒ Enabled)
        const q = query(
          collection(db, "rides"),
          where("status", "==", "open"),
          orderBy("createdAt", "desc"),
          limit(25)
        );

        const snap = await getDocs(q);

        listEl.innerHTML = "";
        if(snap.empty){
          listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
          return;
        }

        snap.forEach(d => {
          listEl.appendChild(rideCard({ id: d.id, ...d.data() }));
        });

      }catch(e){
        console.error(e);
        listEl.innerHTML = `
          <div class="card">
            <b>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</b><br>
            <div class="muted" style="margin-top:8px; white-space:pre-wrap;">${e?.message || e}</div>
          </div>
        `;
      }
    }

    refreshBtn.addEventListener('click', load);
    load();
  </script>
</body>
</html>
