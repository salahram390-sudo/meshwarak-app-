<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./styles.css" />
  <meta name="theme-color" content="#050B16" />

  <!-- âœ… Leaflet (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body.page{ min-height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    .topbar{
      position: sticky; top: 0; z-index: 60;
      background: rgba(5, 11, 22, 0.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand h1{ margin:0; font-size:16px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brand p{ margin:0; font-size:12px; color: rgba(255,255,255,0.70); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 52vw; }
    .logo{ width:44px; height:44px; border-radius:16px; font-size:18px; flex:0 0 auto; display:grid; place-items:center; }
    .top-actions{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
    .top-actions .btn{ padding:10px 12px; border-radius:18px; font-size:14px; min-height:44px; width:auto; }

    .mapWrap{ position:relative; flex:1; min-height: calc(100vh - 70px); overflow:hidden; background:#0b1222; }
    #map{ position:absolute; inset:0; z-index:1; }

    .sheet{
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      z-index: 2000;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: 0 26px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(10px);
      overflow: hidden;
      height: 56vh;
      transition: height .18s ease;
      will-change: height;
    }
    .sheet.dragging{ transition:none; }
    .sheetHeader{
      padding: 10px 14px 12px;
      display:flex; justify-content:center; align-items:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: pan-y;
    }
    .sheetHandle{
      width:56px; height:6px; border-radius:99px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.10);
    }
    .sheetBody{
      padding: 14px;
      overflow-y: auto;
      height: calc(100% - 44px);
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    .sectionTitle{ margin: 6px 0 10px; font-weight:900; font-size:14px; color: rgba(255,255,255,.90); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .note{ margin-top:10px; font-size:12px; color: rgba(255,255,255,.65); line-height:1.5; }
    .sep{ height:1px; background: rgba(255,255,255,0.06); margin:14px 0; }

    .actions{ display:flex; gap:12px; margin-top:16px; flex-wrap:wrap; }
    .actions .btn{ flex: 1 1 140px; min-height:52px; width:auto; }

    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .miniChip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .miniChip.ok{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.25); }
    .miniChip.bad{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.25); }

    /* âœ… Ride card */
    .rideCard{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10, 16, 32, 0.55);
      border-radius: 20px;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .rideRow{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .rideTitle{ font-weight:900; font-size:14px; }
    .rideMeta{ font-size:12px; color: rgba(255,255,255,.75); line-height:1.6; margin-top:6px; }
    .rideActions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .rideActions .btn{ flex: 1 1 140px; min-height:48px; }

    .inputRow{ display:flex; gap:10px; align-items:stretch; }
    .inputRow input{ flex:1 1 auto; min-width:0; }
    .iconBtn{
      min-width: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10, 16, 32, 0.55);
      color: #fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .iconBtn:active{ transform: scale(.985); }

    @media (max-width:420px){
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="page">

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">Ø³</div>
        <div style="min-width:0">
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>

      <div class="top-actions">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="mapWrap">
    <div id="map"></div>
  </div>

  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader">
      <div class="sheetHandle"></div>
    </div>

    <div class="sheetBody">

      <div class="sectionTitle">Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</div>
      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
          </select>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
          <select id="centerSelect" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>
          </select>
        </div>
      </div>

      <div class="note">* Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø·Ù„Ø¨Ø§Øª Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ² ÙÙ‚Ø·.</div>

      <div class="sep"></div>

      <div class="sectionTitle">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
      <div class="grid2">
        <div class="field" style="margin-top:0">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="vehicleType">
            <option value="car">ğŸš— Ù…Ù„Ø§ÙƒÙŠ</option>
            <option value="tuktuk">ğŸ›º ØªÙˆÙƒØªÙˆÙƒ</option>
            <option value="motor_delivery">ğŸï¸ Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
            <option value="microbus">ğŸšŒ Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
            <option value="tamanya">ğŸš ØªÙ…Ù†Ø§ÙŠØ©</option>
            <option value="caboot">ğŸšš Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</option>
          </select>
        </div>

        <div class="field" style="margin-top:0">
          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</label>
          <select id="onlineSelect">
            <option value="online">ğŸŸ¢ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
            <option value="offline">âšª Ø£ÙˆÙÙ„Ø§ÙŠÙ†</option>
          </select>
        </div>
      </div>

      <div class="miniRow">
        <span class="miniChip" id="locChip">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…Ø­Ø¯Ø«</span>
        <span class="miniChip" id="statusChip">â€”</span>
      </div>

      <div class="actions">
        <button class="btn" id="myLocBtn" type="button">ğŸ“ ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>

      <div id="ridesList" style="display:grid; gap:12px;"></div>

      <div class="hint" id="msg" style="margin-top:12px"></div>

      <div class="footerActions" style="margin-top:14px">
        <a class="btn" href="./index.html">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { doc, getDoc, requireAuthAndRole, doLogout, db, setActiveRole, getUserDoc } from "./app.js";
    import {
      collection, query, where, orderBy, onSnapshot,
      doc, updateDoc, serverTimestamp, getDocs, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");
    const safeNum = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function escapeHTML(s){ return String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

    function vehText(v){
      v = clean(v);
      return (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":
        (v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":
        (v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":
        (v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":
        (v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":
        (v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª": (v||"-");
    }
    function statusText(st){
      st = clean(st);
      if(st==="open") return "Ù…ÙØªÙˆØ­";
      if(st==="offered") return "ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±";
      if(st==="accepted") return "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„";
      if(st==="arrived") return "ÙˆØµÙ„Øª";
      if(st==="started") return "Ø¨Ø¯Ø£Øª";
      if(st==="completed"||st==="done") return "Ø§Ù†ØªÙ‡Øª";
      if(st==="canceled") return "Ù…Ù„ØºÙŠ";
      return st || "â€”";
    }

    // ===== Auth
    setActiveRole("driver");
    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email || user.phoneNumber || "-";
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    let driverProfile = null;
    try{ driverProfile = await getUserDoc(user.uid); }catch{ driverProfile=null; }

    const msg = document.getElementById("msg");
    const ridesList = document.getElementById("ridesList");
    const locChip = document.getElementById("locChip");
    const statusChip = document.getElementById("statusChip");

    // ===== Leaflet
    let map, meMarker=null, routeLine=null, pickMarkerFrom=null, pickMarkerTo=null;
    let meLatLng = null;

    function setChip(el, ok, text){
      el.textContent = text;
      el.classList.remove("ok","bad");
      el.classList.add(ok ? "ok" : "bad");
    }

    function invalidateMapSoon(){
      try{ map?.invalidateSize?.(true); }catch{}
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 180);
      setTimeout(()=>{ try{ map?.invalidateSize?.(true); }catch{} }, 420);
    }

    function fitAll(){
      if(!map) return;
      const layers = [];
      if(meMarker) layers.push(meMarker);
      if(pickMarkerFrom) layers.push(pickMarkerFrom);
      if(pickMarkerTo) layers.push(pickMarkerTo);
      if(routeLine) layers.push(routeLine);
      if(!layers.length) return;
      try{
        const g = L.featureGroup(layers);
        map.fitBounds(g.getBounds(), { padding:[40,40] });
      }catch{}
    }

    function initMap(){
      const fallbackCenter = [30.0444, 31.2357];
      map = L.map("map", { zoomControl: true }).setView(fallbackCenter, 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      setTimeout(()=>{ locateMe(false); }, 450);
      invalidateMapSoon();
    }

    const waitLeaflet = setInterval(()=>{
      if(window.L){
        clearInterval(waitLeaflet);
        initMap();
      }
    }, 30);

    function locateMe(showMsg=true){
      if(!navigator.geolocation){
        if(showMsg) msg.textContent="âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      if(showMsg) msg.textContent="ğŸ“ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        meLatLng = { lat, lng };

        if(map){
          map.setView([lat,lng], 16, { animate:false });
          if(!meMarker){
            meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
              .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");
          }else{
            meMarker.setLatLng([lat,lng]);
          }
        }

        setChip(locChip, true, "ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø­Ø¯Ø« âœ…");

        // ØªØ­Ø¯ÙŠØ« driver_status (Ù„Ùˆ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†)
        await pushDriverStatus();

        if(showMsg) msg.textContent="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.";
      }, (err)=>{
        console.error(err);
        setChip(locChip, false, "ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ÙØ´Ù„ âŒ");
        if(showMsg){
          if(err?.code === 1) msg.textContent="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.";
          else msg.textContent="âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    document.getElementById("myLocBtn").addEventListener("click", ()=> locateMe(true));

    // ===== Regions
    const regions = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    const govSelect = document.getElementById("govSelect");
    const centerSelect = document.getElementById("centerSelect");
    const vehicleTypeSel = document.getElementById("vehicleType");
    const onlineSelect = document.getElementById("onlineSelect");

    Object.keys(regions).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
      const op = document.createElement("option");
      op.value = g;
      op.textContent = g;
      govSelect.appendChild(op);
    });

    function fillCenters(g){
      centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²â€¦</option>';
      if(!g){
        centerSelect.disabled = true;
        return;
      }
      regions[g].slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const op = document.createElement("option");
        op.value = c;
        op.textContent = c;
        centerSelect.appendChild(op);
      });
      centerSelect.disabled = false;
    }

    govSelect.addEventListener("change", ()=>{
      fillCenters(govSelect.value);
      persistDriverPrefs();
      refreshWatch();
    });

    centerSelect.addEventListener("change", ()=>{
      persistDriverPrefs();
      refreshWatch();
    });

    vehicleTypeSel.addEventListener("change", ()=>{
      persistDriverPrefs();
      refreshWatch();
    });

    onlineSelect.addEventListener("change", async ()=>{
      persistDriverPrefs();
      await pushDriverStatus();
      refreshWatch();
    });

    function persistDriverPrefs(){
      const prefs = {
        gov: govSelect.value || "",
        center: centerSelect.value || "",
        vehicleType: vehicleTypeSel.value || "car",
        online: onlineSelect.value || "online",
      };
      localStorage.setItem("driverPrefs", JSON.stringify(prefs));
    }

    function loadDriverPrefs(){
      let prefs = null;
      try{ prefs = JSON.parse(localStorage.getItem("driverPrefs") || "null"); }catch{}
      if(prefs){
        if(prefs.gov) govSelect.value = prefs.gov;
        fillCenters(govSelect.value || "");
        if(prefs.center) centerSelect.value = prefs.center;
        if(prefs.vehicleType) vehicleTypeSel.value = prefs.vehicleType;
        if(prefs.online) onlineSelect.value = prefs.online;
      }else{
        fillCenters("");
      }
    }
    loadDriverPrefs();

    async function pushDriverStatus(){
      try{
        const online = (onlineSelect.value === "online");
        const gov = govSelect.value || "";
        const center = centerSelect.value || "";
        const vehicleType = vehicleTypeSel.value || "car";

        const stRef = doc(db, "driver_status", user.uid);

        const payload = {
          uid: user.uid,
          online,
          governorate: gov,
          center,
          vehicleType,
          updatedAt: serverTimestamp()
        };

        if(meLatLng && Number.isFinite(meLatLng.lat) && Number.isFinite(meLatLng.lng)){
          payload.lat = meLatLng.lat;
          payload.lng = meLatLng.lng;
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† users (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try{
          driverProfile = driverProfile || await getUserDoc(user.uid);
          payload.name = driverProfile?.name || null;
          payload.phone = driverProfile?.phone || null;
          payload.email = user.email || null;
          payload.plate = driverProfile?.plate || null;
          payload.model = driverProfile?.model || null;
        }catch{}

        await updateDoc(stRef, payload).catch(async ()=>{
          // Ù„Ùˆ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†Ø¹Ù…Ù„Ù‡Ø§ Ø¨ updateDocØŸ (Ù‡Øªfail). ÙÙ†Ø¹Ù…Ù„ set Ø¹Ø¨Ø± updateDocØŸ Ù„Ø§ â€” Ø¨Ø³ Ø¨Ù…Ø§ Ø¥Ù† rules ØªØ³Ù…Ø­ create/updateØŒ Ù†Ø³ØªØ®Ø¯Ù… updateDoc Ù…Ø¹ Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ doc.
          // Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¨Ø³Ø·: create Ø£ÙˆÙ„ Ù…Ø±Ø© Ù…Ù† app.js Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¹Ù…Ù„ fallback: setDoc.
          const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
          await setDoc(stRef, payload, { merge:true });
        });

        setChip(statusChip, online, online ? "ğŸŸ¢ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" : "âšª Ø£ÙˆÙÙ„Ø§ÙŠÙ†");
      }catch(e){
        console.error(e);
        setChip(statusChip, false, "âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
      }
    }

    // Ø­Ø§ÙˆÙ„ ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø±Ø© Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
    setTimeout(async ()=>{
      await pushDriverStatus();
    }, 400);

    // ===== Sheet drag
    const sheet = document.getElementById("sheet");
    const sheetHeader = document.getElementById("sheetHeader");
    const SNAP = { min: 0.30, mid: 0.56, max: 0.86 };
    let currentSnap = "mid";

    function setSheetHeight(px){
      const maxPx = Math.round(window.innerHeight * SNAP.max);
      const minPx = Math.round(window.innerHeight * SNAP.min);
      const v = clamp(px, minPx, maxPx);
      sheet.style.height = v + "px";
      invalidateMapSoon();
    }
    function setSheetSnap(name){
      currentSnap = name;
      setSheetHeight(Math.round(window.innerHeight * SNAP[name]));
    }
    setSheetSnap("mid");

    let dragging = false;
    let startY = 0;
    let startH = 0;

    sheetHeader.addEventListener("pointerdown", (e)=>{
      dragging = true;
      sheet.classList.add("dragging");
      startY = e.clientY;
      startH = sheet.getBoundingClientRect().height;
      sheetHeader.setPointerCapture(e.pointerId);
      try{ map?.dragging?.disable(); map?.scrollWheelZoom?.disable(); }catch{}
    });

    sheetHeader.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const dy = e.clientY - startY;
      setSheetHeight(startH - dy);
      e.preventDefault();
    }, { passive:false });

    function endDrag(){
      if(!dragging) return;
      dragging = false;
      sheet.classList.remove("dragging");

      const h = sheet.getBoundingClientRect().height;
      const targets = [
        { k:"min", h: window.innerHeight * SNAP.min },
        { k:"mid", h: window.innerHeight * SNAP.mid },
        { k:"max", h: window.innerHeight * SNAP.max },
      ];
      targets.sort((a,b)=>Math.abs(a.h - h) - Math.abs(b.h - h));
      setSheetSnap(targets[0].k);

      try{ map?.dragging?.enable(); map?.scrollWheelZoom?.enable(); }catch{}
    }

    sheetHeader.addEventListener("pointerup", endDrag);
    sheetHeader.addEventListener("pointercancel", endDrag);
    window.addEventListener("resize", ()=> setSheetSnap(currentSnap));

    // ===== Rides watch
    let unsubRides = null;

    function rideCardHTML(rideId, r){
      const st = statusText(r.status || "");
      const fromT = escapeHTML(r.fromText || "");
      const toT = escapeHTML(r.toText || "");
      const gov = escapeHTML(r.governorate || "");
      const center = escapeHTML(r.center || "");
      const vehicle = escapeHTML(vehText(r.vehicleType || r.requestedVehicle || ""));
      const price = Number(r.offerPriceEGP ?? r.priceEGP ?? r.fareEGP);
      const priceTxt = Number.isFinite(price) ? `${Math.round(price)} Ø¬.Ù…` : "";

      const pName = escapeHTML(r.passengerName || "");
      const pPhone = escapeHTML(r.passengerPhone || "");
      const pEmail = escapeHTML(r.passengerEmail || "");

      return `
        <div class="rideCard" data-id="${rideId}">
          <div class="rideRow">
            <div class="rideTitle">ğŸš• Ø·Ù„Ø¨ (${vehicle})</div>
            <span class="miniChip ${["open","offered","accepted","arrived","started"].includes(r.status) ? "ok":"bad"}">${st}</span>
          </div>
          <div class="rideMeta">
            <b>ğŸ“ Ù…Ù†:</b> ${fromT}<br>
            <b>ğŸ Ø¥Ù„Ù‰:</b> ${toT}<br>
            <b>ğŸ—ºï¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${gov} â€¢ ${center}<br>
            ${priceTxt ? `<b>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</b> ${priceTxt}<br>` : ``}
            ${(pName||pPhone||pEmail) ? `<span style="display:block;margin-top:6px;opacity:.9"><b>ğŸ‘¤ Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${pName||"â€”"} ${pPhone?` â€¢ ${pPhone}`:""} ${pEmail?` â€¢ ${pEmail}`:""}</span>` : ``}
          </div>
          <div class="rideActions">
            <button class="btn primary" data-act="openOnMap">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
            <button class="btn success" data-act="offer">ğŸ’° Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶</button>
            <button class="btn" data-act="accept">âœ… Ù‚Ø¨ÙˆÙ„</button>
            <button class="btn danger" data-act="cancel">â›” Ø±ÙØ¶/ØªØ¬Ø§Ù‡Ù„</button>
          </div>
        </div>
      `;
    }

    function clearMapRide(){
      if(routeLine){ try{ map.removeLayer(routeLine); }catch{} routeLine=null; }
      if(pickMarkerFrom){ try{ map.removeLayer(pickMarkerFrom); }catch{} pickMarkerFrom=null; }
      if(pickMarkerTo){ try{ map.removeLayer(pickMarkerTo); }catch{} pickMarkerTo=null; }
    }

    async function drawRideOnMap(r){
      if(!map) return;

      clearMapRide();

      const pLat = safeNum(r.from?.lat), pLng = safeNum(r.from?.lng);
      const tLat = safeNum(r.to?.lat),   tLng = safeNum(r.to?.lng);

      if(pLat!=null && pLng!=null){
        pickMarkerFrom = L.marker([pLat,pLng]).addTo(map).bindPopup("Ø§Ù„Ù‚ÙŠØ§Ù…").openPopup();
      }
      if(tLat!=null && tLng!=null){
        pickMarkerTo = L.marker([tLat,tLng]).addTo(map).bindPopup("Ø§Ù„ÙˆØµÙˆÙ„");
      }

      // Ø±Ø³Ù… Ø®Ø· Ø¨Ø³ÙŠØ· (Ø¨Ø¯ÙˆÙ† OSRM Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ§Øª)
      if(pLat!=null && pLng!=null && tLat!=null && tLng!=null){
        routeLine = L.polyline([[pLat,pLng],[tLat,tLng]], { weight: 5, opacity: 0.92 }).addTo(map);
      }

      fitAll();
      invalidateMapSoon();
    }

    async function sendOffer(rideId){
      const v = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ (Ù…Ø«Ø§Ù„: 45):");
      if(v == null) return;
      const n = Number(String(v).replace(/[^\d.]/g,""));
      if(!Number.isFinite(n) || n <= 0){
        msg.textContent = "âš ï¸ Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­.";
        return;
      }

      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶â€¦";
      try{
        driverProfile = driverProfile || await getUserDoc(user.uid);

        const payload = {
          status: "offered",
          updatedAt: serverTimestamp(),

          driverUid: user.uid,
          driverName: driverProfile?.name || "Ø³Ø§Ø¦Ù‚",
          driverPhone: driverProfile?.phone || user.phoneNumber || "",
          driverEmail: user.email || "",
          driverVehicle: vehicleTypeSel.value || "car",
          driverModel: driverProfile?.model || "",
          driverPlate: driverProfile?.plate || "",

          offerPriceEGP: Math.round(n),
        };

        await updateDoc(doc(db, "rides", rideId), payload);
        msg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶.";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶.";
      }
    }

    async function acceptRide(rideId){
      msg.textContent = "Ø¬Ø§Ø±Ù Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨â€¦";
      try{
        driverProfile = driverProfile || await getUserDoc(user.uid);

        const payload = {
          status: "accepted",
          updatedAt: serverTimestamp(),

          driverUid: user.uid,
          driverName: driverProfile?.name || "Ø³Ø§Ø¦Ù‚",
          driverPhone: driverProfile?.phone || user.phoneNumber || "",
          driverEmail: user.email || "",
          driverVehicle: vehicleTypeSel.value || "car",
          driverModel: driverProfile?.model || "",
          driverPlate: driverProfile?.plate || "",
        };

        await updateDoc(doc(db, "rides", rideId), payload);
        msg.textContent = "âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.";
      }catch(e){
        console.error(e);
        msg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„. Ø±Ø¨Ù…Ø§ Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø± Ø³Ø¨Ù‚Ùƒ.";
      }
    }

    async function cancelRideAsDriver(rideId){
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø§Ù‡Ù„/Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ (Ù„Ù† ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø±Ø§ÙƒØ¨ØŒ ÙÙ‚Ø· ØªØ¬Ø§Ù‡Ù„ Ù…Ù† Ø¹Ù†Ø¯Ùƒ)")) return;
      // Ù…ÙÙŠØ´ "Ø±ÙØ¶" ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ÙƒØŒ ÙØ¨Ù†ÙƒØªÙÙŠ Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ§Ø±Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
      const el = ridesList.querySelector(`[data-id="${rideId}"]`);
      if(el) el.remove();
      msg.textContent = "ØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„.";
    }

    ridesList.addEventListener("click", async (e)=>{
      const card = e.target.closest(".rideCard");
      const btn = e.target.closest("button");
      if(!card || !btn) return;
      const rideId = card.getAttribute("data-id");
      const act = btn.getAttribute("data-act");

      try{
        if(act === "openOnMap"){
  if(!rideId) return;
  const snap = await getDoc(doc(db, "rides", rideId));
  if(snap.exists()) await drawRideOnMap(snap.data());
  return;
}
        if(act === "offer") return await sendOffer(rideId);
        if(act === "accept") return await acceptRide(rideId);
        if(act === "cancel") return await cancelRideAsDriver(rideId);
      }catch(err){
        console.error(err);
      }
    });

    function refreshWatch(){
      if(unsubRides){ try{unsubRides();}catch{} unsubRides=null; }
      ridesList.innerHTML = "";

      const gov = govSelect.value || "";
      const center = centerSelect.value || "";
      const vehicleType = vehicleTypeSel.value || "car";
      const online = (onlineSelect.value === "online");

      if(!online){
        msg.textContent = "âšª Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ù„Ù† ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
        return;
      }
      if(!gov || !center){
        msg.textContent = "âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© + Ø§Ù„Ù…Ø±ÙƒØ² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
        return;
      }

      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦";

      const ridesRef = collection(db, "rides");
      const q1 = query(
        ridesRef,
        where("status", "in", ["open","offered"]),
        where("governorate", "==", gov),
        where("center", "==", center),
        where("requestedVehicle", "==", vehicleType),
        orderBy("createdAt", "desc")
      );

      unsubRides = onSnapshot(q1, (snap)=>{
        const items = [];
        snap.forEach((d)=>{
          const r = d.data();
          // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù„ÙŠ Ø£Ù†Ø§ Ù…Ø§Ø³ÙƒÙ‡/Ù…Ù‚Ø¨ÙˆÙ„Ù‡ Ø¹Ù†Ø¯ÙŠ Ø£Ùˆ Ø¹Ù†Ø¯ ØºÙŠØ±ÙŠ
          const duid = r.driverUid || null;
          if(duid && duid !== user.uid) return;
          items.push({ id: d.id, r });
        });

        ridesList.innerHTML = items.length
          ? items.map(x=>rideCardHTML(x.id, x.r)).join("")
          : `<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù†.</div>`;

        msg.textContent = "";
      }, (err)=>{
        console.error(err);
        msg.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
      });
    }

    function manualRefresh(){
      refreshWatch();
      setTimeout(()=> invalidateMapSoon(), 150);
    }

    document.getElementById("refreshBtn").addEventListener("click", manualRefresh);

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    setTimeout(()=> refreshWatch(), 300);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ùˆ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
    setInterval(async ()=>{
      if(onlineSelect.value === "online"){
        await pushDriverStatus();
      }
    }, 30000);

  </script>
</body>
</html>
```î¨0î¨‚
