<script type="module">
  import { requireAuthAndRole, db } from "./app.js";
  await requireAuthAndRole("driver");

  import {
    collection, query, where, orderBy, limit, getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const listEl = document.getElementById('list');
  const refreshBtn = document.getElementById('refreshBtn');

  function safeNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function rideCard(r){
    const fromLat = safeNum(r.from?.lat);
    const fromLng = safeNum(r.from?.lng);

    const toLat = safeNum(r.to?.lat);
    const toLng = safeNum(r.to?.lng);

    const fromText = (fromLat !== null && fromLng !== null) ? `${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}` : "-";
    const toText   = (toLat !== null && toLng !== null) ? `${toLat.toFixed(5)}, ${toLng.toFixed(5)}` : "-";

    const el = document.createElement('div');
    el.className = 'card';

    el.innerHTML = `
      <div><b>طلب:</b> ${r.id}</div>
      <div class="muted">من: ${fromText}<br>إلى: ${toText}</div>
      <div class="muted">ركاب: ${r.passengers ?? "-"} | هاتف: ${r.phone ?? "-"} </div>
      <div class="muted">ملاحظة: ${r.note ?? "-"}</div>
      <div class="row">
        <button data-id="${r.id}">قبول</button>
        ${fromLat !== null && fromLng !== null ? `
          <a target="_blank" href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
            فتح الانطلاق
          </a>` : ""}
      </div>
    `;

    el.querySelector('button').addEventListener('click', async () => {
      try{
        await updateDoc(doc(db, "rides", r.id), { status: "accepted" });
        await load();
      }catch(e){
        console.error(e);
        alert("فشل قبول الطلب. تأكد من Firestore Rules.");
      }
    });

    return el;
  }

  async function load(){
    listEl.innerHTML = `<div class="card">جارٍ تحميل الطلبات…</div>`;

    const q = query(
      collection(db, "rides"),
      where("status", "==", "open"),
      orderBy("createdAt", "desc"),
      limit(25)
    );

    const snap = await getDocs(q);

    listEl.innerHTML = "";

    if(snap.empty){
      listEl.innerHTML = `<div class="card">لا توجد طلبات مفتوحة حالياً.</div>`;
      return;
    }

    snap.forEach(d => {
      listEl.appendChild(rideCard({ id: d.id, ...d.data() }));
    });
  }

  refreshBtn.addEventListener('click', load);
  load();
</script>
