<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ±Ø§Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
  <style>
    body{font-family:system-ui,Arial; margin:0; background:#0b0f14; color:#e8eef7;}
    header{padding:14px 16px; background:#101825; position:sticky; top:0; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    h1{margin:0; font-size:16px;}
    .wrap{padding:14px 16px; display:grid; gap:12px;}
    .card{background:#101825; border:1px solid #1f2a3a; border-radius:14px; padding:12px;}
    button{padding:10px 12px; border:0; border-radius:12px; background:#2b6cff; color:white; font-weight:800; cursor:pointer;}
    button.secondary{background:#24344a;}
    button.danger{background:#ff5c7a;}
    button:disabled{opacity:.55; cursor:not-allowed;}
    .muted{opacity:.85; font-size:13px; line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center;}
    a{color:#9ec1ff}
    .pill{display:inline-block; padding:4px 10px; border:1px solid #273449; border-radius:999px; font-size:12px; opacity:.9}
    .ok{border-color:rgba(34,197,94,.35); color:#bfffe0}
    .bad{border-color:rgba(255,92,122,.35); color:#ffd0d8}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§‘â€âœˆï¸ Ù…Ø´ÙˆØ±Ø§Ùƒ â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
    <div class="row" style="margin:0">
      <span class="pill" id="mePill">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</span>
      <button id="refreshBtn" class="secondary">ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="muted">
        ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù…Ù† <b>rides</b>. Ø§Ø¶ØºØ· â€œÙ‚Ø¨ÙˆÙ„â€ ÙˆØ³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„ÙŠÙƒ (Transaction) Ù„Ù…Ù†Ø¹ Ù‚Ø¨ÙˆÙ„ Ù…Ø²Ø¯ÙˆØ¬.
      </div>
      <div class="muted" id="hint" style="margin-top:8px"></div>
    </div>

    <div id="list"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, db, auth } from "./app.js";
    const { user } = await requireAuthAndRole("driver");

    import {
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      doc,
      runTransaction,
      serverTimestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const listEl = document.getElementById('list');
    const refreshBtn = document.getElementById('refreshBtn');
    const mePill = document.getElementById('mePill');
    const hint = document.getElementById('hint');

    mePill.textContent = user?.email || "Ø³Ø§Ø¦Ù‚";
    mePill.classList.add("ok");

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);
      const toLat = safeNum(r.to?.lat);
      const toLng = safeNum(r.to?.lng);

      const fromText = r.fromText ? esc(r.fromText) :
        (fromLat !== null && fromLng !== null ? `${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}` : "-");

      const toText = r.toText ? esc(r.toText) :
        (toLat !== null && toLng !== null ? `${toLat.toFixed(5)}, ${toLng.toFixed(5)}` : "-");

      const riderName = esc(r.name || "Ø±Ø§ÙƒØ¨");
      const riderEmail = esc(r.passengerEmail || "-");

      const el = document.createElement('div');
      el.className = 'card';

      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><b>Ø·Ù„Ø¨:</b> ${esc(r.id)}</div>
          <span class="pill">${esc(r.status || "-")}</span>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="muted">
            <b>ğŸ‘¤ Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${riderName}<br>
            <b>ğŸ“§</b> ${riderEmail}<br>
            <b>ğŸ“</b> ${esc(r.phone ?? "-")} | <b>Ø±ÙƒØ§Ø¨:</b> ${esc(r.passengers ?? "-")}
          </div>

          <div class="muted">
            <b>ğŸš© Ù…Ù†:</b> ${fromText}<br>
            <b>ğŸ Ø¥Ù„Ù‰:</b> ${toText}<br>
            <b>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${esc(r.note ?? "-")}
          </div>
        </div>

        <div class="row">
          <button class="acceptBtn" data-id="${esc(r.id)}">Ù‚Ø¨ÙˆÙ„</button>
          ${(fromLat !== null && fromLng !== null) ? `
            <a target="_blank" href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
              ÙØªØ­ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
            </a>` : ``}
        </div>
        <div class="muted" style="margin-top:8px" id="msg-${esc(r.id)}"></div>
      `;

      const btn = el.querySelector('.acceptBtn');
      btn.addEventListener('click', async () => {
        const rideId = btn.dataset.id;
        const msgEl = el.querySelector(`#msg-${CSS.escape(rideId)}`);
        btn.disabled = true;
        msgEl.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";

        try{
          await acceptRide(rideId);
          msgEl.textContent = "âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.";
        }catch(e){
          console.error(e);
          msgEl.textContent = e?.message || "âŒ ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø±Ø§Ø¬Ø¹ Firestore Rules.";
          btn.disabled = false;
        }
      });

      return el;
    }

    async function acceptRide(rideId){
      const uid = auth.currentUser?.uid;
      if(!uid) throw new Error("âŒ Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„ ÙƒØ³Ø§Ø¦Ù‚.");

      const rideRef = doc(db, "rides", rideId);
      const userRef = doc(db, "users", uid); // Ù‡Ù†Ø¬ÙŠØ¨ Ø§Ø³Ù…/Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù† ÙˆØ¬Ø¯

      await runTransaction(db, async (tx) => {
        const rideSnap = await tx.get(rideRef);
        if(!rideSnap.exists()) throw new Error("âŒ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯.");

        const r = rideSnap.data() || {};
        if(r.status !== "open") throw new Error("âŒ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡/ØªØºÙŠÙŠØ±Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„.");
        if(r.driverId) throw new Error("âŒ ØªÙ… ØªØ«Ø¨ÙŠØª Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.");

        let driverName = auth.currentUser?.displayName || auth.currentUser?.email || "Ø³Ø§Ø¦Ù‚";
        let driverPhone = null;

        try{
          const uSnap = await tx.get(userRef);
          if(uSnap.exists()){
            const u = uSnap.data() || {};
            const n = (u.name || u.fullName || u.username || u.displayName || "").toString().trim();
            if(n) driverName = n;
            if(u.phone) driverPhone = String(u.phone).trim();
          }
        }catch(_){}

        tx.update(rideRef, {
          status: "accepted",
          driverId: uid,
          driverName,
          driverPhone: driverPhone || null,
          acceptedAt: serverTimestamp()
        });
      });
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ + Realtime (Ø£Ø®Ù Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù…Ø±Ø©)
    let unsub = null;

    async function load(){
      listEl.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      // Ø¬Ø±Ø¨ realtimeØ› Ù„Ùˆ Ø­ØµÙ„ error ÙÙŠ index Ù‡Ù†Ø±Ø¬Ø¹ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      try{
        if(unsub) unsub();
        unsub = onSnapshot(q, (snap)=>{
          listEl.innerHTML = "";
          hint.textContent = "";
          if(snap.empty){
            listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
            return;
          }
          snap.forEach(d => listEl.appendChild(rideCard({ id: d.id, ...d.data() })));
        }, (err)=>{
          console.error(err);
          hint.textContent = "âš ï¸ ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (Ù…Ù…ÙƒÙ† ÙŠØ­ØªØ§Ø¬ Composite Index). Ø§Ø¶ØºØ· ØªØ­Ø¯ÙŠØ«.";
          hint.className = "muted";
          // fallback ØªØ­Ù…ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ
          loadOnce();
        });
      }catch(e){
        console.error(e);
        loadOnce();
      }
    }

    async function loadOnce(){
      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      const snap = await getDocs(q);
      listEl.innerHTML = "";

      if(snap.empty){
        listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        return;
      }

      snap.forEach(d => listEl.appendChild(rideCard({ id: d.id, ...d.data() })));
    }

    refreshBtn.addEventListener('click', loadOnce);

    load();
  </script>
</body>
</html>
```î¨0î¨‚
