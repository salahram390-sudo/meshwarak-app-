<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشوارك - السائق</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">م</div>
        <div>
          <h1>سائق</h1>
          <p id="who">جارٍ التحميل…</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">الرئيسية</a>
        <button class="btn danger" id="logoutBtn">خروج</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:14px">
    <div class="card">
      <div class="hint">يعرض الطلبات المفتوحة (open). اضغط “قبول” لتثبيت السائق على الطلب.</div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" id="refreshBtn">تحديث</button>
      </div>
    </div>

    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      collection, query, where, orderBy, limit,
      getDocs, doc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const listEl = document.getElementById("list");
    const refreshBtn = document.getElementById("refreshBtn");

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>طلب:</b> ${r.id}</div>
          <div class="pill">${r.createdAt ? "جديد" : ""}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>الراكب:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>من:</b> ${r.fromText ?? "-"}
          <br><b>إلى:</b> ${r.toText ?? "-"}
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-accept="${r.id}">قبول</button>
          ${fromLat && fromLng ? `
            <a class="btn" target="_blank"
              href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
              فتح الانطلاق
            </a>` : ``}
        </div>
        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      el.querySelector(`[data-accept="${r.id}"]`).addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        try{
          m.textContent = "جارٍ القبول…";

          // بيانات السائق من users/{uid}
          const d = await getUserDoc(user.uid);
          const driverName = d?.name || "سائق";
          const driverPhone = d?.phone || null;

          // تأكد الطلب لسه open
          const rideRef = doc(db, "rides", r.id);
          const snap = await getDoc(rideRef);
          if(!snap.exists()){
            m.textContent = "الطلب اختفى.";
            return;
          }
          const cur = snap.data();
          if(cur.status !== "open"){
            m.textContent = "الطلب اتقبل بالفعل.";
            return;
          }

          await updateDoc(rideRef, {
            status: "accepted",
            driverUid: user.uid,
            driverEmail: user.email,
            driverName,
            driverPhone
          });

          m.textContent = "✅ تم قبول الطلب.";
          await load();
        }catch(e){
          console.error(e);
          m.textContent = "❌ فشل القبول. راجع Firestore Rules.";
        }
      });

      return el;
    }

    async function load(){
      listEl.innerHTML = `<div class="card">جارٍ تحميل الطلبات…</div>`;

      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      const snap = await getDocs(q);

      listEl.innerHTML = "";
      if(snap.empty){
        listEl.innerHTML = `<div class="card">لا توجد طلبات مفتوحة حالياً.</div>`;
        return;
      }

      snap.forEach(d=>{
        listEl.appendChild(rideCard({ id:d.id, ...d.data() }));
      });
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
