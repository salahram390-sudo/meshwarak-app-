<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشوارك - السائق</title>
  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">م</div>
        <div>
          <h1>سائق</h1>
          <p id="who">جارٍ التحميل…</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">الرئيسية</a>
        <button class="btn danger" id="logoutBtn" type="button">خروج</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:14px">
    <!-- إعداد منطقة السائق -->
    <div class="card" id="setupCard" style="display:none">
      <div class="hint">لازم تحدد محافظتك ومركزك علشان تشوف الطلبات وتشتغل Online.</div>

      <div class="grid2" style="margin-top:10px">
        <div class="field" style="margin-top:0">
          <label>المحافظة</label>
          <select id="govSel">
            <option value="">اختر المحافظة</option>
          </select>
        </div>
        <div class="field" style="margin-top:0">
          <label>المركز / الحي</label>
          <select id="cenSel" disabled>
            <option value="">اختر المركز</option>
          </select>
        </div>
      </div>

      <div id="cenOtherWrap" style="display:none;margin-top:10px">
        <label>اكتب المركز يدويًا (اختياري لو اخترت "أخرى")</label>
        <input id="cenOtherInput" placeholder="مثال: مركز جديد…" />
      </div>

      <div class="actions">
        <button class="btn primary" id="saveAreaBtn" type="button">حفظ المنطقة</button>
      </div>

      <div class="hint" id="setupMsg" style="margin-top:10px"></div>
    </div>

    <!-- لوحة السائق -->
    <div class="card">
      <div class="pills" style="margin-top:0">
        <span class="pill" id="onlinePill">Offline</span>
        <span class="pill" id="gpsPill">GPS: غير معروف</span>
        <span class="pill" id="areaPill">منطقة: -</span>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="onlineBtn" type="button">Go Online</button>
        <button class="btn" id="refreshBtn" type="button">تحديث الطلبات</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>
      <div class="hint" style="margin-top:10px">
        يعرض طلبات منطقتك فقط. القبول Transaction لمنع القبول المزدوج ✅
      </div>
    </div>

    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";

    import {
      collection, query, where, orderBy, limit,
      getDocs, doc, runTransaction, serverTimestamp, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    const listEl = document.getElementById("list");
    const refreshBtn = document.getElementById("refreshBtn");

    const msg = document.getElementById("msg");
    const onlineBtn = document.getElementById("onlineBtn");
    const onlinePill = document.getElementById("onlinePill");
    const gpsPill = document.getElementById("gpsPill");
    const areaPill = document.getElementById("areaPill");

    const setupCard = document.getElementById("setupCard");
    const setupMsg = document.getElementById("setupMsg");
    const govSel = document.getElementById("govSel");
    const cenSel = document.getElementById("cenSel");
    const cenOtherWrap = document.getElementById("cenOtherWrap");
    const cenOtherInput = document.getElementById("cenOtherInput");
    const saveAreaBtn = document.getElementById("saveAreaBtn");

    const statusRef = doc(db, "driver_status", user.uid);
    const userRef = doc(db, "users", user.uid);

    let isOnline = false;
    let watchId = null;
    let pushTimer = null;

    let lastPos = null; // {lat,lng,heading,speed}
    let driverProfile = null; // users/{uid}

    // =========================
    // ✅ محافظات + مراكز (قائمة جاهزة)
    // =========================
    const AREAS = {
      "القاهرة": ["مدينة نصر","مصر الجديدة","المعادي","حلوان","المرج","شبرا","الزيتون","العباسية","التجمع"],
      "الجيزة": ["الهرم","فيصل","الدقي","العجوزة","6 أكتوبر","الشيخ زايد","البدرشين","الحوامدية"],
      "الإسكندرية": ["سيدي جابر","محرم بك","المنتزه","العجمي","ميامي","سموحة"],
      "الدقهلية": ["المنصورة","طلخا","ميت غمر","أجا","دكرنس"],
      "الشرقية": ["الزقازيق","بلبيس","منيا القمح","فاقوس","ههيا"],
      "الغربية": ["طنطا","المحلة الكبرى","زفتى","كفر الزيات"],
      "المنوفية": ["شبين الكوم","السادات","منوف","الباجور"],
      "القليوبية": ["بنها","شبرا الخيمة","قليوب","الخانكة"],
      "الفيوم": ["الفيوم","سنورس","إطسا"],
      "المنيا": ["المنيا","ملوي","سمالوط"],
      "أسيوط": ["أسيوط","ديروط","منفلوط"],
      "سوهاج": ["سوهاج","جرجا","طما"],
      "قنا": ["قنا","نجع حمادي","قفط"],
      "أسوان": ["أسوان","دراو","كوم أمبو"],
      "الأقصر": ["الأقصر","إسنا","أرمنت"]
    };

    function fillGov(){
      // امسح اللي بعد أول option
      const keep0 = govSel.querySelector("option[value='']");
      govSel.innerHTML = "";
      govSel.appendChild(keep0);

      Object.keys(AREAS)
        .sort((a,b)=>a.localeCompare(b,"ar"))
        .forEach(g=>{
          const o = document.createElement("option");
          o.value = g; o.textContent = g;
          govSel.appendChild(o);
        });
    }

    function fillCenter(gov, preselect=null){
      cenSel.innerHTML = `<option value="">اختر المركز</option>`;

      const arr = AREAS[gov] || [];
      arr.forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.textContent = c;
        cenSel.appendChild(o);
      });

      // ✅ أخرى (إدخال يدوي)
      const other = document.createElement("option");
      other.value = "__other__";
      other.textContent = "أخرى (إدخال يدوي)…";
      cenSel.appendChild(other);

      cenSel.disabled = !gov;
      cenOtherWrap.style.display = "none";
      cenOtherInput.value = "";

      if(preselect){
        const exists = Array.from(cenSel.options).some(o=>o.value===preselect);
        if(exists){
          cenSel.value = preselect;
        }else{
          cenSel.value = "__other__";
          cenOtherWrap.style.display = "block";
          cenOtherInput.value = preselect;
        }
      }
    }

    govSel.addEventListener("change", ()=>{
      const g = govSel.value.trim();
      fillCenter(g);
      setupMsg.textContent = "";
    });

    cenSel.addEventListener("change", ()=>{
      if(cenSel.value === "__other__"){
        cenOtherWrap.style.display = "block";
        cenOtherInput.focus();
      }else{
        cenOtherWrap.style.display = "none";
        cenOtherInput.value = "";
      }
      setupMsg.textContent = "";
    });

    function getSelectedArea(){
      const g = govSel.value.trim() || null;
      const cVal = cenSel.value;

      if(!g) return { gov:null, cen:null };

      if(!cVal) return { gov:g, cen:null };

      if(cVal === "__other__"){
        const manual = cenOtherInput.value.trim();
        return { gov:g, cen: (manual.length >= 2 ? manual : null) };
      }
      return { gov:g, cen:cVal.trim() || null };
    }

    async function loadDriverProfile(){
      driverProfile = await getUserDoc(user.uid).catch(()=>null);
      return driverProfile;
    }

    async function ensureAreaSelected(){
      if(!driverProfile) await loadDriverProfile();

      const gov = driverProfile?.governorate || null;
      const cen = driverProfile?.center || null;

      if(!gov || !cen){
        setupCard.style.display = "block";
        fillGov();
        govSel.value = gov || "";
        fillCenter(govSel.value, cen || null);

        areaPill.textContent = "منطقة: -";
        return false;
      }

      setupCard.style.display = "none";
      areaPill.textContent = `منطقة: ${gov} / ${cen}`;
      return true;
    }

    saveAreaBtn.addEventListener("click", async ()=>{
      setupMsg.textContent = "";

      const { gov, cen } = getSelectedArea();
      if(!gov) return setupMsg.textContent = "❌ اختر المحافظة.";
      if(!cen) return setupMsg.textContent = "❌ اختر المركز (أو اكتب يدويًا).";

      saveAreaBtn.disabled = true;
      setupMsg.textContent = "جارٍ الحفظ…";

      try{
        await setDoc(userRef, {
          governorate: gov,
          center: cen,
          updatedAt: serverTimestamp()
        }, { merge:true });

        await loadDriverProfile();
        setupMsg.textContent = "✅ تم حفظ المنطقة.";
        setupCard.style.display = "none";
        areaPill.textContent = `منطقة: ${gov} / ${cen}`;
        await load();
      }catch(e){
        console.error(e);
        setupMsg.textContent = `❌ فشل الحفظ: ${e.code || ""} ${e.message || e}`;
      }finally{
        saveAreaBtn.disabled = false;
      }
    });

    // =========================
    // UI helpers
    // =========================
    function setOnlineUI(on){
      isOnline = on;
      onlinePill.classList.remove("ok","bad");

      if(on){
        onlinePill.textContent = "Online ✅";
        onlinePill.classList.add("ok");
        onlineBtn.textContent = "Go Offline";
        onlineBtn.classList.remove("primary");
        onlineBtn.classList.add("danger");
      }else{
        onlinePill.textContent = "Offline";
        onlinePill.classList.add("bad");
        onlineBtn.textContent = "Go Online";
        onlineBtn.classList.remove("danger");
        onlineBtn.classList.add("primary");
      }
    }

    function setGpsUI(state){
      gpsPill.classList.remove("ok","bad");
      if(state === "ok"){
        gpsPill.textContent = "GPS: شغال ✅";
        gpsPill.classList.add("ok");
      }else if(state === "denied"){
        gpsPill.textContent = "GPS: مرفوض ❌";
        gpsPill.classList.add("bad");
      }else{
        gpsPill.textContent = "GPS: غير معروف";
      }
    }

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function rideCard(r, gov, cen){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>طلب:</b> ${r.id}</div>
          <div class="pill">${r.status || "-"}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>الراكب:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>من:</b> ${r.fromText ?? "-"}
          <br><b>إلى:</b> ${r.toText ?? "-"}
          <br><b>المنطقة:</b> ${r.governorate ?? "-"} / ${r.center ?? "-"}
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-accept="${r.id}" type="button">قبول</button>
          ${fromLat !== null && fromLng !== null ? `
            <a class="btn" target="_blank"
              href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
              فتح الانطلاق
            </a>` : ``}
        </div>
        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      el.querySelector(`[data-accept="${r.id}"]`).addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          m.textContent = "جارٍ القبول…";

          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "سائق";
          const driverPhone = d?.phone || null;

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"الطلب اختفى." };

            const cur = snap.data();

            // ✅ لازم Open + نفس المنطقة + لم يتم قبوله
            if(cur.status !== "open") return { ok:false, msg:"الطلب لم يعد مفتوح." };

            // مهم: ممكن تكون driverUid = null أو undefined
            if(cur.driverUid) return { ok:false, msg:"الطلب اتقبل بالفعل." };

            if(cur.governorate !== gov || cur.center !== cen){
              return { ok:false, msg:"❌ هذا الطلب خارج منطقتك." };
            }

            tx.update(rideRef, {
              status: "accepted",
              acceptedAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone
            });

            tx.set(statusRef, {
              online: true,
              available: false,
              currentTripId: r.id,
              lastSeenAt: serverTimestamp()
            }, { merge:true });

            return { ok:true, msg:"✅ تم قبول الطلب." };
          });

          m.textContent = res.msg;
          await load();
        }catch(e){
          console.error(e);
          m.textContent = `❌ فشل القبول: ${e.code || ""} ${e.message || e}`;
        }
      });

      return el;
    }

    async function load(){
      const ok = await ensureAreaSelected();
      if(!ok){
        listEl.innerHTML = `<div class="card">حدد منطقتك أولاً.</div>`;
        return;
      }

      const gov = driverProfile.governorate;
      const cen = driverProfile.center;

      listEl.innerHTML = `<div class="card">جارٍ تحميل الطلبات…</div>`;

      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        where("governorate", "==", gov),
        where("center", "==", cen),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      const snap = await getDocs(q);

      listEl.innerHTML = "";
      if(snap.empty){
        listEl.innerHTML = `<div class="card">لا توجد طلبات مفتوحة في منطقتك حالياً.</div>`;
        return;
      }

      snap.forEach(d=>{
        listEl.appendChild(rideCard({ id:d.id, ...d.data() }, gov, cen));
      });
    }

    refreshBtn.addEventListener("click", load);

    // =========================
    // Online / Offline + GPS Push
    // =========================
    async function pushStatus(extra = {}){
      const gov = driverProfile?.governorate || null;
      const cen = driverProfile?.center || null;

      const payload = {
        online: isOnline,
        available: isOnline,
        governorate: gov,
        center: cen,
        lastSeenAt: serverTimestamp(),
        ...extra
      };

      if(lastPos){
        payload.lat = lastPos.lat;
        payload.lng = lastPos.lng;
        payload.heading = lastPos.heading ?? null;
        payload.speed = lastPos.speed ?? null;
      }

      await setDoc(statusRef, payload, { merge:true });
    }

    function startGPS(){
      msg.textContent = "";
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent = "❌ جهازك لا يدعم GPS.";
        return false;
      }

      watchId = navigator.geolocation.watchPosition((pos)=>{
        setGpsUI("ok");
        lastPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: (pos.coords.heading ?? null),
          speed: (pos.coords.speed ?? null),
        };
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setGpsUI("denied");
          msg.innerHTML = "❌ لازم تفعّل إذن الموقع.<br>Android: الإعدادات → التطبيقات → مشوارك → الأذونات → الموقع → سماح.";
        }else{
          setGpsUI("unknown");
          msg.textContent = "تعذر تحديد الموقع الآن. جرّب تاني.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });

      pushTimer = setInterval(async ()=>{
        try{
          if(!isOnline) return;
          await pushStatus();
        }catch(e){
          console.error(e);
        }
      }, 4000);

      return true;
    }

    function stopGPS(){
      if(watchId !== null){
        try{ navigator.geolocation.clearWatch(watchId); }catch{}
        watchId = null;
      }
      if(pushTimer){
        clearInterval(pushTimer);
        pushTimer = null;
      }
      lastPos = null;
      setGpsUI("unknown");
    }

    async function goOnline(){
      onlineBtn.disabled = true;
      msg.textContent = "جارٍ التشغيل Online…";

      await loadDriverProfile();
      const ok = await ensureAreaSelected();
      if(!ok){
        msg.textContent = "❌ لازم تحدد محافظتك ومركزك أولاً.";
        onlineBtn.disabled = false;
        return;
      }

      setOnlineUI(true);

      const okGps = startGPS();
      if(okGps){
        try{
          await pushStatus({ online:true, available:true, currentTripId: null });
          msg.textContent = "✅ Online شغال.. بيتم إرسال موقعك.";
        }catch(e){
          console.error(e);
          msg.textContent = `⚠️ Online اشتغل لكن مشكلة driver_status: ${e.code || ""} ${e.message || e}`;
        }
      }

      onlineBtn.disabled = false;
    }

    async function goOffline(){
      onlineBtn.disabled = true;
      msg.textContent = "جارٍ الإيقاف Offline…";

      setOnlineUI(false);
      stopGPS();

      try{
        await setDoc(statusRef, {
          online: false,
          available: false,
          currentTripId: null,
          lastSeenAt: serverTimestamp()
        }, { merge:true });

        msg.textContent = "✅ تم الإيقاف Offline.";
      }catch(e){
        console.error(e);
        msg.textContent = `⚠️ Offline اتعمل لكن مشكلة driver_status: ${e.code || ""} ${e.message || e}`;
      }

      onlineBtn.disabled = false;
    }

    onlineBtn.addEventListener("click", async ()=>{
      if(isOnline) await goOffline();
      else await goOnline();
    });

    window.addEventListener("beforeunload", ()=>{ try{ stopGPS(); }catch{} });

    // init
    setOnlineUI(false);
    setGpsUI("unknown");
    await loadDriverProfile();
    await ensureAreaSelected();
    await load();
  </script>
</body>
</html>
