<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .map-wrap-driver{height:48vh; position:relative; border-radius:18px; overflow:hidden; border:1px solid var(--stroke)}
    #dmap{height:100%; width:100%}

    .toast{
      position:fixed; left:12px; right:12px; top:76px; z-index:9999;
      display:none;
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px 12px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    .toast.show{display:block; animation:pop .22s ease}
    @keyframes pop{from{transform:translateY(-8px);opacity:.0}to{transform:none;opacity:1}}

    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .pill{font-weight:800}
    .mono{direction:ltr;text-align:left;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="container" style="padding-top:14px">

    <div class="map-wrap-driver">
      <div id="dmap"></div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div class="card" id="setupCard" style="display:none;margin-top:12px">
      <div class="hint">Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸ØªÙƒ ÙˆÙ…Ø±ÙƒØ²Ùƒ Ø¹Ù„Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ´ØªØºÙ„ Online.</div>

      <div class="grid2" style="margin-top:10px">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSel">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          </select>
        </div>
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ø­ÙŠ</label>
          <select id="cenSel" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>
          </select>
        </div>
      </div>

      <div id="cenOtherWrap" style="display:none;margin-top:10px">
        <label>Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ² ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø§Ø®ØªØ±Øª "Ø£Ø®Ø±Ù‰")</label>
        <input id="cenOtherInput" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙƒØ² Ø¬Ø¯ÙŠØ¯â€¦" />
      </div>

      <div class="actions">
        <button class="btn primary" id="saveAreaBtn" type="button">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
      </div>

      <div class="hint" id="setupMsg" style="margin-top:10px"></div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div class="card" style="margin-top:12px">
      <div class="pills" style="margin-top:0">
        <span class="pill" id="onlinePill">Offline</span>
        <span class="pill" id="gpsPill">GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
        <span class="pill" id="areaPill">Ù…Ù†Ø·Ù‚Ø©: -</span>
         <span class="pill" id="vehPill">Ù…Ø±ÙƒØ¨Ø©: -</span>
        <span class="pill" id="tripPill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©</span>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="onlineBtn" type="button">Go Online</button>
        <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn" id="refreshBtn" type="button">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>

      <div class="hint" style="margin-top:10px">
        ÙŠØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ù…Ù†Ø·Ù‚ØªÙƒ ÙÙ‚Ø· (Live). Ø§Ù„Ù‚Ø¨ÙˆÙ„ Transaction Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ âœ…
      </div>
    </div>

    <div class="card" id="currentTripCard" style="margin-top:12px;display:none"></div>
    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";

    import {
      collection, query, where, limit,
      doc, runTransaction, serverTimestamp, setDoc,
      onSnapshot, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= helpers
    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");
    const toast = $("toast");

    function showToast(html, ms=2400){
      toast.innerHTML = html;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), ms);
    }

    function safeNum(x){ const n=Number(x); return Number.isFinite(n)?n:null; }

    // ========= auth
    const { user } = await requireAuthAndRole("driver");
    $("who").textContent = user.email;
    $("logoutBtn").addEventListener("click", doLogout);

    const listEl = $("list");
    const refreshBtn = $("refreshBtn");
    const myLocBtn = $("myLocBtn");

    const msg = $("msg");
    const onlineBtn = $("onlineBtn");
    const onlinePill = $("onlinePill");
    const gpsPill = $("gpsPill");
    const areaPill = $("areaPill");
     const vehPill = $("vehPill");
    const tripPill = $("tripPill");
    const currentTripCard = $("currentTripCard");

    const setupCard = $("setupCard");
    const setupMsg = $("setupMsg");
    const govSel = $("govSel");
    const cenSel = $("cenSel");
    const cenOtherWrap = $("cenOtherWrap");
    const cenOtherInput = $("cenOtherInput");
    const saveAreaBtn = $("saveAreaBtn");

    const statusRef = doc(db, "driver_status", user.uid);
    const userRef = doc(db, "users", user.uid);

    const OTHER = "__other__";
    const LS = { gov:"mw_driver_gov", cen:"mw_driver_cen", cenOther:"mw_driver_cen_other" };

    let isOnline = false;
    let watchId = null;
    let pushTimer = null;
    let lastPos = null;
    let driverProfile = null;
    let unsubStatus = null;
    let unsubTrip = null;
    let currentTripId = null;
    let unsubRides = null;

    // ====== Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    const dmap = L.map("dmap", { zoomControl:false }).setView([30.0444, 31.2357], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(dmap);

    const fixMap = () => { try{ dmap.invalidateSize(true);}catch{} setTimeout(()=>{try{dmap.invalidateSize(true)}catch{}},250); };
    setTimeout(fixMap, 450);
    window.addEventListener("load", ()=> setTimeout(fixMap, 250));
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 200); });

    const divPin = (emoji) => L.divIcon({
      className: "pin-emoji",
      html: `<div class="pin-bubble">${emoji}</div>`,
      iconSize: [44,44],
      iconAnchor: [22,44],
      popupAnchor: [0,-36]
    });

    let meMarker = null;
    let passengerMarker = null;
    let toMarker = null;
    let routeLine = null;

    function setMeOnMap(lat,lng){
      if(!meMarker){
        meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
          .addTo(dmap).bindPopup("ğŸ“ Ø£Ù†Øª");
      }else meMarker.setLatLng([lat,lng]);
    }

    function setPassengerOnMap(lat,lng){
      if(!passengerMarker){
        passengerMarker = L.marker([lat,lng], { icon: divPin("ğŸš©") }).addTo(dmap).bindPopup("ğŸš© Ø§Ù„Ø±Ø§ÙƒØ¨");
      }else passengerMarker.setLatLng([lat,lng]);
    }

    function setToOnMap(lat,lng){
      if(!toMarker){
        toMarker = L.marker([lat,lng], { icon: divPin("ğŸ") }).addTo(dmap).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„");
      }else toMarker.setLatLng([lat,lng]);
    }

    function drawRouteSimple(){
      if(!meMarker || !passengerMarker) return;
      const a = meMarker.getLatLng();
      const b = passengerMarker.getLatLng();
      if(routeLine) dmap.removeLayer(routeLine);
      routeLine = L.polyline([a,b]).addTo(dmap);
    }

    function focusAll(){
      const layers = [];
      if(meMarker) layers.push(meMarker);
      if(passengerMarker) layers.push(passengerMarker);
      if(toMarker) layers.push(toMarker);
      if(routeLine) layers.push(routeLine);

      if(layers.length === 0) return;
      try{
        const group = L.featureGroup(layers);
        dmap.fitBounds(group.getBounds(), { padding:[30,30] });
      }catch{}
      fixMap();
    }

    // ========= ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø­ØªÙ‰ Offline)
    function autoLocateOnce(){
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        setGpsUI("ok");
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        setMeOnMap(lat,lng);
        dmap.setView([lat,lng], 16, { animate:false });
        fixMap();
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setGpsUI("denied");
          msg.innerHTML = "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          setGpsUI("unknown");
          msg.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }

    myLocBtn.addEventListener("click", ()=>{
      msg.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";
      autoLocateOnce();
    });

    // ====== Ù…Ù†Ø§Ø·Ù‚ (Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø©)
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    function fillGov(){
      const keep0 = document.createElement("option");
      keep0.value=""; keep0.textContent="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©";
      govSel.innerHTML = "";
      govSel.appendChild(keep0);

      Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
        const o = document.createElement("option");
        o.value = g; o.textContent = g;
        govSel.appendChild(o);
      });
    }

    function fillCenter(gov, preselect=null){
      cenSel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>`;
      (AREAS[gov] || []).slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.textContent = c;
        cenSel.appendChild(o);
      });

      const other = document.createElement("option");
      other.value = OTHER;
      other.textContent = "Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      cenSel.appendChild(other);

      cenSel.disabled = !gov;
      cenOtherWrap.style.display = "none";
      cenOtherInput.value = "";

      if(preselect){
        const exists = Array.from(cenSel.options).some(o=>o.value===preselect);
        if(exists){ cenSel.value = preselect; }
        else{
          cenSel.value = OTHER;
          cenOtherWrap.style.display = "block";
          cenOtherInput.value = preselect;
        }
      }
    }

    function getSelectedArea(){
      const g = clean(govSel.value) || null;
      const cVal = cenSel.value;
      if(!g) return { gov:null, cen:null };
      if(!cVal) return { gov:g, cen:null };
      if(cVal === OTHER){
        const manual = clean(cenOtherInput.value);
        return { gov:g, cen: (manual.length >= 2 ? manual : null) };
      }
      return { gov:g, cen: clean(cVal) || null };
    }

    function saveAreaLS(){
      const { gov, cen } = getSelectedArea();
      if(gov) localStorage.setItem(LS.gov, gov);
      if(cenSel.value === OTHER){
        localStorage.setItem(LS.cen, OTHER);
        localStorage.setItem(LS.cenOther, cenOtherInput.value || "");
      }else{
        if(cen) localStorage.setItem(LS.cen, cen);
        localStorage.removeItem(LS.cenOther);
      }
    }

    function restoreAreaLS(){
      const g = localStorage.getItem(LS.gov) || "";
      const c = localStorage.getItem(LS.cen) || "";
      const co = localStorage.getItem(LS.cenOther) || "";
      fillGov();
      if(g){
        govSel.value = g;
        fillCenter(g, (c && c !== OTHER) ? c : (co || null));
        if(c === OTHER){
          cenSel.value = OTHER;
          cenOtherWrap.style.display = "block";
          cenOtherInput.value = co;
        }
      }
    }

    govSel.addEventListener("change", ()=>{
      fillCenter(clean(govSel.value));
      setupMsg.textContent = "";
      saveAreaLS();
    });

    cenSel.addEventListener("change", ()=>{
      if(cenSel.value === OTHER){
        cenOtherWrap.style.display = "block";
        cenOtherInput.focus();
      }else{
        cenOtherWrap.style.display = "none";
        cenOtherInput.value = "";
      }
      setupMsg.textContent = "";
      saveAreaLS();
    });

    cenOtherInput.addEventListener("input", saveAreaLS);

    async function loadDriverProfile(){
      driverProfile = await getUserDoc(user.uid).catch(()=>null);
      return driverProfile;
    }

    async function ensureAreaSelected(){
      if(!driverProfile) await loadDriverProfile();

      const gov = clean(driverProfile?.governorate || "");
      const cen = clean(driverProfile?.center || "");

      const veh = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "");

       if(!veh){
         setupCard.style.display = "block";
         setupMsg.textContent = "âŒ Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù† ØµÙØ­Ø© Ø­Ø³Ø§Ø¨ÙŠ.";
         vehPill.textContent = "Ù…Ø±ÙƒØ¨Ø©: -";
         return false;
       }

       if(!gov || !cen){
        setupCard.style.display = "block";
        restoreAreaLS();
        areaPill.textContent = "Ù…Ù†Ø·Ù‚Ø©: -";
         vehPill.textContent = "Ù…Ø±ÙƒØ¨Ø©: -";
        return false;
      }

      setupCard.style.display = "none";
      areaPill.textContent = `Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
       const v = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "") || "-";
       const vText = (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":(v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":(v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":(v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":(v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":(v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª":v;
       vehPill.textContent = `Ù…Ø±ÙƒØ¨Ø©: ${vText}`;
      return true;
    }

    saveAreaBtn.addEventListener("click", async ()=>{
      setupMsg.textContent = "";
      const raw = getSelectedArea();
      const gov = clean(raw.gov);
      const cen = clean(raw.cen);

      if(!gov) return setupMsg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©.";
      if(!cen) return setupMsg.textContent = "âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ² (Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§).";

      saveAreaBtn.disabled = true;
      setupMsg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦";

      try{
        await setDoc(userRef, { governorate: gov, center: cen, updatedAt: serverTimestamp() }, { merge:true });
        saveAreaLS();
        await loadDriverProfile();
        setupMsg.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.";
        setupCard.style.display = "none";
        areaPill.textContent = `Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
        subscribeRides(true);
      }catch(e){
        console.error(e);
        setupMsg.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.`;
      }finally{
        saveAreaBtn.disabled = false;
      }
    });

    // ====== UI helpers
    function setOnlineUI(on){
      isOnline = on;
      onlinePill.classList.remove("ok","bad");
      if(on){
        onlinePill.textContent = "Online âœ…";
        onlinePill.classList.add("ok");
        onlineBtn.textContent = "Go Offline";
        onlineBtn.classList.remove("primary");
        onlineBtn.classList.add("danger");
      }else{
        onlinePill.textContent = "Offline";
        onlinePill.classList.add("bad");
        onlineBtn.textContent = "Go Online";
        onlineBtn.classList.remove("danger");
        onlineBtn.classList.add("primary");
      }
    }

    function setGpsUI(state){
      gpsPill.classList.remove("ok","bad");
      if(state === "ok"){ gpsPill.textContent = "GPS: Ø´ØºØ§Ù„ âœ…"; gpsPill.classList.add("ok"); }
      else if(state === "denied"){ gpsPill.textContent = "GPS: Ù…Ø±ÙÙˆØ¶ âŒ"; gpsPill.classList.add("bad"); }
      else { gpsPill.textContent = "GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"; }
    }

    // ====== Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    function stopWatchTrip(){
      if(unsubTrip){ try{ unsubTrip(); }catch{} unsubTrip=null; }
      if(passengerMarker){ try{ dmap.removeLayer(passengerMarker);}catch{} passengerMarker=null; }
      if(toMarker){ try{ dmap.removeLayer(toMarker);}catch{} toMarker=null; }
      if(routeLine){ try{ dmap.removeLayer(routeLine);}catch{} routeLine=null; }
    }

    function openGoogleMapsNav(lat, lng){
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
      window.open(url, "_blank");
    }

    function watchTrip(tripId){
      if(!tripId) return;
      if(unsubTrip) unsubTrip();

      const rideRef = doc(db, "rides", tripId);
      unsubTrip = onSnapshot(rideRef, (snap)=>{
        if(!snap.exists()){
          currentTripCard.style.display = "block";
          currentTripCard.innerHTML = `<div class="hint">âš ï¸ Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>`;
          return;
        }

        const r = snap.data();
        const status = r.status || "-";

        const pLat = safeNum(r.from?.lat);
        const pLng = safeNum(r.from?.lng);
        const toLat = safeNum(r.to?.lat);
        const toLng = safeNum(r.to?.lng);

        if(pLat!=null && pLng!=null) setPassengerOnMap(pLat,pLng);
        if(toLat!=null && toLng!=null) setToOnMap(toLat,toLng);
        if(meMarker && passengerMarker) drawRouteSimple();
        focusAll();

        if(["completed","canceled","done"].includes(status)){
          currentTripCard.style.display = "block";
          currentTripCard.innerHTML = `<div class="hint">âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù†ØªÙ‡Øª (${status}).</div>`;
          setDoc(statusRef, { available: !!isOnline, currentTripId: null, lastSeenAt: serverTimestamp() }, { merge:true }).catch(()=>{});
          return;
        }

        const pName = r.passengerName || "Ø±Ø§ÙƒØ¨";
        const pEmail = r.passengerEmail || "-";
        const pPhone = r.passengerPhone || "";
        const price = (r.priceEGP ?? r.offerPriceEGP ?? "-");

        const canArrive = (status === "accepted");
        const canStart  = (status === "arrived");
        const canEnd    = (status === "started");

        currentTripCard.style.display = "block";
        currentTripCard.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div><b>ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</b></div>
            <span class="pill ok">${status}</span>
          </div>

          <div class="hint" style="margin-top:10px">
            <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${pName} (${pEmail})
            <br><b>Ù‡Ø§ØªÙ:</b> ${pPhone || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
            <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
            <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
            <br><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${price} EG
          </div>

          <div class="actions" style="margin-top:12px">
            ${pPhone ? `<a class="btn success" href="tel:${pPhone}">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>` : `<button class="btn" disabled>ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…</button>`}
            ${(pLat!=null && pLng!=null) ? `<button class="btn" id="navPickupBtn" type="button">ğŸ§­ Ù…Ù„Ø§Ø­Ø© Ù„Ù„Ù‚ÙŠØ§Ù…</button>` : ``}
            ${(toLat!=null && toLng!=null) ? `<button class="btn" id="navToBtn" type="button">ğŸ§­ Ù…Ù„Ø§Ø­Ø© Ù„Ù„ÙˆØµÙˆÙ„</button>` : ``}
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn ${canArrive ? "primary" : ""}" id="arrivedBtn" ${canArrive ? "" : "disabled"} type="button">ğŸ“ ÙˆØµÙ„Øª</button>
            <button class="btn ${canStart ? "primary" : ""}" id="startBtn" ${canStart ? "" : "disabled"} type="button">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
            <button class="btn danger" id="endBtn" ${canEnd ? "" : "disabled"} type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
          </div>

          <div class="hint" id="tripMsg" style="margin-top:10px"></div>
        `;

        const tripMsg = currentTripCard.querySelector("#tripMsg");
        const navPickupBtn = currentTripCard.querySelector("#navPickupBtn");
        const navToBtn = currentTripCard.querySelector("#navToBtn");
        navPickupBtn?.addEventListener("click", ()=> openGoogleMapsNav(pLat, pLng));
        navToBtn?.addEventListener("click", ()=> openGoogleMapsNav(toLat, toLng));

        currentTripCard.querySelector("#arrivedBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦";
            await updateDoc(rideRef, { status:"arrived", arrivedAt: serverTimestamp() });
            tripMsg.textContent="âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„.";
          }catch(e){
            console.error(e);
            tripMsg.textContent = `âŒ ÙØ´Ù„.`;
          }
        });

        currentTripCard.querySelector("#startBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©â€¦";
            await updateDoc(rideRef, { status:"started", startedAt: serverTimestamp() });
            tripMsg.textContent="âœ… Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©.";
          }catch(e){
            console.error(e);
            tripMsg.textContent = `âŒ ÙØ´Ù„.`;
          }
        });

        currentTripCard.querySelector("#endBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©â€¦";
            await updateDoc(rideRef, { status:"completed", completedAt: serverTimestamp() });
            tripMsg.textContent="âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
            await setDoc(statusRef, { currentTripId:null, available:!!isOnline, lastSeenAt:serverTimestamp() }, {merge:true}).catch(()=>{});
          }catch(e){
            console.error(e);
            tripMsg.textContent = `âŒ ÙØ´Ù„.`;
          }
        });
      });
    }

    function watchDriverStatus(){
      if(unsubStatus) unsubStatus();
      unsubStatus = onSnapshot(statusRef, (snap)=>{
        const st = snap.exists() ? snap.data() : null;
        const online = !!st?.online;
        const tripId = st?.currentTripId || null;

        setOnlineUI(online);

        if(tripId){
          tripPill.textContent = `ğŸš– Ø±Ø­Ù„Ø©: ${tripId}`;
          currentTripId = tripId;
          watchTrip(tripId);
        }else{
          tripPill.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©";
          currentTripId = null;
          stopWatchTrip();
          currentTripCard.style.display = "none";
          currentTripCard.innerHTML = "";
        }
      }, ()=>{});
    }

    // ====== ÙƒØ±ÙˆØª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function rideCard(r, gov, cen){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const el = document.createElement("div");
      el.className = "card";

      const price = (r.offerPriceEGP ?? r.priceEGP ?? "-");

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>Ø·Ù„Ø¨:</b> <span class="mono">${r.id}</span></div>
          <div class="pill">${r.status || "-"}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>Ù‡Ø§ØªÙ:</b> ${r.passengerPhone ?? "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
          <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
          <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
          <br><b>Ø§Ù„Ø³Ø¹Ø±:</b> <b>${price}</b> EG
          <br><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${r.governorate ?? "-"} / ${r.center ?? "-"}
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn primary" data-accept="${r.id}" type="button">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn" data-offer="${r.id}" type="button">ğŸ’° Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±</button>
          <button class="btn danger" data-reject="${r.id}" type="button">Ø±ÙØ¶</button>
          ${fromLat!=null && fromLng!=null ? `<button class="btn" data-focus="${r.id}" type="button">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>` : ``}
        </div>

        <div id="offerWrap_${r.id}" style="display:none;margin-top:10px">
          <div class="field" style="margin-top:0">
            <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (15 â†’ 300)</label>
            <input id="offerInput_${r.id}" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 50" />
          </div>
          <button class="btn primary" data-send-offer="${r.id}" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>

        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      const focusBtn = el.querySelector(`[data-focus="${r.id}"]`);
      if(focusBtn){
        focusBtn.addEventListener("click", ()=>{
          if(fromLat!=null && fromLng!=null){
            setPassengerOnMap(fromLat, fromLng);
            dmap.setView([fromLat, fromLng], 16, { animate:false });
            fixMap();
          }
        });
      }

      el.querySelector(`[data-offer="${r.id}"]`)?.addEventListener("click", ()=>{
        const w = el.querySelector(`#offerWrap_${r.id}`);
        w.style.display = (w.style.display==="none") ? "block" : "none";
      }, (err)=>{
        console.error(err);
        // âœ… Ù„Ø§ ØªØ¸Ù‡Ø± Missing permissions Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        listEl.innerHTML = `<div class=\"card\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†.</div>`;
      });

      // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø³Ø¹Ø±
      el.querySelector(`[data-send-offer="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          if(currentTripId){
            m.textContent = "âŒ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ©. Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.";
            return;
          }

          const v = Number((el.querySelector(`#offerInput_${r.id}`)?.value||"").trim());
          if(!Number.isFinite(v) || v<15 || v>300){
            m.textContent = "âŒ Ø§ÙƒØªØ¨ Ø³Ø¹Ø± Ù…Ù† 15 Ø¥Ù„Ù‰ 300.";
            return;
          }

          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "Ø³Ø§Ø¦Ù‚";
          const driverPhone = d?.phone || null;
          const driverVehicle = d?.vehicle || null;
          const driverModel = d?.model || null;

          m.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶â€¦";

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§Ø®ØªÙÙ‰." };
            const cur = snap.data();

            if(cur.status !== "open") return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙØªÙˆØ­." };
            if(cur.driverUid) return { ok:false, msg:"ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„." };

            if(clean(cur.governorate) !== gov || clean(cur.center) !== cen){
              return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ Ù…Ù†Ø·Ù‚ØªÙƒ." };
            }

            tx.update(rideRef, {
              status: "offered",
              offerPriceEGP: v,
              offerBy: "driver",
              offerAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone,
              driverVehicle: driverVehicle || null,
              driverModel: driverModel || null,
            });

            return { ok:true, msg:`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶: ${v} EG` };
          });

          m.textContent = res.msg;
          if(res.ok){
            showToast("ğŸ’° <b>ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±</b> â€” ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø±Ø§ÙƒØ¨");
          }
        }catch(e){
          console.error(e);
          m.textContent = `âŒ ÙØ´Ù„.`;
        }
      });

      // Ù‚Ø¨ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±
      el.querySelector(`[data-accept="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          m.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";

          if(currentTripId){
            m.textContent = "âŒ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ©. Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.";
            return;
          }

          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "Ø³Ø§Ø¦Ù‚";
          const driverPhone = d?.phone || null;
          const driverVehicle = d?.vehicle || null;
          const driverModel = d?.model || null;

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§Ø®ØªÙÙ‰." };

            const cur = snap.data();

            if(cur.status === "offered" && cur.driverUid !== user.uid){
              return { ok:false, msg:"Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ø¬ÙˆØ² Ù„Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±." };
            }

            if(cur.status !== "open" && cur.status !== "offered"){
              return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø¨ÙˆÙ„." };
            }

            if(cur.status === "open"){
              if(cur.driverUid) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§ØªÙ‚Ø¨Ù„ Ø¨Ø§Ù„ÙØ¹Ù„." };
              if(clean(cur.governorate) !== gov || clean(cur.center) !== cen){
                return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ Ù…Ù†Ø·Ù‚ØªÙƒ." };
              }

              const myVeh = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "");
              const reqVeh = clean(cur.requestedVehicle || "");
              if(myVeh && reqVeh && myVeh !== reqVeh){
                return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†ÙˆØ¹ Ù…Ø±ÙƒØ¨Ø© Ù…Ø®ØªÙ„Ù." };
              }
            }

            const finalPrice = (cur.offerPriceEGP ?? cur.priceEGP ?? null);

            tx.update(rideRef, {
              status: "accepted",
              acceptedAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone,
              driverVehicle: driverVehicle || null,
              driverModel: driverModel || null,
              priceEGP: finalPrice
            });

            tx.set(statusRef, {
              online: true,
              available: false,
              currentTripId: r.id,
              lastSeenAt: serverTimestamp()
            }, { merge:true });

            return { ok:true, msg:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨." };
          });

          m.textContent = res.msg;
          if(res.ok){
            showToast("âœ… <b>ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</b> â€” ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©");
          }
        }catch(e){
          console.error(e);
          m.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„.`;
        }
      });

      // Ø±ÙØ¶ Ù…Ø­Ù„ÙŠ
      el.querySelector(`[data-reject="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        m.textContent = "ØªÙ… Ø§Ù„Ø±ÙØ¶. Ù„Ù† ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†.";
        el.style.display = "none";
      });

      return el;
    }

    // ====== Live Subscribe Ù„Ù„Ø·Ù„Ø¨Ø§Øª
    let firstRidesLoad = true;
    let knownIds = new Set();

    function showSoftLoadError(){
      listEl.innerHTML = `
        <div class="card">
          <div class="hint">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†.</div>
        </div>
      `;
    }

    async function subscribeRides(reset=false){
      if(unsubRides){ try{unsubRides()}catch{} unsubRides=null; }
      if(reset){
        firstRidesLoad = true;
        knownIds = new Set();
      }

      const ok = await ensureAreaSelected();
      if(!ok){
        listEl.innerHTML = `<div class="card">Ø­Ø¯Ø¯ Ù…Ù†Ø·Ù‚ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.</div>`;
        return;
      }

      const gov = clean(driverProfile.governorate);
      const cen = clean(driverProfile.center);

      listEl.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      // âœ… Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ù€ Rules: Ù„Ø§Ø²Ù… Ù†Ø¶ÙŠÙ driverUid == null ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
      const qy = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        where("driverUid", "==", null),
        where("governorate", "==", gov),
        where("center", "==", cen),
        where("requestedVehicle", "==", (clean(driverProfile?.vehicle || driverProfile?.vehicleType || "") || null)),
        limit(25)
      );

      unsubRides = onSnapshot(qy, (snap)=>{
        listEl.innerHTML = "";

        if(snap.empty){
          listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
          firstRidesLoad = false;
          return;
        }

        let newCount = 0;
        snap.forEach(d=>{
          if(!knownIds.has(d.id)) newCount++;
        });

        if(!firstRidesLoad && newCount > 0){
          showToast(`ğŸ”” <b>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„</b> (${newCount})`);
        }

        knownIds = new Set(snap.docs.map(x=>x.id));
        firstRidesLoad = false;

        snap.forEach(d=>{
          listEl.appendChild(rideCard({ id:d.id, ...d.data() }, gov, cen));
        });
      }, ()=>{
        showSoftLoadError();
      });
    }

    refreshBtn.addEventListener("click", ()=> subscribeRides(true));

    // ====== Online / Offline + GPS Push
    async function pushStatus(extra = {}){
      const gov = clean(driverProfile?.governorate || "") || null;
      const cen = clean(driverProfile?.center || "") || null;

      const payload = {
        online: isOnline,
        available: isOnline && !currentTripId,
        governorate: gov,
        center: cen,
        lastSeenAt: serverTimestamp(),
        ...extra
      };

      if(lastPos){
        payload.lat = lastPos.lat;
        payload.lng = lastPos.lng;
        payload.heading = lastPos.heading ?? null;
        payload.speed = lastPos.speed ?? null;
      }

      await setDoc(statusRef, payload, { merge:true });
    }

    function startGPS(){
      msg.textContent = "";
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return false;
      }

      watchId = navigator.geolocation.watchPosition((pos)=>{
        setGpsUI("ok");
        lastPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: (pos.coords.heading ?? null),
          speed: (pos.coords.speed ?? null),
        };
        setMeOnMap(lastPos.lat, lastPos.lng);
        if(passengerMarker) drawRouteSimple();
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setGpsUI("denied");
          msg.innerHTML = "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          setGpsUI("unknown");
          msg.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });

      pushTimer = setInterval(async ()=>{
        try{
          if(!isOnline) return;
          await pushStatus();
        }catch(e){ console.error(e); }
      }, 4000);

      return true;
    }

    function stopGPS(){
      if(watchId !== null){ try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId = null; }
      if(pushTimer){ clearInterval(pushTimer); pushTimer = null; }
      lastPos = null;
      setGpsUI("unknown");
    }

    async function goOnline(){
      onlineBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Onlineâ€¦";

      await loadDriverProfile();
      const ok = await ensureAreaSelected();
      if(!ok){
        msg.textContent = "âŒ Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸ØªÙƒ ÙˆÙ…Ø±ÙƒØ²Ùƒ Ø£ÙˆÙ„Ø§Ù‹.";
        onlineBtn.disabled = false;
        return;
      }

      setOnlineUI(true);

      const okGps = startGPS();
      if(okGps){
        try{
          await pushStatus({ online:true, available: !currentTripId, currentTripId: currentTripId || null });
          msg.textContent = "âœ… Online Ø´ØºØ§Ù„.. Ø¨ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.";
          showToast("âœ… <b>Ø£Ù†Øª Online</b> â€” Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨ÙŠØªØ¨Ø¹Øª");
        }catch(e){
          console.error(e);
          msg.textContent = `âš ï¸ Online Ø§Ø´ØªØºÙ„ Ù„ÙƒÙ† ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­ÙØ¸.`;
        }
      }

      onlineBtn.disabled = false;
    }

    async function goOffline(){
      onlineBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offlineâ€¦";

      setOnlineUI(false);
      stopGPS();

      try{
        await setDoc(statusRef, {
          online: false,
          available: false,
          lastSeenAt: serverTimestamp()
        }, { merge:true });
        msg.textContent = "âœ… ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offline.";
        showToast("âšª <b>Ø£Ù†Øª Offline</b>");
      }catch(e){
        console.error(e);
        msg.textContent = `âš ï¸ Offline Ø§ØªØ¹Ù…Ù„ Ù„ÙƒÙ† Ø­ØµÙ„ Ø®Ø·Ø£.`;
      }

      onlineBtn.disabled = false;
    }

    onlineBtn.addEventListener("click", async ()=>{
      if(isOnline) await goOffline();
      else await goOnline();
    });

    window.addEventListener("beforeunload", ()=>{ try{ stopGPS(); }catch{} });

    // init
    setOnlineUI(false);
    setGpsUI("unknown");
    await loadDriverProfile();
    await ensureAreaSelected();
    watchDriverStatus();
    subscribeRides(true);
    autoLocateOnce();

    window.addEventListener("error", ()=>{ msg.textContent = "âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©."; });
  </script>
</body>
</html>
sala
