<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشوارك - السائق</title>

  <!-- ✅ اسم ملف الستايل الصحيح -->
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">م</div>
        <div>
          <h1>سائق</h1>
          <p id="who">جارٍ التحميل…</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">الرئيسية</a>
        <button class="btn danger" id="logoutBtn" type="button">خروج</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:14px">
    <div class="card">
      <div class="pills" style="margin-top:0">
        <span class="pill bad" id="onlinePill">Offline</span>
        <span class="pill" id="gpsPill">GPS: غير معروف</span>
        <span class="pill" id="areaPill">منطقة: -</span>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="onlineBtn" type="button">Go Online</button>
        <button class="btn" id="refreshBtn" type="button">تحديث الطلبات</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>
      <div class="hint" style="margin-top:10px">
        يعرض الطلبات المفتوحة (open). القبول Transaction لمنع القبول المزدوج ✅
      </div>
    </div>

    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    const { user } = await requireAuthAndRole("driver");
    document.getElementById("who").textContent = user.email;
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    import {
      collection, query, where, orderBy, limit,
      getDocs, doc, runTransaction, serverTimestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const listEl = document.getElementById("list");
    const refreshBtn = document.getElementById("refreshBtn");

    const msg = document.getElementById("msg");
    const onlineBtn = document.getElementById("onlineBtn");
    const onlinePill = document.getElementById("onlinePill");
    const gpsPill = document.getElementById("gpsPill");
    const areaPill = document.getElementById("areaPill");

    const statusRef = doc(db, "driver_status", user.uid);

    let isOnline = false;
    let watchId = null;
    let pushTimer = null;

    let lastPos = null; // {lat,lng,heading,speed}
    let driverProfile = null; // from users/{uid}

    function setOnlineUI(on){
      isOnline = on;

      onlinePill.classList.remove("ok","bad");
      if(on){
        onlinePill.textContent = "Online ✅";
        onlinePill.classList.add("ok");
        onlineBtn.textContent = "Go Offline";
        onlineBtn.classList.remove("primary");
        onlineBtn.classList.add("danger");
      }else{
        onlinePill.textContent = "Offline";
        onlinePill.classList.add("bad");
        onlineBtn.textContent = "Go Online";
        onlineBtn.classList.remove("danger");
        onlineBtn.classList.add("primary");
      }
    }

    function setGpsUI(state){
      gpsPill.classList.remove("ok","bad");
      if(state === "ok"){
        gpsPill.textContent = "GPS: شغال ✅";
        gpsPill.classList.add("ok");
      }else if(state === "denied"){
        gpsPill.textContent = "GPS: مرفوض ❌";
        gpsPill.classList.add("bad");
      }else{
        gpsPill.textContent = "GPS: غير معروف";
      }
    }

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>طلب:</b> ${r.id}</div>
          <div class="pill">${r.status || "-"}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>الراكب:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>من:</b> ${r.fromText ?? "-"}
          <br><b>إلى:</b> ${r.toText ?? "-"}
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-accept="${r.id}" type="button">قبول</button>
          ${fromLat !== null && fromLng !== null ? `
            <a class="btn" target="_blank"
              href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">
              فتح الانطلاق
            </a>` : ``}
        </div>
        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      el.querySelector(`[data-accept="${r.id}"]`).addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          m.textContent = "جارٍ القبول…";

          // بيانات السائق من users/{uid}
          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "سائق";
          const driverPhone = d?.phone || null;

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"الطلب اختفى." };

            const cur = snap.data();

            if(cur.status !== "open" || cur.driverUid){
              return { ok:false, msg:"الطلب اتقبل بالفعل." };
            }

            tx.update(rideRef, {
              status: "accepted",
              acceptedAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone
            });

            tx.set(statusRef, {
              online: true,
              available: false,
              currentTripId: r.id,
              lastSeenAt: serverTimestamp()
            }, { merge:true });

            return { ok:true, msg:"✅ تم قبول الطلب." };
          });

          m.textContent = res.msg;
          await load();
        }catch(e){
          console.error(e);
          m.textContent = "❌ فشل القبول. راجع Firestore Rules.";
        }
      });

      return el;
    }

    async function load(){
      listEl.innerHTML = `<div class="card">جارٍ تحميل الطلبات…</div>`;

      const q = query(
        collection(db, "rides"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(25)
      );

      const snap = await getDocs(q);

      listEl.innerHTML = "";
      if(snap.empty){
        listEl.innerHTML = `<div class="card">لا توجد طلبات مفتوحة حالياً.</div>`;
        return;
      }

      snap.forEach(d=>{
        listEl.appendChild(rideCard({ id:d.id, ...d.data() }));
      });
    }

    refreshBtn.addEventListener("click", load);

    async function pushStatus(extra = {}){
      const gov = driverProfile?.governorate || null;
      const cen = driverProfile?.center || null;

      const payload = {
        online: isOnline,
        available: isOnline, // طالما Online ولسه مفيش Trip
        governorate: gov,
        center: cen,
        lastSeenAt: serverTimestamp(),
        ...extra
      };

      if(lastPos){
        payload.lat = lastPos.lat;
        payload.lng = lastPos.lng;
        payload.heading = lastPos.heading ?? null;
        payload.speed = lastPos.speed ?? null;
      }

      await setDoc(statusRef, payload, { merge:true });
    }

    function startGPS(){
      msg.textContent = "";
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent = "❌ جهازك لا يدعم GPS.";
        return false;
      }

      watchId = navigator.geolocation.watchPosition((pos)=>{
        setGpsUI("ok");
        lastPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: (pos.coords.heading ?? null),
          speed: (pos.coords.speed ?? null),
        };
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setGpsUI("denied");
          msg.innerHTML = "❌ لازم تفعّل إذن الموقع.<br>Android: الإعدادات → التطبيقات → مشوارك → الأذونات → الموقع → سماح.";
        }else{
          setGpsUI("unknown");
          msg.textContent = "تعذر تحديد الموقع الآن. جرّب تاني.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });

      pushTimer = setInterval(async ()=>{
        try{
          if(!isOnline) return;
          await pushStatus();
        }catch(e){
          console.error(e);
        }
      }, 3000);

      return true;
    }

    function stopGPS(){
      if(watchId !== null){
        try{ navigator.geolocation.clearWatch(watchId); }catch{}
        watchId = null;
      }
      if(pushTimer){
        clearInterval(pushTimer);
        pushTimer = null;
      }
      lastPos = null;
      setGpsUI("unknown");
    }

    async function goOnline(){
      onlineBtn.disabled = true;
      msg.textContent = "جارٍ التشغيل Online…";

      driverProfile = await getUserDoc(user.uid);

      const gov = driverProfile?.governorate;
      const cen = driverProfile?.center;

      if(!gov || !cen){
        msg.textContent = "❌ لازم تضيف governorate + center داخل users/{uid} للسائق.";
        onlineBtn.disabled = false;
        return;
      }

      areaPill.textContent = `منطقة: ${gov} / ${cen}`;

      setOnlineUI(true);

      const ok = startGPS();
      if(ok){
        try{
          await pushStatus({ online:true, available:true, currentTripId: null });
          msg.textContent = "✅ Online شغال.. بيتم إرسال موقعك.";
        }catch(e){
          console.error(e);
          msg.textContent = "⚠️ Online اشتغل لكن في مشكلة كتابة driver_status. راجع Rules.";
        }
      }

      onlineBtn.disabled = false;
    }

    async function goOffline(){
      onlineBtn.disabled = true;
      msg.textContent = "جارٍ الإيقاف Offline…";

      setOnlineUI(false);
      stopGPS();

      try{
        await setDoc(statusRef, {
          online: false,
          available: false,
          currentTripId: null,
          lastSeenAt: serverTimestamp()
        }, { merge:true });

        msg.textContent = "✅ تم الإيقاف Offline.";
      }catch(e){
        console.error(e);
        msg.textContent = "⚠️ Offline اتعمل لكن في مشكلة كتابة driver_status. راجع Rules.";
      }

      onlineBtn.disabled = false;
    }

    onlineBtn.addEventListener("click", async ()=>{
      if(isOnline) await goOffline();
      else await goOnline();
    });

    window.addEventListener("beforeunload", ()=>{
      try{ stopGPS(); }catch{}
    });

    setOnlineUI(false);
    setGpsUI("unknown");
    areaPill.textContent = "منطقة: -";
    load();
  </script>
</body>
</html>
