<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <link rel="icon" href="./favicon.png">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./styles.css" />
  <meta name="theme-color" content="#050B16" />

  <!-- âœ… Leaflet (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #toast{
      position:fixed; left:14px; right:14px; bottom:14px;
      background:rgba(10,18,34,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px 14px;
      color:#fff;
      box-shadow:0 16px 55px rgba(0,0,0,.45);
      transform: translateY(30px);
      opacity:0;
      pointer-events:none;
      transition:.25s ease;
      z-index:9999;
      max-width:720px;
      margin:auto;
    }
    #toast.show{opacity:1; transform: translateY(0);}

    #dmap{
      width:100%;
      height:260px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:#0b1222;
      position: relative;
    }
    #mapFallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:#fff; opacity:.85;
      padding:14px;
      text-align:center;
      pointer-events:none;
      font-size:13px;
      line-height:1.7;
    }

    .pin-emoji{background:transparent;border:none;}
    .pin-bubble{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(10,18,34,.92);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-size:22px;
    }

    .wrap{ width:min(980px,92%); margin:14px auto 90px; }
    .topbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .topbar .left{ display:flex;gap:10px;align-items:center;flex-wrap:wrap; }
    .title{ font-weight:900; font-size:16px; display:flex; gap:8px; align-items:center; }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:12px;
    }
    .pill.ok{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.25)}
    .pill.bad{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.25)}
    .card{
      background: linear-gradient(180deg, rgba(12,18,32,.95), rgba(10,18,34,.82));
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.28);
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .hint{opacity:.9;line-height:1.7}
    .text-bad{color:#ffb4b4}
    .btn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      background:rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height:44px;
    }
    .btn.primary{background:rgba(43,108,255,.85);border-color:rgba(43,108,255,.35)}
    .btn.danger{background:rgba(239,68,68,.75);border-color:rgba(239,68,68,.35)}
    .btn.success{background:rgba(34,197,94,.78);border-color:rgba(34,197,94,.35);color:#04110a;text-decoration:none;display:inline-flex;align-items:center}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .field{margin-top:10px}
    .field label{display:block;margin-bottom:6px;opacity:.9}
    .field input,.field select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <div id="toast"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <div class="title">ğŸ§‘â€âœˆï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
        <div class="pill"><span class="mono" id="who">...</span></div>
      </div>
      <button class="btn danger" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="card">
      <div class="actions" style="justify-content:space-between;align-items:center">
        <div class="actions">
          <button class="btn primary" id="onlineBtn" type="button">Go Online</button>
          <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
          <button class="btn" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div class="pills">
          <span class="pill bad" id="onlinePill">Offline</span>
          <span class="pill" id="gpsPill">GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
          <span class="pill" id="areaPill">Ù…Ù†Ø·Ù‚Ø©: -</span>
          <span class="pill" id="vehPill">Ù…Ø±ÙƒØ¨Ø©: -</span>
          <span class="pill" id="tripPill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©</span>
        </div>
      </div>

      <div id="msg" class="hint" style="margin-top:12px"></div>

      <div style="margin-top:12px">
        <div id="dmap">
          <div id="mapFallback">ğŸ—ºï¸ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©â€¦<br>Ù„Ùˆ ÙØ¶Ù„Øª ÙØ§Ø¶ÙŠØ©: Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯ÙˆÙ† VPN Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« (Refresh).</div>
        </div>
      </div>

      <!-- âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ùˆ Ù†Ø§Ù‚Øµ -->
      <div id="vehicleCard" class="card" style="margin-top:12px;display:none">
        <b>ğŸš— Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</b>
        <div class="hint" style="margin-top:6px">Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© + Ù…ÙˆØ¯ÙŠÙ„/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø¹Ù„Ø´Ø§Ù† ØªØ¸Ù‡Ø±Ù„Ùƒ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹.</div>

        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
          <select id="vehSel">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©â€¦</option>
            <option value="tuktuk">ØªÙˆÙƒØªÙˆÙƒ</option>
            <option value="motor_delivery">Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
            <option value="car">Ù…Ù„Ø§ÙƒÙŠ</option>
            <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
            <option value="tamanya">ØªÙ…Ù†Ø§ÙŠØ©</option>
            <option value="caboot">Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª</option>
          </select>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="field" style="margin-top:0">
            <label>Ù…ÙˆØ¯ÙŠÙ„/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
            <input id="vehModel" placeholder="Ù…Ø«Ø§Ù„: 2020 / BYD / Ø¥Ù„Ø®" />
          </div>
          <div class="field" style="margin-top:0">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="vehPlate" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¬ 1234" />
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="saveVehBtn" type="button">ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</button>
        </div>
        <div class="hint" id="vehMsg" style="margin-top:10px"></div>
      </div>

      <div id="setupCard" class="card" style="margin-top:12px;display:none">
        <b>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</b>
        <div class="hint" style="margin-top:6px">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ø±ÙƒØ² (Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§) Ø«Ù… Ø­ÙØ¸.</div>

        <div class="field">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSel"></select>
        </div>

        <div class="field">
          <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
          <select id="cenSel" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>
          </select>
        </div>

        <div id="cenOtherWrap" class="field" style="display:none">
          <label>Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ² (Ù„Ùˆ Ø§Ø®ØªØ±Øª Ø£Ø®Ø±Ù‰)</label>
          <input id="cenOtherInput" placeholder="" />
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="saveAreaBtn" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
        </div>

        <div class="hint" id="setupMsg" style="margin-top:10px"></div>
      </div>

      <div class="hint" style="margin-top:10px">
        ÙŠØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ù…Ù†Ø·Ù‚ØªÙƒ ÙÙ‚Ø· (Live). Ø§Ù„Ù‚Ø¨ÙˆÙ„ Transaction Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ âœ…
      </div>
    </div>

    <div class="card" id="currentTripCard" style="margin-top:12px;display:none"></div>
    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc, setActiveRole } from "./app.js";
    import { initMessaging, notify, ensureNotificationPermission } from "./messaging.js";
    import {
      collection, query, where, limit,
      doc, runTransaction, serverTimestamp, setDoc,
      onSnapshot, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=> (s||"").trim().replace(/\s+/g," ");
    const safeNum = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };

    setActiveRole("driver");

    // âœ… Messaging init
    await initMessaging({
      role: "driver",
      appName: "Ù…Ø´ÙˆØ§Ø±Ùƒ",
      icon: "./favicon.png",
      toastId: "toast",
      askPermissionOnLoad: true
    });

    // ========= auth
    const { user } = await requireAuthAndRole("driver");
    $("who").textContent = user.email || "-";
    $("logoutBtn").addEventListener("click", doLogout);

    const listEl = $("list");
    const refreshBtn = $("refreshBtn");
    const myLocBtn = $("myLocBtn");

    const msg = $("msg");
    const onlineBtn = $("onlineBtn");
    const onlinePill = $("onlinePill");
    const gpsPill = $("gpsPill");
    const areaPill = $("areaPill");
    const vehPill = $("vehPill");
    const tripPill = $("tripPill");
    const currentTripCard = $("currentTripCard");

    const setupCard = $("setupCard");
    const setupMsg = $("setupMsg");
    const govSel = $("govSel");
    const cenSel = $("cenSel");
    const cenOtherWrap = $("cenOtherWrap");
    const cenOtherInput = $("cenOtherInput");
    const saveAreaBtn = $("saveAreaBtn");

    const vehicleCard = $("vehicleCard");
    const vehSel = $("vehSel");
    const vehModel = $("vehModel");
    const vehPlate = $("vehPlate");
    const saveVehBtn = $("saveVehBtn");
    const vehMsg = $("vehMsg");

    const statusRef = doc(db, "driver_status", user.uid);
    const userRef = doc(db, "users", user.uid);

    const OTHER = "__other__";
    const LS = { gov:"mw_driver_gov", cen:"mw_driver_cen", cenOther:"mw_driver_cen_other" };

    let isOnline = false;
    let watchId = null;
    let pushTimer = null;
    let lastPos = null;
    let driverProfile = null;
    let unsubStatus = null;
    let unsubTrip = null;
    let currentTripId = null;
    let unsubRides = null;
    let unsubMyOffers = null;

    // =========================================================
    // âœ… LIVE TRIP PUSH (driverLive Ø¯Ø§Ø®Ù„ rides/{tripId})
    // =========================================================
    let liveTripRef = null;
    let lastTripLiveAt = 0;

    function setLiveTripRef(tripId){
      liveTripRef = tripId ? doc(db, "rides", tripId) : null;
      lastTripLiveAt = 0;
    }

    async function pushTripLive(force=false){
      try{
        if(!liveTripRef || !lastPos) return;
        const now = Date.now();
        if(!force && (now - lastTripLiveAt) < 3500) return;
        lastTripLiveAt = now;

        await setDoc(liveTripRef, {
          driverLive: {
            uid: user.uid,
            lat: lastPos.lat,
            lng: lastPos.lng,
            heading: lastPos.heading ?? null,
            speed: lastPos.speed ?? null,
            at: serverTimestamp()
          },
          driverLiveAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch(e){
        console.error(e);
      }
    }

    // =========================================================
    // âœ… MAP INIT (Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Leaflet)
    // =========================================================
    let fixMap = ()=>{};
    let leafletOK = false;
    let dmap = null;
    let divPin = ()=>null;

    function waitLeaflet(){
      return new Promise((resolve)=>{
        const t = setInterval(()=>{
          if(window.L){
            clearInterval(t);
            resolve();
          }
        }, 25);
      });
    }

    await waitLeaflet();

    try{
      dmap = L.map("dmap", { zoomControl:false }).setView([30.0444, 31.2357], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(dmap);

      leafletOK = true;
      $("mapFallback").style.display = "none";

      fixMap = () => {
        try{ dmap.invalidateSize(true); }catch{}
        setTimeout(()=>{ try{ dmap.invalidateSize(true); }catch{} }, 250);
      };

      divPin = (emoji) => L.divIcon({
        className: "pin-emoji",
        html: `<div class="pin-bubble">${emoji}</div>`,
        iconSize: [44,44],
        iconAnchor: [22,44],
        popupAnchor: [0,-36]
      });

      setTimeout(fixMap, 280);
      window.addEventListener("load", ()=> setTimeout(fixMap, 200));
      document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 200); });

    }catch(e){
      console.error(e);
      leafletOK = false;
      $("mapFallback").style.display = "flex";
      $("mapFallback").innerHTML = `âŒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªÙØ­Ù…Ù‘Ù„.<br>Ø¬Ø±Ù‘Ø¨ Ø¨Ø¯ÙˆÙ† VPN / Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.`;
      msg.innerHTML = `<span class="text-bad">âŒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªÙØ­Ù…Ù‘Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</span>`;
    }

    let meMarker = null;
    let passengerMarker = null;
    let toMarker = null;
    let routeToPickup = null;
    let routeToDropoff = null;
    let lastRouteAt = 0;

    function setMeOnMap(lat,lng){
      if(!leafletOK || !dmap) return;
      if(!meMarker){
        meMarker = L.circleMarker([lat,lng],{radius:9, weight:2, fillOpacity:.85})
          .addTo(dmap).bindPopup("ğŸ“ Ø£Ù†Øª");
      }else meMarker.setLatLng([lat,lng]);
    }
    function setPassengerOnMap(lat,lng){
      if(!leafletOK || !dmap) return;
      if(!passengerMarker){
        passengerMarker = L.marker([lat,lng],{icon:divPin("ğŸš©")}).addTo(dmap).bindPopup("ğŸš© Ø§Ù„Ø±Ø§ÙƒØ¨ (Live/Ø§Ù„Ù‚ÙŠØ§Ù…)");
      }else passengerMarker.setLatLng([lat,lng]);
    }
    function setToOnMap(lat,lng){
      if(!leafletOK || !dmap) return;
      if(!toMarker){
        toMarker = L.marker([lat,lng],{icon:divPin("ğŸ")}).addTo(dmap).bindPopup("ğŸ Ø§Ù„ÙˆØµÙˆÙ„");
      }else toMarker.setLatLng([lat,lng]);
    }
    function clearRoutes(){
      if(!leafletOK || !dmap) return;
      if(routeToPickup){ try{ dmap.removeLayer(routeToPickup);}catch{} routeToPickup=null; }
      if(routeToDropoff){ try{ dmap.removeLayer(routeToDropoff);}catch{} routeToDropoff=null; }
    }
    async function fetchRouteOSRM(a,b){
      const url =
        `https://router.project-osrm.org/route/v1/driving/`+
        `${a.lng},${a.lat};${b.lng},${b.lat}`+
        `?overview=full&geometries=geojson`;
      const res = await fetch(url, { headers:{ Accept:"application/json" } });
      if(!res.ok) throw new Error("osrm failed");
      const data = await res.json();
      const coords = data?.routes?.[0]?.geometry?.coordinates;
      if(!coords?.length) return null;
      return coords.map(([lng,lat])=>[lat,lng]);
    }
    async function drawRoutesReal({withDropoff=true}={}){
      if(!leafletOK || !dmap) return;
      if(!meMarker || !passengerMarker) return;

      const now = Date.now();
      if(now - lastRouteAt < 8000) return;
      lastRouteAt = now;

      const a = meMarker.getLatLng();
      const b = passengerMarker.getLatLng();
      const c = toMarker ? toMarker.getLatLng() : null;

      try{
        const pts1 = await fetchRouteOSRM({lat:a.lat,lng:a.lng},{lat:b.lat,lng:b.lng});
        if(!pts1) return;

        if(routeToPickup){ try{ dmap.removeLayer(routeToPickup);}catch{} }
        routeToPickup = L.polyline(pts1,{weight:5, opacity:0.92}).addTo(dmap);

        if(withDropoff && c){
          const pts2 = await fetchRouteOSRM({lat:b.lat,lng:b.lng},{lat:c.lat,lng:c.lng});
          if(pts2){
            if(routeToDropoff){ try{ dmap.removeLayer(routeToDropoff);}catch{} }
            routeToDropoff = L.polyline(pts2,{weight:4, opacity:0.75}).addTo(dmap);
          }
        }
        focusAll();
      }catch(e){ console.error(e); }
    }
    function focusAll(){
      if(!leafletOK || !dmap) return;
      const layers=[];
      if(meMarker) layers.push(meMarker);
      if(passengerMarker) layers.push(passengerMarker);
      if(toMarker) layers.push(toMarker);
      if(routeToPickup) layers.push(routeToPickup);
      if(routeToDropoff) layers.push(routeToDropoff);
      if(!layers.length) return;
      try{
        const group=L.featureGroup(layers);
        dmap.fitBounds(group.getBounds(), { padding:[30,30] });
      }catch{}
      fixMap();
    }

    // ========= GPS
    function setGpsUI(state){
      gpsPill.classList.remove("ok","bad");
      if(state==="ok"){ gpsPill.textContent="GPS: Ø´ØºØ§Ù„ âœ…"; gpsPill.classList.add("ok"); }
      else if(state==="denied"){ gpsPill.textContent="GPS: Ù…Ø±ÙÙˆØ¶ âŒ"; gpsPill.classList.add("bad"); }
      else gpsPill.textContent="GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }
    function autoLocateOnce(){
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent="âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        setGpsUI("ok");
        const lat=pos.coords.latitude;
        const lng=pos.coords.longitude;
        setMeOnMap(lat,lng);
        if(leafletOK && dmap){
          dmap.setView([lat,lng], 16, {animate:false});
          fixMap();
        }
      }, (err)=>{
        console.error(err);
        if(err?.code===1){
          setGpsUI("denied");
          msg.innerHTML="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          setGpsUI("unknown");
          msg.textContent="ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, {enableHighAccuracy:true, timeout:20000, maximumAge:0});
    }
    myLocBtn.addEventListener("click", ()=>{
      msg.textContent="Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";
      autoLocateOnce();
    });

    // ====== Ù…Ù†Ø§Ø·Ù‚
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ù…Ø±Ø¬","Ø¹ÙŠÙ† Ø´Ù…Ø³","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","ÙÙŠØµÙ„","Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±","Ø§Ù„ÙˆØ±Ø§Ù‚","Ø§Ù„Ø¹ÙŠØ§Ø·","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ø³Ù…ÙˆØ­Ø©","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ù…ÙŠØ§Ù…ÙŠ","Ø§Ù„Ø¹ØµØ§ÙØ±Ø©","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¯Ø®ÙŠÙ„Ø©","Ø§Ù„Ø¹Ø¬Ù…ÙŠ"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†","Ø£Ø¬Ø§","Ø§Ù„Ù…Ù†Ø²Ù„Ø©"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±","Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª","Ø²ÙØªÙ‰","Ø§Ù„Ø³Ù†Ø·Ø©"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ù…Ù†ÙˆÙ","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±","Ù‚ÙˆÙŠØ³Ù†Ø§"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§","Ø·Ø§Ù…ÙŠØ©","ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
      "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","Ù†Ø§ØµØ±","Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§","Ø³Ù…Ø³Ø·Ø§","Ø§Ù„ÙØ´Ù†"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·","Ù…Ø·Ø§ÙŠ","Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·","Ø§Ù„Ù‚ÙˆØµÙŠØ©","Ø£Ø¨Ùˆ ØªÙŠØ¬"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø£Ø®Ù…ÙŠÙ…","Ø·Ù‡Ø·Ø§","Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·","Ù‚ÙˆØµ","Ø£Ø¨Ùˆ ØªØ´Øª"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ","Ø¥Ø¯ÙÙˆ"],
      "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±","ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±","Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯","Ø±Ø´ÙŠØ¯","Ø£Ø¨Ùˆ Ø­Ù…Øµ"],
      "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø¯Ø³ÙˆÙ‚","Ø¨Ù„Ø·ÙŠÙ…","Ø§Ù„Ø­Ø§Ù…ÙˆÙ„","ÙÙˆÙ‡"],
      "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·","ÙØ§Ø±Ø³ÙƒÙˆØ±","ÙƒÙØ± Ø³Ø¹Ø¯","Ø§Ù„Ø²Ø±Ù‚Ø§"],
      "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø´Ø±Ù‚","ØºØ±Ø¨","Ø§Ù„Ø²Ù‡ÙˆØ±","Ø§Ù„Ù…Ù†Ø§Ø®"],
      "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","ÙØ§ÙŠØ¯","Ø§Ù„Ù‚Ù†Ø·Ø±Ø©","Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±"],
      "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†","Ø¹ØªØ§Ù‚Ø©"],
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´","Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯","Ø±ÙØ­","Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯"],
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®","Ø¯Ù‡Ø¨","Ù†ÙˆÙŠØ¨Ø¹","Ø·ÙˆØ± Ø³ÙŠÙ†Ø§Ø¡"],
      "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­","Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†","Ø§Ù„Ø­Ù…Ø§Ù…","Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ"],
      "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©","Ø³ÙØ§Ø¬Ø§","Ø§Ù„Ù‚ØµÙŠØ±","Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø§Ù„Ø²ÙŠÙ†ÙŠØ©","Ø£Ø±Ù…Ù†Øª"]
    };

    function fillGov(){
      const keep0=document.createElement("option");
      keep0.value=""; keep0.textContent="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©";
      govSel.innerHTML="";
      govSel.appendChild(keep0);
      Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
        const o=document.createElement("option");
        o.value=g; o.textContent=g;
        govSel.appendChild(o);
      });
    }
    function fillCenter(gov, preselect=null){
      cenSel.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>`;
      (AREAS[gov]||[]).slice().sort((a,b)=>a.localeCompare(b,"ar")).forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        cenSel.appendChild(o);
      });
      const other=document.createElement("option");
      other.value=OTHER;
      other.textContent="Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦";
      cenSel.appendChild(other);

      cenSel.disabled=!gov;
      cenOtherWrap.style.display="none";
      cenOtherInput.value="";

      if(preselect){
        const exists=Array.from(cenSel.options).some(o=>o.value===preselect);
        if(exists) cenSel.value=preselect;
        else{
          cenSel.value=OTHER;
          cenOtherWrap.style.display="block";
          cenOtherInput.value=preselect;
        }
      }
    }
    function getSelectedArea(){
      const g=clean(govSel.value)||null;
      const cVal=cenSel.value;
      if(!g) return {gov:null, cen:null};
      if(!cVal) return {gov:g, cen:null};
      if(cVal===OTHER){
        const manual=clean(cenOtherInput.value);
        return {gov:g, cen:(manual.length>=2?manual:null)};
      }
      return {gov:g, cen:clean(cVal)||null};
    }
    function saveAreaLS(){
      const {gov,cen}=getSelectedArea();
      if(gov) localStorage.setItem(LS.gov, gov);
      if(cenSel.value===OTHER){
        localStorage.setItem(LS.cen, OTHER);
        localStorage.setItem(LS.cenOther, cenOtherInput.value||"");
      }else{
        if(cen) localStorage.setItem(LS.cen, cen);
        localStorage.removeItem(LS.cenOther);
      }
    }
    function restoreAreaLS(){
      const g=localStorage.getItem(LS.gov)||"";
      const c=localStorage.getItem(LS.cen)||"";
      const co=localStorage.getItem(LS.cenOther)||"";
      fillGov();
      if(g){
        govSel.value=g;
        fillCenter(g, (c && c!==OTHER) ? c : (co||null));
        if(c===OTHER){
          cenSel.value=OTHER;
          cenOtherWrap.style.display="block";
          cenOtherInput.value=co;
        }
      }
    }
    govSel.addEventListener("change", ()=>{
      fillCenter(clean(govSel.value));
      setupMsg.textContent="";
      saveAreaLS();
    });
    cenSel.addEventListener("change", ()=>{
      if(cenSel.value===OTHER){
        cenOtherWrap.style.display="block";
        cenOtherInput.focus();
      }else{
        cenOtherWrap.style.display="none";
        cenOtherInput.value="";
      }
      setupMsg.textContent="";
      saveAreaLS();
    });
    cenOtherInput.addEventListener("input", saveAreaLS);

    function vehText(v){
      return (v==="tuktuk")?"ØªÙˆÙƒØªÙˆÙƒ":
        (v==="motor_delivery")?"Ù…ÙˆØªØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ":
        (v==="car")?"Ù…Ù„Ø§ÙƒÙŠ":
        (v==="microbus")?"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ":
        (v==="tamanya")?"ØªÙ…Ù†Ø§ÙŠØ©":
        (v==="caboot")?"Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ø¨ÙˆØª": (v || "-");
    }

    async function loadDriverProfile(){
      driverProfile = await getUserDoc(user.uid).catch(()=>null);
      return driverProfile;
    }

    async function ensureVehicleReady(){
      if(!driverProfile) await loadDriverProfile();

      const veh = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "");
      const model = clean(driverProfile?.model || "");
      const plate = clean(driverProfile?.plate || "");

      if(veh) vehSel.value = veh;
      if(model) vehModel.value = model;
      if(plate) vehPlate.value = plate;

      if(!veh || model.length < 2){
        vehicleCard.style.display = "block";
        vehPill.textContent = "Ù…Ø±ÙƒØ¨Ø©: -";
        return false;
      }

      vehicleCard.style.display = "none";
      vehPill.textContent = `Ù…Ø±ÙƒØ¨Ø©: ${vehText(veh)} â€¢ ${model}`;
      return true;
    }

    saveVehBtn.addEventListener("click", async ()=>{
      vehMsg.textContent = "";
      const v = clean(vehSel.value);
      const m = clean(vehModel.value);
      const p = clean(vehPlate.value);

      if(!v) { vehMsg.textContent = "âŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©."; return; }
      if(m.length < 2) { vehMsg.textContent = "âŒ Ø§ÙƒØªØ¨ Ù…ÙˆØ¯ÙŠÙ„/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)."; return; }

      saveVehBtn.disabled = true;
      vehMsg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦";
      try{
        await setDoc(userRef, { vehicle:v, model:m, plate:(p||null), updatedAt: serverTimestamp() }, { merge:true });
        await loadDriverProfile();
        vehMsg.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.";
        await ensureVehicleReady();
        subscribeRides(true);
      }catch(e){
        console.error(e);
        vehMsg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.";
      }finally{
        saveVehBtn.disabled = false;
      }
    });

    async function ensureAreaSelected(){
      if(!driverProfile) await loadDriverProfile();

      const gov = clean(driverProfile?.governorate || "");
      const cen = clean(driverProfile?.center || "");

      if(!gov || !cen){
        setupCard.style.display="block";
        restoreAreaLS();
        areaPill.textContent="Ù…Ù†Ø·Ù‚Ø©: -";
        return false;
      }

      setupCard.style.display="none";
      areaPill.textContent = `Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
      return true;
    }

    saveAreaBtn.addEventListener("click", async ()=>{
      setupMsg.textContent="";
      const raw = getSelectedArea();
      const gov = clean(raw.gov);
      const cen = clean(raw.cen);

      if(!gov) return setupMsg.textContent="âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©.";
      if(!cen) return setupMsg.textContent="âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ² (Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§).";

      saveAreaBtn.disabled=true;
      setupMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦";

      try{
        await setDoc(userRef, { governorate: gov, center: cen, updatedAt: serverTimestamp() }, { merge:true });
        saveAreaLS();
        await loadDriverProfile();
        setupMsg.textContent="âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.";
        setupCard.style.display="none";
        areaPill.textContent = `Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
        subscribeRides(true);
      }catch(e){
        console.error(e);
        setupMsg.textContent="âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.";
      }finally{
        saveAreaBtn.disabled=false;
      }
    });

    function setOnlineUI(on){
      isOnline = on;
      onlinePill.classList.remove("ok","bad");
      if(on){
        onlinePill.textContent="Online âœ…";
        onlinePill.classList.add("ok");
        onlineBtn.textContent="Go Offline";
        onlineBtn.classList.remove("primary");
        onlineBtn.classList.add("danger");
      }else{
        onlinePill.textContent="Offline";
        onlinePill.classList.add("bad");
        onlineBtn.textContent="Go Online";
        onlineBtn.classList.remove("danger");
        onlineBtn.classList.add("primary");
      }
    }

    function stopWatchTrip(){
      if(unsubTrip){ try{ unsubTrip(); }catch{} unsubTrip=null; }
      setLiveTripRef(null);
      clearRoutes();
      if(!leafletOK || !dmap) return;
      if(passengerMarker){ try{ dmap.removeLayer(passengerMarker);}catch{} passengerMarker=null; }
      if(toMarker){ try{ dmap.removeLayer(toMarker);}catch{} toMarker=null; }
    }

    function openGoogleMapsNav(lat, lng){
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
      window.open(url, "_blank");
    }

    // âœ… Trip notifications
    let lastTripStatus = null;
    async function tripNotify(st){
      if(st === lastTripStatus) return;
      lastTripStatus = st;

      if(st === "accepted"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©", tone:"accepted", tag:"d_trip_accepted", toastHtml:"âœ… <b>ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</b>", toastMs:2600 });
      }
      if(st === "arrived"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„", tone:"arrived", tag:"d_trip_arrived", toastHtml:"ğŸ“ <b>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„</b>", toastMs:2600 });
      }
      if(st === "started"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©", tone:"started", tag:"d_trip_started", toastHtml:"ğŸš– <b>ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</b>", toastMs:2600 });
      }
      if(st === "completed"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©", tone:"ended", tag:"d_trip_done", toastHtml:"ğŸ <b>ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</b>", toastMs:2800 });
      }
      if(st === "canceled"){
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨", tone:"ended", tag:"d_trip_cancel", toastHtml:"âŒ <b>ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</b>", toastMs:2800 });
      }
    }

    function watchTrip(tripId){
      if(!tripId) return;
      if(unsubTrip) unsubTrip();

      setLiveTripRef(tripId);

      const rideRef = doc(db, "rides", tripId);
      unsubTrip = onSnapshot(rideRef, async (snap)=>{
        if(!snap.exists()){
          currentTripCard.style.display="block";
          currentTripCard.innerHTML=`<div class="hint">âš ï¸ Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>`;
          return;
        }

        const r = snap.data();
        const status = r.status || "-";

        await tripNotify(status);

        // âœ… pickup/dropoff (fallback)
        const fromLat = safeNum(r.from?.lat);
        const fromLng = safeNum(r.from?.lng);
        const toLat = safeNum(r.to?.lat);
        const toLng = safeNum(r.to?.lng);

        if(toLat!=null && toLng!=null) setToOnMap(toLat,toLng);

        // âœ… passengerLive (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)
        const plLat = safeNum(r.passengerLive?.lat);
        const plLng = safeNum(r.passengerLive?.lng);
        const pickupLat = (plLat!=null ? plLat : fromLat);
        const pickupLng = (plLng!=null ? plLng : fromLng);

        if(pickupLat!=null && pickupLng!=null) setPassengerOnMap(pickupLat, pickupLng);

        await drawRoutesReal({withDropoff:true});
        await pushTripLive(false);

        if(["completed","canceled","done"].includes(status)){
          currentTripCard.style.display="block";
          currentTripCard.innerHTML=`<div class="hint">âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù†ØªÙ‡Øª (${status}).</div>`;
          setDoc(statusRef, { available: !!isOnline, currentTripId: null, lastSeenAt: serverTimestamp() }, { merge:true }).catch(()=>{});
          setLiveTripRef(null);
          return;
        }

        // âœ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ (ÙˆÙ…Ù†Ù‡Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
        const pName = r.passengerName || "Ø±Ø§ÙƒØ¨";
        const pEmail = r.passengerEmail || "-";
        const pPhone = r.passengerPhone || "";
        const pAddr  = r.passengerAddress || "";
        const price = (r.priceEGP ?? r.offerPriceEGP ?? "-");

        const canArrive = (status === "accepted");
        const canStart  = (status === "arrived");
        const canEnd    = (status === "started");

        currentTripCard.style.display="block";
        currentTripCard.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div><b>ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</b></div>
            <span class="pill ok">${status}</span>
          </div>

          <div class="hint" style="margin-top:10px">
            <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${pName} (${pEmail})
            <br><b>Ù‡Ø§ØªÙ:</b> ${pPhone || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
            <br><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${pAddr || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
            <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
            <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
            <br><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${price} EG
          </div>

          <div class="actions" style="margin-top:12px">
            ${pPhone ? `<a class="btn success" href="tel:${pPhone}">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>` : `<button class="btn" disabled>ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…</button>`}
            ${(pickupLat!=null && pickupLng!=null) ? `<button class="btn" id="navPickupBtn" type="button">ğŸ§­ Ù…Ù„Ø§Ø­Ø© Ù„Ù„Ø±Ø§ÙƒØ¨</button>` : ``}
            ${(toLat!=null && toLng!=null) ? `<button class="btn" id="navToBtn" type="button">ğŸ§­ Ù…Ù„Ø§Ø­Ø© Ù„Ù„ÙˆØµÙˆÙ„</button>` : ``}
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn ${canArrive ? "primary" : ""}" id="arrivedBtn" ${canArrive ? "" : "disabled"} type="button">ğŸ“ ÙˆØµÙ„Øª</button>
            <button class="btn ${canStart ? "primary" : ""}" id="startBtn" ${canStart ? "" : "disabled"} type="button">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
            <button class="btn danger" id="endBtn" ${canEnd ? "" : "disabled"} type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
          </div>

          <div class="hint" id="tripMsg" style="margin-top:10px"></div>
        `;

        const tripMsg = currentTripCard.querySelector("#tripMsg");
        currentTripCard.querySelector("#navPickupBtn")?.addEventListener("click", ()=> openGoogleMapsNav(pickupLat, pickupLng));
        currentTripCard.querySelector("#navToBtn")?.addEventListener("click", ()=> openGoogleMapsNav(toLat, toLng));

        currentTripCard.querySelector("#arrivedBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦";
            await ensureNotificationPermission();
            await updateDoc(rideRef, { status:"arrived", arrivedAt: serverTimestamp(), updatedAt: serverTimestamp() });
            tripMsg.textContent="âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„.";
          }catch(e){
            console.error(e);
            tripMsg.textContent="âŒ ÙØ´Ù„.";
          }
        });

        currentTripCard.querySelector("#startBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©â€¦";
            await ensureNotificationPermission();
            await updateDoc(rideRef, { status:"started", startedAt: serverTimestamp(), updatedAt: serverTimestamp() });
            tripMsg.textContent="âœ… Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©.";
          }catch(e){
            console.error(e);
            tripMsg.textContent="âŒ ÙØ´Ù„.";
          }
        });

        currentTripCard.querySelector("#endBtn")?.addEventListener("click", async ()=>{
          try{
            tripMsg.textContent="Ø¬Ø§Ø±Ù Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©â€¦";
            await ensureNotificationPermission();
            await updateDoc(rideRef, { status:"completed", completedAt: serverTimestamp(), updatedAt: serverTimestamp() });
            tripMsg.textContent="âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
            await setDoc(statusRef, { currentTripId:null, available:!!isOnline, lastSeenAt:serverTimestamp() }, {merge:true}).catch(()=>{});
            setLiveTripRef(null);
          }catch(e){
            console.error(e);
            tripMsg.textContent="âŒ ÙØ´Ù„.";
          }
        });
      });
    }

    function watchDriverStatus(){
      if(unsubStatus) unsubStatus();
      unsubStatus = onSnapshot(statusRef, (snap)=>{
        const st = snap.exists() ? snap.data() : null;
        const online = !!st?.online;
        const tripId = st?.currentTripId || null;

        setOnlineUI(online);

        if(tripId){
          tripPill.textContent = `ğŸš– Ø±Ø­Ù„Ø©: ${tripId}`;
          currentTripId = tripId;
          watchTrip(tripId);
          try{ currentTripCard.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}
        }else{
          tripPill.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©";
          currentTripId = null;
          stopWatchTrip();
          currentTripCard.style.display = "none";
          currentTripCard.innerHTML = "";
        }
      }, ()=>{});
    }

    // âœ… Ù„Ùˆ Ø£Ù†Øª Ø£Ø±Ø³Ù„Øª Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø±Ø§ÙƒØ¨ ÙˆØ§ÙÙ‚ => Ø§ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    function watchMyOfferedAndAccepted(){
      if(unsubMyOffers) { try{unsubMyOffers()}catch{} unsubMyOffers=null; }

      const qy = query(
        collection(db,"rides"),
        where("driverUid","==", user.uid),
        where("status","in", ["offered","accepted","arrived","started"])
      );

      let lastSeenAccepted = new Set();

      unsubMyOffers = onSnapshot(qy, async (snap)=>{
        if(snap.empty) return;

        for(const d of snap.docs){
          const r = d.data();
          const id = d.id;
          const st = r.status || "-";

          if(st === "accepted" && !currentTripId){
            await setDoc(statusRef, {
              online: true,
              available: false,
              currentTripId: id,
              lastSeenAt: serverTimestamp()
            }, { merge:true });

            if(!lastSeenAccepted.has(id)){
              lastSeenAccepted.add(id);
              await notify({
                title:"Ù…Ø´ÙˆØ§Ø±Ùƒ",
                body:"Ø§Ù„Ø±Ø§ÙƒØ¨ ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± â€” ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø©",
                tone:"accepted",
                tag:"offer_accepted_by_passenger",
                toastHtml:"âœ… <b>Ø§Ù„Ø±Ø§ÙƒØ¨ ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</b> â€” ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø©",
                toastMs:3200
              });
            }
          }
        }
      });
    }

    async function pushStatus(extra = {}){
      const gov = clean(driverProfile?.governorate || "") || null;
      const cen = clean(driverProfile?.center || "") || null;

      const payload = {
        online: isOnline,
        available: isOnline && !currentTripId,
        governorate: gov,
        center: cen,
        lastSeenAt: serverTimestamp(),
        ...extra
      };

      if(lastPos){
        payload.lat = lastPos.lat;
        payload.lng = lastPos.lng;
        payload.heading = lastPos.heading ?? null;
        payload.speed = lastPos.speed ?? null;
      }
      await setDoc(statusRef, payload, { merge:true });
    }

    function startGPS(){
      msg.textContent = "";
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return false;
      }

      watchId = navigator.geolocation.watchPosition(async (pos)=>{
        setGpsUI("ok");
        lastPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: (pos.coords.heading ?? null),
          speed: (pos.coords.speed ?? null),
        };

        setMeOnMap(lastPos.lat, lastPos.lng);
        await pushTripLive(false);

        if(passengerMarker){
          await drawRoutesReal({withDropoff:true});
        }
      }, (err)=>{
        console.error(err);
        if(err?.code === 1){
          setGpsUI("denied");
          msg.innerHTML = "âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          setGpsUI("unknown");
          msg.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });

      pushTimer = setInterval(async ()=>{
        try{
          if(!isOnline) return;
          await pushStatus();
          await pushTripLive(false);
        }catch(e){ console.error(e); }
      }, 4500);

      return true;
    }

    function stopGPS(){
      if(watchId !== null){ try{ navigator.geolocation.clearWatch(watchId); }catch{} watchId = null; }
      if(pushTimer){ clearInterval(pushTimer); pushTimer = null; }
      lastPos = null;
      setGpsUI("unknown");
    }

    async function goOnline(){
      onlineBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Onlineâ€¦";

      await loadDriverProfile();

      const vehOk = await ensureVehicleReady();
      const areaOk = await ensureAreaSelected();

      if(!vehOk){
        msg.textContent = "âŒ Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹.";
        onlineBtn.disabled = false;
        return;
      }
      if(!areaOk){
        msg.textContent = "âŒ Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸ØªÙƒ ÙˆÙ…Ø±ÙƒØ²Ùƒ Ø£ÙˆÙ„Ø§Ù‹.";
        onlineBtn.disabled = false;
        return;
      }

      setOnlineUI(true);

      const okGps = startGPS();
      if(okGps){
        try{
          await pushStatus({ online:true, available: !currentTripId, currentTripId: currentTripId || null });
          msg.textContent = "âœ… Online Ø´ØºØ§Ù„.. Ø¨ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.";
          await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"Ø£Ù†Øª Online â€” Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨ÙŠØªØ¨Ø¹Øª", tone:"notify", tag:"driver_online", toastHtml:"âœ… <b>Ø£Ù†Øª Online</b> â€” Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨ÙŠØªØ¨Ø¹Øª", toastMs:2500 });
        }catch(e){
          console.error(e);
          msg.textContent = "âš ï¸ Online Ø§Ø´ØªØºÙ„ Ù„ÙƒÙ† ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­ÙØ¸.";
        }
      }

      onlineBtn.disabled = false;
    }

    async function goOffline(){
      onlineBtn.disabled = true;
      msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offlineâ€¦";

      setOnlineUI(false);
      stopGPS();

      try{
        await setDoc(statusRef, {
          online: false,
          available: false,
          lastSeenAt: serverTimestamp()
        }, { merge:true });

        msg.textContent = "âœ… ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offline.";
        await notify({ title:"Ù…Ø´ÙˆØ§Ø±Ùƒ", body:"Ø£Ù†Øª Offline", tone:"ended", tag:"driver_offline", toastHtml:"âšª <b>Ø£Ù†Øª Offline</b>", toastMs:2200 });
      }catch(e){
        console.error(e);
        msg.textContent = "âš ï¸ Offline Ø§ØªØ¹Ù…Ù„ Ù„ÙƒÙ† Ø­ØµÙ„ Ø®Ø·Ø£.";
      }

      onlineBtn.disabled = false;
    }

    onlineBtn.addEventListener("click", async ()=>{
      await ensureNotificationPermission();
      if(isOnline) await goOffline();
      else await goOnline();
    });

    // ========= rides list
    function rideCard(r, gov, cen){
      const fromLat = safeNum(r.from?.lat);
      const fromLng = safeNum(r.from?.lng);

      const el = document.createElement("div");
      el.className = "card";

      const price = (r.offerPriceEGP ?? r.priceEGP ?? "-");

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>Ø·Ù„Ø¨:</b> <span class="mono">${r.id}</span></div>
          <div class="pill">${r.status || "-"}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>Ù‡Ø§ØªÙ:</b> ${r.passengerPhone ?? "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
          <br><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${r.passengerAddress ?? "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
          <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
          <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
          <br><b>Ø§Ù„Ø³Ø¹Ø±:</b> <b>${price}</b> EG
          <br><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${r.governorate ?? "-"} / ${r.center ?? "-"}
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn primary" data-accept="${r.id}" type="button">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn" data-offer="${r.id}" type="button">ğŸ’° Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±</button>
          <button class="btn danger" data-reject="${r.id}" type="button">Ø±ÙØ¶</button>
          ${fromLat!=null && fromLng!=null ? `<button class="btn" data-focus="${r.id}" type="button">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>` : ``}
        </div>

        <div id="offerWrap_${r.id}" style="display:none;margin-top:10px">
          <div class="field" style="margin-top:0">
            <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (15 â†’ 300)</label>
            <input id="offerInput_${r.id}" inputmode="numeric" placeholder="" />
          </div>
          <button class="btn primary" data-send-offer="${r.id}" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>

        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      const focusBtn = el.querySelector(`[data-focus="${r.id}"]`);
      if(focusBtn){
        focusBtn.addEventListener("click", async ()=>{
          if(!leafletOK || !dmap) return;
          if(fromLat!=null && fromLng!=null){
            setPassengerOnMap(fromLat, fromLng);
            dmap.setView([fromLat, fromLng], 16, { animate:false });
            fixMap();
            await drawRoutesReal({withDropoff:false});
          }
        });
      }

      el.querySelector(`[data-offer="${r.id}"]`)?.addEventListener("click", ()=>{
        const w = el.querySelector(`#offerWrap_${r.id}`);
        w.style.display = (w.style.display==="none") ? "block" : "none";
      });

      el.querySelector(`[data-send-offer="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          if(currentTripId){
            m.textContent = "âŒ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ©. Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.";
            return;
          }

          const v = Number((el.querySelector(`#offerInput_${r.id}`)?.value||"").trim());
          if(!Number.isFinite(v) || v<15 || v>300){
            m.textContent = "âŒ Ø§ÙƒØªØ¨ Ø³Ø¹Ø± Ù…Ù† 15 Ø¥Ù„Ù‰ 300.";
            return;
          }

          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "Ø³Ø§Ø¦Ù‚";
          const driverPhone = d?.phone || null;
          const driverVehicle = d?.vehicle || null;
          const driverModel = d?.model || null;

          m.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶â€¦";
          await ensureNotificationPermission();

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§Ø®ØªÙÙ‰." };
            const cur = snap.data();

            if(cur.status !== "open") return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙØªÙˆØ­." };
            if(cur.driverUid) return { ok:false, msg:"ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„." };

            if(clean(cur.governorate) !== gov || clean(cur.center) !== cen){
              return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ Ù…Ù†Ø·Ù‚ØªÙƒ." };
            }

            tx.update(rideRef, {
              status: "offered",
              offerPriceEGP: v,
              offerBy: "driver",
              offerAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone,
              driverVehicle: driverVehicle || null,
              driverModel: driverModel || null,
              updatedAt: serverTimestamp()
            });

            return { ok:true, msg:`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶: ${v} EG` };
          });

          m.textContent = res.msg;
          if(res.ok){
            await notify({
              title:"Ù…Ø´ÙˆØ§Ø±Ùƒ",
              body:"ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø± â€” ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø±Ø§ÙƒØ¨",
              tone:"offer",
              tag:"driver_offer_sent",
              toastHtml:"ğŸ’° <b>ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±</b> â€” ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø±Ø§ÙƒØ¨",
              toastMs:2800
            });
          }
        }catch(e){
          console.error(e);
          m.textContent = "âŒ ÙØ´Ù„.";
        }
      });

      el.querySelector(`[data-accept="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        const rideRef = doc(db, "rides", r.id);

        try{
          m.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";

          if(currentTripId){
            m.textContent = "âŒ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ©. Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.";
            return;
          }

          const d = driverProfile || await getUserDoc(user.uid);
          const driverName  = d?.name || "Ø³Ø§Ø¦Ù‚";
          const driverPhone = d?.phone || null;
          const driverVehicle = d?.vehicle || null;
          const driverModel = d?.model || null;

          await ensureNotificationPermission();

          const res = await runTransaction(db, async (tx)=>{
            const snap = await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§Ø®ØªÙÙ‰." };

            const cur = snap.data();

            if(cur.status === "offered" && cur.driverUid !== user.uid){
              return { ok:false, msg:"Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ø¬ÙˆØ² Ù„Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±." };
            }

            if(cur.status !== "open" && cur.status !== "offered"){
              return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø¨ÙˆÙ„." };
            }

            // ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            if(clean(cur.governorate) !== gov || clean(cur.center) !== cen){
              return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ Ù…Ù†Ø·Ù‚ØªÙƒ." };
            }

            // âœ… ØªØ­Ù‚Ù‚ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯Ù‡
            const myVeh = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "");
            const reqVeh = clean(cur.requestedVehicle || "");
            if(reqVeh && myVeh && myVeh !== reqVeh){
              return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†ÙˆØ¹ Ù…Ø±ÙƒØ¨Ø© Ù…Ø®ØªÙ„Ù." };
            }

            const finalPrice = (cur.offerPriceEGP ?? cur.priceEGP ?? null);

            tx.update(rideRef, {
              status: "accepted",
              acceptedAt: serverTimestamp(),
              driverUid: user.uid,
              driverEmail: user.email,
              driverName,
              driverPhone,
              driverVehicle: driverVehicle || null,
              driverModel: driverModel || null,
              priceEGP: finalPrice,
              updatedAt: serverTimestamp()
            });

            tx.set(statusRef, {
              online: true,
              available: false,
              currentTripId: r.id,
              lastSeenAt: serverTimestamp()
            }, { merge:true });

            return { ok:true, msg:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨." };
          });

          m.textContent = res.msg;
          if(res.ok){
            await notify({
              title:"Ù…Ø´ÙˆØ§Ø±Ùƒ",
              body:"ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ â€” ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
              tone:"accepted",
              tag:"driver_accept",
              toastHtml:"âœ… <b>ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</b> â€” ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
              toastMs:2800
            });
          }
        }catch(e){
          console.error(e);
          m.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„.";
        }
      });

      el.querySelector(`[data-reject="${r.id}"]`)?.addEventListener("click", async ()=>{
        const m = el.querySelector(`#m_${r.id}`);
        m.textContent = "ØªÙ… Ø§Ù„Ø±ÙØ¶. Ù„Ù† ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†.";
        el.style.display = "none";
      });

      return el;
    }

    function showSoftLoadError(){
      listEl.innerHTML = `<div class="card"><div class="hint">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†.</div></div>`;
    }

    // âœ… ØªØ­Ø³ÙŠÙ†: Ù„Ùˆ myVeh Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ø³Ø¨Ø¨ Ù…Ø§) Ù…Ø§ Ù†Ù‚ÙÙ„Ø´ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù‡Ø§
    async function subscribeRides(reset=false){
      if(unsubRides){ try{unsubRides()}catch{} unsubRides=null; }

      await loadDriverProfile();

      const vehOk = await ensureVehicleReady();
      const areaOk = await ensureAreaSelected();

      if(!vehOk){
        listEl.innerHTML = `<div class="card">Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹.</div>`;
        return;
      }
      if(!areaOk){
        listEl.innerHTML = `<div class="card">Ø­Ø¯Ø¯ Ù…Ù†Ø·Ù‚ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.</div>`;
        return;
      }

      const gov = clean(driverProfile.governorate);
      const cen = clean(driverProfile.center);

      listEl.innerHTML = `<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      const myVeh = clean(driverProfile?.vehicle || driverProfile?.vehicleType || "");

      let qy = null;
      if(myVeh){
        qy = query(
          collection(db, "rides"),
          where("status", "==", "open"),
          where("governorate", "==", gov),
          where("center", "==", cen),
          where("requestedVehicle", "==", myVeh),
          limit(25)
        );
      }else{
        // fallback (Ù†Ø§Ø¯Ø±): Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø© Ù…Ø±ÙƒØ¨Ø©
        qy = query(
          collection(db, "rides"),
          where("status", "==", "open"),
          where("governorate", "==", gov),
          where("center", "==", cen),
          limit(25)
        );
      }

      unsubRides = onSnapshot(qy, async (snap)=>{
        listEl.innerHTML = "";

        if(snap.empty){
          listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
          return;
        }

        const docs = snap.docs.filter(d=>{
          const r=d.data();
          return !r.driverUid;
        });

        if(!docs.length){
          listEl.innerHTML = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
          return;
        }

        docs.forEach(d=>{
          listEl.appendChild(rideCard({ id:d.id, ...d.data() }, gov, cen));
        });
      }, ()=>{
        showSoftLoadError();
      });
    }

    refreshBtn.addEventListener("click", ()=> subscribeRides(true));

    // ========= init
    setOnlineUI(false);
    setGpsUI("unknown");

    await loadDriverProfile();
    await ensureVehicleReady();
    await ensureAreaSelected();

    // init selects
    fillGov();
    restoreAreaLS();

    function watchDriverStatus(){
      if(unsubStatus) unsubStatus();
      unsubStatus = onSnapshot(statusRef, (snap)=>{
        const st = snap.exists() ? snap.data() : null;
        const online = !!st?.online;
        const tripId = st?.currentTripId || null;

        setOnlineUI(online);

        if(tripId){
          tripPill.textContent = `ğŸš– Ø±Ø­Ù„Ø©: ${tripId}`;
          currentTripId = tripId;
          watchTrip(tripId);
        }else{
          tripPill.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©";
          currentTripId = null;
          stopWatchTrip();
          currentTripCard.style.display = "none";
          currentTripCard.innerHTML = "";
        }
      }, ()=>{});
    }

    watchDriverStatus();
    watchMyOfferedAndAccepted();
    subscribeRides(true);
    autoLocateOnce();
    setTimeout(()=>{ try{ fixMap(); }catch{} }, 320);

    window.addEventListener("beforeunload", ()=>{ try{ stopGPS(); }catch{} });
    window.addEventListener("error", ()=>{ msg.textContent = "âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©."; });
  </script>
</body>
</html>
