<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø³Ø§Ø¦Ù‚</title>

  <style>
    :root{
      --bg:#0b0f14; --card:#101825; --stroke:#1f2a3a; --stroke2:#273449;
      --text:#e8eef7; --muted:rgba(232,238,247,.78);
      --brand:#7c3aed; --brand2:#2b6cff; --ok:#22c55e; --bad:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    .top{
      position:sticky; top:0; z-index:10;
      background:rgba(16,24,37,.92);
      border-bottom:1px solid rgba(31,42,58,.95);
      backdrop-filter: blur(10px);
      padding:12px 12px calc(12px + env(safe-area-inset-top));
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2))}
    .title{font-weight:1000}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .btn{
      border:0; cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      color:white;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
    }
    .btn.secondary{
      background:rgba(36,52,74,.95);
      border:1px solid rgba(39,52,73,.95);
      color:var(--text);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .wrap{max-width:720px; margin:0 auto; padding:12px 12px calc(18px + env(safe-area-inset-bottom))}
    .card{
      background:rgba(16,24,37,.92);
      border:1px solid rgba(31,42,58,.95);
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:12px;
      margin-top:10px;
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(39,52,73,.9);
      font-size:12px;
      color:var(--muted);
    }
    .row{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; align-items:center}
    .kvs{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px}
    .kv{background:rgba(11,15,20,.65); border:1px solid rgba(39,52,73,.9); border-radius:16px; padding:10px}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{margin-top:4px;font-weight:900}

    a{color:#9ec1ff; text-decoration:none; font-weight:800}
    .sep{height:1px;background:rgba(39,52,73,.7);margin:10px 0}
    .empty{padding:14px;text-align:center;color:var(--muted)}
  </style>
</head>

<body>
  <div class="top">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div class="title">Ù…Ø´ÙˆØ§Ø±Ùƒ â€” Ø³Ø§Ø¦Ù‚</div>
        <div class="sub" id="liveText">Live: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>
      </div>
    </div>
    <div class="row" style="margin:0">
      <button class="btn secondary" id="logoutBtn">â‹ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="muted">
        Ø¯ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ (Live).<br>
        Ø§Ø¶ØºØ· â€œÙ‚Ø¨ÙˆÙ„â€ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ accepted.
      </div>
    </div>

    <div id="list"></div>
  </div>

  <script type="module">
    // âœ… Ø­Ø§Ø±Ø³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ "Ø³Ø§Ø¦Ù‚"
    import { requireAuthAndRole, doLogout } from "./app.js";
    const { user } = await requireAuthAndRole("driver");
    document.getElementById('logoutBtn').addEventListener('click', doLogout);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, where, orderBy, limit,
      onSnapshot, doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA9pP-Y3PEvl6675f4pHDyXzayzzmihhI",
      authDomain: "meshwark-8adf8.firebaseapp.com",
      projectId: "meshwark-8adf8",
      storageBucket: "meshwark-8adf8.firebasestorage.app",
      messagingSenderId: "450060838946",
      appId: "1:450060838946:web:963cacdd125b253fa1827b",
      measurementId: "G-GP0JGBZTGG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listEl = document.getElementById('list');
    const liveText = document.getElementById('liveText');

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function vehicleLabel(v){
      if(v === "tuktuk") return "ğŸ›º ØªÙˆÙƒØªÙˆÙƒ";
      if(v === "microbus") return "ğŸš Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ";
      return "ğŸš— Ù…Ù„Ø§ÙƒÙŠ";
    }

    function googleMapsDirLink(from, to){
      if(!from?.lat || !from?.lng || !to?.lat || !to?.lng) return null;
      const o = `${from.lat},${from.lng}`;
      const d = `${to.lat},${to.lng}`;
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}`;
    }

    function rideCard(r){
      const fromLat = safeNum(r.from?.lat), fromLng = safeNum(r.from?.lng);
      const toLat = safeNum(r.to?.lat), toLng = safeNum(r.to?.lng);

      const fromText = r.fromText || (fromLat!==null && fromLng!==null ? `${fromLat.toFixed(5)}, ${fromLng.toFixed(5)}` : "-");
      const toText = r.toText || (toLat!==null && toLng!==null ? `${toLat.toFixed(5)}, ${toLng.toFixed(5)}` : "-");

      const dir = googleMapsDirLink(r.from, r.to);

      const el = document.createElement('div');
      el.className = 'card';

      const offer = (r.offerPrice != null) ? `${r.offerPrice} Ø¬Ù†ÙŠÙ‡` : "-";
      const km = (r.distanceKm != null) ? `${Number(r.distanceKm).toFixed(1)} ÙƒÙ…` : "-";
      const veh = vehicleLabel(r.vehicle);

      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="font-weight:1000">Ø·Ù„Ø¨: ${r.id}</div>
          <span class="badge">Live</span>
        </div>

        <div class="kvs">
          <div class="kv">
            <div class="k">Ù…Ù†</div>
            <div class="v">${fromText}</div>
          </div>
          <div class="kv">
            <div class="k">Ø¥Ù„Ù‰</div>
            <div class="v">${toText}</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <span class="badge">${veh}</span>
          <span class="badge">ğŸ“ ${km}</span>
          <span class="badge">ğŸ’° ${offer}</span>
          <span class="badge">ğŸ‘¥ ${r.passengers ?? "-"}</span>
          <span class="badge">ğŸ“ ${r.phone ?? "-"}</span>
        </div>

        <div class="muted" style="margin-top:10px">
          Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note ?? "-"}
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" data-id="${r.id}">Ù‚Ø¨ÙˆÙ„</button>
          ${dir ? `<a target="_blank" href="${dir}">ğŸ§­ ÙØªØ­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</a>` : ``}
          ${(fromLat!==null && fromLng!==null) ? `<a target="_blank" href="https://www.openstreetmap.org/?mlat=${fromLat}&mlon=${fromLng}#map=16/${fromLat}/${fromLng}">ğŸ“ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</a>` : ``}
        </div>
      `;

      el.querySelector('button').addEventListener('click', async () => {
        const btn = el.querySelector('button');
        btn.disabled = true;
        btn.textContent = "Ø¬Ø§Ø±Ùâ€¦";
        try{
          await updateDoc(doc(db, "rides", r.id), {
            status: "accepted",
            driverUid: user.uid,
            acceptedAt: serverTimestamp()
          });
        }catch(e){
          console.error(e);
          alert("ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† Firestore Rules.");
        }finally{
          btn.disabled = false;
          btn.textContent = "Ù‚Ø¨ÙˆÙ„";
        }
      });

      return el;
    }

    // âœ… Live listener
    const q = query(
      collection(db, "rides"),
      where("status", "==", "open"),
      orderBy("createdAt", "desc"),
      limit(50)
    );

    listEl.innerHTML = `<div class="card"><div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>`;

    onSnapshot(q, (snap) => {
      listEl.innerHTML = "";
      liveText.textContent = `Live: ${snap.size} Ø·Ù„Ø¨ Ù…ÙØªÙˆØ­`;

      if(snap.empty){
        listEl.innerHTML = `<div class="card"><div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div></div>`;
        return;
      }

      snap.forEach(d => {
        listEl.appendChild(rideCard({ id: d.id, ...d.data() }));
      });
    }, (err) => {
      console.error(err);
      listEl.innerHTML = `<div class="card"><div class="muted" style="color:#ffb4b4">Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø±Ø§Ø¬Ø¹ Firestore Rules.</div></div>`;
      liveText.textContent = "Live: Ø®Ø·Ø£";
    });
  </script>
</body>
</html>
