<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

  <link rel="stylesheet" href="./styles.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Eruda (Console Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <style>
    body.page{ min-height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    .topbar{ position:sticky; top:0; z-index:60; background:rgba(5,11,22,.72); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,.06); }
    .topbar-inner{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand h1{ margin:0; font-size:16px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brand p{ margin:0; font-size:12px; color:rgba(255,255,255,.7); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw; }
    .top-actions{ display:flex; gap:8px; align-items:center; }
    #mapWrap{ position:relative; flex:1; min-height:calc(100vh - 70px); overflow:hidden; background:#0b1222; }
    #map{ position:absolute; inset:0; z-index:1; }
    .sheet{ position:fixed; left:12px; right:12px; bottom:12px; z-index:2000; background:var(--card); border:1px solid var(--stroke); border-radius:26px; box-shadow:0 26px 70px rgba(0,0,0,.5); backdrop-filter:blur(10px); overflow:hidden; height:62vh; transition:height .18s ease; will-change:height; }
    .sheet.dragging{ transition:none; }
    .sheetHeader{ padding:10px 14px 12px; display:flex; justify-content:center; align-items:center; user-select:none; -webkit-tap-highlight-color:transparent; touch-action:pan-y; }
    .sheetHandle{ width:56px; height:6px; border-radius:999px; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.10); }
    .sheetBody{ padding:14px; overflow-y:auto; height:calc(100% - 44px); -webkit-overflow-scrolling:touch; touch-action:pan-y; }

    .miniRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0 12px; }
    .miniChip{ padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); font-size:12px; }
    .miniChip.ok{ border-color:rgba(25,190,107,.35); background:rgba(25,190,107,.10); }
    .miniChip.bad{ border-color:rgba(255,80,80,.35); background:rgba(255,80,80,.10); }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .actions .btn{ width:100%; }
    .sep{ height:1px; background:rgba(255,255,255,.08); margin:14px 0; }

    .sectionTitle{ margin:6px 0 10px; font-weight:900; font-size:14px; color:rgba(255,255,255,.90); }
    .list{ display:grid; gap:10px; }
    .card{ border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); border-radius:16px; padding:12px; }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .muted{ color:rgba(255,255,255,.7); font-size:12px; }
    .hint{ margin-top:10px; color:rgba(255,255,255,.75); font-size:13px; min-height:18px; }
    .footerActions{ margin-top:14px; }
    .footerActions .btn{ width:100%; }

    .inlineActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .inlineActions .btn{ flex:1; min-width:120px; }
    input.small{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.20); color:#fff; outline:none; }
    select.small{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.20); color:#fff; outline:none; }
  </style>
</head>

<body class="page">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">ğŸš–</div>
        <div style="min-width:0">
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">â€”</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn danger" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    </div>
  </div>

  <div id="mapWrap">
    <div id="map"></div>
  </div>

  <div class="sheet" id="sheet">
    <div class="sheetHeader" id="sheetHeader"><div class="sheetHandle"></div></div>
    <div class="sheetBody">

      <div class="miniRow">
        <span class="miniChip" id="gpsChip">GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
        <span class="miniChip" id="statusChip">Offline</span>
        <span class="miniChip" id="locChip">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -</span>
        <span class="miniChip" id="vehChip">Ù…Ø±ÙƒØ¨Ø©: -</span>
      </div>

      <div class="actions">
        <button class="btn primary" id="goOnlineBtn" type="button">Go Online</button>
        <button class="btn" id="myLocBtn" type="button">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="btn danger" id="stopOnlineBtn" type="button">Go Offline</button>
        <button class="btn" id="refreshBtn" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ù…Ù†Ø·Ù‚ØªÙƒ (Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)</div>
      <div class="card" id="setupCard">
        <div class="row">
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</div>
            <select class="small" id="govSel">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©...</option>
              <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
              <option>Ø§Ù„Ø¬ÙŠØ²Ø©</option>
              <option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
              <option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
              <option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
              <option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
              <option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
              <option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
              <option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
              <option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
              <option>Ø¯Ù…ÙŠØ§Ø·</option>
              <option>Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
              <option>Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
              <option>Ø§Ù„Ø³ÙˆÙŠØ³</option>
              <option>Ø§Ù„ÙÙŠÙˆÙ…</option>
              <option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
              <option>Ø§Ù„Ù…Ù†ÙŠØ§</option>
              <option>Ø£Ø³ÙŠÙˆØ·</option>
              <option>Ø³ÙˆÙ‡Ø§Ø¬</option>
              <option>Ù‚Ù†Ø§</option>
              <option>Ø§Ù„Ø£Ù‚ØµØ±</option>
              <option>Ø£Ø³ÙˆØ§Ù†</option>
              <option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
              <option>Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
              <option>Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
              <option>Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
              <option>Ù…Ø·Ø±ÙˆØ­</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Ø§Ù„Ù…Ø±ÙƒØ²</div>
            <input class="small" id="cenInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
            <select class="small" id="vehSel">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option value="tuktuk">ØªÙˆÙƒ ØªÙˆÙƒ</option>
              <option value="motor_delivery">Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ</option>
              <option value="car">Ø³ÙŠØ§Ø±Ø©</option>
              <option value="microbus">Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
              <option value="tamanya">ØªÙ…Ù†ÙŠØ©</option>
              <option value="caboot">ÙƒØ§Ø¨ÙˆØª</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <input class="small" id="offerPrice" placeholder="Ù…Ø«Ø§Ù„: 25" inputmode="numeric" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="actions">
          <button class="btn primary" id="saveAreaBtn" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
          <button class="btn" id="clearAreaBtn" type="button">Ù…Ø³Ø­</button>
        </div>

        <div class="hint" id="setupMsg"></div>
      </div>

      <div class="sep"></div>

      <div class="sectionTitle">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
      <div id="ridesList" class="list"></div>
      <div class="hint" id="msg"></div>

      <div class="footerActions">
        <a class="btn" href="./index.html">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>

    </div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, setActiveRole, getUserDoc } from "./app.js";
    import {
      collection, doc, setDoc, getDoc, updateDoc,
      query, where, orderBy, limit, onSnapshot, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const clean = (s)=>String(s??"").trim().replace(/\s+/g," ");
    const safeNum = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };

    // ---- UI
    const whoEl = $("who");
    const msgEl = $("msg");
    const setupMsg = $("setupMsg");
    const ridesList = $("ridesList");

    const gpsChip = $("gpsChip");
    const statusChip = $("statusChip");
    const locChip = $("locChip");
    const vehChip = $("vehChip");

    const govSel = $("govSel");
    const cenInput = $("cenInput");
    const vehSel = $("vehSel");
    const offerPrice = $("offerPrice");

    $("logoutBtn").addEventListener("click", doLogout);

    // ---- Role + Auth
    setActiveRole("driver");
    const { user } = await requireAuthAndRole("driver");
    whoEl.textContent = user.email || user.phoneNumber || "â€”";

    // ---- Load saved area
    let driverProfile = null;
    try{ driverProfile = await getUserDoc(user.uid); }catch(e){ driverProfile=null; }

    const LS_KEY = "mesh_driver_area";
    function loadArea(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch{ return null; }
    }
    function saveAreaToLS(area){
      localStorage.setItem(LS_KEY, JSON.stringify(area));
    }
    function applyAreaUI(area){
      if(!area) return;
      govSel.value = area.gov || "";
      cenInput.value = area.cen || "";
      vehSel.value = area.veh || "";
      locChip.textContent = "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: " + ((area.gov||"-") + " / " + (area.cen||"-"));
      vehChip.textContent = "Ù…Ø±ÙƒØ¨Ø©: " + (area.veh||"-");
    }
    const area0 = loadArea();
    applyAreaUI(area0);

    $("saveAreaBtn").addEventListener("click", async ()=>{
      const area = {
        gov: clean(govSel.value),
        cen: clean(cenInput.value),
        veh: clean(vehSel.value),
        updatedAt: Date.now()
      };
      if(!area.gov || !area.cen || !area.veh){
        setupMsg.textContent = "Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ù…Ø­Ø§ÙØ¸Ø© + ØªÙƒØªØ¨ Ù…Ø±ÙƒØ² + ØªØ®ØªØ§Ø± Ù…Ø±ÙƒØ¨Ø©.";
        return;
      }
      saveAreaToLS(area);
      applyAreaUI(area);
      setupMsg.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.";
      // Ù„Ùˆ ØªØ­Ø¨ ØªØ®Ø²Ù†Ù‡Ø§ ÙÙŠ Firestore ÙƒÙ…Ø§Ù†:
      try{
        await setDoc(doc(db,"driver_status",user.uid), {
          areaGov: area.gov,
          areaCen: area.cen,
          vehicleType: area.veh,
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch(e){}
      resubscribeRides();
    });

    $("clearAreaBtn").addEventListener("click", ()=>{
      localStorage.removeItem(LS_KEY);
      govSel.value = "";
      cenInput.value = "";
      vehSel.value = "";
      setupMsg.textContent = "ØªÙ… Ø§Ù„Ù…Ø³Ø­.";
      locChip.textContent = "Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: -";
      vehChip.textContent = "Ù…Ø±ÙƒØ¨Ø©: -";
      resubscribeRides();
    });

    // ---- Map
    let map, meMarker=null, pickupMarker=null, toMarker=null, routeLine=null;
    let meLat=null, meLng=null;

    function initMap(){
      map = L.map("map",{ zoomControl:true });
      map.setView([30.0444,31.2357], 12); // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠ
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      setTimeout(()=>map.invalidateSize(true), 250);
    }

    function setMeMarker(lat,lng){
      meLat=lat; meLng=lng;
      gpsChip.textContent = "GPS: âœ…";
      gpsChip.classList.add("ok");
      if(!meMarker){
        meMarker = L.marker([lat,lng]).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ");
      }else{
        meMarker.setLatLng([lat,lng]);
      }
    }

    async function getMyLocation(){
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation) return reject(new Error("no_geolocation"));
        navigator.geolocation.getCurrentPosition(
          (pos)=>resolve(pos.coords),
          (err)=>reject(err),
          { enableHighAccuracy:true, timeout:15000, maximumAge:5000 }
        );
      });
    }

    async function goMyLocation(){
      try{
        const c = await getMyLocation();
        setMeMarker(c.latitude, c.longitude);
        map.setView([c.latitude,c.longitude], 16, { animate:true });
      }catch(e){
        gpsChip.textContent = "GPS: âŒ";
        gpsChip.classList.add("bad");
        msgEl.textContent = "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙØ¹Ù‘Ù„ GPS ÙˆØ§Ø³Ù…Ø­ Ø¨Ø§Ù„ØªØµØ±ÙŠØ­.";
      }
    }

    // ---- Online status
    let isOnline = false;

    async function pushDriverStatus(extra={}){
      try{
        const area = loadArea();
        await setDoc(doc(db,"driver_status",user.uid), {
          uid: user.uid,
          online: !!isOnline,
          lat: meLat ?? null,
          lng: meLng ?? null,
          areaGov: area?.gov || null,
          areaCen: area?.cen || null,
          vehicleType: area?.veh || null,
          updatedAt: serverTimestamp(),
          ...extra
        }, { merge:true });
      }catch(e){}
    }

    function setOnlineUI(v){
      isOnline = v;
      statusChip.textContent = v ? "Online" : "Offline";
      statusChip.className = "miniChip " + (v ? "ok" : "bad");
    }

    $("goOnlineBtn").addEventListener("click", async ()=>{
      const area = loadArea();
      if(!area?.gov || !area?.cen || !area?.veh){
        msgEl.textContent = "Ù„Ø§Ø²Ù… ØªØ­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø­Ø§ÙØ¸Ø©/Ù…Ø±ÙƒØ²/Ù…Ø±ÙƒØ¨Ø©) Ù‚Ø¨Ù„ Ù…Ø§ ØªØ´ØªØºÙ„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†.";
        return;
      }
      await goMyLocation();
      setOnlineUI(true);
      await pushDriverStatus();
      msgEl.textContent = "âœ… Ø£Ù†Øª Online";
      resubscribeRides();
    });

    $("stopOnlineBtn").addEventListener("click", async ()=>{
      setOnlineUI(false);
      await pushDriverStatus({ online:false });
      msgEl.textContent = "Ø£Ù†Øª Offline";
      clearRides();
    });

    $("myLocBtn").addEventListener("click", async ()=>{
      await goMyLocation();
      if(isOnline) await pushDriverStatus();
    });

    $("refreshBtn").addEventListener("click", ()=>{
      resubscribeRides(true);
    });

    // ---- Rides list subscription
    let unsubRides = null;

    function clearRides(){
      ridesList.innerHTML = "";
    }

    function rideCardHTML(r){
      const from = clean(r.fromText || "");
      const to = clean(r.toText || "");
      const price = r.price != null ? `${r.price} EG` : "â€”";
      const gov = r.governorate || "-";
      const cen = r.center || "-";
      const veh = r.vehicleType || "-";
      const st = r.status || "-";
      const id = r.id;

      return `
        <div class="card" data-id="${id}">
          <div class="row">
            <div style="font-weight:900">Ø·Ù„Ø¨ #${id.slice(0,6)}</div>
            <div class="muted">${st}</div>
          </div>
          <div class="muted" style="margin-top:6px">
            <div><b>Ù…Ù†:</b> ${from || "-"}</div>
            <div><b>Ø¥Ù„Ù‰:</b> ${to || "-"}</div>
            <div><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${price}</div>
            <div><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${gov} / ${cen}</div>
            <div><b>Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</b> ${veh}</div>
          </div>

          <div class="inlineActions">
            <button class="btn" data-act="openOnMap" type="button">ğŸ—ºï¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
            <button class="btn" data-act="offer" type="button">ğŸ’° Ø¹Ø±Ø¶</button>
            <button class="btn primary" data-act="accept" type="button">âœ… Ù‚Ø¨ÙˆÙ„</button>
          </div>
        </div>
      `;
    }

    async function drawRideOnMap(r){
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…
      if(pickupMarker){ map.removeLayer(pickupMarker); pickupMarker=null; }
      if(toMarker){ map.removeLayer(toMarker); toMarker=null; }

      const pLat = r.pickupLat ?? r.fromLat ?? null;
      const pLng = r.pickupLng ?? r.fromLng ?? null;
      const tLat = r.toLat ?? null;
      const tLng = r.toLng ?? null;

      if(pLat!=null && pLng!=null){
        pickupMarker = L.marker([pLat,pLng]).addTo(map).bindPopup("Ù…ÙƒØ§Ù† Ø§Ù„Ø±Ø§ÙƒØ¨").openPopup();
        map.setView([pLat,pLng], 15, { animate:true });
      }
      if(tLat!=null && tLng!=null){
        toMarker = L.marker([tLat,tLng]).addTo(map).bindPopup("Ø§Ù„ÙˆØ¬Ù‡Ø©");
      }
    }

    async function sendOffer(rideId){
      const n = safeNum(offerPrice.value);
      // Firestore Rules Ø¹Ù†Ø¯Ùƒ: Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠÙ‚Ø¯Ø± ÙŠØ­ÙˆÙ„ open -> offered
      await updateDoc(doc(db,"rides",rideId), {
        status: "offered",
        driverUid: user.uid,
        offerPrice: n ?? null,
        offeredAt: serverTimestamp()
      });
      msgEl.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶.";
    }

    async function acceptRide(rideId){
      await updateDoc(doc(db,"rides",rideId), {
        status: "accepted",
        driverUid: user.uid,
        acceptedAt: serverTimestamp()
      });
      msgEl.textContent = "âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©.";
      // Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù‡Ù†ÙˆÙ‚Ù Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆÙ†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      clearRides();
    }

    function buildRidesQuery(){
      const area = loadArea();
      // Ù„Ùˆ Ù…Ø´ Online: Ù…Ø§ Ù†Ø¹Ø±Ø¶Ø´ Ø·Ù„Ø¨Ø§Øª
      if(!isOnline) return null;

      // Ø£Ù‚Ù„ Ø´Ø±ÙˆØ· Ø¹Ù„Ø´Ø§Ù† ÙŠÙ‚Ù„Ù‘Ù„ Ø§Ù„Ù„ÙˆØ¯ + ÙŠÙˆØ§ÙÙ‚ ÙÙƒØ±Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
      let qy = query(collection(db,"rides"), where("status","==","open"), orderBy("createdAt","desc"), limit(30));

      // Ù„Ùˆ Ø¹Ø§ÙŠØ² ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ù…Ø³ØªØ­Ø³Ù†):
      if(area?.gov) qy = query(collection(db,"rides"),
        where("status","==","open"),
        where("governorate","==", area.gov),
        orderBy("createdAt","desc"),
        limit(30)
      );

      // Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù…ÙƒÙ† ÙŠØ­ØªØ§Ø¬ÙˆØ§ Index Ø¥Ø¶Ø§ÙÙŠâ€”Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù‡Ù†Ø¨Ø³Ø·Ù‡Ù….
      return qy;
    }

    function resubscribeRides(force=false){
      if(unsubRides){ unsubRides(); unsubRides=null; }
      clearRides();
      msgEl.textContent = "";

      const qy = buildRidesQuery();
      if(!qy){
        msgEl.textContent = "Ø£Ù†Øª Offline.";
        return;
      }

      unsubRides = onSnapshot(qy, (snap)=>{
        clearRides();
        if(snap.empty){
          msgEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ù†.";
          return;
        }
        const docs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        ridesList.innerHTML = docs.map(rideCardHTML).join("");
      }, (err)=>{
        console.error(err);
        msgEl.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Index).";
      });
    }

    ridesList.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const card = e.target.closest(".card");
      const rideId = card?.dataset?.id;
      if(!rideId) return;

      const act = btn.dataset.act;
      try{
        if(act === "openOnMap"){
          const snap = await getDoc(doc(db,"rides",rideId));
          if(snap.exists()) await drawRideOnMap(snap.data());
          return;
        }
        if(act === "offer") return await sendOffer(rideId);
        if(act === "accept") return await acceptRide(rideId);
      }catch(err){
        console.error(err);
        msgEl.textContent = "âŒ Ø­ØµÙ„ Ø®Ø·Ø£ØŒ Ø§ÙØªØ­ Console ÙˆØ§Ø¨Ø¹ØªÙ„ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.";
      }
    });

    // ---- init
    initMap();
    setOnlineUI(false);
    await goMyLocation();
    await pushDriverStatus({ online:false });

    // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ùˆ Online: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    setInterval(async ()=>{
      if(isOnline){
        try{
          await goMyLocation();
          await pushDriverStatus();
        }catch(e){}
      }
    }, 30000);

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„: Ù…Ø§ Ù†Ø¬ÙŠØ¨Ø´ Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Go Online
  </script>
</body>
</html>
