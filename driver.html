<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø´ÙˆØ§Ø±Ùƒ - Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
  <link rel="stylesheet" href="./styles.css">
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .map-wrap-driver{height:48vh; position:relative; border-radius:18px; overflow:hidden; border:1px solid var(--stroke)}
    #dmap{height:100%; width:100%}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div>
          <h1>Ø³Ø§Ø¦Ù‚</h1>
          <p id="who">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="container" style="padding-top:14px">

    <div class="map-wrap-driver">
      <div id="dmap"></div>
    </div>

    <div class="card" id="setupCard" style="display:none;margin-top:12px">
      <div class="hint">Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸ØªÙƒ ÙˆÙ…Ø±ÙƒØ²Ùƒ Ø¹Ù„Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ´ØªØºÙ„ Online.</div>

      <div class="grid2" style="margin-top:10px">
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
          <select id="govSel">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          </select>
        </div>
        <div class="field" style="margin-top:0">
          <label>Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ø­ÙŠ</label>
          <select id="cenSel" disabled>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>
          </select>
        </div>
      </div>

      <div id="cenOtherWrap" style="display:none;margin-top:10px">
        <label>Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø±ÙƒØ² ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø§Ø®ØªØ±Øª "Ø£Ø®Ø±Ù‰")</label>
        <input id="cenOtherInput" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙƒØ² Ø¬Ø¯ÙŠØ¯â€¦" />
      </div>

      <div class="actions">
        <button class="btn primary" id="saveAreaBtn" type="button">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
      </div>

      <div class="hint" id="setupMsg" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="pills" style="margin-top:0">
        <span class="pill" id="onlinePill">Offline</span>
        <span class="pill" id="gpsPill">GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
        <span class="pill" id="areaPill">Ù…Ù†Ø·Ù‚Ø©: -</span>
        <span class="pill" id="tripPill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©</span>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="onlineBtn" type="button">Go Online</button>
        <button class="btn" id="refreshBtn" type="button">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      </div>

      <div class="hint" id="msg" style="margin-top:10px"></div>
      <div class="hint" style="margin-top:10px">
        ÙŠØ¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ù…Ù†Ø·Ù‚ØªÙƒ ÙÙ‚Ø·. Ø§Ù„Ù‚Ø¨ÙˆÙ„ Transaction Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ âœ…
      </div>
    </div>

    <div class="card" id="currentTripCard" style="margin-top:12px;display:none"></div>
    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <script type="module">
    import { requireAuthAndRole, doLogout, db, getUserDoc } from "./app.js";
    import {
      collection, query, where, orderBy, limit,
      getDocs, doc, runTransaction, serverTimestamp, setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);

    const { user } = await requireAuthAndRole("driver");
    $("who").textContent = user.email;
    $("logoutBtn").addEventListener("click", doLogout);

    const listEl = $("list");
    const msg = $("msg");
    const onlineBtn = $("onlineBtn");
    const onlinePill = $("onlinePill");
    const gpsPill = $("gpsPill");
    const areaPill = $("areaPill");
    const tripPill = $("tripPill");
    const currentTripCard = $("currentTripCard");

    const setupCard = $("setupCard");
    const setupMsg = $("setupMsg");
    const govSel = $("govSel");
    const cenSel = $("cenSel");
    const cenOtherWrap = $("cenOtherWrap");
    const cenOtherInput = $("cenOtherInput");
    const saveAreaBtn = $("saveAreaBtn");
    $("refreshBtn").addEventListener("click", load);

    const statusRef = doc(db, "driver_status", user.uid);
    const userRef = doc(db, "users", user.uid);

    const OTHER = "__other__";
    const LS = { gov:"mw_driver_gov", cen:"mw_driver_cen", cenOther:"mw_driver_cen_other" };

    // Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ù…Ø´ Ø¨ÙŠØ£Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨)
    const REJ_KEY = "mw_rejected_ids";
    const rejected = new Set(JSON.parse(localStorage.getItem(REJ_KEY) || "[]"));
    const rejectId = (id)=>{ rejected.add(id); localStorage.setItem(REJ_KEY, JSON.stringify([...rejected])); };

    let isOnline = false, watchId = null, pushTimer = null;
    let lastPos = null; // {lat,lng,heading,speed}
    let driverProfile = null;
    let unsubStatus = null, unsubTrip = null;
    let currentTripId = null;

    // =========================
    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    // =========================
    const dmap = L.map("dmap", { zoomControl:false }).setView([30.0444, 31.2357], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    }).addTo(dmap);

    const fixMap = () => { try{ dmap.invalidateSize(true);}catch{} };
    setTimeout(fixMap, 300);
    window.addEventListener("load", ()=> setTimeout(fixMap, 200));
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) setTimeout(fixMap, 150); });

    const divPin = (emoji)=>L.divIcon({
      className:"pin-emoji",
      html:`<div class="pin-bubble">${emoji}</div>`,
      iconSize:[44,44], iconAnchor:[22,44], popupAnchor:[0,-36]
    });

    let meMarker=null, passengerMarker=null, routeLine=null;

    function setMeOnMap(lat,lng){
      if(!meMarker){
        meMarker = L.circleMarker([lat,lng], { radius:9, weight:2, fillOpacity:.85 })
          .addTo(dmap).bindPopup("ğŸ“ Ø£Ù†Øª");
      } else meMarker.setLatLng([lat,lng]);
    }
    function setPassengerOnMap(lat,lng){
      if(!passengerMarker){
        passengerMarker = L.marker([lat,lng], { icon: divPin("ğŸš©") }).addTo(dmap).bindPopup("ğŸš© Ø§Ù„Ø±Ø§ÙƒØ¨");
      } else passengerMarker.setLatLng([lat,lng]);
    }
    function drawRoute(){
      if(!meMarker || !passengerMarker) return;
      const a = meMarker.getLatLng(), b = passengerMarker.getLatLng();
      if(routeLine) dmap.removeLayer(routeLine);
      routeLine = L.polyline([a,b]).addTo(dmap);
    }
    function clearTripMap(){
      if(passengerMarker){ try{ dmap.removeLayer(passengerMarker);}catch{} passengerMarker=null; }
      if(routeLine){ try{ dmap.removeLayer(routeLine);}catch{} routeLine=null; }
    }

    // âœ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø­ØªÙ‰ Ù„Ùˆ Offline)
    function autoLocateOnce(){
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        setMeOnMap(lat,lng);
        dmap.setView([lat,lng], 15, { animate:false });
        fixMap();
      }, ()=>{}, { enableHighAccuracy:true, timeout:15000, maximumAge:8000 });
    }
    autoLocateOnce();

    // =========================
    // Ù…Ù†Ø§Ø·Ù‚
    // =========================
    const AREAS = {
      "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±","Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©","Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ","Ø­Ù„ÙˆØ§Ù†","Ø§Ù„Ù…Ø±Ø¬","Ø´Ø¨Ø±Ø§","Ø§Ù„Ø²ÙŠØªÙˆÙ†","Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©","Ø§Ù„ØªØ¬Ù…Ø¹"],
      "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…","ÙÙŠØµÙ„","Ø§Ù„Ø¯Ù‚ÙŠ","Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©","6 Ø£ÙƒØªÙˆØ¨Ø±","Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯","Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†","Ø§Ù„Ø­ÙˆØ§Ù…Ø¯ÙŠØ©"],
      "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±","Ù…Ø­Ø±Ù… Ø¨Ùƒ","Ø§Ù„Ù…Ù†ØªØ²Ù‡","Ø§Ù„Ø¹Ø¬Ù…ÙŠ","Ù…ÙŠØ§Ù…ÙŠ","Ø³Ù…ÙˆØ­Ø©"],
      "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©","Ø·Ù„Ø®Ø§","Ù…ÙŠØª ØºÙ…Ø±","Ø£Ø¬Ø§","Ø¯ÙƒØ±Ù†Ø³"],
      "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚","Ø¨Ù„Ø¨ÙŠØ³","Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­","ÙØ§Ù‚ÙˆØ³","Ù‡Ù‡ÙŠØ§"],
      "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§","Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰","Ø²ÙØªÙ‰","ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª"],
      "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…","Ø§Ù„Ø³Ø§Ø¯Ø§Øª","Ù…Ù†ÙˆÙ","Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±"],
      "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©": ["Ø¨Ù†Ù‡Ø§","Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©","Ù‚Ù„ÙŠÙˆØ¨","Ø§Ù„Ø®Ø§Ù†ÙƒØ©"],
      "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…","Ø³Ù†ÙˆØ±Ø³","Ø¥Ø·Ø³Ø§"],
      "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§","Ù…Ù„ÙˆÙŠ","Ø³Ù…Ø§Ù„ÙˆØ·"],
      "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·","Ø¯ÙŠØ±ÙˆØ·","Ù…Ù†ÙÙ„ÙˆØ·"],
      "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬","Ø¬Ø±Ø¬Ø§","Ø·Ù…Ø§"],
      "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§","Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ","Ù‚ÙØ·"],
      "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†","Ø¯Ø±Ø§Ùˆ","ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ"],
      "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±","Ø¥Ø³Ù†Ø§","Ø£Ø±Ù…Ù†Øª"]
    };

    function fillGov(){
      const keep0 = govSel.querySelector("option[value='']");
      govSel.innerHTML = ""; govSel.appendChild(keep0);
      Object.keys(AREAS).sort((a,b)=>a.localeCompare(b,"ar")).forEach(g=>{
        const o=document.createElement("option"); o.value=g; o.textContent=g; govSel.appendChild(o);
      });
    }
    function fillCenter(gov, pre=null){
      cenSel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>`;
      (AREAS[gov]||[]).forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; cenSel.appendChild(o); });
      const other=document.createElement("option"); other.value=OTHER; other.textContent="Ø£Ø®Ø±Ù‰ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)â€¦"; cenSel.appendChild(other);

      cenSel.disabled=!gov; cenOtherWrap.style.display="none"; cenOtherInput.value="";
      if(pre){
        const ok=[...cenSel.options].some(o=>o.value===pre);
        if(ok) cenSel.value=pre;
        else{ cenSel.value=OTHER; cenOtherWrap.style.display="block"; cenOtherInput.value=pre; }
      }
    }
    function getSelectedArea(){
      const gov=govSel.value.trim()||null, cVal=cenSel.value;
      if(!gov) return {gov:null, cen:null};
      if(!cVal) return {gov, cen:null};
      if(cVal===OTHER){
        const manual=cenOtherInput.value.trim();
        return {gov, cen:(manual.length>=2?manual:null)};
      }
      return {gov, cen:cVal.trim()||null};
    }
    function saveAreaLS(){
      const {gov,cen}=getSelectedArea();
      if(gov) localStorage.setItem(LS.gov, gov);
      if(cenSel.value===OTHER){
        localStorage.setItem(LS.cen, OTHER);
        localStorage.setItem(LS.cenOther, cenOtherInput.value||"");
      }else{
        if(cen) localStorage.setItem(LS.cen, cen);
        localStorage.removeItem(LS.cenOther);
      }
    }
    function restoreAreaLS(){
      const g=localStorage.getItem(LS.gov)||"", c=localStorage.getItem(LS.cen)||"", co=localStorage.getItem(LS.cenOther)||"";
      if(g){
        fillGov(); govSel.value=g;
        fillCenter(g, (c && c!==OTHER) ? c : (co||null));
        if(c===OTHER){ cenSel.value=OTHER; cenOtherWrap.style.display="block"; cenOtherInput.value=co; }
      }
    }

    govSel.addEventListener("change", ()=>{ fillCenter(govSel.value.trim()); setupMsg.textContent=""; saveAreaLS(); });
    cenSel.addEventListener("change", ()=>{
      if(cenSel.value===OTHER){ cenOtherWrap.style.display="block"; cenOtherInput.focus(); }
      else{ cenOtherWrap.style.display="none"; cenOtherInput.value=""; }
      setupMsg.textContent=""; saveAreaLS();
    });
    cenOtherInput.addEventListener("input", saveAreaLS);

    async function loadDriverProfile(){
      driverProfile = await getUserDoc(user.uid).catch(()=>null);
      return driverProfile;
    }
    async function ensureAreaSelected(){
      if(!driverProfile) await loadDriverProfile();
      const gov=driverProfile?.governorate||null, cen=driverProfile?.center||null;

      if(!gov || !cen){
        setupCard.style.display="block";
        fillGov(); restoreAreaLS();
        if(gov){ govSel.value=gov; fillCenter(govSel.value, cen||null); }
        else if(govSel.value){ fillCenter(govSel.value, null); }
        areaPill.textContent="Ù…Ù†Ø·Ù‚Ø©: -";
        return false;
      }
      setupCard.style.display="none";
      areaPill.textContent=`Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
      return true;
    }

    saveAreaBtn.addEventListener("click", async ()=>{
      setupMsg.textContent="";
      const {gov,cen}=getSelectedArea();
      if(!gov) return setupMsg.textContent="âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©.";
      if(!cen) return setupMsg.textContent="âŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ² (Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§).";

      saveAreaBtn.disabled=true; setupMsg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦";
      try{
        await setDoc(userRef, { governorate:gov, center:cen, updatedAt:serverTimestamp() }, { merge:true });
        saveAreaLS(); await loadDriverProfile();
        setupMsg.textContent="âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.";
        setupCard.style.display="none";
        areaPill.textContent=`Ù…Ù†Ø·Ù‚Ø©: ${gov} / ${cen}`;
        await load();
      }catch(e){
        console.error(e);
        setupMsg.textContent=`âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ${e.message||e}`;
      }finally{ saveAreaBtn.disabled=false; }
    });

    // =========================
    // UI
    // =========================
    function setOnlineUI(on){
      isOnline=on;
      onlinePill.classList.remove("ok","bad");
      if(on){
        onlinePill.textContent="Online âœ…"; onlinePill.classList.add("ok");
        onlineBtn.textContent="Go Offline"; onlineBtn.classList.remove("primary"); onlineBtn.classList.add("danger");
      }else{
        onlinePill.textContent="Offline"; onlinePill.classList.add("bad");
        onlineBtn.textContent="Go Online"; onlineBtn.classList.remove("danger"); onlineBtn.classList.add("primary");
      }
    }
    function setGpsUI(state){
      gpsPill.classList.remove("ok","bad");
      if(state==="ok"){ gpsPill.textContent="GPS: Ø´ØºØ§Ù„ âœ…"; gpsPill.classList.add("ok"); }
      else if(state==="denied"){ gpsPill.textContent="GPS: Ù…Ø±ÙÙˆØ¶ âŒ"; gpsPill.classList.add("bad"); }
      else gpsPill.textContent="GPS: ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }

    // =========================
    // Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø§ÙƒØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©)
    // =========================
    function stopWatchTrip(){
      if(unsubTrip){ try{unsubTrip();}catch{} unsubTrip=null; }
      clearTripMap();
    }

    function watchTrip(tripId){
      if(!tripId) return;
      if(unsubTrip) unsubTrip();

      const rideRef = doc(db, "rides", tripId);
      unsubTrip = onSnapshot(rideRef, (snap)=>{
        if(!snap.exists()){
          currentTripCard.style.display="block";
          currentTripCard.innerHTML=`<div class="hint">âš ï¸ Ø§Ù„Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</div>`;
          return;
        }

        const r=snap.data();
        const status=r.status||"-";

        const pLat=Number(r.from?.lat), pLng=Number(r.from?.lng);
        if(Number.isFinite(pLat) && Number.isFinite(pLng)){
          setPassengerOnMap(pLat,pLng);
          if(meMarker) drawRoute();
          if(status==="accepted" && !localStorage.getItem("autoFocusPickup_"+tripId)){
            localStorage.setItem("autoFocusPickup_"+tripId,"1");
            dmap.setView([pLat,pLng],16,{animate:false});
            fixMap();
          }
        }

        if(status==="done" || status==="canceled" || status==="completed"){
          currentTripCard.style.display="block";
          currentTripCard.innerHTML=`<div class="hint">âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù†ØªÙ‡Øª (${status}).</div>`;
          setDoc(statusRef, { available:!!isOnline, currentTripId:null, lastSeenAt:serverTimestamp() }, { merge:true }).catch(()=>{});
          return;
        }

        const pName=r.passengerName||"Ø±Ø§ÙƒØ¨";
        const pEmail=r.passengerEmail||"-";
        const pPhone=r.passengerPhone||"";

        currentTripCard.style.display="block";
        currentTripCard.innerHTML=`
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div><b>ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</b></div>
            <span class="pill ok">${status}</span>
          </div>
          <div class="hint" style="margin-top:10px">
            <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${pName} (${pEmail})
            <br><b>Ù‡Ø§ØªÙ:</b> ${pPhone || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
            <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
            <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
            <br><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${r.governorate ?? "-"} / ${r.center ?? "-"}
          </div>
          <div class="actions" style="margin-top:12px">
            ${pPhone ? `<a class="btn success" href="tel:${pPhone}">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>` : `<button class="btn" disabled>ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…</button>`}
            ${(Number.isFinite(pLat) && Number.isFinite(pLng)) ? `<button class="btn" id="focusPickupBtn" type="button">ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨</button>` : ``}
          </div>
        `;

        const focusBtn=currentTripCard.querySelector("#focusPickupBtn");
        if(focusBtn){
          focusBtn.addEventListener("click", ()=>{
            dmap.setView([pLat,pLng], 16, { animate:false });
            fixMap();
          });
        }
      });
    }

    function watchDriverStatus(){
      if(unsubStatus) unsubStatus();
      unsubStatus = onSnapshot(statusRef, (snap)=>{
        const st=snap.exists()?snap.data():null;
        const online=!!st?.online;
        const tripId=st?.currentTripId||null;
        setOnlineUI(online);

        if(tripId){
          tripPill.textContent=`ğŸš– Ø±Ø­Ù„Ø©: ${tripId}`;
          currentTripId=tripId;
          watchTrip(tripId);
        }else{
          tripPill.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø©";
          currentTripId=null;
          stopWatchTrip();
          currentTripCard.style.display="none";
          currentTripCard.innerHTML="";
        }
      });
    }

    // =========================
    // ÙƒØ±ÙˆØª Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù‚Ø¨ÙˆÙ„ + Ø±ÙØ¶)
    // =========================
    const safeNum=(x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };

    function rideCard(r, gov, cen){
      if(rejected.has(r.id)) return null; // Ù…Ø®ÙÙŠ Ù…Ø­Ù„ÙŠÙ‹Ø§

      const fromLat=safeNum(r.from?.lat), fromLng=safeNum(r.from?.lng);

      const el=document.createElement("div");
      el.className="card";
      el.innerHTML=`
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><b>Ø·Ù„Ø¨:</b> ${r.id}</div>
          <div class="pill">${r.status||"-"}</div>
        </div>

        <div class="hint" style="margin-top:8px">
          <b>Ø§Ù„Ø±Ø§ÙƒØ¨:</b> ${r.passengerName ?? "-"} (${r.passengerEmail ?? "-"})
          <br><b>Ù‡Ø§ØªÙ:</b> ${r.passengerPhone ?? "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
          <br><b>Ù…Ù†:</b> ${r.fromText ?? "-"}
          <br><b>Ø¥Ù„Ù‰:</b> ${r.toText ?? "-"}
          <br><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${r.governorate ?? "-"} / ${r.center ?? "-"}
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" data-accept="${r.id}" type="button">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn" data-reject="${r.id}" type="button">Ø±ÙØ¶</button>
          ${(fromLat!==null && fromLng!==null) ? `<button class="btn" data-focus="${r.id}" type="button">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>` : ``}
        </div>
        <div class="hint" style="margin-top:10px" id="m_${r.id}"></div>
      `;

      // focus
      const focusBtn=el.querySelector(`[data-focus="${r.id}"]`);
      if(focusBtn){
        focusBtn.addEventListener("click", ()=>{
          setPassengerOnMap(fromLat, fromLng);
          dmap.setView([fromLat, fromLng], 16, { animate:false });
          fixMap();
        });
      }

      // reject (local hide)
      el.querySelector(`[data-reject="${r.id}"]`).addEventListener("click", ()=>{
        rejectId(r.id);
        el.remove();
      });

      // accept
      el.querySelector(`[data-accept="${r.id}"]`).addEventListener("click", async ()=>{
        const m=el.querySelector(`#m_${r.id}`);
        const rideRef=doc(db,"rides",r.id);

        try{
          m.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø¨ÙˆÙ„â€¦";
          if(currentTripId){ m.textContent="âŒ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ø­Ø§Ù„ÙŠØ©. Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹."; return; }

          const d=driverProfile || await getUserDoc(user.uid);
          const driverName=d?.name || "Ø³Ø§Ø¦Ù‚";
          const driverPhone=d?.phone || null;

          const res = await runTransaction(db, async (tx)=>{
            const snap=await tx.get(rideRef);
            if(!snap.exists()) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§Ø®ØªÙÙ‰." };
            const cur=snap.data();

            if(cur.status!=="open") return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙØªÙˆØ­." };
            if(cur.driverUid) return { ok:false, msg:"Ø§Ù„Ø·Ù„Ø¨ Ø§ØªÙ‚Ø¨Ù„ Ø¨Ø§Ù„ÙØ¹Ù„." };
            if(cur.governorate!==gov || cur.center!==cen) return { ok:false, msg:"âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ø§Ø±Ø¬ Ù…Ù†Ø·Ù‚ØªÙƒ." };

            tx.update(rideRef, {
              status:"accepted",
              acceptedAt:serverTimestamp(),
              driverUid:user.uid,
              driverEmail:user.email,
              driverName,
              driverPhone
            });

            tx.set(statusRef, {
              online:true,
              available:false,
              currentTripId:r.id,
              lastSeenAt:serverTimestamp()
            }, { merge:true });

            return { ok:true, msg:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨." };
          });

          m.textContent=res.msg;
          await load();
        }catch(e){
          console.error(e);
          m.textContent=`âŒ ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„: ${e.message||e}`;
        }
      });

      return el;
    }

    async function load(){
      const ok = await ensureAreaSelected();
      if(!ok){ listEl.innerHTML=`<div class="card">Ø­Ø¯Ø¯ Ù…Ù†Ø·Ù‚ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.</div>`; return; }

      const gov=driverProfile.governorate, cen=driverProfile.center;
      listEl.innerHTML=`<div class="card">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øªâ€¦</div>`;

      const q = query(
        collection(db,"rides"),
        where("status","==","open"),
        where("governorate","==",gov),
        where("center","==",cen),
        orderBy("createdAt","desc"),
        limit(25)
      );

      const snap=await getDocs(q);
      listEl.innerHTML="";

      if(snap.empty){
        listEl.innerHTML=`<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        return;
      }

      snap.forEach(d=>{
        const card = rideCard({ id:d.id, ...d.data() }, gov, cen);
        if(card) listEl.appendChild(card);
      });
    }

    // =========================
    // Online/Offline + GPS Push
    // =========================
    async function pushStatus(extra={}){
      const gov=driverProfile?.governorate||null, cen=driverProfile?.center||null;
      const payload={
        online:isOnline,
        available:isOnline && !currentTripId,
        governorate:gov,
        center:cen,
        lastSeenAt:serverTimestamp(),
        ...extra
      };
      if(lastPos){
        payload.lat=lastPos.lat; payload.lng=lastPos.lng;
        payload.heading=lastPos.heading ?? null;
        payload.speed=lastPos.speed ?? null;
      }
      await setDoc(statusRef, payload, { merge:true });
    }

    function startGPS(){
      msg.textContent="";
      if(!navigator.geolocation){
        setGpsUI("denied");
        msg.textContent="âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.";
        return false;
      }

      watchId = navigator.geolocation.watchPosition((pos)=>{
        setGpsUI("ok");
        lastPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          heading: pos.coords.heading ?? null,
          speed: pos.coords.speed ?? null
        };
        setMeOnMap(lastPos.lat, lastPos.lng);
        if(passengerMarker) drawRoute();
      }, (err)=>{
        console.error(err);
        if(err?.code===1){
          setGpsUI("denied");
          msg.innerHTML="âŒ Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>Android: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ù…Ø´ÙˆØ§Ø±Ùƒ â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø³Ù…Ø§Ø­.";
        }else{
          setGpsUI("unknown");
          msg.textContent="ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.";
        }
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });

      pushTimer = setInterval(async ()=>{
        try{ if(isOnline) await pushStatus(); }catch(e){ console.error(e); }
      }, 4500);

      return true;
    }

    function stopGPS(){
      if(watchId!==null){ try{ navigator.geolocation.clearWatch(watchId);}catch{} watchId=null; }
      if(pushTimer){ clearInterval(pushTimer); pushTimer=null; }
      lastPos=null;
      setGpsUI("unknown");
    }

    async function goOnline(){
      onlineBtn.disabled=true;
      msg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Onlineâ€¦";

      await loadDriverProfile();
      const ok = await ensureAreaSelected();
      if(!ok){ msg.textContent="âŒ Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ù…Ø­Ø§ÙØ¸ØªÙƒ ÙˆÙ…Ø±ÙƒØ²Ùƒ Ø£ÙˆÙ„Ø§Ù‹."; onlineBtn.disabled=false; return; }

      setOnlineUI(true);
      const okGps = startGPS();

      if(okGps){
        try{
          await pushStatus({ online:true, available:!currentTripId, currentTripId: currentTripId || null });
          msg.textContent="âœ… Online Ø´ØºØ§Ù„.. Ø¨ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ.";
        }catch(e){
          console.error(e);
          msg.textContent=`âš ï¸ Online Ø§Ø´ØªØºÙ„ Ù„ÙƒÙ† Ù…Ø´ÙƒÙ„Ø© driver_status: ${e.message||e}`;
        }
      }
      onlineBtn.disabled=false;
    }

    async function goOffline(){
      onlineBtn.disabled=true;
      msg.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offlineâ€¦";
      setOnlineUI(false);
      stopGPS();

      try{
        await setDoc(statusRef, { online:false, available:false, lastSeenAt:serverTimestamp() }, { merge:true });
        msg.textContent="âœ… ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Offline.";
      }catch(e){
        console.error(e);
        msg.textContent=`âš ï¸ Offline Ø§ØªØ¹Ù…Ù„ Ù„ÙƒÙ† Ù…Ø´ÙƒÙ„Ø© driver_status: ${e.message||e}`;
      }
      onlineBtn.disabled=false;
    }

    onlineBtn.addEventListener("click", async ()=>{ if(isOnline) await goOffline(); else await goOnline(); });
    window.addEventListener("beforeunload", ()=>{ try{ stopGPS(); }catch{} });

    // init
    setOnlineUI(false);
    setGpsUI("unknown");
    await loadDriverProfile();
    await ensureAreaSelected();
    watchDriverStatus();
    await load();
  </script>
</body>
</html>
